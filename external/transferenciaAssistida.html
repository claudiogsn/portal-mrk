<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferência Assistida</title>

    <!-- Favicon-->
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <!-- Bootstrap Core Css -->
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Waves Effect Css -->
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet" />

    <!-- Animation Css -->
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet" />

    <!-- JQuery DataTable Css -->
    <link href="bsb/plugins/jquery-datatable/skin/bootstrap/css/dataTables.bootstrap.css" rel="stylesheet">

    <!-- SweetAlert Css -->
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet" />

    <!-- Custom Css -->
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet" />

    <!-- JQuery Steps CSS (para o Wizard) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.css">

    <!-- MultiSelect CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/css/multi-select.css">

    <!-- Custom CSS for table and modal -->
    <style>
        .wizard > .content {
            min-height: 300px;
        }
        /* Custom table alignment */
        #result-section {
            margin-top: 20px;
        }

                /* Altera a cor dos steps para azul */
        .wizard .steps .current a {
            background-color: #007bff !important; /* Cor azul */
            border-color: #007bff !important; /* Cor azul */
            color: white !important; /* Texto branco */
        }

        .wizard .steps .done a {
            background-color: #007bff !important; /* Cor azul para steps concluídos */
            border-color: #007bff !important;
            color: white !important;
        }

        .wizard .actions a {
            background-color: #007bff !important; /* Azul */
            border-color: #007bff !important; /* Azul */
            color: white !important; /* Texto branco */
        }

        .wizard .actions a:hover {
            background-color: #0056b3 !important; /* Azul mais escuro no hover */
            border-color: #0056b3 !important; /* Azul mais escuro no hover */
        }
    </style>
</head>
<body class="theme-blue">

    <!-- Modal Estilo AdminBSB -->
    <div class="modal fade" id="defaultModal" tabindex="-1" role="dialog" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="defaultModalLabel">Calculando Média de Consumo...</h4>
                </div>
                <div class="modal-body">
                    Aguarde enquanto as necessidades para o período selecionado estão sendo calculadas.
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row clearfix">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="card">
                    <div class="header">
                        <h2>Transferência Assistida</h2>
                    </div>
                    <div class="body">
                        <!-- Form Wizard -->
                        <form id="wizard-form">
                            <div id="wizard">
                                <h2>Destino</h2>
                                <section>
                                    <h4>Selecione o Destino</h4>
                                    <label for="unit-select">Unidade de Destino:</label>
                                    <select id="unit-select" name="unit-select" class="form-control" required>
                                        <!-- Unidades serão preenchidas dinamicamente -->
                                    </select>
                                </section>

                                <h2>Período</h2>
                                <section>
                                    <h4>Selecione o Período</h4>
                                    <div class="form-group">
                                        <input type="checkbox" id="use-period" checked>
                                        <label for="use-period">Usar Período</label>
                                    </div>
                                    <div id="period-selection" class="row">
                                        <div class="col-sm-6">
                                            <label for="start-date">Data Inicial</label>
                                            <input type="date" id="start-date" name="start-date" class="form-control" required>
                                        </div>
                                        <div class="col-sm-6">
                                            <label for="end-date">Data Final</label>
                                            <input type="date" id="end-date" name="end-date" class="form-control" required>
                                        </div>
                                    </div>
                                </section>

                                <h2>Produtos</h2>
                                <section>
                                    <h4>Selecione os Produtos</h4>
                                    <select multiple id="product-select" name="product-select" class="multi-select" required>
                                        <!-- Produtos serão preenchidos dinamicamente -->
                                    </select>
                                </section>

                                <h2>Necessidades Calculadas</h2>
                                <section>
                                    <div id="result-section" style="display:none;">
                                        <h4>Necessidades Calculadas</h4>
                                        <table id="result-table" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Codigo</th>
                                                    <th>Produto</th>
                                                    <th>Quantidade Sugerida</th>
                                                    <th>Aplicar</th>
                                                    <th>Quantidade para Transferência</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Resultados serão preenchidos dinamicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </form>

                        <div id="result"></div> <!-- Área para mostrar os últimos 4 dias -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jquery Core Js (Versão 2.2.4 para Compatibilidade com Bootstrap) -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <!-- Bootstrap Core Js -->
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <!-- Waves Effect Plugin Js -->
    <script src="bsb/plugins/node-waves/waves.js"></script>
    <!-- SweetAlert Plugin Js -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jQuery Steps JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-steps/1.1.0/jquery.steps.min.js"></script>
    <!-- jQuery Validation JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <!-- jQuery Multi-Select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/multi-select/0.9.12/js/jquery.multi-select.min.js"></script>

    <!-- Custom JS -->
     <script>
            document.addEventListener('DOMContentLoaded', function () {
    const baseUrl = window.location.hostname !== 'localhost' ?
        'https://portal.mrksolucoes.com.br/api/v1/index.php' :
        'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unitId = urlParams.get('unit_matriz_id');

    // Inicializar o Form Wizard
    const form = $("#wizard-form");

    form.validate({
        errorPlacement: function (error, element) {
            element.before(error); // Posiciona o erro antes do elemento
        },
        rules: {
            "unit-select": "required",
            "start-date": "required",
            "end-date": "required",
            "product-select": {
                required: function () {
                    return $("#product-select option:selected").length > 0; // Pelo menos um produto deve ser selecionado
                }
            }
        }
    });

    $("#wizard").steps({
        headerTag: "h2",
        bodyTag: "section",
        transitionEffect: "slideLeft",
        labels: {
            finish: "Finalizar",
            next: "Próximo",
            previous: "Anterior"
        },
        onStepChanging: function (event, currentIndex, newIndex) {
            form.validate().settings.ignore = ":disabled,:hidden";

            // Verifica se está tentando voltar (newIndex < currentIndex)
            if (newIndex < currentIndex) {
                window.location.reload();  // Força o reload da página
                return false; // Impede que o step volte normalmente
            }

            return form.valid(); // Continua para o próximo step normalmente
        },
        onStepChanged: function (event, currentIndex, priorIndex) {
            // Se o step atual for "Necessidades Calculadas", calcular as necessidades
            if (currentIndex === 3) {
                calcularNecessidades();
            } else if (currentIndex === 2) {
                const selectedUnitId = document.getElementById('unit-select').value;
                if (selectedUnitId) {
                    loadProdutos(selectedUnitId);
                } else {
                    alert("Por favor, selecione uma unidade de destino.");
                }
            }
        },
        onFinished: function (event, currentIndex) {
            // Finalização do wizard
        }
    });

    // Exibir Modal de Carregamento
    function showLoadingModal() {
        $('#defaultModal').modal('show');
    }

    // Ocultar Modal de Carregamento
    function hideLoadingModal() {
        $('#defaultModal').modal('hide');
    }

    // Carregar Unidades Vinculadas
    async function loadUnidades() {
        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'getFiliaisByMatriz',
                token: token,
                data: { unit_matriz_id: unitId }
            })
        });

        const unidades = await response.json();
        const select = document.getElementById('unit-select');
        unidades.forEach(filial => {
            const option = new Option(filial.filial_nome, filial.filial_id);
            select.appendChild(option);
        });
    }

    // Carregar Insumos/Produtos
    async function loadProdutos(unitId) {
        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'getInsumosUsage',
                token: token,
                data: { system_unit_id: unitId }
            })
        });

        const produtos = await response.json();
        const select = document.getElementById('product-select');
        select.innerHTML = ''; // Limpa produtos antigos
        produtos.forEach(produto => {
            const option = new Option(produto.insumo_nome, produto.insumo_id);
            select.appendChild(option);
        });
        $('#product-select').multiSelect();
    }

    // Calcular necessidades após o envio de datas e produtos
    async function calcularNecessidades() {
        const selectedUnitId = document.getElementById('unit-select').value;
        const selectedProducts = $('#product-select').val(); // Produtos selecionados
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        // Exibe as datas no console
        console.log("Datas selecionadas:", startDate, endDate);

        const dates = calcularUltimas4DatasPorSemana(startDate, endDate);
        console.log("Últimas 4 datas calculadas:", dates); // Exibe as datas calculadas no console

        showLoadingModal(); // Exibir o modal enquanto os dados estão sendo carregados

        const response = await fetch(baseUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                method: 'getInsumoConsumption',
                token: token,
                data: {
                    system_unit_id: selectedUnitId,
                    dates: dates,  // Enviando as últimas 4 datas para cada dia da semana
                    productCodes: selectedProducts
                }
            })
        });

        const consumptions = await response.json();
        const tableBody = document.getElementById('result-table').querySelector('tbody');
        tableBody.innerHTML = '';

        // Adicionar a lógica para obter os nomes dos produtos e mostrar na tabela
        const productSelect = document.getElementById('product-select');
        const productNames = Array.from(productSelect.selectedOptions).map(option => option.text);

        for (const [index, [productId, quantity]] of Object.entries(Object.entries(consumptions))) {
            const productName = productNames[index]; // Nome do produto com base na seleção
            const row = `
                <tr>
                    <td>${productName}</td>
                    <td>${productId}</td>
                    <td>${quantity}</td>
                    <td>
                        <button type="button" class="btn btn-primary btn-apply" data-quantity="${quantity}">➡</button>
                    </td>
                    <td><input type="number" class="form-control" value=""></td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        }

        // Adicionando evento para os botões de aplicar a quantidade
        document.querySelectorAll('.btn-apply').forEach(button => {
            button.addEventListener('click', function () {
                const quantity = this.getAttribute('data-quantity');
                const input = this.closest('tr').querySelector('input');
                input.value = quantity; // Aplicar a quantidade sugerida no campo de input
            });
        });

        hideLoadingModal(); // Ocultar o modal após o cálculo
        document.getElementById('result-section').style.display = 'block'; // Mostrar a tabela de resultados
    }

    function isolarDiasDaSemana(startDateInput, endDateInput) {
        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);
        let diasUnicos = new Set();

        // Percorrer o intervalo de datas e identificar os dias da semana únicos
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            diasUnicos.add(d.getDay()); // Adiciona o índice do dia da semana (0 = Domingo, 6 = Sábado)
        }

        console.log("Dias da semana isolados no período:", Array.from(diasUnicos)); // Exibe os dias da semana isolados
        return Array.from(diasUnicos); // Retorna um array de dias únicos
    }

    // Função que retorna as últimas 4 ocorrências de um dia da semana específico
    function calcularUltimas4DatasParaDia(diaSemana) {
        let datasEncontradas = [];
        let dataAtual = new Date();  // Usaremos a data atual como ponto de referência

        // Loop para encontrar as últimas 4 ocorrências do dia da semana
        while (datasEncontradas.length < 4) {
            if (dataAtual.getDay() === diaSemana) {
                datasEncontradas.push(new Date(dataAtual).toISOString().slice(0, 10));
            }
            dataAtual.setDate(dataAtual.getDate() - 1); // Retrocede um dia
        }

        console.log(`Últimas 4 datas para o dia ${diaSemana}:`, datasEncontradas); // Log das últimas 4 datas para o dia
        return datasEncontradas;
    }


    // Função principal que isola os dias da semana e calcula as últimas 4 datas de cada um
    function calcularUltimas4DatasPorSemana(startDateInput, endDateInput) {
        // Passa o intervalo de datas para a função que isola os dias da semana
        const diasDaSemana = isolarDiasDaSemana(startDateInput, endDateInput);
        let todasAsDatas = [];

        // Para cada dia da semana isolado, calcular as 4 últimas datas
        diasDaSemana.forEach(dia => {
            const ultimas4Datas = calcularUltimas4DatasParaDia(dia);
            todasAsDatas.push(...ultimas4Datas); // Adiciona as datas ao array principal
        });

        console.log("Todas as últimas 4 datas calculadas:", todasAsDatas); // Log das datas finais
        return todasAsDatas; // Retorna todas as últimas 4 datas
    }


    // Inicializar
    loadUnidades();
});

    </script>
</body>
</html>
