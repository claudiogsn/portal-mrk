<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Realizar Balanço</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Header e Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif; color: var(--mrk-blue); font-weight: 600; font-size: 12px;
            background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; white-space: nowrap;
        }
        .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        /* Acordeão de Categorias */
        .category-header { cursor: pointer; transition: background 0.2s; }
        .category-header:hover { background-color: #e3f2fd !important; }
        .category-header td { background-color: #f1f1f1; font-weight: 600; color: var(--mrk-blue); border-top: 2px solid #fff; }
        .toggle-icon { margin-right: 10px; font-weight: bold; }

        /* Inputs na Tabela */
        .form-control-sm { height: 30px; padding: 2px 8px; font-size: 13px; }

        /* Skeleton */
        .skeleton-wrapper { display: none; margin-top: 20px; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Modal */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-black); font-weight: 600; }
        .modal-footer { border-top: 1px solid #eee; background: #fff; padding: 15px; }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">
    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:check-one" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                REALIZAR BALANÇO <span id="pageTitle" class="muted text-small" style="font-weight:400; margin-left:10px;"></span>
            </h2>
        </div>

        <div class="body">
            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-4">
                        <label class="muted">Data de Referência (Movimento)</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <select id="dateBalance" class="form-control"></select>
                        </div>
                    </div>
                    <div class="col-md-8 text-right" style="margin-top: 25px;">
                        <button id="btnEnviar" class="btn btn-primary waves-effect btn-lg">
                            <iconify-icon icon="icon-park-outline:send" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            ENVIAR CONTAGEM
                        </button>
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="itensTable">
                    <thead>
                    <tr>
                        <th>Produto</th>
                        <th width="100" class="text-center">Unid.</th>
                        <th width="150" class="text-right">Quantidade</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="3" class="text-center muted" style="padding: 30px;">Aguardando login...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 8px; border:none;">
            <div class="modal-header">
                <h4 class="modal-title">
                    <iconify-icon icon="icon-park-outline:lock" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon>
                    Acesso Restrito
                </h4>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="alert alert-danger" id="loginError" style="display: none;">
                    <strong>Erro!</strong> Usuário ou senha incorretos.
                </div>
                <div class="form-group">
                    <label class="muted">Usuário</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:user"></iconify-icon></span>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Seu usuário">
                    </div>
                </div>
                <div class="form-group">
                    <label class="muted">Senha</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:key"></iconify-icon></span>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Sua senha">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="loginButton" class="btn btn-primary btn-block waves-effect">ENTRAR</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // Configurações de API
    const isLocalhost = window.location.hostname === 'localhost';
    const baseUrl = isLocalhost
        ? 'http://localhost/portal-mrk/api/v1/index.php'
        : 'https://portal.mrksolucoes.com.br/api/v1/index.php';

    // Endpoint específico para Login
    const loginUrl = isLocalhost
        ? 'http://localhost/portal-mrk/api/v1/login.php'
        : 'https://portal.mrksolucoes.com.br/api/v1/login.php';

    let loggedUserId = '';
    let system_unit_id = '';

    // Helper: Skeleton Loader
    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    $(document).ready(() => {
        populateDateSelect();
        extractSystemUnitId();

        // Exibir Modal de Login
        $('#loginModal').modal('show');

        // Handler do Botão Entrar
        $('#loginButton').click(async () => {
            const username = $('#loginUsername').val();
            const password = $('#loginPassword').val();
            const btn = $('#loginButton');
            const errorAlert = $('#loginError');

            if (!username || !password) {
                Swal.fire('Atenção', 'Preencha usuário e senha.', 'warning');
                return;
            }

            // Feedback visual
            btn.text('Verificando...').prop('disabled', true);
            errorAlert.hide();

            try {
                const res = await axios.post(loginUrl, {
                    login: username,
                    password: password
                });

                if (res.data && res.data.token) {
                    // Login Sucesso
                    loggedUserId = res.data.user.id;
                    $('#loginModal').modal('hide');

                    Swal.fire({
                        icon: 'success',
                        title: `Olá, ${res.data.user.name}`,
                        text: 'Acesso autorizado.',
                        timer: 1500,
                        showConfirmButton: false
                    });

                    // Carrega os dados
                    loadItemsByTag();
                } else {
                    // Resposta veio, mas sem token (erro lógico)
                    errorAlert.text('Credenciais inválidas ou usuário inativo.').show();
                    btn.text('ENTRAR').prop('disabled', false);
                }

            } catch (e) {
                // Erro HTTP (401, 500, etc)
                console.error(e);
                let msg = 'Erro ao conectar ao servidor.';
                if (e.response && e.response.status === 401) {
                    msg = 'Usuário ou senha incorretos.';
                }
                errorAlert.text(msg).show();
                btn.text('ENTRAR').prop('disabled', false);
            }
        });

        // Enviar Balanço
        $('#btnEnviar').click(sendBalance);

        // Enter no campo de senha dispara o login
        $('#loginPassword').keypress(function(e) {
            if(e.which == 13) $('#loginButton').click();
        });
    });

    function populateDateSelect() {
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);

        const fmt = d => d.toLocaleDateString('pt-BR');
        const iso = d => d.toISOString().split('T')[0];

        $('#dateBalance').append(new Option(`Hoje (${fmt(today)})`, iso(today)));
        $('#dateBalance').append(new Option(`Ontem (${fmt(yesterday)})`, iso(yesterday)));
    }

    function extractSystemUnitId() {
        const params = new URLSearchParams(window.location.search);
        const tag = params.get('tag');
        if (tag) {
            const [id] = tag.split('-');
            system_unit_id = parseInt(id, 10);
        }
    }

    async function loadItemsByTag() {
        const params = new URLSearchParams(window.location.search);
        const tag = params.get('tag');

        if (!tag) {
            Swal.fire('Erro', 'Tag não identificada na URL.', 'error');
            return;
        }

        toggleLoading(true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'getModelByTag',
                data: { tag }
            });

            if (res.data && res.data.success) {
                const { modelo, itens } = res.data;
                $('#pageTitle').text(`- ${modelo.system_unit_name}`);
                renderItens(itens);
            } else {
                toggleLoading(false);
                Swal.fire('Erro', 'Falha ao carregar itens: ' + res.data.message, 'error');
            }
        } catch (error) {
            console.error(error);
            toggleLoading(false);
            Swal.fire('Erro', 'Erro ao carregar itens.', 'error');
        } finally {
            toggleLoading(false);
        }
    }

    function renderItens(itens) {
        const tbody = $('#itensTable tbody');
        tbody.empty();

        const categorias = Object.keys(itens).sort();

        categorias.forEach((cat, idx) => {
            const catId = `cat-${idx}`;

            // Header da Categoria
            tbody.append(`
                <tr class="category-header" data-target="#${catId}">
                    <td colspan="3">
                        <span class="toggle-icon"><iconify-icon icon="icon-park-outline:minus"></iconify-icon></span>
                        ${cat}
                    </td>
                </tr>
            `);

            // Itens
            itens[cat].sort((a,b) => a.nome_produto.localeCompare(b.nome_produto)).forEach((item, i) => {
                const badgeStyle = "background:#eee; color:#555;";

                tbody.append(`
                    <tr class="item-row ${catId}">
                        <td>${item.nome_produto}</td>
                        <td class="text-center">
                            <span class="badge unit-badge" style="${badgeStyle}">${item.und_produto}</span>
                        </td>
                        <td>
                            <input type="text" inputmode="decimal" class="form-control form-control-sm quantidade text-right"
                                   data-id="${item.codigo_produto}" data-seq="${i + 1}" placeholder="0,000" />
                        </td>
                    </tr>
                `);
            });
        });

        // Toggle Acordeão
        $('.category-header').click(function() {
            const target = $(this).data('target');
            const icon = $(this).find('iconify-icon');
            const isVisible = $(`.${target.replace('#', '')}`).is(':visible');

            $(`.${target.replace('#', '')}`).toggle();

            if (isVisible) icon.attr('icon', 'icon-park-outline:plus');
            else icon.attr('icon', 'icon-park-outline:minus');
        });

        // Configurar Máscara/Inputs
        applyInputMasks();
    }

        function applyInputMasks() {
        $('.quantidade').each(function() {
            const row = $(this).closest('tr');
            const unidade = row.find('.unit-badge').text().trim().toUpperCase();

            // Unidades fracionadas (KG, LT, etc) - 3 casas decimais
            // Limite: 5 dígitos inteiros + 3 decimais = 8 dígitos numéricos totais
            if (['KG', 'LT', 'L', 'M', 'M2', 'M3'].includes(unidade)) {
                $(this).on('input', function() {
                    let v = $(this).val().replace(/\D/g, ''); // Apenas números

                    if (v === '') {
                        $(this).val('');
                        return;
                    }

                    // Limita a 8 dígitos no total (corresponde a 99999,999)
                    if (v.length > 8) {
                        v = v.substring(0, 8);
                    }

                    // Converte para decimal (divide por 1000)
                    let valorDecimal = (parseInt(v) / 1000).toFixed(3);

                    // Troca ponto por vírgula para exibição BR
                    $(this).val(valorDecimal.replace('.', ','));
                });
            }
                // Unidades Inteiras (UN, CX, etc)
            // Limite: 5 dígitos totais
            else {
                $(this).on('input', function() {
                    let v = $(this).val().replace(/\D/g, ''); // Apenas números

                    // Limita a 5 dígitos
                    if (v.length > 5) {
                        v = v.substring(0, 5);
                    }

                    $(this).val(v);
                });
            }
        });
    }


    async function sendBalance() {
        const date_balance = $('#dateBalance').val();

        const itens = [];
        $('.quantidade').each(function() {
            let qtd = $(this).val();

            if (qtd === '') qtd = '0'; // Envia 0 se vazio para indicar que foi contado (opcional, regra de negócio)

            // Converte formato BR (1.234,56) para float JS (1234.56)
            // Remove pontos de milhar se houver, troca virgula decimal por ponto
            qtd = qtd.replace(/\./g, '').replace(',', '.');

            itens.push({
                codigo: $(this).data('id'),
                seq: $(this).data('seq'),
                quantidade: qtd
            });
        });

        if (itens.length === 0) return Swal.fire('Aviso', 'Nenhum item carregado.', 'warning');

        Swal.fire({ title: 'Enviando...', didOpen: () => Swal.showLoading() });

        try {
            const res = await axios.post(baseUrl, {
                method: 'saveBalanceItems',
                data: {
                    system_unit_id: parseInt(system_unit_id, 10),
                    date_balance: date_balance,
                    itens: itens,
                    user: loggedUserId
                }
            });

            Swal.close();

            if (res.data && res.data.success) {
                await Swal.fire('Sucesso', `Balanço <b>${res.data.balanco}</b> salvo com sucesso!`, 'success');
                // Limpa campos visualmente
                $('.quantidade').val('');
            } else {
                Swal.fire('Erro', res.data.message || 'Falha ao salvar.', 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Falha na conexão.', 'error');
        }
    }
</script>
</body>
</html>