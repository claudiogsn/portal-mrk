<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Consolidação Mensal | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet" />
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== AJUSTES GERAIS MRK ====== */
        html, body { background: transparent !important; }
        body { font-family: 'Poppins', sans-serif; background-color: #F4F7F6; }
        .container-fluid { padding-top: 15px; }

        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            border-top: 2px solid var(--mrk-blue) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        .card .header h2 { font-family: 'Kanit', sans-serif; font-weight: 600; color: var(--mrk-blue); display: flex; align-items: center; gap: 8px; }

        /* ====== GRID DE DIAS ====== */
        .day-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        .day-card {
            cursor: pointer;
            padding: 12px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #eee;
            border-left: 4px solid #ccc;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .day-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .day-card p { margin: 0; font-family: 'Kanit'; font-size: 22px; font-weight: 700; color: #333; }
        .day-card small { font-size: 10px; text-transform: uppercase; font-weight: 600; }

        .day-consolidated { border-left-color: var(--mrk-green); background: #f1f8f1; }
        .day-consolidated small { color: var(--mrk-green); }
        .day-pending { border-left-color: var(--mrk-amber); background: #fffaf0; }
        .day-pending small { color: var(--mrk-amber); }

        /* ====== TABELA E SKELETON ====== */
        .table thead th {
            background-color: #f8f9fa;
            color: var(--mrk-blue);
            font-family: 'Kanit', sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            position: sticky; top: 0; z-index: 10;
        }
        .saldo-final { background-color: #e3f2fd !important; font-weight: bold; color: var(--mrk-blue); }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* ====== TIMELINE ====== */
        .timeline-item {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .timeline-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .timeline-entrada { border-left: 5px solid var(--mrk-green); }
        .timeline-entrada .timeline-icon { background: #e8f5e9; color: var(--mrk-green); }
        .timeline-saida { border-left: 5px solid var(--mrk-red); }
        .timeline-saida .timeline-icon { background: #ffebee; color: var(--mrk-red); }
        .timeline-balanco { border-left: 5px solid #607d8b; background: #f5f7f9; }

        /* ====== CONTEXT MENU ====== */
        #customContextMenu {
            background: #fff; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: none; padding: 5px;
        }
        .dropdown-item {
            border-radius: 4px; font-family: 'Poppins'; font-size: 13px; padding: 8px 15px; display: flex; align-items: center; gap: 8px;
        }
        .dropdown-item:hover { background: var(--mrk-blue); color: #fff; }

        /* Modal Position Fix */
        .modal-header { position: relative; border-bottom: 2px solid var(--mrk-blue); padding: 18px 25px; }
        .modal-title { font-family: 'Kanit'; color: var(--mrk-blue); font-weight: 600; }
        .btn-close-mrk { position: absolute; top: 15px; right: 15px; color: var(--mrk-red); font-size: 26px; background: none; border: none; cursor: pointer; }
    </style>
</head>
<body class="theme-blue">

<div class="container-fluid">
    <div class="card">
        <div class="body">
            <div class="row clearfix">
                <div class="col-md-3 mb-0">
                    <label style="font-family:'Kanit'">Ano</label>
                    <select id="yearSelect" class="form-control">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="col-md-3 mb-0">
                    <label style="font-family:'Kanit'">Mês</label>
                    <select id="monthSelect" class="form-control">
                        <option value="1">Janeiro</option><option value="2">Fevereiro</option><option value="3">Março</option>
                        <option value="4">Abril</option><option value="5">Maio</option><option value="6">Junho</option>
                        <option value="7">Julho</option><option value="8">Agosto</option><option value="9">Setembro</option>
                        <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="col-md-2 mb-0" style="display: flex; align-items: flex-end;">
                    <button id="searchButton" class="btn btn-primary btn-block" style="height:38px; background-color: var(--mrk-blue) !important;">
                        <iconify-icon icon="icon-park-outline:search" style="vertical-align:middle; margin-right:5px;"></iconify-icon> BUSCAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="header">
            <h2><iconify-icon icon="icon-park-outline:calendar-dot" width="24"></iconify-icon> STATUS DE CONSOLIDAÇÃO DIÁRIA</h2>
        </div>
        <div class="body">
            <div class="day-grid" id="dayGrid">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg" style="width: 95%; max-width: 1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferência de Estoque</h5>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body p-0">
                <div id="modalContentGrid" class="table-responsive" style="max-height: 65vh;">
                </div>
            </div>
            <div class="modal-footer">
                <button id="exportToExcel" class="btn btn-default waves-effect">
                    <iconify-icon icon="icon-park-outline:excel" style="vertical-align:middle;"></iconify-icon> EXPORTAR EXCEL
                </button>
                <button id="confirmDifferences" class="btn btn-primary" style="background-color: var(--mrk-blue) !important;">
                    <iconify-icon icon="icon-park-outline:check-one" style="vertical-align:middle;"></iconify-icon> CONFIRMAR DIA
                </button>
                <button type="button" class="btn btn-link" data-dismiss="modal" style="color:#666;">FECHAR</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="timelineModal" tabindex="-1">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Histórico do Produto</h5>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body" id="timelineContent" style="background: #f9f9f9;">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ajusteSaldoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ajusteSaldoLabel">Ajustar Saldo</h5>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body">
                <label>Definir Novo Saldo:</label>
                <input type="text" id="novoSaldo" class="form-control text-center" style="font-size: 20px; font-weight: bold; color: var(--mrk-blue);" placeholder="0,000">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal" style="color:#666;">CANCELAR</button>
                <button type="button" class="btn btn-primary" id="confirmAjusteSaldo" style="background-color: var(--mrk-blue) !important;">SALVAR AJUSTE</button>
            </div>
        </div>
    </div>
</div>

<div id="customContextMenu" class="dropdown-menu" style="position: absolute; display: none; z-index: 9999;">
    <button class="dropdown-item" id="adjustSaldoOption">
        <iconify-icon icon="icon-park-outline:modify"></iconify-icon> Ajustar Saldo Manual
    </button>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    'use strict';

    document.addEventListener('DOMContentLoaded', async function () {
        const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/index.php' : 'http://localhost/portal-mrk/api/v1/index.php';
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token'), unitId = params.get('unit_id'), username = params.get('username');

        let currentDetails = [];

        // ====== SKELETONS ======
        function showGridSkeletons() {
            const grid = $('#dayGrid').empty();
            for(let i=0; i<30; i++) {
                grid.append(`<div class="skeleton" style="height: 80px; border-radius:8px;"></div>`);
            }
        }

        // ====== CORE LOGIC ======
        async function loadDays(year, month) {
            showGridSkeletons();
            try {
                const res = await axios.post(baseUrl, {
                    method: 'getStatusConsolidationMonth', token,
                    data: { system_unit_id: unitId, year: String(year), month: String(month).padStart(2, '0') }
                });
                renderDays(res.data);
            } catch (e) { console.error(e); }
        }

        function renderDays(days) {
            const grid = $('#dayGrid').empty();
            days.sort((a, b) => new Date(a.date) - new Date(b.date));

            days.forEach(day => {
                const dayNum = parseInt(day.date.split('-')[2]);
                const statusClass = day.status === 'consolidated' ? 'day-consolidated' : 'day-pending';
                const statusTxt = day.status === 'consolidated' ? 'Consolidado' : 'Pendente';
                const icon = day.status === 'consolidated' ? 'check-one' : 'time';

                const card = $(`
                    <div class="day-card ${statusClass}" data-date="${day.date}">
                        <p>${dayNum}</p>
                        <small><iconify-icon icon="icon-park-outline:${icon}"></iconify-icon> ${statusTxt}</small>
                    </div>
                `);

                card.click(() => openDetailsModal(day.date));
                grid.append(card);
            });
        }

        async function openDetailsModal(date) {
            Swal.fire({ title: 'Buscando dados...', didOpen: () => Swal.showLoading() });
            try {
                const configResp = await axios.post(baseUrl, { method: 'getConfigGroupByUnitId', token, data: { system_unit_id: unitId } });
                const metodo = configResp?.data?.consolidacao_diaria == 1 ? 'GetInfoConsolidationEstoque' : 'GetInfoConsolidationEstoqueSemBalanco';

                const res = await axios.post(baseUrl, { method: metodo, token, data: { system_unit_id: unitId, data: date } });
                Swal.close();

                currentDetails = res.data.data || [];
                renderDetailsGrid(currentDetails, date);

                $('#confirmDifferences').off('click').on('click', () => {
                    Swal.fire({
                        title: 'Confirmar Dia?', text: 'Deseja persistir as divergências deste dia?',
                        icon: 'question', showCancelButton: true, confirmButtonText: 'Sim, Persistir'
                    }).then(r => { if(r.isConfirmed) confirmDifferences(currentDetails, date); });
                });

                $('#detailsModal').modal('show');
            } catch (e) { Swal.fire('Erro', 'Falha ao carregar detalhes.', 'error'); }
        }

        function renderDetailsGrid(details, date) {
            const container = $('#modalContentGrid').empty();
            if (!details.length) { container.html('<div class="p-4 text-center">Nenhum dado para este dia.</div>'); return; }

            const table = $(`
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:50px">Hist.</th>
                            <th>Cód.</th>
                            <th>Descrição do Produto</th>
                            <th class="text-center">S. Anterior</th>
                            <th class="text-center">Entradas</th>
                            <th class="text-center">Saídas</th>
                            <th class="text-center saldo-final">Saldo Final</th>
                            <th class="text-center">Qtd. Balanço</th>
                            <th class="text-center">Diferença</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `);

            details.forEach((d, idx) => {
                const diffColor = parseFloat(d.diferenca) < 0 ? 'var(--mrk-red)' : (parseFloat(d.diferenca) > 0 ? 'var(--mrk-green)' : '#666');
                table.find('tbody').append(`
                    <tr>
                        <td class="text-center">
                            <a href="javascript:void(0)" onclick="openTimelineModal('${d.produto}', '${date}')" style="font-size:20px; color:var(--mrk-blue);">
                                <iconify-icon icon="icon-park-outline:history"></iconify-icon>
                            </a>
                        </td>
                        <td><b>${d.produto}</b></td>
                        <td>${d.nome_produto}</td>
                        <td class="text-center saldo-anterior-cell" data-idx="${idx}" style="cursor:context-menu;">${d.saldo_anterior}</td>
                        <td class="text-center" style="color:var(--mrk-green)">+ ${d.entradas}</td>
                        <td class="text-center" style="color:var(--mrk-red)">- ${d.saidas}</td>
                        <td class="text-center saldo-final">${d.contagem_ideal}</td>
                        <td class="text-center"><b>${d.contagem_realizada}</b></td>
                        <td class="text-center" style="color:${diffColor}; font-weight:bold;">${d.diferenca}</td>
                    </tr>
                `);
            });

            container.append(table);
            addSaldoClickEvent(details, date);
        }

        // ====== TIMELINE ======
        window.openTimelineModal = async function (product, date) {
            Swal.fire({ title: 'Carregando Linha do Tempo...', didOpen: () => Swal.showLoading() });
            try {
                const res = await axios.post(baseUrl, { method: 'getMovsByProd', token, data: { system_unit_id: unitId, data: date, product } });
                Swal.close();
                renderTimeline(res.data);
                $('#timelineModal').modal('show');
            } catch (e) { Swal.fire('Erro', 'Falha ao carregar timeline.', 'error'); }
        };

        function renderTimeline(movs) {
            const container = $('#timelineContent').empty();
            movs.forEach(m => {
                const isEntrada = m.tipo_mov.toLowerCase().includes('entrada');
                container.append(`
                    <div class="timeline-item timeline-${isEntrada ? 'entrada' : 'saida'}">
                        <div class="timeline-icon">
                            <iconify-icon icon="icon-park-outline:${isEntrada ? 'arrow-down' : 'arrow-up'}"></iconify-icon>
                        </div>
                        <div style="flex:1">
                            <div style="font-weight:700; color:#333; text-transform:uppercase; font-size:11px;">${m.tipo_mov}</div>
                            <div style="font-size:13px;">${m.nome_produto}</div>
                            <div style="font-size:12px; color:#666;">Doc: ${m.doc} | Destino: ${m.system_unit_id_destino || '-'}</div>
                        </div>
                        <div style="font-family:'Kanit'; font-weight:700; font-size:16px;">
                            ${isEntrada ? '+' : '-'} ${m.quantidade}
                        </div>
                    </div>
                `);
            });
        }

        // ====== AJUSTE DE SALDO ======
        function addSaldoClickEvent(details, date) {
            $('.saldo-anterior-cell').on('contextmenu', function (e) {
                e.preventDefault();
                const idx = $(this).data('idx');
                const item = details[idx];
                $('#customContextMenu').css({ display: 'block', left: e.pageX, top: e.pageY });
                $('#adjustSaldoOption').off('click').on('click', () => {
                    $('#customContextMenu').hide();
                    showSaldoAdjustmentModal(item, date);
                });
            });
        }

        function showSaldoAdjustmentModal(item, date) {
            $('#ajusteSaldoLabel').text(`Ajustar Saldo: ${item.nome_produto}`);
            $('#novoSaldo').val('').off('input').on('input', function() {
                let v = $(this).val().replace(/\D/g, '');
                v = (v / 1000).toFixed(3);
                $(this).val(v.replace('.', ','));
            });

            $('#confirmAjusteSaldo').off('click').on('click', async () => {
                const novoSaldo = $('#novoSaldo').val().trim();
                $('#ajusteSaldoModal').modal('hide');

                Swal.fire({ title: 'Salvando Ajuste...', didOpen: () => Swal.showLoading() });
                try {
                    const res = await axios.post(baseUrl, {
                        method: 'createAjusteSaldo', token,
                        data: {
                            system_unit_id: unitId, ajuste_date: date, usuario_id: username,
                            itens: [{ codigo: item.produto, descricao: item.nome_produto, saldoAtual: item.saldo_anterior, novoSaldo }]
                        }
                    });
                    if (res.data.status === 'success') {
                        Swal.fire('Sucesso!', 'Saldo ajustado.', 'success').then(() => $('#detailsModal').modal('hide'));
                    }
                } catch (e) { Swal.fire('Erro', 'Falha no ajuste.', 'error'); }
            });

            $('#ajusteSaldoModal').modal('show');
        }

        // ====== PERSISTÊNCIA ======
        async function confirmDifferences(details, date) {
            try {
                Swal.fire({ title: 'Confirmando...', didOpen: () => Swal.showLoading() });
                const res = await axios.post(baseUrl, {
                    method: 'persistStockDifferences', token,
                    data: { date, system_unit_id: unitId, data: details }
                });
                if (res.data.status === 'success') {
                    Swal.fire('Sucesso!', res.data.message, 'success');
                    $('#detailsModal').modal('hide');
                    loadDays($('#yearSelect').val(), $('#monthSelect').val());
                }
            } catch (e) { Swal.fire('Erro', 'Tente novamente.', 'error'); }
        }

        // ====== EXPORTAÇÃO ======
        $('#exportToExcel').click(function () {
            const table = document.querySelector('#modalContentGrid table');
            if (!table) return;
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(table);
            XLSX.utils.book_append_sheet(wb, ws, 'Diferenças');
            XLSX.writeFile(wb, `Diferencas_Estoque_${new Date().getTime()}.xlsx`);
        });

        // ====== INIT ======
        $('#searchButton').click(() => loadDays($('#yearSelect').val(), $('#monthSelect').val()));
        $(document).click(() => $('#customContextMenu').hide());

        const now = new Date();
        $('#yearSelect').val(now.getFullYear());
        $('#monthSelect').val(now.getMonth() + 1);
        loadDays(now.getFullYear(), now.getMonth() + 1);
    });
</script>
</body>
</html>