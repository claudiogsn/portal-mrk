<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Editar Conta Financeira</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <!-- AdminBSB / Bootstrap -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <!-- Select2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

    <style>
        html, body { background:#fff; }
        .form-control { margin-bottom:10px; }
        .table th, .table td { vertical-align: middle !important; }
        .modal-body { max-height: 500px; overflow-y: auto; }
        .select2-container .select2-selection--single { height: 34px !important; }
        .select2-selection__rendered { line-height: 34px !important; }
        .select2-selection__arrow { height: 34px !important; }
        .text-right { text-align:right; }
        /* força fundo branco em tudo dentro do iframe */
        html, body, .container-fluid, .card, .card .body {
            background: #fff !important;
        }

        /* remove qualquer cinza do tema na área principal (AdminBSB costuma pintar .content) */
        .content, .content .container-fluid {
            background: #fff !important;
        }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <div class="block-header"><h2></h2><br></div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="header"><h2>Editar Conta Financeira</h2></div>

                <div class="body">
                    <!-- Topo -->
                    <div class="row">
                        <div class="col-md-6">
                            <label>Fornecedor</label>
                            <select id="fornecedor" class="form-control">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Plano de Contas</label>
                            <select id="plano_contas" class="form-control">
                                <option value="">Selecione...</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label>Documento</label>
                            <input type="text" id="doc" class="form-control" autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <label>Emissão</label>
                            <input type="date" id="emissao" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label>Vencimento</label>
                            <input type="date" id="vencimento" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label>Valor (bruto)</label>
                            <input type="number" step="0.01" id="valor_total" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label>Desconto</label>
                            <input type="number" step="0.01" id="desconto" class="form-control" value="0">
                        </div>
                        <div class="col-md-4">
                            <label>Acréscimo</label>
                            <input type="number" step="0.01" id="acrescimo" class="form-control" value="0">
                        </div>

                        <div class="col-md-6">
                            <label>Forma de Pagamento</label>
                            <select id="forma_pagamento_id" class="form-control">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Observação</label>
                            <input type="text" id="obs_extra" class="form-control" autocomplete="off">
                        </div>
                    </div>

                    <hr>

                    <!-- Toggle parcelamento -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="checkbox">
                                <input id="chkParcelar" type="checkbox" class="filled-in">
                                <label for="chkParcelar">Deseja parcelar?</label>
                            </div>
                        </div>
                    </div>

                    <!-- Área de parcelamento (esconde/mostra) -->
                    <div id="areaParcelas" style="display:none;">
                        <div class="row">
                            <div class="col-md-3">
                                <label>Quantidade de parcelas</label>
                                <input type="number" id="qtParcelas" class="form-control" min="1" step="1" value="2">
                            </div>
                            <div class="col-md-3" style="margin-top:25px;">
                                <button type="button" class="btn btn-primary" id="btnGerarParcelas">Gerar parcelas</button>
                            </div>
                        </div>

                        <div class="table-responsive" style="margin-top:10px;">
                            <table class="table table-striped" id="tblParcelas">
                                <thead>
                                <tr>
                                    <th style="width:90px;">Parcela</th>
                                    <th>Documento</th>
                                    <th style="width:160px;">Emissão</th>
                                    <th style="width:160px;">Vencimento</th>
                                    <th style="width:160px;">Valor</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="row" style="margin-top:8px;">
                            <div class="col-md-6">
                                <small id="avisoParcelas" class="text-danger" style="display:none;">
                                    A soma das parcelas difere do total ajustado (valor - desconto + acréscimo).
                                </small>
                            </div>
                            <div class="col-md-6 text-right">
                                <strong>Total das parcelas: <span id="totalParcelas">R$ 0,00</span></strong>
                            </div>
                        </div>
                    </div>

                    <div class="text-right" style="margin-top:18px;">
                        <button type="button" class="btn btn-success" id="btnSalvar">
                            <i class="fa fa-save"></i> Salvar
                        </button>
                    </div>
                </div><!-- body -->
            </div><!-- card -->
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="bsb/plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="bsb/plugins/bootstrap-notify/bootstrap-notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // ======= Params e URLs =======
    const urlParams = new URLSearchParams(window.location.search);
    const token     = urlParams.get('token');
    const id        = urlParams.get('id'); // id da conta a editar
    const unit_id   = urlParams.get('system_unit_id') || urlParams.get('unit_id');
    const user_id   = urlParams.get('user_id') || urlParams.get('username');

    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    // ======= Helpers =======
    function toBRL(v){ const n = Number(v)||0; return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}) }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function addMonths(dateStr, months){
        const d = new Date(dateStr);
        d.setMonth(d.getMonth() + months);
        const tz = new Date(d.getTime() - d.getTimezoneOffset()*60000);
        return tz.toISOString().slice(0,10);
    }

    let contaLoaded = null;

    // ======= Init =======
    $(document).ready(() => {
        if (!token || !id) {
            Swal.fire('Atenção','Parâmetros ausentes na URL (token e/ou id).','warning');
            return;
        }

        // Select2
        $('#fornecedor').select2({ placeholder: 'Selecione...', allowClear: true, width: '100%' });
        $('#plano_contas').select2({ placeholder: 'Selecione...', allowClear: true, width: '100%' });
        $('#forma_pagamento_id').select2({ placeholder: 'Selecione...', allowClear: true, width: '100%' });

        // Carrega dados necessários e depois carrega a conta
        carregarFornecedores()
            .then(() => carregarPlanos())
            .then(() => carregarFormasPagamento())
            .then(() => carregarConta());

        // Toggle de parcelamento
        $('#chkParcelar').on('change', function(){
            const show = $(this).is(':checked');
            $('#areaParcelas').toggle(show);
            if (show) gerarParcelas(); else limparParcelasUI();
        });

        // Geração de parcelas
        $('#btnGerarParcelas').on('click', gerarParcelas);

        // Regenerar ao alterar campos base
        $('#qtParcelas, #valor_total, #desconto, #acrescimo, #vencimento, #doc').on('change input', () => {
            if ($('#chkParcelar').is(':checked')) gerarParcelas();
        });

        // Recalcular total ao editar manualmente
        $(document).on('input change', '.valorParcela, .emissaoParcela, .vencParcela', atualizarTotalParcelas);

        $('#btnSalvar').on('click', salvar);

        // ESC fecha modal pai
        (function enableEscClose(){
            if (!document.body.hasAttribute('tabindex')) document.body.setAttribute('tabindex','-1');
            document.body.focus();
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    e.preventDefault();
                    fecharModalParent();
                }
            });
        })();
    });

    // ======= Loaders =======
    async function carregarConta(){
        try{
            Swal.fire({ title:'Carregando...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, {
                method: 'getContaById',
                token,
                data: { id: Number(id) }
            });
            Swal.close();

            if (!res.data || !res.data.id) {
                return Swal.fire('Erro','Conta não encontrada.','error');
            }

            contaLoaded = res.data;

            // Preenche campos
            $('#doc').val(contaLoaded.doc || '');
            $('#emissao').val(contaLoaded.emissao || '');
            $('#vencimento').val(contaLoaded.vencimento || '');
            $('#valor_total').val(contaLoaded.valor || 0);
            $('#desconto').val(0);
            $('#acrescimo').val(Number(contaLoaded.adic || 0));

            $('#obs_extra').val(contaLoaded.obs || '');

            // fornecedor/entidade
            if (contaLoaded.entidade) {
                $('#fornecedor').val(String(contaLoaded.entidade)).trigger('change');
            }

            // plano de contas
            if (contaLoaded.plano_contas) {
                $('#plano_contas').val(String(contaLoaded.plano_contas)).trigger('change');
            }

            // forma de pagamento / banco (código do banco)
            if (typeof contaLoaded.forma_pagamento !== 'undefined' && contaLoaded.forma_pagamento !== null) {
                $('#forma_pagamento_id').val(String(contaLoaded.forma_pagamento)).trigger('change');
            } else if (typeof contaLoaded.banco !== 'undefined' && contaLoaded.banco !== null) {
                $('#forma_pagamento_id').val(String(contaLoaded.banco)).trigger('change');
            }

        } catch(e){
            console.error(e);
            Swal.close();
            Swal.fire('Erro','Falha ao carregar a conta.','error');
        }
    }

    async function carregarFornecedores(){
        try{
            const res = await axios.post(baseUrl, {
                method: 'listFornecedores',
                token,
                data: { system_unit_id: Number(unit_id) }
            });
            const list = Array.isArray(res.data) ? res.data : (res.data?.data || res.data || []);
            const sel = $('#fornecedor');
            list.forEach(f => {
                const label = f.razao && f.razao.trim() !== '' ? f.razao : f.nome;
                sel.append(new Option(`${f.id} - ${label}`, f.id, false, false));
            });
            sel.trigger('change.select2');
        }catch(e){
            console.error(e);
            Swal.fire('Erro','Falha ao carregar fornecedores.','error');
        }
    }

    async function carregarPlanos(){
        try{
            const res = await axios.post(baseUrl, {
                method: 'listPlanos',
                token,
                data: { system_unit_id: Number(unit_id) }
            });

            const lista = Array.isArray(res.data) ? res.data : (res.data?.data || res.data || []);
            const sel = $('#plano_contas');

            // ordena por código
            lista.sort((a,b) => a.codigo.localeCompare(b.codigo));

            lista.forEach(p => {
                const nivel = Math.floor((p.codigo.length - 2) / 2);
                const indent = '\u00A0'.repeat(nivel * 4); // espaços reais

                sel.append(
                    new Option(`${indent}${p.codigo} - ${p.descricao}`, p.codigo, false, false)
                );
            });

            sel.trigger('change.select2');

        }catch(e){
            console.error(e);
            Swal.fire('Erro','Falha ao carregar planos de conta.','error');
        }
    }

    async function carregarFormasPagamento(){
        try{
            const res = await axios.post(baseUrl, {
                method: 'listBancos',
                token,
                data: {
                    system_unit_id: Number(unit_id),
                    apenasAtivos: true
                }
            });

            const lista = Array.isArray(res.data) ? res.data : (res.data?.data || res.data || []);
            const sel = $('#forma_pagamento_id');

            // se o backend já ordenar por codigo, beleza; se não, garante aqui
            lista.sort((a,b) => {
                const ca = String(a.codigo || '');
                const cb = String(b.codigo || '');
                return ca.localeCompare(cb, 'pt-BR', { numeric: true });
            });

            lista.forEach(b => {
                sel.append(new Option(`${b.codigo} - ${b.nome}`, b.codigo, false, false));
            });

            sel.trigger('change.select2');

        } catch (e){
            console.error(e);
            Swal.fire('Erro','Falha ao carregar formas de pagamento (bancos).','error');
        }
    }

    // ======= Parcelas =======
    function limparParcelasUI(){
        $('#tblParcelas tbody').empty();
        $('#totalParcelas').text('R$ 0,00');
        $('#avisoParcelas').hide();
    }

    function gerarParcelas(){
        const qt           = Math.max(1, parseInt($('#qtParcelas').val() || '1', 10));
        const docBase      = ($('#doc').val() || '').trim();
        const emissao      = $('#emissao').val();
        const vencInicial  = $('#vencimento').val();

        const valor_total  = parseFloat($('#valor_total').val() || 0);
        const desconto     = parseFloat($('#desconto').val() || 0);
        const acrescimo    = parseFloat($('#acrescimo').val() || 0);

        const totalAjustado = (valor_total - desconto + acrescimo);

        if (!docBase || !vencInicial || totalAjustado <= 0 || qt < 1) {
            limparParcelasUI();
            return;
        }

        const baseParcela = Math.floor((totalAjustado / qt) * 100) / 100; // trunc 2 casas
        let soma = 0;
        const tbody = $('#tblParcelas tbody').empty();

        for (let i=1; i<=qt; i++){
            let valor = (i < qt) ? baseParcela : (Math.round((totalAjustado - soma)*100)/100);
            soma = Math.round((soma + valor)*100)/100;

            const doc = `${docBase}-${pad2(i)}`;
            const emiss = emissao || '';
            const venc  = addMonths(vencInicial, i-1);

            tbody.append(`
        <tr>
          <td>${i}/${qt}</td>
          <td><input type="text" class="form-control docParcela" value="${doc}"></td>
          <td><input type="date" class="form-control emissaoParcela" value="${emiss}"></td>
          <td><input type="date" class="form-control vencParcela" value="${venc}"></td>
          <td><input type="number" step="0.01" class="form-control valorParcela" value="${valor.toFixed(2)}"></td>
        </tr>
      `);
        }

        $('#totalParcelas').text(toBRL(soma));
        const dif = Math.abs(soma - totalAjustado);
        $('#avisoParcelas').toggle(dif > 0.009);
    }

    function atualizarTotalParcelas(){
        let soma = 0;
        $('#tblParcelas tbody tr').each(function(){
            const v = parseFloat($(this).find('.valorParcela').val() || 0);
            soma += v;
        });

        const valor_total  = parseFloat($('#valor_total').val() || 0);
        const desconto     = parseFloat($('#desconto').val() || 0);
        const acrescimo    = parseFloat($('#acrescimo').val() || 0);
        const totalAjustado = (valor_total - desconto + acrescimo);

        $('#totalParcelas').text(toBRL(soma));
        $('#avisoParcelas').toggle(Math.abs(soma - totalAjustado) > 0.009);
    }

    // ======= Salvar =======
    async function salvar(){
        const fornecedor_id  = $('#fornecedor').val();
        const documentoBase  = ($('#doc').val() || '').trim();
        const emissao        = $('#emissao').val();
        const vencimento     = $('#vencimento').val();
        const plano_contas   = $('#plano_contas').val();
        const obs_extra      = $('#obs_extra').val();

        const valor_total    = parseFloat($('#valor_total').val() || 0);
        const desconto       = parseFloat($('#desconto').val() || 0);
        const acrescimo      = parseFloat($('#acrescimo').val() || 0);

        if (!contaLoaded) {
            return Swal.fire('Atenção','Conta não carregada.','warning');
        }
        if (!fornecedor_id || !documentoBase || !vencimento || !valor_total) {
            return Swal.fire('Atenção','Preencha Fornecedor, Documento, Vencimento e Valor.','warning');
        }

        const parcelar = $('#chkParcelar').is(':checked');

        if (!parcelar) {
            const forma_pagamento_id = $('#forma_pagamento_id').val();
            if (!forma_pagamento_id) return Swal.fire('Atenção','Selecione a forma de pagamento.','warning');

            // === Edita a conta (única) ===
            Swal.fire({ title:'Salvando...', didOpen:()=>Swal.showLoading() });
            try{
                const payload = {
                    method: 'editConta',
                    token,
                    data: {
                        id: Number(contaLoaded.id),
                        usuario_id: user_id || null,
                        entidade: Number(fornecedor_id),
                        doc: documentoBase,
                        emissao: emissao || null,
                        vencimento: vencimento,
                        valor: valor_total,
                        adic: acrescimo,
                        plano_contas: plano_contas || null,
                        obs: obs_extra || null
                    }
                };

                if (forma_pagamento_id) {
                    // usamos o código do banco como forma_pagamento e banco
                    payload.data.forma_pagamento = Number(forma_pagamento_id);
                    payload.data.banco = Number(forma_pagamento_id);
                }

                const res = await axios.post(baseUrl, payload);
                Swal.close();

                if (res.data && res.data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sucesso',
                        text: 'Conta atualizada com sucesso.'
                    }).then(() => {
                        fecharModalParent();
                        if (window.parent) {
                            if (typeof window.parent.buscar === 'function') window.parent.buscar();
                            if (typeof window.parent.recarregarContas === 'function') window.parent.recarregarContas();
                        }
                    });

                    // fallback: fecha mesmo se o usuário não clicar no Swal
                    setTimeout(() => fecharModalParent(), 1200);
                } else {
                    Swal.fire('Erro', res.data?.message || 'Falha ao atualizar conta.','error');
                }

            } catch(e){
                console.error(e);
                Swal.close();
                Swal.fire('Erro','Falha na comunicação com o servidor.','error');
            }

        } else {
            // === Parcelar: 1) editConta como parcela 1; 2) createContaLote demais parcelas ===
            // Monta linhas de parcelas a partir da tabela
            const linhas = [];
            $('#tblParcelas tbody tr').each(function(){
                const doc  = ($(this).find('.docParcela').val() || '').trim();
                const em   = $(this).find('.emissaoParcela').val() || null;
                const ven  = $(this).find('.vencParcela').val();
                const val  = parseFloat($(this).find('.valorParcela').val() || 0);
                if (doc && ven && val > 0) {
                    linhas.push({ doc, emissao: em, vencimento: ven, valor: val });
                }
            });

            if (!linhas.length) {
                return Swal.fire('Atenção','Gere/edite as parcelas antes de salvar.','warning');
            }

            // Validação de soma
            const totalAjustado = (valor_total - desconto + acrescimo);
            const somaParcelas = linhas.reduce((acc, p)=> acc + Number(p.valor||0), 0);
            if (Math.abs(somaParcelas - totalAjustado) > 0.009) {
                return Swal.fire('Atenção','A soma das parcelas difere do total ajustado.','warning');
            }

            const p1 = linhas[0];
            const restantes = linhas.slice(1);

            Swal.fire({ title:'Salvando...', didOpen:()=>Swal.showLoading() });

            try{
                // 1) Atualiza a conta atual como 1ª parcela (zera adic/desconto pra não duplicar)
                const res1 = await axios.post(baseUrl, {
                    method: 'editConta',
                    token,
                    data: {
                        id: Number(contaLoaded.id),
                        usuario_id: user_id || null,
                        entidade: Number(fornecedor_id),
                        doc: p1.doc,
                        emissao: p1.emissao || null,
                        vencimento: p1.vencimento,
                        valor: p1.valor,
                        adic: 0,
                        // desconto: 0, // se existir no backend
                        plano_contas: plano_contas || null,
                        obs: obs_extra || null
                    }
                });

                if (!res1.data || !res1.data.success) {
                    Swal.close();
                    return Swal.fire('Erro', res1.data?.message || 'Falha ao atualizar a 1ª parcela.','error');
                }

                // 2) Cria as demais parcelas em lote
                if (restantes.length) {
                    const forma_pagamento_id = $('#forma_pagamento_id').val();
                    if (!forma_pagamento_id) {
                        Swal.close();
                        return Swal.fire('Atenção','Selecione a forma de pagamento para as parcelas.','warning');
                    }

                    const contas = restantes.map(p => ({
                        fornecedor_id: Number(fornecedor_id),
                        documento: p.doc,
                        emissao: p.emissao || null,
                        vencimento: p.vencimento,
                        valor: p.valor,
                        adicional: 0,
                        desconto: 0,
                        plano_contas: plano_contas || null,
                        // enviamos o código do banco para ambos
                        forma_pagamento: Number(forma_pagamento_id),
                        banco: Number(forma_pagamento_id),
                        obs_extra
                    }));

                    const res2 = await axios.post(baseUrl, {
                        method: 'createContaLote',
                        token,
                        data: {
                            system_unit_id: Number(unit_id),
                            usuario_id: user_id || null,
                            contas
                        }
                    });

                    if (!res2.data || !res2.data.success) {
                        Swal.close();
                        return Swal.fire('Atenção', res2.data?.message || 'Falha ao criar parcelas subsequentes.','warning');
                    }
                }

                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso',
                    text: `Parcelas salvas com sucesso.`
                }).then(() => {
                    fecharModalParent();
                    if (window.parent) {
                        if (typeof window.parent.buscar === 'function') window.parent.buscar();
                        if (typeof window.parent.recarregarContas === 'function') window.parent.recarregarContas();
                    }
                });

            } catch(e){
                console.error(e);
                Swal.close();
                Swal.fire('Erro','Falha na comunicação com o servidor.','error');
            }
        }
    }

    function fecharModalParent() {
        const $p = (window.parent && window.parent.$) ? window.parent.$ : null;
        if (!$p) return;
        const ids = ['#modalEditConta', '#modalImportacao', '#modalFinanceiro'];
        let fechou = false;
        for (const sel of ids) {
            if ($p(sel).length) { $p(sel).modal('hide'); fechou = true; }
        }
        if (!fechou) { $p('.modal.in, .modal.show').modal('hide'); }
    }

    (function enableEscClose(){
        // dá foco no body do iframe pra capturar teclas
        if (!document.body.hasAttribute('tabindex')) document.body.setAttribute('tabindex','-1');
        document.body.focus();

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' || e.keyCode === 27) {
                e.preventDefault();
                fecharModalParent();
            }
        });
    })();
</script>
</body>
</html>
