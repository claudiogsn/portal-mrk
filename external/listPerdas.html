<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Perdas de Estoque</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .form-control { margin-bottom: 10px; }
        .label-xs { font-size: 11px; padding: 3px 6px; border-radius: 3px; }
        .table thead th { white-space: nowrap; }
        .nowrap { white-space: nowrap; }
        .muted { color: #777; }
        .text-small { font-size: 12px; }

        .badge-green { background: #2e7d32; }
        .badge-red   { background: #c62828; }
        .badge-gray  { background: #757575; }

        @media (max-width: 768px) {
            body, .form-control, .modal-content, table, th, td, button {
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>

    <div class="card">
        <div class="header">
            <h2>Relatório de Perdas de Estoque</h2>
        </div>

        <!-- Filtros -->
        <div class="row" style="margin: 15px 0;">
            <div class="col-md-3">
                <label class="muted">Data inicial</label>
                <input type="date" id="dtInicio" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="muted">Data final</label>
                <input type="date" id="dtFim" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="muted">Filtro de produto</label>
                <input type="text" id="filtroProduto" class="form-control"
                       placeholder="Código ou parte do nome">
            </div>
            <div class="col-md-3">
                <label class="muted">Ações</label><br>
                <button id="btnConsultar" class="btn btn-primary">
                    <i class="fa fa-search"></i> Consultar
                </button>
            </div>
        </div>

        <div class="row" style="margin: 5px 0 15px;">
            <div class="col-md-6">
                <span id="msgUnidade" class="text-small muted"></span>
            </div>
            <div class="col-md-6 text-right">
                <span id="msgResumo" class="text-small muted"></span>
            </div>
        </div>

        <!-- Tabela -->
        <div class="body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabela-perdas">
                    <thead>
                    <tr>
                        <th>Data</th>
                        <th>Documento</th>
                        <th>Cód. Produto</th>
                        <th>Produto</th>
                        <th>Unidade</th>
                        <th class="text-right">Quantidade</th>
                        <th class="text-right">Custo Unitário (R$)</th>
                        <th class="text-right">Valor da Perda (R$)</th>
                        <th>Usuário</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="resumoTotais" class="text-right muted text-small" style="margin-top:5px;"></div>
        </div>
    </div>
</div>

<script>
    // ====== CONFIG ======
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams       = new URLSearchParams(window.location.search);
    const token           = urlParams.get('token');
    const system_unit_id  = urlParams.get('system_unit_id');
    const unit_name       = urlParams.get('unit_name');

    // ====== STATE ======
    let ultimoResultado = []; // dados crus vindos do backend
    let listaFiltrada   = []; // após filtro por produto

    // ====== UTILS ======
    function brNumber(v) {
        if (v === null || v === undefined || isNaN(v)) return '-';
        return Number(v).toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function brMoney(v) {
        if (v === null || v === undefined || isNaN(v)) return '-';
        return Number(v).toLocaleString('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        });
    }

    function formatDateBR(iso) {
        if (!iso) return '';
        const d = String(iso).slice(0,10).split('-'); // YYYY-MM-DD
        if (d.length !== 3) return '';
        return d[2] + '/' + d[1] + '/' + d[0];
    }

    function escapeHtml(s) {
        if (s == null) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function normalizarString(s) {
        if (!s) return '';
        return String(s)
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
    }

    // ====== INIT ======
    $(document).ready(function () {
        // coloca hoje como dtFim e hoje -7 dias como dtInicio
        const hoje = new Date();
        const y  = hoje.getFullYear();
        const m  = String(hoje.getMonth() + 1).padStart(2, '0');
        const d  = String(hoje.getDate()).padStart(2, '0');
        const hojeStr = `${y}-${m}-${d}`;

        const seteDiasAtras = new Date(hoje.getTime() - 7*24*60*60*1000);
        const y2 = seteDiasAtras.getFullYear();
        const m2 = String(seteDiasAtras.getMonth() + 1).padStart(2, '0');
        const d2 = String(seteDiasAtras.getDate()).padStart(2, '0');
        const inicioStr = `${y2}-${m2}-${d2}`;

        $('#dtInicio').val(inicioStr);
        $('#dtFim').val(hojeStr);

        if (unit_name) {
            $('#msgUnidade').text(`Unidade: ${unit_name} (ID ${system_unit_id})`);
        }

        $('#btnConsultar').on('click', onConsultar);
        $('#filtroProduto').on('input', aplicarFiltroProduto);
    });

    // ====== CONSULTA ======
    async function onConsultar() {
        const data_inicial = $('#dtInicio').val();
        const data_final   = $('#dtFim').val();

        if (!token || !system_unit_id) {
            return Swal.fire('Atenção', 'URL deve conter token e system_unit_id.', 'warning');
        }
        if (!data_inicial || !data_final) {
            return Swal.fire('Atenção', 'Informe data inicial e data final.', 'warning');
        }

        Swal.fire({
            title: 'Consultando perdas...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'getRelatorioPerdas', // ajuste se o nome no backend for outro
                token: token,
                data: {
                    system_unit_id: Number(system_unit_id),
                    data_inicial: data_inicial,
                    data_final: data_final
                }
            });

            Swal.close();

            if (!res.data || res.data.success === false) {
                const msg = res.data && res.data.message ? res.data.message : 'Erro ao consultar perdas.';
                $('#msgResumo').text('');
                renderTabela([]);
                return Swal.fire('Erro', msg, 'error');
            }

            const lista = Array.isArray(res.data.data) ? res.data.data : [];
            ultimoResultado = lista;
            $('#msgResumo').text(`Período de ${formatDateBR(data_inicial)} até ${formatDateBR(data_final)} · Registros: ${lista.length}`);

            aplicarFiltroProduto(); // atualiza tabela com/sem filtro
        } catch (e) {
            Swal.close();
            console.error(e);
            Swal.fire('Erro', 'Não foi possível consultar os dados.', 'error');
        }
    }

    // ====== FILTRO POR PRODUTO ======
    function aplicarFiltroProduto() {
        const termo = normalizarString($('#filtroProduto').val());

        if (!termo) {
            listaFiltrada = ultimoResultado.slice();
        } else {
            listaFiltrada = ultimoResultado.filter(item => {
                const cod = String(item.codigo_produto || item.produto || '').toLowerCase();
                const nome = normalizarString(item.nome_produto || '');
                return cod.indexOf(termo) !== -1 || nome.indexOf(termo) !== -1;
            });
        }

        renderTabela(listaFiltrada);
    }

    // ====== RENDER TABELA ======
    function renderTabela(itens) {
        const $tbody = $('#tabela-perdas tbody');
        $tbody.empty();

        if (!itens || !itens.length) {
            $tbody.append('<tr><td colspan="9" class="text-center">Nenhuma perda encontrada no período.</td></tr>');
            $('#resumoTotais').html('');
            return;
        }

        let totalQtd  = 0;
        let totalVal  = 0;

        itens.forEach(row => {
            // custo unitário: usa preco_custo; se não tiver, tenta valor/quantidade
            let custoUnit = null;

            if (row.preco_custo != null) {
                custoUnit = Number(row.preco_custo);
            } else if (row.valor != null && row.quantidade) {
                custoUnit = Number(row.valor) / Number(row.quantidade);
            }

            const qtd   = Number(row.quantidade || 0);
            const valPerda = (custoUnit != null ? (custoUnit * qtd) : null);

            totalQtd += qtd;
            if (valPerda != null) totalVal += valPerda;

            const tr = `
                <tr>
                    <td>${formatDateBR(row.data)}</td>
                    <td>${escapeHtml(row.doc)}</td>
                    <td>${escapeHtml(row.codigo_produto || row.produto)}</td>
                    <td>${escapeHtml(row.nome_produto)}</td>
                    <td>${escapeHtml(row.unidade || '')}</td>
                    <td class="text-right">${brNumber(qtd)}</td>
                    <td class="text-right">${custoUnit != null ? brMoney(custoUnit) : '-'}</td>
                    <td class="text-right">${valPerda != null ? brMoney(valPerda) : '-'}</td>
                    <td>${escapeHtml(row.usuario_id || '')}</td>
                </tr>
            `;
            $tbody.append(tr);
        });

        $('#resumoTotais').html(`
            Totais &nbsp;|&nbsp;
            Quantidade perdida: <b>${brNumber(totalQtd)}</b> &nbsp;·&nbsp;
            Valor total da perda: <b>${brMoney(totalVal)}</b>
        `);
    }
</script>
</body>
</html>
