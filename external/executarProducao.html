<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Produção</title>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        .form-control { height: 34px; }
        .select2-container .select2-selection--multiple { min-height: 34px; }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered { line-height: 22px; }
        .right { text-align: right; }
        .center { text-align: center; }
        .btn-mini { padding: 3px 8px; }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>

    <div class="card">
        <div class="header"><h2>Produção</h2></div>

        <div class="body">
            <div class="row">
                <div class="col-md-2">
                    <label>Data</label>
                    <input type="date" id="dateProducao" class="form-control">
                </div>

                <div class="col-md-8">
                    <label>Produtos</label>
                    <select id="produtoSelect" class="form-control" multiple style="width:100%;">
                        <option value="">Carregando...</option>
                    </select>
                    <small class="text-muted">Selecione vários e clique em “Adicionar”.</small>
                </div>

                <div class="col-md-2" style="padding-top:25px;">
                    <button type="button" id="btnAdd" class="btn btn-info waves-effect" style="width:100%;">Adicionar</button>
                </div>
            </div>

            <hr>

            <table class="table table-striped table-hover" id="tabelaProdutos">
                <thead>
                <tr>
                    <th style="width:90px;">Código</th>
                    <th>Produto</th>
                    <th style="width:80px;">Unid</th>
                    <th style="width:200px;" class="right">Qtd Produzida</th>
                    <th style="width:70px;" class="center">Ação</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="5" class="text-center text-muted">Adicione produtos para produzir</td></tr>
                </tbody>
            </table>

            <center style="margin-top: 15px;">
                <button type="button" id="btnSalvar" class="btn btn-success waves-effect">Executar Produção</button>
            </center>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const qs = new URLSearchParams(window.location.search);
    const token = qs.get('token');
    const system_unit_id = parseInt(qs.get('system_unit_id') || qs.get('unit_id') || qs.get('unit') || '0', 10);
    const userId = parseInt(qs.get('user_id') || qs.get('user') || qs.get('username') || '0', 10);

    let producoes = [];        // vindo do listProducoes (já com unidade do produto e insumos)
    let linhas = [];           // [{ codigo, nome, unidade, quantidade_str }]

    function escapeHtml(str) {
        return (str || '').toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function loading(title) {
        Swal.fire({
            title: title || 'Carregando...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false
        });
    }

    function setDateToday() {
        const input = document.getElementById('dateProducao');
        const today = new Date().toISOString().split('T')[0];
        input.setAttribute('max', today);
        input.value = today;
    }

    function parseBRNumber(v) {
        if (v === null || v === undefined) return 0;
        let s = v.toString().trim();
        if (!s) return 0;

        s = s.replace(/\s/g, '');
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.');
        else if (s.includes(',')) s = s.replace(',', '.');

        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function formatBR(n, dec=3) {
        const v = (typeof n === 'number') ? n : parseBRNumber(n);
        let s = v.toFixed(dec);
        s = s.replace('.', ',');
        return s;
    }

    function renderGrid() {
        const tbody = $('#tabelaProdutos tbody');
        tbody.empty();

        if (!linhas.length) {
            tbody.append(`<tr><td colspan="5" class="text-center text-muted">Adicione produtos para produzir</td></tr>`);
            return;
        }

        linhas.forEach((r, idx) => {
            tbody.append(`
        <tr data-idx="${idx}">
          <td>${escapeHtml(r.codigo)}</td>
          <td>${escapeHtml(r.nome)}</td>
          <td>${escapeHtml(r.unidade || '-')}</td>
          <td class="right">
            <input type="text"
                   class="form-control qtdInput"
                   data-unidade="${escapeHtml(r.unidade || '')}"
                   value="${escapeHtml(r.quantidade_str || '')}"
                   style="text-align:right;">
          </td>
          <td class="center">
            <button type="button" class="btn btn-danger btn-mini btnRemover">X</button>
          </td>
        </tr>
      `);
        });

        bindGridEvents();
    }

    function maskValueByUnidade(rawDigits, unidade) {
        const u = (unidade || '').toUpperCase().trim();
        const inteiro = (u === 'UN' || u === 'UND');

        if (inteiro) {
            return (rawDigits || '').replace(/\D/g, '');
        } else {
            let v = (rawDigits || '').replace(/\D/g, '');
            v = (parseInt(v || '0', 10) / 1000).toFixed(3);
            return v.replace('.', ',');
        }
    }

    function bindGridEvents() {
        // remove
        $('.btnRemover').off('click').on('click', function() {
            const idx = parseInt($(this).closest('tr').attr('data-idx'), 10);
            linhas.splice(idx, 1);
            renderGrid();
        });

        // digitação quantidade (máscara por unidade do produto)
        $('.qtdInput').off('input').on('input', function() {
            const $tr = $(this).closest('tr');
            const idx = parseInt($tr.attr('data-idx'), 10);
            const unidade = $(this).data('unidade');

            const masked = maskValueByUnidade($(this).val(), unidade);
            $(this).val(masked);

            linhas[idx].quantidade_str = masked;
        });
    }

    async function loadProducoes() {
        if (!token) return Swal.fire('Erro', 'Token não informado na URL.', 'error');
        if (!system_unit_id) return Swal.fire('Erro', 'Unidade não informada na URL.', 'error');
        if (!userId) return Swal.fire('Erro', 'Usuário não informado na URL.', 'error');

        loading('Carregando...');
        try {
            const { data } = await axios.post(baseUrl, {
                method: 'listProducoes',
                token,
                data: { unit_id: String(system_unit_id) }
            });

            Swal.close();

            if (!data?.success) {
                Swal.fire('Erro', data?.message || 'Falha ao carregar.', 'error');
                return;
            }

            producoes = data.producoes || [];

            const sel = $('#produtoSelect');
            sel.empty();

            producoes.forEach(p => {
                const txt = `${p.produto} - ${p.nome} (${p.unidade || '-'})`;
                sel.append(new Option(txt, p.produto));
            });

            sel.select2({
                width: '100%',
                placeholder: 'Selecione vários produtos',
                allowClear: true
            });

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao carregar produtos.', 'error');
        }
    }

    function addSelecionadosAoGrid() {
        const values = ($('#produtoSelect').val() || []).map(v => parseInt(v, 10)).filter(Boolean);
        if (!values.length) {
            Swal.fire('Atenção', 'Selecione pelo menos 1 produto.', 'warning');
            return;
        }

        values.forEach(cod => {
            const p = producoes.find(x => parseInt(x.produto, 10) === cod);
            if (!p) return;

            const jaTem = linhas.some(l => parseInt(l.codigo, 10) === cod);
            if (jaTem) return;

            linhas.push({
                codigo: cod,
                nome: p.nome || '',
                unidade: p.unidade || '',
                quantidade_str: ''
            });
        });

        $('#produtoSelect').val(null).trigger('change');

        renderGrid();
    }

    async function salvarMassa() {
        if (!linhas.length) {
            return Swal.fire('Erro', 'Adicione pelo menos 1 produto no grid.', 'error');
        }

        const date_producao = $('#dateProducao').val();

        const items = [];
        for (const l of linhas) {
            const qtd = parseBRNumber(l.quantidade_str);
            if (!qtd || qtd <= 0) {
                return Swal.fire('Erro', `Informe a quantidade do produto ${l.codigo} - ${l.nome}`, 'error');
            }
            items.push({
                product_codigo: l.codigo,
                quantidade_produzida: l.quantidade_str
            });
        }

        const htmlResumo = `
      <div style="text-align:left">
        <div><b>Total de produtos:</b> ${items.length}</div>
        <div style="max-height:260px; overflow:auto; margin-top:10px; border:1px solid #eee; border-radius:6px;">
          <table class="table table-striped" style="margin:0">
            <thead><tr><th>Produto</th><th class="right">Qtd</th></tr></thead>
            <tbody>
              ${linhas.map(l => `
                <tr>
                  <td>${escapeHtml(l.codigo)} - ${escapeHtml(l.nome)}</td>
                  <td class="right"><b>${escapeHtml(l.quantidade_str)}</b> ${escapeHtml(l.unidade || '')}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top:8px" class="text-muted">Será gerado <b>1 único documento</b>.</div>
      </div>
    `;

        const ok = await Swal.fire({
            title: 'Confirmar Produção?',
            html: htmlResumo,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar',
            width: 850
        });

        if (!ok.isConfirmed) return;

        loading('Executando...');

        try {
            const { data } = await axios.post(baseUrl, {
                method: 'executeProductionBatch',
                token,
                data: {
                    system_unit_id,
                    user: userId,
                    date_producao,
                    allow_negative: true,
                    items
                }
            });

            Swal.close();

            if (!data?.success) {
                Swal.fire('Erro', data?.message || 'Falha ao executar.', 'error');
                return;
            }

            localStorage.setItem('producaoPdfData', JSON.stringify(data));

            const doc = data?.doc || '-';

            await Swal.fire({
                title: 'Produção executada!',
                html: `Documento: <b>${doc}</b><br/>${escapeHtml(data?.message || '')}`,
                icon: 'success',
                confirmButtonText: 'OK'
            });

            window.open(`./reports/producao.html`, '_blank');

            linhas = [];
            renderGrid();

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao executar produção.', 'error');
        }
    }

    $('#btnAdd').on('click', addSelecionadosAoGrid);
    $('#btnSalvar').on('click', salvarMassa);

    setDateToday();
    loadProducoes();
    renderGrid();
</script>
</body>
</html>
