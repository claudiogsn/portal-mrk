<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lançamento de Produção</title>

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* Ajustes Específicos da Tela */
        body { background-color: #F4F7F6; }

        .form-control { height: 34px; font-family: 'Poppins', sans-serif; }

        /* Select2 */
        .select2-container .select2-selection--multiple {
            min-height: 34px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            line-height: 22px;
            font-family: 'Poppins', sans-serif;
            padding: 2px 5px;
        }
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: var(--mrk-blue) !important;
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(11, 70, 172, 0.4);
        }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
        }

        .right { text-align: right; }
        .center { text-align: center; }

        /* Botão Remover */
        .btn-mini {
            padding: 4px 8px;
            line-height: 1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="block-header">
        <h2> </h2>
        <br>
    </div>

    <div class="card">
        <div class="header">
            <h2>
                <iconify-icon icon="icon-park-outline:workbench" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                LANÇAMENTO DE PRODUÇÃO
            </h2>
        </div>

        <div class="body">
            <form id="formProducao">
                <div class="row">
                    <div class="col-md-2">
                        <label style="font-family: 'Kanit', sans-serif;">Data de Produção</label>
                        <input type="date" id="dateProducao" class="form-control">
                    </div>

                    <div class="col-md-8">
                        <label style="font-family: 'Kanit', sans-serif;">Selecione os Produtos</label>
                        <select id="produtoSelect" class="form-control" multiple style="width:100%;">
                        </select>
                        <small class="text-muted" style="font-size: 11px;"><iconify-icon icon="icon-park-outline:info" style="vertical-align: middle;"></iconify-icon> Selecione um ou mais itens e clique em "Adicionar".</small>
                    </div>

                    <div class="col-md-2" style="padding-top:25px;">
                        <button type="button" id="btnAdd" class="btn btn-primary waves-effect" style="width:100%; background-color: var(--mrk-blue) !important;">
                            <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            ADICIONAR
                        </button>
                    </div>
                </div>
            </form>

            <hr style="margin: 20px 0; border-top: 1px dashed #ddd;">

            <div class="table-responsive">
                <table class="table table-hover" id="tabelaProdutos">
                    <thead>
                    <tr>
                        <th style="width:10%;">Cód.</th>
                        <th style="width:50%;">Produto</th>
                        <th style="width:10%;">Unid.</th>
                        <th style="width:20%;" class="center">Qtd. Produzida</th>
                        <th style="width:10%;" class="center">Ação</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="5" class="text-center text-muted" style="padding: 20px;">Nenhum produto adicionado para produção.</td></tr>
                    </tbody>
                </table>
            </div>

            <center style="margin-top: 30px; margin-bottom: 10px;">
                <button type="button" id="btnSalvar" class="btn btn-success waves-effect" style="background-color: var(--mrk-green) !important; padding: 10px 40px; font-size: 14px;">
                    <iconify-icon icon="icon-park-outline:check-one" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                    EXECUTAR PRODUÇÃO
                </button>
            </center>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const qs = new URLSearchParams(window.location.search);
    const token = qs.get('token');
    const system_unit_id = parseInt(qs.get('system_unit_id') || qs.get('unit_id') || qs.get('unit') || '0', 10);
    const userId = parseInt(qs.get('user_id') || qs.get('user') || qs.get('username') || '0', 10);

    let producoes = [];
    let linhas = [];

    function escapeHtml(str) {
        return (str || '').toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function loading(title) {
        Swal.fire({
            title: title || 'Carregando...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false,
            confirmButtonColor: '#0B46AC'
        });
    }

    function setDateToday() {
        const input = document.getElementById('dateProducao');
        const today = new Date().toISOString().split('T')[0];
        input.setAttribute('max', today);
        input.value = today;
    }

    // Função auxiliar para pegar o valor numérico limpo
    function parseBRNumber(v) {
        if (v === null || v === undefined) return 0;
        let s = v.toString().trim();
        if (!s) return 0;
        s = s.replace(/\s/g, '');
        // Se tiver ponto e vírgula, assume ponto milhar e vírgula decimal
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.');
        else if (s.includes(',')) s = s.replace(',', '.');

        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function renderGrid() {
        const tbody = $('#tabelaProdutos tbody');
        tbody.empty();

        if (!linhas.length) {
            tbody.append(`<tr><td colspan="5" class="text-center text-muted" style="padding: 20px;">Nenhum produto adicionado para produção.</td></tr>`);
            return;
        }

        linhas.forEach((r, idx) => {
            tbody.append(`
        <tr data-idx="${idx}">
          <td style="vertical-align: middle;"><b>${escapeHtml(r.codigo)}</b></td>
          <td style="vertical-align: middle;">${escapeHtml(r.nome)}</td>
          <td style="vertical-align: middle;">${escapeHtml(r.unidade || '-')}</td>
          <td class="right">
            <input type="text"
                   class="form-control qtdInput quantidade"
                   data-unidade="${escapeHtml(r.unidade || '')}"
                   value="${escapeHtml(r.quantidade_str || '')}"
                   placeholder="0"
                   style="text-align:right; font-weight: 500; color: var(--mrk-blue);">
          </td>
          <td class="center" style="vertical-align: middle;">
            <button type="button" class="btn btn-danger btn-mini btnRemover" style="background-color: #ffebee !important; color: #d32f2f !important; border: 1px solid #ffcdd2;">
                <iconify-icon icon="icon-park-outline:delete" width="16"></iconify-icon>
            </button>
          </td>
        </tr>
      `);
        });

        // Aplica os eventos e a máscara que você solicitou
        bindGridEvents();
    }

    function bindGridEvents() {
        // Remover linha
        $('.btnRemover').off('click').on('click', function() {
            const idx = parseInt($(this).closest('tr').attr('data-idx'), 10);
            linhas.splice(idx, 1);
            renderGrid();
        });

        // ============================================================
        //  AQUI ESTÁ A MÁSCARA SOLICITADA (INTEGRADA NO bindGridEvents)
        // ============================================================
        $('.qtdInput').off('input').on('input', function() {
            const $this = $(this);
            const unidade = ($this.data('unidade') || '').trim().toUpperCase();

            // Remove tudo que não for número
            let v = $this.val().replace(/\D/g, '');

            // 1. Unidades Fracionadas (KG, LT, etc) - 3 casas decimais
            // Limite: 5 dígitos inteiros + 3 decimais = 8 dígitos numéricos totais
            if (['KG', 'LT', 'L', 'M', 'M2', 'M3'].includes(unidade)) {
                if (v === '') {
                    $this.val('');
                } else {
                    // Limita a 8 dígitos no total (corresponde a 99999,999)
                    if (v.length > 8) {
                        v = v.substring(0, 8);
                    }
                    // Converte para decimal (divide por 1000) e fixa 3 casas
                    let valorDecimal = (parseInt(v, 10) / 1000).toFixed(3);

                    // Troca ponto por vírgula para exibição BR
                    $this.val(valorDecimal.replace('.', ','));
                }
            }
            // 2. Unidades Inteiras (UN, CX, etc)
            else {
                // Limita a 5 dígitos
                if (v.length > 5) {
                    v = v.substring(0, 5);
                }
                $this.val(v);
            }

            // Atualiza o array de dados (estado)
            const idx = parseInt($this.closest('tr').attr('data-idx'), 10);
            if (linhas[idx]) {
                linhas[idx].quantidade_str = $this.val();
            }
        });

        // Navegação com TAB
        $('.qtdInput').off('keydown').on('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const inputs = $('.qtdInput');
                const idxAtual = inputs.index(this);
                if (idxAtual >= 0 && idxAtual < inputs.length - 1) {
                    const $next = inputs.eq(idxAtual + 1);
                    $next.focus().select(); // Foca e seleciona tudo para facilitar digitação
                } else {
                    $('#btnSalvar').focus();
                }
            }
        });
    }

    async function loadProducoes() {
        if (!token) return Swal.fire('Erro', 'Token não informado na URL.', 'error');
        if (!system_unit_id) return Swal.fire('Erro', 'Unidade não informada na URL.', 'error');

        loading('Carregando Itens...');
        try {
            const { data } = await axios.post(baseUrl, {
                method: 'listProducoes',
                token,
                data: { unit_id: String(system_unit_id) }
            });

            Swal.close();

            if (!data?.success) {
                Swal.fire('Erro', data?.message || 'Falha ao carregar.', 'error');
                return;
            }

            producoes = data.producoes || [];
            const sel = $('#produtoSelect');
            sel.empty();

            producoes.forEach(p => {
                const txt = `${p.produto} - ${p.nome} (${p.unidade || '-'})`;
                sel.append(new Option(txt, p.produto));
            });

            sel.select2({
                width: '100%',
                placeholder: 'Pesquise por nome ou código...',
                allowClear: true
            });

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao carregar produtos.', 'error');
        }
    }

    function addSelecionadosAoGrid() {
        const values = ($('#produtoSelect').val() || []).map(v => parseInt(v, 10)).filter(Boolean);
        if (!values.length) {
            Swal.fire({
                title: 'Atenção',
                text: 'Selecione pelo menos 1 produto para adicionar.',
                icon: 'warning',
                confirmButtonColor: '#0B46AC'
            });
            return;
        }

        values.forEach(cod => {
            const p = producoes.find(x => parseInt(x.produto, 10) === cod);
            if (!p) return;
            const jaTem = linhas.some(l => parseInt(l.codigo, 10) === cod);
            if (jaTem) return;

            linhas.push({
                codigo: cod,
                nome: p.nome || '',
                unidade: p.unidade || '',
                quantidade_str: ''
            });
        });

        $('#produtoSelect').val(null).trigger('change');
        renderGrid();
    }

    async function salvarMassa() {
        if (!linhas.length) {
            return Swal.fire('Erro', 'Adicione pelo menos 1 produto no grid.', 'error');
        }

        const date_producao = $('#dateProducao').val();
        const items = [];

        for (const l of linhas) {
            const qtd = parseBRNumber(l.quantidade_str);
            if (!qtd || qtd <= 0) {
                return Swal.fire('Atenção', `Informe a quantidade válida para: ${l.nome}`, 'warning');
            }
            items.push({
                product_codigo: l.codigo,
                quantidade_produzida: l.quantidade_str
            });
        }

        const htmlResumo = `
            <div style="text-align:left; font-family: 'Poppins', sans-serif;">
                <p>Confirma a produção de <b>${items.length} itens</b> para o dia <b>${date_producao.split('-').reverse().join('/')}</b>?</p>
                <div style="max-height:200px; overflow:auto; margin-top:10px; border:1px solid #eee; border-radius:6px;">
                <table class="table table-striped" style="margin:0; font-size: 12px;">
                    <thead><tr><th>Produto</th><th class="right">Qtd</th></tr></thead>
                    <tbody>
                    ${linhas.map(l => `
                        <tr>
                        <td>${escapeHtml(l.nome)}</td>
                        <td class="right"><b>${escapeHtml(l.quantidade_str)}</b> ${escapeHtml(l.unidade || '')}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                </div>
            </div>
        `;

        const ok = await Swal.fire({
            title: 'Confirmar Produção?',
            html: htmlResumo,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#08A794', // Verde MRK
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, Produzir',
            cancelButtonText: 'Cancelar',
            width: 600
        });

        if (!ok.isConfirmed) return;

        loading('Executando Baixa de Estoque...');

        try {
            const { data } = await axios.post(baseUrl, {
                method: 'executeProductionBatch',
                token,
                data: {
                    system_unit_id,
                    user: userId,
                    date_producao,
                    allow_negative: true,
                    items
                }
            });

            Swal.close();

            if (!data?.success) {
                Swal.fire('Erro', data?.message || 'Falha ao executar.', 'error');
                return;
            }

            await Swal.fire({
                title: 'Sucesso!',
                html: `Produção realizada.<br>Documento gerado: <b>${data?.doc || '-'}</b>`,
                icon: 'success',
                confirmButtonColor: '#0B46AC'
            });

            linhas = [];
            renderGrid();

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao executar produção.', 'error');
        }
    }

    // Bindings
    $('#btnAdd').on('click', addSelecionadosAoGrid);
    $('#btnSalvar').on('click', salvarMassa);

    // Init
    setDateToday();
    loadProducoes();
    renderGrid();
</script>
</body>
</html>