<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Produção</title>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        .form-control {
            display: block;
            width: 100%;
            height: 34px;
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #555;
            background-color: #fff;
            background-image: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075);
            -webkit-transition: border-color ease-in-out .15s, -webkit-box-shadow ease-in-out .15s;
            -o-transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
            transition: border-color ease-in-out .15s, box-shadow ease-in-out .15s;
        }
        .form-control:focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, .6);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(102, 175, 233, .6);
        }

        .select2-container .select2-selection--single { height: 34px; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 34px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 34px; }

        /* Barra cinza */
        #produtoBar {
            display: none;
            background: #f2f2f2;
            border: 1px solid #e6e6e6;
            border-radius: 6px;
            padding: 10px 12px;
            margin-top: 10px;
        }
        #produtoBar .titulo { font-weight: 700; font-size: 14px; }
        #produtoBar .sub { color: #777; font-size: 12px; margin-top: 2px; }

        #produtoBar .linha {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        #produtoBar .colInfo { flex: 1; min-width: 260px; }
        #produtoBar .colQtd {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            min-width: 340px;
        }
        #produtoBar .colQtd input {
            width: 210px;
            text-align: right;
        }

        .right { text-align: right; }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">
    <br>

    <div class="card">
        <div class="header"><h2>Produção</h2></div>

        <div class="row" style="margin: 15px 0;">
            <div class="col-md-2">
                <label>Data</label>
                <input type="date" id="dateProducao" class="form-control">
            </div>

            <div class="col-md-10">
                <label>Produto</label>
                <select id="produtoSelect" class="form-control" style="width: 100%;">
                    <option value="">Carregando...</option>
                </select>

                <div id="produtoBar">
                    <div class="linha">
                        <div class="colInfo">
                            <div class="titulo" id="produtoNome">-</div>
                            <div class="sub">
                                Código: <span id="produtoCodigo">-</span>
                                &nbsp;&nbsp;|&nbsp;&nbsp;
                                Unidade: <span id="produtoUnidade">-</span>
                            </div>
                        </div>

                        <div class="colQtd">
                            <div style="font-weight:700;">Quantidade Produzida</div>
                            <input type="text" id="qtdProduzida" inputmode="decimal" class="form-control" placeholder="">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="body">
            <table class="table table-striped table-hover" id="tabelaInsumos">
                <thead>
                <tr>
                    <th style="width:90px">Código</th>
                    <th>Insumo</th>
                    <th style="width:90px">Unid</th>
                    <th style="width:140px">Consumo</th>
                    <th style="width:140px">Rendimento</th>
                    <th style="width:140px">Ficha</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="6" class="text-center text-muted">Selecione um produto</td></tr>
                </tbody>
            </table>

            <center style="margin-top: 15px;">
                <button type="button" id="btnSalvar" class="btn btn-success waves-effect">Salvar Produção</button>
            </center>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const qs = new URLSearchParams(window.location.search);
    const token = qs.get('token');
    const system_unit_id = parseInt(qs.get('system_unit_id') || qs.get('unit_id') || qs.get('unit') || '0', 10);
    const userId = parseInt(qs.get('user_id') || qs.get('user') || qs.get('username') || '0', 10);

    let producoes = [];
    let selected = null;
    let computedRows = [];

    function escapeHtml(str) {
        return (str || '').toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function parseBRNumber(v) {
        if (v === null || v === undefined) return 0;
        let s = v.toString().trim();
        if (!s) return 0;

        s = s.replace(/\s/g, '');
        if (s.includes(',') && s.includes('.')) {
            s = s.replace(/\./g, '').replace(',', '.');
        } else if (s.includes(',')) {
            s = s.replace(',', '.');
        }

        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function formatBR(n, dec=4) {
        const v = (typeof n === 'number') ? n : parseBRNumber(n);
        let s = v.toFixed(dec);
        s = s.replace(/\.?0+$/, (m) => m.startsWith('.') ? '' : m);
        s = s.replace('.', ',');
        return s;
    }

    function loading(title) {
        Swal.fire({
            title: title || 'Carregando...',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false
        });
    }

    function setDateToday() {
        const input = document.getElementById('dateProducao');
        const today = new Date().toISOString().split('T')[0];
        input.setAttribute('max', today);
        input.value = today;
    }

    function renderEmpty(msg) {
        const tbody = $('#tabelaInsumos tbody');
        tbody.empty();
        tbody.append(`<tr><td colspan="6" class="text-center text-muted">${escapeHtml(msg)}</td></tr>`);
        computedRows = [];
    }

    function computeConsumption(item, qtdProduzida) {
        const fichaQtd = parseBRNumber(item.quantity);
        const rend = parseBRNumber(item.rendimento);
        const rendimento = (rend && rend > 0) ? rend : 1;

        const consumo = fichaQtd * (qtdProduzida / rendimento);
        return {
            fichaQtd,
            rendimento,
            consumo: Math.round(consumo * 10000) / 10000
        };
    }

    function recalcGrid() {
        if (!selected) return;

        const qtd = parseBRNumber($('#qtdProduzida').val());
        const insumos = selected.insumos || [];

        computedRows = insumos.map(i => {
            const r = computeConsumption(i, qtd);
            return {
                codigo: i.insumo_id,
                nome: i.nome,
                unidade: i.unidade || '-',     // ✅ unidade do insumo (backend)
                ficha: r.fichaQtd,
                rend: r.rendimento,
                consumo: r.consumo
            };
        });

        const tbody = $('#tabelaInsumos tbody');
        tbody.empty();

        computedRows.forEach(r => {
            tbody.append(`
                <tr>
                    <td>${escapeHtml(r.codigo)}</td>
                    <td>${escapeHtml(r.nome)}</td>
                    <td>${escapeHtml(r.unidade)}</td>
                    <td><b>${escapeHtml(formatBR(r.consumo, 4))}</b></td>
                    <td>${escapeHtml(formatBR(r.rend, 4))}</td>
                    <td>${escapeHtml(formatBR(r.ficha, 4))}</td>
                </tr>
            `);
        });
    }

    // ✅ Regra do campo quantidade produzida baseado na unidade do PRODUTO
    function bindQtdMaskByProdutoUnidade(unidadeProduto) {
        const u = (unidadeProduto || '').toUpperCase().trim();
        const $inp = $('#qtdProduzida');

        $inp.off('input._mask');
        $inp.val('');

        const isUnidadeInteira = (u === 'UN' || u === 'UND');

        if (isUnidadeInteira) {
            $inp.on('input._mask', function () {
                $(this).val($(this).val().replace(/\D/g, ''));
                if (!selected) return;

                const qtd = parseBRNumber($(this).val());
                if (!qtd || qtd <= 0) {
                    renderEmpty('Digite a quantidade produzida');
                    computedRows = [];
                    return;
                }
                recalcGrid();
            });
        } else {
            // 3 casas decimais após vírgula (igual sua lógica)
            $inp.on('input._mask', function () {
                let valor = $(this).val().replace(/\D/g, '');
                valor = (parseInt(valor || '0', 10) / 1000).toFixed(3);
                $(this).val(valor.replace('.', ','));

                if (!selected) return;

                const qtd = parseBRNumber($(this).val());
                if (!qtd || qtd <= 0) {
                    renderEmpty('Digite a quantidade produzida');
                    computedRows = [];
                    return;
                }
                recalcGrid();
            });
        }
    }

    async function loadProducoes() {
        if (!token) return Swal.fire('Erro', 'Token não informado na URL.', 'error');
        if (!system_unit_id) return Swal.fire('Erro', 'Unidade não informada na URL.', 'error');
        if (!userId) return Swal.fire('Erro', 'Usuário não informado na URL.', 'error');

        loading('Carregando...');
        try {
            const { data } = await axios.post(baseUrl, {
                method: 'listProducoes',
                token,
                data: { unit_id: String(system_unit_id) }
            });

            Swal.close();

            if (!data?.success) {
                Swal.fire('Erro', data?.message || 'Falha ao carregar.', 'error');
                return;
            }

            producoes = data.producoes || [];

            const sel = $('#produtoSelect');
            sel.empty();
            sel.append('<option value="">Selecione</option>');
            producoes.forEach(p => sel.append(new Option(`${p.produto} - ${p.nome}`, p.produto)));

            sel.select2({ width: '100%', placeholder: 'Selecione', allowClear: true });

            sel.off('change').on('change', function() {
                const cod = parseInt($(this).val() || '0', 10);
                selected = producoes.find(x => parseInt(x.produto, 10) === cod) || null;

                if (!selected) {
                    $('#produtoBar').hide();
                    $('#produtoNome').text('-');
                    $('#produtoCodigo').text('-');
                    $('#produtoUnidade').text('-');
                    $('#qtdProduzida').val('');
                    renderEmpty('Selecione um produto');
                    return;
                }

                $('#produtoBar').show();
                $('#produtoNome').text(selected.nome || '-');
                $('#produtoCodigo').text(selected.produto || '-');
                $('#produtoUnidade').text(selected.unidade || '-'); // ✅ unidade do produto

                renderEmpty('Digite a quantidade produzida');

                // ✅ aplica máscara da quantidade produzida pela unidade do produto
                bindQtdMaskByProdutoUnidade(selected.unidade);

                $('#qtdProduzida').focus();
            });

            renderEmpty('Selecione um produto');
            $('#produtoBar').hide();

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao carregar produtos.', 'error');
        }
    }

    async function salvar() {
        const product_codigo = parseInt($('#produtoSelect').val() || '0', 10);
        const quantidade = parseBRNumber($('#qtdProduzida').val());
        const date_producao = $('#dateProducao').val();

        if (!product_codigo) return Swal.fire('Erro', 'Selecione um produto.', 'error');
        if (!quantidade || quantidade <= 0) return Swal.fire('Erro', 'Informe a quantidade.', 'error');
        if (!selected) return Swal.fire('Erro', 'Produto inválido.', 'error');

        const resumo = `
            <div style="text-align:left">
                <div><b>${escapeHtml(selected.nome)}</b> (${escapeHtml(product_codigo)})</div>
                <div style="margin-top:6px">Quantidade: <b>${escapeHtml(formatBR(quantidade, 3))}</b> ${escapeHtml(selected.unidade || '')}</div>
                <hr/>
                <div style="max-height:260px; overflow:auto; border:1px solid #eee; border-radius:6px;">
                    <table class="table table-striped" style="margin:0">
                        <thead>
                        <tr>
                            <th>Insumo</th>
                            <th>Consumo</th>
                        </tr>
                        </thead>
                        <tbody>
                        ${computedRows.map(r => `
                            <tr>
                                <td>${escapeHtml(r.codigo)} - ${escapeHtml(r.nome)}</td>
                                <td><b>${escapeHtml(formatBR(r.consumo, 4))}</b> ${escapeHtml(r.unidade || '')}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        const ok = await Swal.fire({
            title: 'Confirmar?',
            html: resumo,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Confirmar',
            cancelButtonText: 'Cancelar',
            width: 850
        });

        if (!ok.isConfirmed) return;

        loading('Salvando...');

        try {
            const { data } = await axios.post(baseUrl, {
                method: 'executeProduction',
                token,
                data: {
                    system_unit_id: system_unit_id,
                    product_codigo: product_codigo,
                    quantidade_produzida: quantidade,
                    user: userId,
                    date_producao: date_producao,
                    allow_negative: true
                }
            });

            Swal.close();

            if (data?.success) {
                const doc = data?.doc || '';

                await Swal.fire({
                    title: 'Produção executada!',
                    html: doc ? `Documento: <b>${doc}</b>` : 'Produção executada.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                // ✅ grava o retorno completo pra impressão
                localStorage.setItem('producaoPdfData', JSON.stringify(data));

                // ✅ abre a impressão numa nova aba
                window.open(`./reports/producao.html`, '_blank', 'width=1024,height=768,scrollbars=yes,resizable=yes');

                // limpa campo
                $('#qtdProduzida').val('');
                renderEmpty('Digite a quantidade produzida');

            } else {
                Swal.fire('Erro', data?.message || 'Falha ao salvar.', 'error');
            }


        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Erro ao salvar.', 'error');
        }
    }

    $('#btnSalvar').on('click', salvar);

    setDateToday();
    loadProducoes();
</script>

</body>
</html>
