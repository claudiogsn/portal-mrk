<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão de Compras</title>

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet" />
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet" />
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet" />
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* Ajustes específicos da tela */
        body { background-color: #F4F7F6; }

        /* Ajuste do Select2 para combinar com mrk.css */
        .select2-container .select2-selection--single {
            height: 34px !important;
            border: 1px solid #ccc !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 34px !important;
            font-family: 'Poppins', sans-serif;
            color: #555;
        }

        /* Tabela Visual MRK */
        .category-header td {
            background-color: #e3eefc !important; /* Azul bem claro */
            color: var(--mrk-blue);
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            padding-top: 15px;
            padding-bottom: 15px;
        }

        @media print {
            .no-print { display: none !important; }
            .card { box-shadow: none; border: none; }
        }
    </style>
</head>
<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <h2> </h2>
        <br>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="header">
                    <h2>
                        <iconify-icon icon="icon-park-outline:shopping-cart-one" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                        PREVISÃO DE COMPRAS
                    </h2>
                </div>
                <div class="body">
                    <form id="transferForm">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="quant-days" style="font-family: 'Kanit', sans-serif;">Dias de Estoque</label>
                                <input type="number" id="quant-days" class="form-control" placeholder="Ex: 7" required>
                            </div>
                            <div class="col-md-4">
                                <label for="unit-select" style="font-family: 'Kanit', sans-serif;">Unidade de Produção</label>
                                <select id="unit-select" class="form-control" style="width: 100%;" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="modelos-select" style="font-family: 'Kanit', sans-serif;">Modelo de Balanço</label>
                                <select id="modelos-select" name="modelos-select" class="form-control">
                                    <option value="">Selecione uma unidade primeiro</option>
                                </select>
                            </div>
                            <div class="col-md-2" style="margin-top: 25px;">
                                <button type="button" id="add-item" class="btn btn-primary waves-effect btn-block" style="background-color: var(--mrk-blue);">
                                    <iconify-icon icon="icon-park-outline:search" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                                    CONSULTAR
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="kpi-alertas" class="row" style="margin-bottom:15px; display:none;">
        <div class="col-md-12">
            <div class="card">
                <div class="body kpi orange" style="text-align:left; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="text-center">
                            <small>ITENS COM FALHA</small>
                            <h4 id="kpi-alertas-qtd" style="font-size: 28px;">0</h4>
                        </div>
                        <div style="border-left: 1px solid #eee; padding-left: 20px;">
                            <small>MOTIVO</small>
                            <h4 id="kpi-alertas-msg" style="font-size: 16px; margin-top: 5px;">—</h4>
                        </div>
                    </div>

                    <button type="button" class="btn btn-default waves-effect" onclick="$('#kpi-alertas-lista').slideToggle()">
                        Ver Detalhes <iconify-icon icon="icon-park-outline:down" style="margin-left:5px;"></iconify-icon>
                    </button>
                </div>

                <div id="kpi-alertas-lista" class="body" style="display:none; border-top: 1px solid #eee; background: #fafafa;">
                    <ul style="margin:0; padding-left:18px; columns: 2;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="body table-responsive">
            <table id="result-table" class="table table-hover">
                <thead>
                <tr>
                    <th width="15%">Código</th>
                    <th width="65%">Descrição do Produto</th>
                    <th width="20%">Quantidade Sugerida</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <center>
        <button type="button" id="print-button" class="btn btn-danger waves-effect" style="margin-bottom: 40px; background-color: var(--mrk-red) !important;">
            <iconify-icon icon="icon-park-outline:printer" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
            IMPRIMIR RELATÓRIO
        </button>
    </center>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="bsb/plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const baseUrl = window.location.hostname !== 'localhost' ?
            'https://portal.mrksolucoes.com.br/api/v1/index.php' :
            'http://localhost/portal-mrk/api/v1/index.php';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const username = urlParams.get('username');
        let importedProductCodes = [];

        // ========================
        // CARREGAMENTO DE DADOS
        // ========================

        async function loadUnidades() {
            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'getFiliaisProduction',
                        token: token,
                        data: { username: username }
                    })
                });

                const unidades = await response.json();
                const select = $('#unit-select');
                select.empty();
                select.append('<option value="">Selecione uma unidade</option>');

                unidades.forEach(filial => {
                    select.append(new Option(filial.filial_nome, filial.filial_id));
                });

                // Inicializa Select2
                select.select2({ placeholder: 'Pesquise a unidade...', allowClear: true, width: '100%' });
                select.on('select2:select', function (e) { loadModelos(e.params.data.id); });

            } catch (e) { console.error(e); }
        }

        async function loadModelos(unitId) {
            const select = document.getElementById('modelos-select');
            select.innerHTML = '<option disabled selected>Carregando...</option>';
            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'listModelosWithProducts',
                        token: token,
                        data: { unit_id: unitId }
                    })
                });
                const data = await response.json();
                select.innerHTML = '<option value="">Selecione um modelo</option>';
                data.modelos.forEach(modelo => {
                    select.appendChild(new Option(modelo.nome, modelo.tag));
                });
            } catch (error) {
                select.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        document.getElementById('modelos-select').addEventListener('change', function () {
            if (this.value) loadProdutosDoModelo(this.value);
        });

        async function loadProdutosDoModelo(tag) {
            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method: 'getModelByTag', data: { tag: tag } })
                });
                const data = await response.json();
                const produtosModelo = data.itens;
                importedProductCodes = [];
                for (const categoria in produtosModelo) {
                    produtosModelo[categoria].forEach(item => importedProductCodes.push(item.codigo_produto));
                }
            } catch (e) { console.error(e); }
        }

        // ========================
        // CÁLCULOS
        // ========================

        async function calcularNecessidades() {
            const selectedUnitId = $('#unit-select').val();
            const dates = document.getElementById('quant-days').value;
            const allSelectedProducts = importedProductCodes;

            if (!selectedUnitId || !dates || allSelectedProducts.length === 0) {
                Swal.fire({
                    title: 'Campos incompletos',
                    text: 'Preencha os dias, selecione a unidade e o modelo.',
                    icon: 'warning',
                    confirmButtonColor: '#0B46AC'
                });
                return;
            }

            Swal.fire({
                title: 'Calculando consumo...',
                html: 'Analisando histórico de vendas...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'getConsumptionBuy',
                        token: token,
                        data: { matriz_id: selectedUnitId, dias: dates, insumoIds: allSelectedProducts }
                    })
                });
                const consumos = await response.json();
                Swal.close();
                calcularCompras(consumos);
            } catch (error) { Swal.fire('Erro', 'Falha ao calcular consumo.', 'error'); }
        }

        async function calcularCompras(params) {
            const selectedUnitId = $('#unit-select').val();

            Swal.fire({
                title: 'Gerando sugestão de compras...',
                html: 'Cruzando dados com estoque atual...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'getProductsToBuy',
                        token: token,
                        data: { matriz_id: selectedUnitId, vendas: params }
                    })
                });

                const result = await response.json();
                Swal.close();

                renderKpiAlertas(result.alertas || null);

                const compras = result.compras || [];
                const produtosAgrupados = compras.reduce((acc, produto) => {
                    if (!acc[produto.categoria]) acc[produto.categoria] = [];
                    acc[produto.categoria].push(produto);
                    return acc;
                }, {});

                renderItensByCategory(produtosAgrupados);

            } catch (error) { Swal.fire('Erro', 'Falha ao calcular compras.', 'error'); }
        }

        // ========================
        // RENDERIZAÇÃO
        // ========================

        function renderItensByCategory(itens) {
            const tbody = $('#result-table tbody');
            tbody.empty();

            if (Object.keys(itens).length === 0) {
                tbody.append('<tr><td colspan="3" class="text-center">Nenhum item sugerido para compra.</td></tr>');
                return;
            }

            for (const categoria in itens) {
                tbody.append(`<tr class="category-header"><td colspan="3">${categoria}</td></tr>`);
                itens[categoria].forEach(produto => {
                    tbody.append(`
                        <tr>
                            <td style="vertical-align: middle;">${produto.insumo_id}</td>
                            <td style="vertical-align: middle; font-weight: 500;">${produto.nome || 'Produto desconhecido'}</td>
                            <td style="vertical-align: middle; font-weight: bold; color: var(--mrk-blue); font-size: 14px;">${produto.compras}</td>
                        </tr>
                    `);
                });
            }
        }

        function renderKpiAlertas(alertas) {
            const container = document.getElementById('kpi-alertas');

            // Se não houver alertas ou a lista de itens estiver vazia
            if (!alertas || !alertas.itens || alertas.itens.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Atualiza a quantidade
            document.getElementById('kpi-alertas-qtd').innerText = alertas.itens.length;

            // --- Define a mensagem Global (Título do box) ---
            let tituloMotivo = alertas.message;

            if (!tituloMotivo) {
                if (alertas.tipo === 'falha_configuracao') {
                    tituloMotivo = "Itens com Fator de Conversão Inválido";
                } else if (alertas.tipo === 'sem_estoque') {
                    tituloMotivo = "Itens sem registro de estoque";
                } else {
                    tituloMotivo = "Verifique o cadastro dos itens abaixo";
                }
            }
            document.getElementById('kpi-alertas-msg').innerText = tituloMotivo;

            // --- Renderiza a lista com o motivo ao lado ---
            const ul = document.querySelector('#kpi-alertas-lista ul');
            ul.innerHTML = '';

            alertas.itens.forEach(item => {
                const li = document.createElement('li');

                // Garante que pegamos o código correto
                const cod = item.codigo || item.id || item.insumo_id || '';

                // Tenta pegar o motivo específico do item, senão usa um padrão baseado no tipo global
                let motivoItem = item.motivo || item.erro || item.msg;

                if (!motivoItem) {
                    if (alertas.tipo === 'falha_configuracao') motivoItem = "Sem Fator de Conversão";
                    else if (alertas.tipo === 'sem_estoque') motivoItem = "Estoque Zerado";
                    else motivoItem = "Erro de Cadastro";
                }

                // Monta o HTML: Código - Nome <span vermelho>(Motivo)</span>
                li.innerHTML = `
            <b>${cod}</b> - ${item.nome}
            <span style="color: #D32F2F; font-size: 11px; font-weight: 600; margin-left: 8px;">
                <iconify-icon icon="icon-park-outline:attention" style="vertical-align: -2px;"></iconify-icon>
                ${motivoItem}
            </span>
        `;

                // Adiciona linha divisória leve entre itens para facilitar leitura
                li.style.borderBottom = "1px dashed #eee";
                li.style.padding = "4px 0";

                ul.appendChild(li);
            });

            container.style.display = 'block';
        }
        // ========================
        // IMPRESSÃO
        // ========================

        function printTable(event) {
            event.preventDefault();

            const table = document.getElementById('result-table');
            const quantDays = document.getElementById('quant-days').value || '0';
            const unitName = $("#unit-select option:selected").text();
            const currentDateTime = new Date().toLocaleString('pt-BR');

            // Clone para não afetar a tela
            const tableClone = table.cloneNode(true);

            const printContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Sugestão de Compras</title>
                    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 20px; color: #000; font-size: 12px; }
                        h3 { font-family: 'Kanit', sans-serif; color: #0B46AC; margin: 0; }
                        .header { border-bottom: 2px solid #0B46AC; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; }
                        .header img { max-height: 50px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
                        th { background: #f0f0f0; font-family: 'Kanit', sans-serif; }
                        .category-header td { background: #e9e9e9; font-weight: bold; text-transform: uppercase; }
                        .signature { margin-top: 50px; border-top: 1px solid #000; width: 40%; display: inline-block; padding-top: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div>
                            <h3>Portal MRK - Sugestão de Compras</h3>
                            <p style="margin:0;"><strong>Unidade:</strong> ${unitName}</p>
                            <p style="margin:0;"><strong>Previsão para:</strong> ${quantDays} dias</p>
                            <p style="margin:0;"><strong>Data:</strong> ${currentDateTime}</p>
                        </div>
                        <div>
                            <img id="logo-img" src="https://portal.mrksolucoes.com.br/app/templates/theme5/images/logo.png" alt="Logo">
                        </div>
                    </div>
                    ${tableClone.outerHTML}
                    <div style="text-align: center; margin-top: 40px;">
                        <div class="signature">Aprovação de Compra</div>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank', 'height=700,width=900');
            win.document.write(printContent);
            win.document.close();

            const logoImg = win.document.getElementById('logo-img');
            if (logoImg) {
                logoImg.onload = function() { win.print(); win.close(); };
            } else {
                setTimeout(() => { win.print(); win.close(); }, 500);
            }
        }

        $('#print-button').click(function (event) {
            printTable(event);
        });

        loadUnidades();
        document.getElementById('add-item').addEventListener('click', calcularNecessidades);
    });
</script>

</body>
</html>