<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Nota de Entrada Avulsa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== FUNDO TRANSPARENTE PARA IFRAME ====== */
        html, body { background: transparent !important; }
        body.theme-blue { background: transparent !important; }
        .container-fluid { background: transparent !important; }

        /* Card Transparente/Branco */
        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: none !important;
            border: 1px solid #eee;
            margin-bottom: 0;
        }

        .card .header { border-bottom: 2px solid var(--mrk-blue); padding-bottom: 10px; margin-bottom: 20px; }
        .card .header h2 { margin: 0; font-size: 18px; color: var(--mrk-blue); display: flex; align-items: center; gap: 8px; }

        /* KPI Boxes (Totais) */
        .kpi-box {
            background: #fff;
            border: 1px solid #ddd;
            border-left: 4px solid var(--mrk-blue);
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .kpi-box h4 { margin: 0 0 5px 0; font-size: 12px; color: #666; font-family: 'Poppins', sans-serif; text-transform: uppercase; }
        .kpi-box span { font-size: 18px; font-weight: 700; color: var(--mrk-black); font-family: 'Kanit', sans-serif; }

        /* Tabela de Itens */
        .table-items thead th {
            background-color: #f5f5f5;
            color: var(--mrk-blue);
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 2px solid #ddd;
        }
        .table-items tbody tr td { vertical-align: middle; }

        /* Campos Readonly */
        .readonly-field {
            background-color: #e9ecef;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 4px;
            min-height: 34px;
            line-height: 20px;
            color: #555;
            font-family: 'Poppins', sans-serif;
            font-size: 13px;
            pointer-events: none;
        }

        /* Ajuste Select2 */
        .select2-container .select2-selection--single {
            height: 34px !important;
            border: 1px solid #ccc !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 34px !important;
            font-family: 'Poppins', sans-serif;
            color: #555;
        }

        /* Botões de Ação na Tabela */
        .action-cell { white-space: nowrap; width: 100px; }
        .btn-action { margin: 0 2px; }

        /* Utilitários */
        .mb-10 { margin-bottom: 10px; }
        .mt-10 { margin-top: 10px; }
        label { font-family: 'Kanit', sans-serif; font-weight: 500; color: #666; font-size: 12px; margin-bottom: 4px; }

        /* Spin Animation Customizada para Iconify se necessário */
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br/>
    <div class="card">
        <div class="body">
            <input type="hidden" id="fornecedor_id">
            <input type="hidden" id="nota_id_hidden">
            <input type="hidden" id="natureza_operacao" value="NOTA AVULSA">

            <div class="row">
                <div class="col-md-8">
                    <h4 style="font-family: 'Kanit', sans-serif; font-size: 16px; color: var(--mrk-black); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px;">
                        <iconify-icon icon="icon-park-outline:doc-detail" style="vertical-align: -2px; color: var(--mrk-blue);"></iconify-icon> DADOS DA NOTA
                    </h4>

                    <div class="row clearfix">
                        <div class="col-md-12 mb-10">
                            <label>Fornecedor</label>
                            <select id="selFornecedor" class="form-control" style="width: 100%;"></select>
                        </div>
                    </div>

                    <div class="row clearfix">
                        <div class="col-md-4 mb-10">
                            <label>Nº Nota Fiscal</label>
                            <input type="text" id="numero_nf" class="form-control" placeholder="Ex: 123456">
                        </div>
                        <div class="col-md-2 mb-10">
                            <label>Série</label>
                            <input type="text" id="serie" class="form-control" placeholder="1">
                        </div>
                        <div class="col-md-3 mb-10">
                            <label>Data Emissão</label>
                            <input type="date" id="data_emissao" class="form-control">
                        </div>
                        <div class="col-md-3 mb-10">
                            <label>Data Entrada</label>
                            <input type="date" id="data_entrada" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <h4 style="font-family: 'Kanit', sans-serif; font-size: 16px; color: var(--mrk-black); border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px;">
                        <iconify-icon icon="icon-park-outline:calculator" style="vertical-align: -2px; color: var(--mrk-blue);"></iconify-icon> TOTAIS
                    </h4>

                    <div class="row clearfix">
                        <div class="col-md-6 mb-10">
                            <div class="kpi-box" style="border-left-color: #999;">
                                <h4>Produtos</h4>
                                <span id="valor_produtos">R$ 0,00</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-10">
                            <div class="kpi-box" style="border-left-color: var(--mrk-green);">
                                <h4>Total Nota</h4>
                                <span id="valor_total_nota" style="color: var(--mrk-green);">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <div class="row clearfix">
                        <div class="col-md-12 mb-10">
                            <label>Valor Frete (R$)</label>
                            <div class="input-group">
                                <span class="input-group-addon" style="background: #eee; border: 1px solid #ccc; border-right: 0;">R$</span>
                                <input type="text" id="valor_frete" class="form-control" placeholder="0,00" style="text-align: right; font-weight: bold;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <hr style="border-top: 1px dashed #ddd; margin: 20px 0;">

            <h4 style="font-family: 'Kanit', sans-serif; font-size: 16px; color: var(--mrk-black); margin-bottom: 15px;">
                <iconify-icon icon="icon-park-outline:shopping-bag" style="vertical-align: -2px; color: var(--mrk-blue);"></iconify-icon> ITENS DA NOTA
            </h4>

            <div class="row clearfix" style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; margin-bottom: 15px;">
                <div class="col-md-3 mb-10">
                    <label>Produto (Estoque)</label>
                    <select id="selProduto" class="form-control" style="width: 100%;"></select>
                </div>
                <div class="col-md-1 mb-10">
                    <label>Unid.</label>
                    <div id="item_unidade" class="readonly-field text-center">-</div>
                </div>
                <div class="col-md-2 mb-10">
                    <label>Quantidade</label>
                    <input type="text" id="item_quantidade" class="form-control" placeholder="0">
                </div>
                <div class="col-md-2 mb-10">
                    <label>Valor Unit. (R$)</label>
                    <input type="text" id="item_valor_unitario" class="form-control" placeholder="0,00">
                </div>
                <div class="col-md-2 mb-10">
                    <label>Total (R$)</label>
                    <input type="text" id="item_valor_total" class="form-control readonly-field" placeholder="0,00" readonly>
                </div>
                <div class="col-md-2 mb-10" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary btn-block" id="btnAddItem" type="button" style="height: 34px; background-color: var(--mrk-blue) !important;">
                        <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle;"></iconify-icon> ADICIONAR
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-items" id="tabelaItens">
                    <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>Cód.</th>
                        <th>Descrição do Produto</th>
                        <th class="text-center">Unid.</th>
                        <th class="text-right">Qtd.</th>
                        <th class="text-right">Vlr. Unit.</th>
                        <th class="text-right">Vlr. Total</th>
                        <th class="text-center action-cell">Ações</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="8" class="text-center text-muted" style="padding: 20px;">Nenhum item adicionado.</td></tr>
                    </tbody>
                </table>
            </div>

            <br/>

            <div class="text-center" style="padding-top: 20px; border-top: 1px solid #eee;">
                <button class="btn btn-danger" id="btnFecharTela" type="button" style="margin-right: 10px; background-color: var(--mrk-red) !important;">
                    <iconify-icon icon="icon-park-outline:close" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> FECHAR
                </button>

                <button class="btn btn-success" id="btnSalvarNota" type="button" style="background-color: var(--mrk-green) !important; min-width: 150px;">
                    <iconify-icon icon="icon-park-outline:save" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> SALVAR NOTA
                </button>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    'use strict';

    // ===== Configs =====
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const financeiroUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const params = new URLSearchParams(window.location.search);
    const system_unit_id = params.get('system_unit_id');
    const token          = params.get('token');
    const usuario_id     = params.get('usuario_id');
    let   nota_id        = params.get('nota_id');

    // Estado
    let fornecedores = [];
    let insumos      = [];
    let itens        = [];
    let editIndex    = null;
    let nota         = null;

    // ===== Helpers =====
    function parseValorBR(str) {
        if (str == null) return 0;
        let s = String(str).trim();
        if (s === '') return 0;
        s = s.replace(/\./g, '').replace(',', '.');
        return parseFloat(s) || 0;
    }

    function formatValorBR(num) {
        return Number(num).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtDateInput(s) {
        if (!s) return '';
        const d = new Date(s);
        return isNaN(d) ? '' : d.toISOString().split('T')[0];
    }

    function fecharTela() {
        try {
            if (window.parent && window.parent.$) window.parent.$('#modalEntradaEstoque').modal('hide');
        } catch (e) {}
    }

    // ===== Init =====
    async function initPage() {
        if (!system_unit_id || !token) {
            Swal.fire('Erro', 'Parâmetros inválidos.', 'error');
            return;
        }

        // Configura Select2
        $('#selFornecedor').select2({ placeholder: 'Carregando...', width: '100%' });
        $('#selProduto').select2({ placeholder: 'Carregando...', width: '100%' });

        // Bindings
        $('#selFornecedor').on('change', onChangeFornecedor);
        $('#selProduto').on('change', onChangeProduto);
        $('#btnAddItem').on('click', adicionarOuAtualizarItem);
        $('#btnFecharTela').on('click', fecharTela);
        $('#btnSalvarNota').on('click', salvarNotaAvulsa);
        $('#valor_frete').on('input', recalcularTotais);

        // Bind MÁSCARA INTELIGENTE NO CAMPO DE QUANTIDADE
        $('#item_quantidade').on('input', aplicarMascaraQuantidade);

        // Cálculo automático (Qtd * Unit = Total)
        $('#item_quantidade, #item_valor_unitario').on('input', calcularTotalItem);

        // Data Default
        const hoje = new Date().toISOString().split('T')[0];
        $('#data_emissao').val(hoje);
        $('#data_entrada').val(hoje);

        try {
            Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            await Promise.all([carregarInsumos(), carregarFornecedores()]);

            if (nota_id) await carregarNotaAvulsa();

            Swal.close();
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha ao carregar dados iniciais.', 'error');
        }
    }

    // ===== MÁSCARA INTELIGENTE =====
    function aplicarMascaraQuantidade() {
        const unidade = $('#item_unidade').text().trim().toUpperCase();
        let v = $(this).val().replace(/\D/g, ''); // Apenas números

        if (['KG', 'LT', 'L', 'M', 'M2', 'M3'].includes(unidade)) {
            if (v === '') {
                $(this).val('');
                return;
            }
            if (v.length > 8) v = v.substring(0, 8);
            let valorDecimal = (parseInt(v) / 1000).toFixed(3);
            $(this).val(valorDecimal.replace('.', ','));
        } else {
            if (v.length > 5) v = v.substring(0, 5);
            $(this).val(v);
        }
    }

    function calcularTotalItem() {
        setTimeout(() => {
            const qtd = parseValorBR($('#item_quantidade').val());
            const unit = parseValorBR($('#item_valor_unitario').val());
            const total = qtd * unit;
            $('#item_valor_total').val(formatValorBR(total));
        }, 50);
    }

    // ===== Loads =====
    async function carregarFornecedores() {
        const res = await axios.post(financeiroUrl, {
            method: 'listFornecedores', token,
            data: { system_unit_id: Number(system_unit_id) }
        });

        let lista = Array.isArray(res.data) ? res.data : (res.data?.fornecedores || []);
        fornecedores = lista.map(f => ({ id: f.id, nome: f.nome || f.razao, cnpj: f.cnpj_cpf }));

        const $sel = $('#selFornecedor');
        $sel.empty().append('<option value=""></option>');
        fornecedores.forEach(f => {
            $sel.append(new Option(`${f.nome} ${f.cnpj ? '('+f.cnpj+')' : ''}`, f.id));
        });
        $sel.select2({ placeholder: 'Selecione um fornecedor...', allowClear: true });
    }

    function onChangeFornecedor() {
        $('#fornecedor_id').val($('#selFornecedor').val());
    }

    async function carregarInsumos() {
        const res = await axios.post(baseUrl, {
            method: 'listInsumos', token,
            data: { unit_id: String(system_unit_id) }
        });

        insumos = res.data?.insumos || [];
        const $sel = $('#selProduto');
        $sel.empty().append('<option value=""></option>');

        insumos.forEach(i => {
            $sel.append(new Option(`${i.codigo} - ${i.nome}`, i.codigo));
        });
        $sel.select2({ placeholder: 'Selecione um produto...', allowClear: true });
    }

    function onChangeProduto() {
        const codigo = $('#selProduto').val();
        const ins = insumos.find(x => String(x.codigo) === String(codigo));
        $('#item_unidade').text(ins ? (ins.und || '-') : '-');

        // Limpa campos
        $('#item_quantidade').val('');
        $('#item_valor_unitario').val('');
        $('#item_valor_total').val('');
    }

    // ===== Itens =====
    function adicionarOuAtualizarItem() {
        const codigo = $('#selProduto').val();
        const ins = insumos.find(x => String(x.codigo) === String(codigo));

        const qtd = parseValorBR($('#item_quantidade').val());
        const vUnit = parseValorBR($('#item_valor_unitario').val());
        const vTot = qtd * vUnit;

        if (!codigo) return Swal.fire('Atenção', 'Selecione um produto.', 'warning');
        if (!(qtd > 0)) return Swal.fire('Atenção', 'Quantidade inválida.', 'warning');
        if (!(vUnit >= 0)) return Swal.fire('Atenção', 'Valor unitário inválido.', 'warning');

        const item = {
            numero_item: editIndex !== null ? (editIndex + 1) : (itens.length + 1),
            codigo_produto: ins.codigo,
            descricao: ins.nome,
            unidade: ins.und || 'UND',
            quantidade: qtd,
            valor_unitario: vUnit,
            valor_total: vTot
        };

        if (editIndex !== null) itens[editIndex] = item;
        else itens.push(item);

        renderTabelaItens();
        recalcularTotais();
        limparCamposItem();
    }

    function renderTabelaItens() {
        const tbody = $('#tabelaItens tbody');
        tbody.empty();

        if (!itens.length) {
            tbody.append('<tr><td colspan="8" class="text-center text-muted" style="padding: 20px;">Nenhum item adicionado.</td></tr>');
            return;
        }

        itens.forEach((it, idx) => {
            const qtdExibicao = it.quantidade.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });

            tbody.append(`
                <tr data-idx="${idx}">
                    <td>${idx + 1}</td>
                    <td><b>${it.codigo_produto}</b></td>
                    <td>${it.descricao}</td>
                    <td class="text-center">${it.unidade}</td>
                    <td class="text-right">${qtdExibicao}</td>
                    <td class="text-right">R$ ${formatValorBR(it.valor_unitario)}</td>
                    <td class="text-right"><b>R$ ${formatValorBR(it.valor_total)}</b></td>
                    <td class="text-center action-cell">
                        <button class="btn btn-warning btn-xs btn-action btn-edit" title="Editar"><iconify-icon icon="icon-park-outline:edit"></iconify-icon></button>
                        <button class="btn btn-danger btn-xs btn-action btn-del" title="Remover"><iconify-icon icon="icon-park-outline:delete"></iconify-icon></button>
                    </td>
                </tr>
            `);
        });

        $('.btn-edit').click(function() {
            const idx = $(this).closest('tr').data('idx');
            editarItem(idx);
        });
        $('.btn-del').click(function() {
            const idx = $(this).closest('tr').data('idx');
            itens.splice(idx, 1);
            renderTabelaItens();
            recalcularTotais();
        });
    }

    function editarItem(idx) {
        const it = itens[idx];
        editIndex = idx;
        $('#selProduto').val(it.codigo_produto).trigger('change');

        let qtdStr = it.quantidade.toString();
        if (['KG', 'LT', 'L', 'M', 'M2', 'M3'].includes(it.unidade.toUpperCase())) {
            qtdStr = it.quantidade.toFixed(3).replace('.', ',');
        }

        $('#item_quantidade').val(qtdStr);
        $('#item_valor_unitario').val(formatValorBR(it.valor_unitario));
        $('#item_valor_total').val(formatValorBR(it.valor_total));

        $('#btnAddItem').html('<iconify-icon icon="icon-park-outline:check"></iconify-icon> ATUALIZAR').removeClass('btn-primary').addClass('btn-warning');
    }

    function limparCamposItem() {
        $('#selProduto').val(null).trigger('change');
        $('#item_quantidade').val('');
        $('#item_valor_unitario').val('');
        $('#item_valor_total').val('');
        $('#item_unidade').text('-');
        editIndex = null;
        $('#btnAddItem').html('<iconify-icon icon="icon-park-outline:plus"></iconify-icon> ADICIONAR').removeClass('btn-warning').addClass('btn-primary');
    }

    function recalcularTotais() {
        const somaItens = itens.reduce((acc, it) => acc + it.valor_total, 0);
        const frete = parseValorBR($('#valor_frete').val());
        const total = somaItens + frete;

        $('#valor_produtos').text(`R$ ${formatValorBR(somaItens)}`);
        $('#valor_total_nota').text(`R$ ${formatValorBR(total)}`);
    }

    // ===== Salvar =====
    async function salvarNotaAvulsa() {
        const fornId = $('#fornecedor_id').val();
        if (!fornId) return Swal.fire('Atenção', 'Selecione um fornecedor.', 'warning');
        if (!itens.length) return Swal.fire('Atenção', 'Adicione ao menos um item.', 'warning');

        // Referência do botão e estado original
        const $btn = $('#btnSalvarNota');
        const originalContent = $btn.html();
        const isNewNota = !nota_id; // Verifica se é criação antes da requisição

        // 1. Travar botão
        $btn.prop('disabled', true).html('<iconify-icon icon="icon-park-outline:loading-one" class="spin"></iconify-icon> PROCESSANDO...');

        const payload = {
            system_unit_id: Number(system_unit_id),
            fornecedor_id: Number(fornId),
            numero_nf: $('#numero_nf').val(),
            serie: $('#serie').val(),
            data_emissao: $('#data_emissao').val(),
            data_entrada: $('#data_entrada').val(),
            natureza_operacao: 'NOTA AVULSA',
            valor_frete: parseValorBR($('#valor_frete').val()),
            usuario_id: Number(usuario_id),
            itens: itens.map((it, idx) => ({
                ...it,
                numero_item: idx + 1,
                valor_unitario: it.valor_unitario,
                valor_total: it.valor_total
            }))
        };

        if(nota_id) payload.nota_id = Number(nota_id);

        try {
            const res = await axios.post(baseUrl, {
                method: nota_id ? 'updateNotaAvulsa' : 'lancarNotaAvulsa',
                token,
                data: payload
            });

            if(res.data.success) {
                await Swal.fire('Sucesso', 'Nota salva com sucesso.', 'success');

                // 2. Comportamento pós-sucesso
                if (isNewNota) {
                    // Se for nova, reseta a tela para inserir outra
                    resetFormNotaAvulsa();
                    // Destrava para nova inserção
                    $btn.prop('disabled', false).html(originalContent);
                } else {
                    // Se for edição, mantém travado como "SALVO"
                    $btn.html('<iconify-icon icon="icon-park-outline:check"></iconify-icon> SALVO');
                    // Opcional: fechar a tela automaticamente após um tempo
                    // setTimeout(fecharTela, 1500);
                }
            } else {
                throw new Error(res.data.message);
            }
        } catch(e) {
            Swal.fire('Erro', e.message || 'Falha ao salvar.', 'error');
            // 3. Em caso de erro, destrava
            $btn.prop('disabled', false).html(originalContent);
        }
    }

    // Função auxiliar para resetar formulário (usada ao salvar nova nota com sucesso)
    function resetFormNotaAvulsa() {
        nota_id = null;
        $('#nota_id_hidden').val('');
        $('#selFornecedor').val(null).trigger('change');
        $('#numero_nf').val('');
        $('#serie').val('');
        $('#valor_frete').val('');
        itens = [];
        renderTabelaItens();
        recalcularTotais();
        limparCamposItem();

        // Mantém as datas de hoje por conveniência
        const hoje = new Date().toISOString().split('T')[0];
        $('#data_emissao').val(hoje);
        $('#data_entrada').val(hoje);
    }

    // ===== Carregar Edição =====
    async function carregarNotaAvulsa() {
        const res = await axios.post(baseUrl, {
            method: 'getNotaAvulsa', token,
            data: { system_unit_id: Number(system_unit_id), nota_id: Number(nota_id) }
        });

        if(res.data.success) {
            const n = res.data.data.nota || res.data.data.nota_avulsa;
            const its = res.data.data.itens;

            $('#numero_nf').val(n.numero_nf);
            $('#serie').val(n.serie);
            $('#data_emissao').val(fmtDateInput(n.data_emissao));
            $('#data_entrada').val(fmtDateInput(n.data_entrada));
            $('#valor_frete').val(formatValorBR(n.valor_frete));
            $('#selFornecedor').val(n.fornecedor_id).trigger('change');

            itens = its.map((it, i) => ({
                numero_item: i+1,
                codigo_produto: it.codigo_produto,
                descricao: it.descricao,
                unidade: it.unidade,
                quantidade: Number(it.quantidade),
                valor_unitario: Number(it.valor_total) / Number(it.quantidade),
                valor_total: Number(it.valor_total)
            }));

            renderTabelaItens();
            recalcularTotais();
        }
    }

    // Start
    window.addEventListener('load', initPage);

</script>
</body>
</html>