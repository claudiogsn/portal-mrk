<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Relatório - Produções Realizadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

  <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
  <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
  <link href="bsb/css/style.css" rel="stylesheet">
  <link href="style/mrk.css" rel="stylesheet">

  <style>
    body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

    /* Card Principal */
    .card {
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #eee;
      border-top: 3px solid var(--mrk-blue) !important;
      margin-bottom: 20px;
      border-radius: 6px;
    }

    /* --- KPIs Internos --- */
    .kpi-card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #eee;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s;
      height: 100%;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

    .kpi-card.blue   { border-left: 4px solid var(--mrk-blue); }
    .kpi-card.green  { border-left: 4px solid var(--mrk-green); }
    .kpi-card.orange { border-left: 4px solid var(--mrk-amber); }
    .kpi-card.red    { border-left: 4px solid var(--mrk-red); }

    .kpi-title { font-size: 11px; color: #888; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 5px; }
    .kpi-value { font-size: 22px; font-weight: 700; font-family: 'Kanit', sans-serif; color: var(--mrk-black); }

    .kpi-bg-icon {
      position: absolute; right: 15px; top: 15px; font-size: 28px; opacity: 0.15;
    }
    .kpi-card.blue .kpi-bg-icon { color: var(--mrk-blue); }
    .kpi-card.green .kpi-bg-icon { color: var(--mrk-green); }
    .kpi-card.orange .kpi-bg-icon { color: var(--mrk-amber); }

    /* Filtros */
    .header-flex { display: flex; align-items: center; justify-content: space-between; }
    .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
    .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

    /* Tabela */
    .table thead th {
      font-family: 'Kanit', sans-serif;
      color: var(--mrk-blue);
      font-weight: 600;
      font-size: 12px;
      background-color: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      white-space: nowrap;
    }
    .table tbody td { font-size: 12px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

    /* Skeleton */
    .skeleton-wrapper { display: none; margin-top: 20px; }
    .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
    .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  </style>
</head>

<body>

<div class="container-fluid">

  <div class="card">
    <div class="header header-flex">
      <h2>
        <iconify-icon icon="icon-park-outline:workbench" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
        PRODUÇÕES REALIZADAS
      </h2>
    </div>

    <div class="body">

      <div class="filter-box">
        <div class="row clearfix">
          <div class="col-md-4">
            <label class="muted">Data Inicial</label>
            <div class="input-group">
              <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
              <input type="date" id="dtInicio" class="form-control">
            </div>
          </div>
          <div class="col-md-4">
            <label class="muted">Data Final</label>
            <div class="input-group">
              <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
              <input type="date" id="dtFim" class="form-control">
            </div>
          </div>
          <div class="col-md-4" style="margin-top: 22px;">
            <button id="btnAtualizar" class="btn btn-primary btn-block waves-effect">
              <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
              ATUALIZAR DADOS
            </button>
          </div>
        </div>
      </div>

      <div class="row clearfix" style="margin-bottom: 20px;">
        <div class="col-md-4">
          <div class="kpi-card blue">
            <span class="kpi-title">Registros Encontrados</span>
            <span class="kpi-value" id="totRegistros">0</span>
            <iconify-icon icon="icon-park-outline:list-numbers" class="kpi-bg-icon"></iconify-icon>
          </div>
        </div>

        <div class="col-md-4">
          <div class="kpi-card green" id="cardProduzido">
            <span class="kpi-title">Total Produzido</span>
            <span class="kpi-value" id="totProduzido">---</span>
            <iconify-icon icon="icon-park-outline:factory-building" class="kpi-bg-icon"></iconify-icon>
          </div>
        </div>

        <div class="col-md-4">
          <div class="kpi-card orange" id="cardUnidade">
            <span class="kpi-title">Unidade de Medida</span>
            <span class="kpi-value" id="totUnidade">---</span>
            <iconify-icon icon="icon-park-outline:ruler" class="kpi-bg-icon"></iconify-icon>
          </div>
        </div>
      </div>

      <div class="alert alert-info" style="font-size: 11px; padding: 10px; margin-bottom: 20px; background-color: #08A794; border-color: #bbdefb; color: #0d47a1;">
        <iconify-icon icon="icon-park-outline:info" style="vertical-align: middle; margin-right: 4px;"></iconify-icon>
        <strong>Nota:</strong> O total produzido só é calculado se todos os itens listados tiverem a mesma unidade de medida.
      </div>

      <div class="row clearfix" style="margin-bottom: 15px;">
        <div class="col-md-12">
          <div class="input-group">
            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
            <input type="text" id="filtroTexto" class="form-control" placeholder="Filtrar por Documento, Código ou Nome do Produto...">
          </div>
        </div>
      </div>

      <div id="sk-table" class="skeleton-wrapper">
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover" id="tabela-producoes">
          <thead>
          <tr>
            <th class="nowrap" width="120">Documento</th>
            <th class="nowrap" width="100">Data</th>
            <th class="nowrap" width="80">Código</th>
            <th>Produto</th>
            <th class="text-center nowrap" width="60">Unid.</th>
            <th class="text-right nowrap" width="120">Qtd Produzida</th>
          </tr>
          </thead>
          <tbody>
          <tr>
            <td colspan="6" class="text-center muted" style="padding: 40px;">
              Utilize os filtros acima e clique em <b>ATUALIZAR DADOS</b>.
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div style="margin-top: 10px; text-align: right;">
        <small class="muted" id="infoStatus"></small>
      </div>

    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  // ================= CONFIG =================
  const baseUrl = window.location.hostname !== 'localhost'
          ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
          : 'http://localhost/portal-mrk/api/v1/index.php';

  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const system_unit_id = urlParams.get('unit_id');

  // ================= STATE =================
  let dadosBrutos = [];
  let dadosFiltrados = [];

  // ================= UTILS =================
  function escapeHtml(s) {
    if (s == null) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function formatNumber(v) {
    const n = Number(v || 0);
    return n.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
  }

  function formatBRDate(dt) {
    if (!dt) return '';
    const s = String(dt).slice(0, 10); // YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
      const [y, m, d] = s.split('-');
      return `${d}/${m}/${y}`;
    }
    return '';
  }

  function toggleLoading(isLoading) {
    if (isLoading) {
      $('#tabela-producoes tbody').empty();
      $('#sk-table').show();
    } else {
      $('#sk-table').hide();
    }
  }

  function debounce(fn, ms){
    let t; return function(){ clearTimeout(t); const args = arguments; t = setTimeout(() => fn.apply(null, args), ms); }
  }

  // ================= INIT =================
  $(document).ready(() => {
    // Datas Padrão (Últimos 7 dias)
    const hoje = new Date();
    const y = hoje.getFullYear();
    const m = String(hoje.getMonth() + 1).padStart(2, '0');
    const d = String(hoje.getDate()).padStart(2, '0');
    $('#dtFim').val(`${y}-${m}-${d}`);

    const ini = new Date(hoje.getTime() - 7*24*60*60*1000);
    const y2 = ini.getFullYear();
    const m2 = String(ini.getMonth() + 1).padStart(2, '0');
    const d2 = String(ini.getDate()).padStart(2, '0');
    $('#dtInicio').val(`${y2}-${m2}-${d2}`);

    // Eventos
    $('#btnAtualizar').on('click', fetchBackend);
    $('#filtroTexto').on('input', debounce(applyFiltrosTempoReal, 150));

    if (!token || !system_unit_id) {
      Swal.fire('Atenção', 'URL inválida (token/unit_id).', 'warning');
    }
  });

  // ================= BACKEND =================
  async function fetchBackend(){
    const dt_inicio = $('#dtInicio').val();
    const dt_fim    = $('#dtFim').val();

    if (!dt_inicio || !dt_fim) {
      return Swal.fire('Atenção', 'Informe o período.', 'warning');
    }

    toggleLoading(true);

    try {
      const res = await axios.post(baseUrl, {
        method: 'listProducoesRealizadasBasico',
        token,
        data: {
          system_unit_id: Number(system_unit_id),
          data_inicial: dt_inicio,
          data_final: dt_fim
        }
      });

      if (!res.data || res.data.success === false) {
        toggleLoading(false);
        dadosBrutos = [];
        applyFiltrosTempoReal();
        return Swal.fire('Atenção', res.data?.message || 'Nenhum registro encontrado.', 'warning');
      }

      dadosBrutos = res.data.producoes || [];

      // Limpa filtro e aplica
      $('#filtroTexto').val('');
      applyFiltrosTempoReal();

      toggleLoading(false);

      if (dadosBrutos.length === 0) {
        Swal.fire('Info', 'Nenhuma produção no período.', 'info');
      }

    } catch (e) {
      console.error(e);
      toggleLoading(false);
      Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
    }
  }

  // ================= FILTROS & RENDER =================
  function applyFiltrosTempoReal(){
    const termo = ($('#filtroTexto').val() || '').trim().toLowerCase();
    let arr = Array.isArray(dadosBrutos) ? dadosBrutos.slice() : [];

    if (termo) {
      arr = arr.filter(p => {
        const prod = p.produto_final || {};
        const doc   = String(p.doc || '').toLowerCase();
        const data  = String(formatBRDate(p.data) || '').toLowerCase();
        const cod   = String(prod.codigo || '').toLowerCase();
        const nome  = String(prod.nome || '').toLowerCase();
        const unid  = String(prod.unidade || '').toLowerCase();

        return doc.includes(termo) || data.includes(termo) || cod.includes(termo) || nome.includes(termo) || unid.includes(termo);
      });
    }

    dadosFiltrados = arr;
    renderTotalizadores(arr);
    renderTabela(arr);
    renderInfoStatus();
  }

  function renderTotalizadores(lista) {
    const $qtd = $('#totRegistros');
    const $prod = $('#totProduzido');
    const $unid = $('#totUnidade');

    const $cardProd = $('#cardProduzido');
    const $cardUnid = $('#cardUnidade');

    // 1. Qtd Registros
    $qtd.text(lista.length);

    if (lista.length === 0) {
      $prod.text('---');
      $unid.text('---');
      // Reset cores
      $cardProd.removeClass('red green orange').addClass('green');
      $cardUnid.removeClass('red green orange').addClass('orange');
      return;
    }

    // 2. Verifica Unidade
    const primeiraUnidade = (lista[0].produto_final?.unidade || '').trim().toUpperCase();
    const isTodasIguais = lista.every(item => {
      const u = (item.produto_final?.unidade || '').trim().toUpperCase();
      return u === primeiraUnidade;
    });

    if (isTodasIguais && primeiraUnidade !== '') {
      // SOMA PERMITIDA
      const total = lista.reduce((acc, curr) => {
        return acc + Number(curr.produto_final?.quantidade_produzida || 0);
      }, 0);

      $prod.text(formatNumber(total));
      $unid.text(primeiraUnidade);

      // Visual Verde (OK)
      $cardUnid.removeClass('orange red').addClass('green');
    } else {
      // SOMA BLOQUEADA (Múltiplas unidades)
      $prod.text('---');
      $unid.text('Múltiplas');

      // Visual Laranja (Alerta)
      $cardUnid.removeClass('green red').addClass('orange');
    }
  }

  function renderInfoStatus(){
    const total = dadosBrutos.length;
    const filtrados = dadosFiltrados.length;

    if (total === 0) {
      $('#infoStatus').text('');
    } else if (filtrados !== total) {
      $('#infoStatus').html(`Exibindo <b>${filtrados}</b> de <b>${total}</b> produções.`);
    } else {
      $('#infoStatus').html(`Total de <b>${total}</b> produções.`);
    }
  }

  function renderTabela(lista){
    const $tbody = $('#tabela-producoes tbody');
    $tbody.empty();

    if (lista.length === 0) {
      $tbody.append('<tr><td colspan="6" class="text-center muted" style="padding: 30px;">Nenhum registro encontrado.</td></tr>');
      return;
    }

    // Limite para performance
    const limiteRender = 500;
    const renderList = lista.slice(0, limiteRender);

    renderList.forEach(p => {
      const prod = p.produto_final || {};

      $tbody.append(`
                <tr>
                  <td class="nowrap"><strong>${escapeHtml(p.doc)}</strong></td>
                  <td class="nowrap">${formatBRDate(p.data)}</td>
                  <td class="nowrap text-muted">${escapeHtml(prod.codigo)}</td>
                  <td>${escapeHtml(prod.nome)}</td>
                  <td class="text-center nowrap"><span class="badge badge-default" style="background:#eee; color:#555;">${escapeHtml(prod.unidade)}</span></td>
                  <td class="text-right nowrap"><strong>${formatNumber(prod.quantidade_produzida)}</strong></td>
                </tr>
            `);
    });

    if (lista.length > limiteRender) {
      $tbody.append(`<tr><td colspan="6" class="text-center text-warning" style="padding: 10px;">Exibindo apenas os primeiros ${limiteRender} registros. Refine sua busca.</td></tr>`);
    }
  }
</script>

</body>
</html>