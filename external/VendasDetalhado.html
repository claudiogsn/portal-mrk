<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Vendas Detalhado</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Header e Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        /* Ações */
        .btn-action {
            color: var(--mrk-blue);
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            display: inline-block;
        }
        .btn-action:hover { transform: scale(1.1); color: var(--mrk-black); }

        /* Skeleton */
        .skeleton-wrapper { display: none; margin-top: 20px; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Modal */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-black); font-weight: 600; }
        .modal-footer { border-top: 1px solid #eee; background: #fff; }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:sales-report" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                RELATÓRIO DE VENDAS DETALHADO
            </h2>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-3">
                        <label class="muted">Data Inicial</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dataInicio" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Data Final</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dataFim" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-6" style="margin-top: 22px; text-align: right;">
                        <button id="btnBuscar" class="btn btn-primary waves-effect" style="margin-right: 5px;">
                            <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            BUSCAR
                        </button>
                        <button id="btnExportarTabela" class="btn btn-success waves-effect">
                            <iconify-icon icon="icon-park-outline:file-excel" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            EXPORTAR TABELA
                        </button>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-bottom: 10px;">
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:filter"></iconify-icon></span>
                        <input type="text" id="filtro" class="form-control" placeholder="Filtrar resultado por Código ou Nome..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="relatorioTable">
                    <thead>
                    <tr>
                        <th width="60" class="text-center">Ações</th>
                        <th width="120">Código Insumo</th>
                        <th>Nome Insumo</th>
                        <th class="text-right">Venda Insumos</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="4" class="text-center muted" style="padding: 30px;">Selecione o período e clique em Buscar.</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="detalhesModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border-radius: 8px; border:none;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">
                    <iconify-icon icon="icon-park-outline:preview-open" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon>
                    Detalhes do Insumo
                </h4>
            </div>

            <div class="modal-body" style="padding: 0;">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cód. Produto</th>
                            <th>Nome Produto</th>
                            <th class="text-right">Qtd. Insumo</th>
                            <th class="text-right">Qtd. Vendida</th>
                            <th class="text-right">Uso Insumo</th>
                        </tr>
                        </thead>
                        <tbody id="detalhesProdutos">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button id="btnExportarDetalhes" class="btn btn-success waves-effect">
                    <iconify-icon icon="icon-park-outline:file-excel"></iconify-icon> Exportar Detalhes
                </button>
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script>
    // Configurações
    const baseUrl = window.location.hostname !== 'localhost' ?
        'https://portal.mrksolucoes.com.br/api/v1/index.php' :
        'http://localhost/portal-mrk/api/v1/index.php';

    const params = new URLSearchParams(window.location.search);
    const token  = params.get('token');
    const unitId = params.get('unit_id');

    // Helper: Skeleton Toggle
    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    // Init
    $(document).ready(function () {
        // Datas Padrão
        const today = new Date().toISOString().split('T')[0];
        $('#dataInicio').val(today);
        $('#dataFim').val(today);

        $('#btnBuscar').on('click', fetchAndRenderData);

        // Exportar Tabela Principal
        $('#btnExportarTabela').on('click', function () {
            const rows = [];
            $('#relatorioTable tbody tr:visible').each(function () {
                const cols = $(this).find('td');
                if (cols.length >= 4) {
                    rows.push({
                        "Código Insumo": $(cols[1]).text(),
                        "Nome Insumo": $(cols[2]).text(),
                        "Venda Insumos": $(cols[3]).text()
                    });
                }
            });
            exportToExcel(rows, "Relatorio_Vendas_Insumos");
        });
    });

    // Filtro Local
    window.filterTable = function() {
        const input = document.getElementById('filtro');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('#relatorioTable tbody tr');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    }

    // Busca API
    async function fetchAndRenderData() {
        const dataInicio = $('#dataInicio').val();
        const dataFim    = $('#dataFim').val();

        if (!dataInicio || !dataFim) return Swal.fire('Atenção', 'Informe o período.', 'warning');
        if (dataInicio > dataFim) return Swal.fire('Atenção', 'Data inicial maior que final.', 'warning');

        toggleLoading(true);

        try {
            const response = await axios.post(baseUrl, {
                method: 'getSalesByInsumos',
                token: token,
                data: {
                    system_unit_id: unitId,
                    data_inicio: dataInicio,
                    data_fim: dataFim
                }
            });

            if (response.data && Array.isArray(response.data)) {
                renderTable(response.data);
            } else if (response.data && response.data.error) {
                Swal.fire('Aviso', response.data.error, 'info');
                $('#relatorioTable tbody').empty();
            } else {
                Swal.fire('Erro', 'Erro ao buscar dados.', 'error');
            }
        } catch (error) {
            console.error("Erro:", error);
            Swal.fire('Erro', 'Erro de conexão.', 'error');
        } finally {
            toggleLoading(false);
        }
    }

    function renderTable(data) {
        const tbody = $('#relatorioTable tbody');
        tbody.empty();

        if (!data.length) {
            tbody.append('<tr><td colspan="4" class="text-center muted" style="padding: 20px;">Nenhum dado encontrado para o período.</td></tr>');
            return;
        }

        data.forEach(item => {
            // Encode item for data attribute
            const itemStr = encodeURIComponent(JSON.stringify(item));

            tbody.append(`
                <tr>
                    <td class="text-center">
                        <a class="btn-action ver-detalhes" data-item="${itemStr}" title="Ver Detalhes">
                            <iconify-icon icon="icon-park-outline:search"></iconify-icon>
                        </a>
                    </td>
                    <td>${item.codigo_insumo}</td>
                    <td>${item.nome_insumo}</td>
                    <td class="text-right"><strong>${item.sale_insumos}</strong></td>
                </tr>
            `);
        });

        // Bind Click
        $('.ver-detalhes').off('click').on('click', function (e) {
            e.preventDefault();
            const item = JSON.parse(decodeURIComponent($(this).data('item')));
            renderModal(item);
            $('#detalhesModal').modal('show');
        });

        // Reapply filter if exists
        filterTable();
    }

    function renderModal(item) {
        const tbody = $('#detalhesProdutos');
        tbody.empty();

        if (!item.produtos_vendidos || !item.produtos_vendidos.length) {
            tbody.append('<tr><td colspan="6" class="text-center muted">Nenhum produto vinculado.</td></tr>');
        } else {
            item.produtos_vendidos.forEach(prod => {
                tbody.append(`
                    <tr>
                        <td>${prod.data_movimento || '-'}</td>
                        <td>${prod.codigo_produto}</td>
                        <td>${prod.nome_produto}</td>
                        <td class="text-right">${prod.quantidade_insumo}</td>
                        <td class="text-right">${prod.quantidade_venda_produto}</td>
                        <td class="text-right">${prod.uso_insumo}</td>
                    </tr>
                `);
            });
        }

        // Setup Export Button
        $('#btnExportarDetalhes').off('click').on('click', function () {
            if (!item.produtos_vendidos || !item.produtos_vendidos.length) {
                Swal.fire('Aviso', 'Nada para exportar.', 'info');
                return;
            }
            exportToExcel(item.produtos_vendidos, `Detalhes_${item.nome_insumo}`);
        });
    }

    function exportToExcel(data, fileName) {
        if (!data || !data.length) return Swal.fire('Aviso', 'Não há dados para exportar.', 'info');

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, fileName);
        XLSX.writeFile(wb, `${fileName}.xlsx`);
    }

</script>

</body>
</html>