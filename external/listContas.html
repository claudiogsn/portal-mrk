<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Contas - Lista e Totais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        .header-flex { display:flex; align-items:center; }
        .btn-header-right { margin-left:auto; display:inline-flex; align-items:center; }
        .btn-header-right img { height:18px; margin-left:8px; vertical-align:middle; }
        /* Modal Fullscreen (mantido do seu modelo) */
        .modal-fullscreen { max-width:100%!important; width:100%!important; height:100%!important; margin:0!important; }
        .modal-fullscreen .modal-content { height:100%; border:0; border-radius:0; }
        .modal-fullscreen .modal-body { overflow-y:auto; }

        .form-control { margin-bottom:10px; }
        .label-success { background-color:#4caf50; }
        .label-danger  { background-color:#f44336; }
        .modal-iframe { width:100%; height:80vh; border:none; }

        /* Cards KPI */
        .kpi { text-align:center; padding:12px; border-radius:6px; border:1px solid #eee; }
        .kpi h4 { margin:4px 0 0 0; font-weight:700; }
        .kpi small { color:#333; opacity:.9; display:block; }
        .kpi.green { background:#e8f5e9; border-color:#c8e6c9; color:#2e7d32; }
        .kpi.red   { background:#ffebee; border-color:#ffcdd2; color:#c62828; }
        .kpi.blue  { background:#e3f2fd; border-color:#bbdefb; color:#1565c0; }

        .table thead th { white-space:nowrap; }
        .text-right { text-align:right; }

        /* Círculo de contorno para ícones do FA */
        .icon-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-radius: 50%;
            line-height: 1;
            font-size: 10px;
        }
        .icon-circle.green { color: #4caf50; }
        .icon-circle.red   { color: #f44336; }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2>Relação de Contas</h2>
            <button class="btn btn-primary btn-header-right" id="btnOpenExportF360">
                Export
                <img src="https://f360.com.br/wp-content/uploads/2023/08/79pcxj07x5p-768x333.png.webp" alt="F360">
            </button>
        </div>
        <div class="body">

            <!-- Filtros (um único row) -->
            <div class="row">
                <div class="col-md-2">
                    <label>Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Tipo de Data</label>
                    <select id="filtroTipoData" class="form-control">
                        <option value="emissao">Emissão</option>
                        <option value="vencimento" selected>Vencimento</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Tipo</label>
                    <select id="filtroTipo" class="form-control">
                        <option value="">Todas</option>
                        <option value="c">Crédito (c)</option>
                        <option value="d">Débito (d)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todos</option>
                        <option value="aberto">Em aberto</option>
                        <option value="pago">Pago</option>
                    </select>
                </div>
                <div class="col-md-2 text-right">
                    <label>&nbsp;</label><br>
                    <button class="btn btn-primary" id="btnBuscar">Buscar</button>
                </div>
            </div>

            <!-- Totalizadores -->
            <div class="row">
                <div class="col-md-4">
                    <div class="kpi green">
                        <small>Total de Créditos</small>
                        <h4 id="kpiCreditos">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi red">
                        <small>Total de Débitos</small>
                        <h4 id="kpiDebitos">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi blue">
                        <small>Diferença (Créditos − Débitos)</small>
                        <h4 id="kpiDiferenca">R$ 0,00</h4>
                    </div>
                </div>
            </div>

            <!-- BUSCA (entre KPIs e Grid) -->
            <div class="row">
                <div class="col-md-6">
                    <label>Buscar</label>
                    <input type="text" id="filtroBusca" class="form-control" placeholder="Digite para buscar em Entidade (nome) e Documento">
                </div>
            </div>

            <!-- Grid -->
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabelaContas">
                    <thead>
                    <tr>
                        <th style="width:40px;"></th> <!-- ação editar -->
                        <th style="width:40px;"></th> <!-- outras ações -->
                        <th style="width:40px;">Tipo</th>
                        <th>Entidade</th>
                        <th>Documento</th>
                        <th>Emissão</th>
                        <th>Data Vencimento</th>
                        <th>Observação</th>
                        <th>Status</th>
                        <th>Data Pagamento</th>
                        <th class="text-right">Valor</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- Modal (mantido do modelo) -->
<div class="modal fade" id="modalImportacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Importar</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeImportacao" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Modal Exportação F360 -->
<div class="modal fade" id="modalExportF360" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:1px solid #eee;">
                <h4 class="modal-title">Exportar para F360</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">
                <div id="expInfo" class="mb-2">
                    <small class="text-muted">Listando contas em aberto (débito) ainda não exportadas…</small>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tblExportF360">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Número</th>
                            <th>Observação</th>
                            <th>Cliente / Fornecedor</th>
                            <th>Emissão</th>
                            <th>Vencimento</th>
                            <th class="text-right">Valor</th>
                            <th>Plano de Conta</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                        <tr>
                            <th colspan="6" class="text-right">Total:</th>
                            <th class="text-right" id="expTotal">R$ 0,00</th>
                            <th></th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="modal-footer" style="border-top:1px solid #eee;">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnDoExportF360" disabled>
                    <i class="fa fa-file-excel"></i> Exportar XLSX
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    // === Configs iguais ao seu modelo ===
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token   = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';

    $('#btnOpenExportF360').hide();

    // === Helpers ===
    function toBRL(v){
        if (v === null || v === undefined || v === '') return 'R$ 0,00';
        const num = Number(v) || 0;
        return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }

    function setDefaultMonth(){
        const today = new Date();
        const y = today.getFullYear();
        const m = today.getMonth(); // 0..11
        const first = new Date(y, m, 1);
        const last  = new Date(y, m + 1, 0);
        const toInput = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
        $('#filtroDataInicial').val(toInput(first));
        $('#filtroDataFinal').val(toInput(last));
        $('#filtroTipoData').val('vencimento');
        $('#filtroTipo').val(''); // todas
        $('#filtroStatus').val(''); // todos
    }

    let contas = [];

    $(document).ready(function () {
        setDefaultMonth();
        checarIntegracaoF360();

        $('#btnBuscar').click(buscar);

        // filtros locais em tempo real
        $('#filtroStatus').on('change input', aplicarFiltrosLocais);
        $('#filtroBusca').on('input', aplicarFiltrosLocais);

        // busca inicial com os defaults
        buscar();
    });

    async function buscar(){
        if (!token || !unit_id){
            Swal.fire('Atenção', 'Parâmetros ausentes na URL (token e/ou unit_id).', 'warning');
            return;
        }

        const data_inicial = $('#filtroDataInicial').val();
        const data_final   = $('#filtroDataFinal').val();
        const tipoData     = $('#filtroTipoData').val(); // 'emissao' | 'vencimento'
        const tipo         = $('#filtroTipo').val();     // '' | 'c' | 'd'

        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });

        try {
            const payload = {
                method: 'listContas',
                token,
                data: {
                    system_unit_id: Number(unit_id),
                    data_inicial,
                    data_final,
                    tipoData,
                    ...(tipo ? { tipo } : {}) // se vazio, não envia (todas)
                }
            };
            const res = await axios.post(baseUrl, payload);

            if (Array.isArray(res.data)) {
                contas = res.data;
            } else if (res.data && res.data.success && Array.isArray(res.data.data)) {
                contas = res.data.data;
            } else if (Array.isArray(res.data?.response)) {
                contas = res.data.response;
            } else {
                contas = [];
            }

            aplicarFiltrosLocais(); // aplica status + busca local
            Swal.close();
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    // Normaliza string p/ busca (case-insensitive + sem acentos)
    function norm(s){
        return String(s || '')
            .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
            .toLowerCase();
    }

    // Filtros locais combinados: Status + Busca
    function aplicarFiltrosLocais(){
        const status = $('#filtroStatus').val(); // '' | 'aberto' | 'pago'
        const termo  = norm($('#filtroBusca').val());

        let lista = contas.slice();

        if (status === 'aberto') {
            lista = lista.filter(n => !n.baixa_dt);
        } else if (status === 'pago') {
            lista = lista.filter(n => !!n.baixa_dt);
        }

        if (termo) {
            lista = lista.filter(n => {
                const nome = norm(n.nome);
                const doc  = norm(n.doc);
                return (nome && nome.includes(termo)) || (doc && doc.includes(termo));
            });
        }

        renderTabela(lista);
        renderTotais(lista);
    }

    function renderTotais(lista){
        let totalCreditos = 0;
        let totalDebitos  = 0;

        for (const row of lista){
            const val = Number(row.valor) || 0;
            const t = (row.tipo || '').toString().trim().toLowerCase();
            if (t === 'c') totalCreditos += val;
            else if (t === 'd') totalDebitos += val;
        }

        const diferenca = totalCreditos - totalDebitos;
        $('#kpiCreditos').text(toBRL(totalCreditos));
        $('#kpiDebitos').text(toBRL(totalDebitos));
        $('#kpiDiferenca').text(toBRL(diferenca));
    }

    function renderTabela(lista){
        const tbody = $('#tabelaContas tbody');
        tbody.empty();

        if (!lista || !lista.length){
            tbody.append('<tr><td colspan="11" class="text-center">Nenhum registro encontrado.</td></tr>');
            return;
        }

        for (const n of lista){
            const emissao    = fmtDate(n.emissao);
            const vencimento = fmtDate(n.vencimento);
            const pagamento  = fmtDate(n.baixa_dt);

            const isPago = !!n.baixa_dt;
            const statusBadge = isPago
                ? '<span class="label label-success">Pago</span>'
                : '<span class="label label-warning">Em aberto</span>';

            const t = (n.tipo || '').toString().trim().toLowerCase();
            let tipoIcon = '<span class="icon-circle" style="color:#9e9e9e;"><i class="fa fa-question"></i></span>';
            if (t === 'c') tipoIcon = '<span class="icon-circle green" title="Crédito"><i class="fa fa-plus"></i></span>';
            if (t === 'd') tipoIcon = '<span class="icon-circle red" title="Débito"><i class="fa fa-minus"></i></span>';

            tbody.append(`
                <tr>
                    <td><a href="#" title="Editar"><i class="fa fa-edit blue"></i></a></td>
                    <td><a href="#" title="Outras ações"><i class="fa fa-ellipsis-v green"></i></a></td>
                    <td class="text-center">${tipoIcon}</td>
                    <td>${n.nome ?? ''}</td>
                    <td>${n.doc ?? ''}</td>
                    <td>${emissao}</td>
                    <td>${vencimento}</td>
                    <td title="${n.obs ?? ''}">${n.obs ? String(n.obs).slice(0, 80) : ''}</td>
                    <td>${statusBadge}</td>
                    <td>${pagamento}</td>
                    <td class="text-right">${toBRL(n.valor)}</td>
                </tr>
            `);
        }
    }

    // Exibição dd/mm/aaaa só no grid
    function fmtDate(iso) {
        if (!iso) return '';
        const s = String(iso).slice(0, 10); // 'YYYY-MM-DD'
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            const [y, m, d] = s.split('-');
            return `${d}/${m}/${y}`;
        }
        const d = new Date(iso);
        if (isNaN(d)) return '';
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
    }
    // ===== Estado do modal de exportação =====
    let expRows = []; // resultado de exportContasF360

    const F360_EMPRESA_CNPJ   = '26.144.579/0001-50';
    const F360_TIPO_TITULO    = 'PAGAR';
    const F360_TIPO_DOCUMENTO = 'Outros';
    const F360_CONTA_BANCARIA = 'SICOOB PITUBA';
    const F360_MEIO_PAGAMENTO = 'Boleto';
    const F360_CENTRO_CUSTO   = 'RED BURGER N BAR | PITUBA';
    const F360_COMPETENCIA    = '';

    // Abrir modal + listar
    $(document).on('click', '#btnOpenExportF360', function () {
        $('#modalExportF360').modal('show');
        listarParaExportF360();
    });

    // Chama sua API exportContasF360 e preenche a tabela
    async function listarParaExportF360() {
        $('#tblExportF360 tbody').empty();
        $('#btnDoExportF360').prop('disabled', true);
        $('#expTotal').text('R$ 0,00');

        if (!token || !unit_id) {
            return Swal.fire('Atenção', 'Parâmetros ausentes na URL (token e/ou unit_id).', 'warning');
        }

        try {
            Swal.fire({ title:'Carregando...', didOpen:()=>Swal.showLoading() });

            const res = await axios.post(baseUrl, {
                method: 'exportContasF360',
                token,
                data: { system_unit_id: Number(unit_id) }
            });

            Swal.close();

            if (!res.data || !res.data.success) {
                expRows = [];
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Falha ao listar.</td></tr>');
                return;
            }

            expRows = res.data.rows || [];

            if (!expRows.length) {
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Sem contas elegíveis para exportação.</td></tr>');
                return;
            }

            renderTabelaExportF360(expRows);
            $('#btnDoExportF360').prop('disabled', false);

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function toBRL(v){
        if (v === null || v === undefined || v === '') return 'R$ 0,00';
        const num = Number(v) || 0;
        return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }

    function renderTabelaExportF360(rows){
        const tbody = $('#tblExportF360 tbody').empty();
        let total = 0;

        rows.forEach((r, i) => {
            total += Number(r.valor) || 0;
            tbody.append(`
        <tr>
          <td>${i+1}</td>
          <td>${r.numero ?? ''}</td>
          <td title="${(r.observacao??'').replace(/"/g,'&quot;')}">${r.observacao ? String(r.observacao).slice(0,80) : ''}</td>
          <td>${r.cliente_fornecedor ?? ''}</td>
          <td>${r.emissao ?? ''}</td>
          <td>${r.vencimento ?? ''}</td>
          <td class="text-right">${toBRL(r.valor)}</td>
          <td>${r.plano_de_conta ?? ''}</td>
        </tr>
      `);
        });

        $('#expTotal').text(toBRL(total));
    }

    // Clique em Exportar XLSX
    $(document).on('click', '#btnDoExportF360', exportarXLSXF360);

    function exportarXLSXF360(){
        if (!expRows.length) {
            return Swal.fire('Atenção','Não há contas para exportar.','warning');
        }

        // Cabeçalho completo (ordem igual ao exemplo)
        const header = [
            'Empresa (CNPJ)',
            'Tipo Título',
            'Número',
            'OBSERVAÇÃO',
            'Cliente / Fornecedor (CPF/CNPJ OU NOME)',
            'Competência',
            'Emissão',
            'Vencimento',
            'Valor',
            'Tipo de Documento',
            'Conta Bancária',
            'Meio de Pagamento',
            'Plano de Conta',
            'Centro de Custo'
        ];

        // Linhas: mistura FIXOS + campos vindos da API
        const data = expRows.map(r => ([
            F360_EMPRESA_CNPJ,                  // Empresa (CNPJ)
            F360_TIPO_TITULO,                   // Tipo Título
            r.numero ?? '',                     // Número
            r.observacao ?? '',                 // OBSERVAÇÃO
            r.cliente_fornecedor ?? '',         // Cliente / Fornecedor
            F360_COMPETENCIA,                   // Competência
            r.emissao ?? '',                    // Emissão
            r.vencimento ?? '',                 // Vencimento
            Number(r.valor) || 0,               // Valor (numérico)
            F360_TIPO_DOCUMENTO,                // Tipo de Documento
            F360_CONTA_BANCARIA,                // Conta Bancária
            (r.forma_pagamento ?? ''),          // Meio de Pagamento (ex.: 'Boleto', 'PIX', ...)
            r.plano_de_conta ?? '',             // Plano de Conta
            F360_CENTRO_CUSTO                   // Centro de Custo
        ]));


        // Monta planilha
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([header, ...data]);

        // Larguras de coluna (ajuste fino se quiser)
        ws['!cols'] = [
            { wch: 20 }, // Empresa (CNPJ)
            { wch: 12 }, // Tipo Título
            { wch: 20 }, // Número
            { wch: 45 }, // Observação
            { wch: 42 }, // Cliente / Fornecedor
            { wch: 14 }, // Competência
            { wch: 12 }, // Emissão
            { wch: 12 }, // Vencimento
            { wch: 14 }, // Valor
            { wch: 18 }, // Tipo de Documento
            { wch: 20 }, // Conta Bancária
            { wch: 18 }, // Meio de Pagamento
            { wch: 26 }, // Plano de Conta
            { wch: 28 }  // Centro de Custo
        ];

        XLSX.utils.book_append_sheet(wb, ws, 'Exportação F360');

        // Nome do arquivo
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        const fname = `f360_export_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.xlsx`;

        // Baixa o arquivo
        XLSX.writeFile(wb, fname);

        // Depois de salvar, marca como exportado
        marcarExportadoF360(expRows.map(r => r.id));
    }
    async function marcarExportadoF360(ids){
        try {
            if (!ids || !ids.length) return;

            Swal.fire({ title:'Marcando exportados...', didOpen:()=>Swal.showLoading() });

            const res = await axios.post(baseUrl, {
                method: 'marcarExportadoF360',
                token,
                data: {
                    system_unit_id: Number(unit_id),
                    ids: ids
                }
            });

            Swal.close();

            if (!res.data || !res.data.success) {
                return Swal.fire('Atenção', res.data?.error || 'Não foi possível marcar como exportado.', 'warning');
            }

            Swal.fire('Sucesso', `Exportadas e marcadas: ${res.data.marcados}.`, 'success');

            // Atualiza a listagem (tabela principal) se quiser:
            // buscar();

            // Recarrega a listagem do modal para refletir o que ainda falta
            listarParaExportF360();

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Falha ao marcar exportados.', 'error');
        }
    }

    async function checarIntegracaoF360() {
        try {
            if (!token || !unit_id) {
                $('#btnOpenExportF360').remove();
                return;
            }

            const res = await axios.post(baseUrl, {
                method: 'hasF360Integration',
                token,
                data: { system_unit_id: Number(unit_id) }
            });

            const ativo = !!(res.data && res.data.success && res.data.active === 1);

            if (ativo) {
                $('#btnOpenExportF360').show();   // renderiza o botão
            } else {
                $('#btnOpenExportF360').remove(); // não renderiza
            }
        } catch (e) {
            console.error(e);
            $('#btnOpenExportF360').remove();     // em erro, não mostra
        }
    }

</script>
</body>
</html>
