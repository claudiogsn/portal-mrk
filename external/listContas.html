<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Contas - Lista e Totais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:bill" width="24" style="color: #0B46AC; vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                RELAÇÃO DE CONTAS
            </h2>
            <button class="btn btn-primary btn-header-right" id="btnOpenExportF360" style="display:none;">
                Export F360
                <img src="https://f360.com.br/wp-content/uploads/2023/08/79pcxj07x5p-768x333.png.webp" alt="F360">
            </button>
        </div>
        <div class="body">

            <div class="row clearfix">
                <div class="col-md-2">
                    <label class="muted">Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="muted">Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="muted">Tipo de Data</label>
                    <select id="filtroTipoData" class="form-control">
                        <option value="emissao">Emissão</option>
                        <option value="vencimento" selected>Vencimento</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="muted">Tipo</label>
                    <select id="filtroTipo" class="form-control">
                        <option value="">Todas</option>
                        <option value="c">Crédito</option>
                        <option value="d">Débito</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="muted">Rateio</label>
                    <select id="filtroRateio" class="form-control">
                        <option value="">Todos</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="muted">Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todos</option>
                        <option value="aberto">Não Quitado</option>
                        <option value="pago">Quitado</option>
                    </select>
                </div>
                <div class="col-md-2 text-right">
                    <label>&nbsp;</label><br>
                    <button class="btn btn-primary" id="btnBuscar" style="margin-right: 5px;">
                        <iconify-icon icon="icon-park-outline:search" width="16" style="vertical-align: middle; margin-right: 4px;"></iconify-icon> Buscar
                    </button>
                    <button class="btn btn-success" id="btnNovaConta">
                        <iconify-icon icon="icon-park-outline:add" width="16" style="vertical-align: middle; margin-right: 4px;"></iconify-icon> Nova
                    </button>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 15px;">
                <div class="col-md-4">
                    <div class="kpi green">
                        <small>Total de Créditos</small>
                        <h4 id="kpiCreditos">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi orange" style="border-left-color: var(--mrk-red) !important;"> <small style="color: var(--mrk-red);">Total de Débitos</small>
                        <h4 id="kpiDebitos" style="color: var(--mrk-red);">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi blue">
                        <small>Diferença (Créditos − Débitos)</small>
                        <h4 id="kpiDiferenca">R$ 0,00</h4>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 10px;">
                <div class="col-md-6">
                    <label class="muted">Buscar</label>
                    <div class="input-group">
                        <span class="input-group-addon">
                            <iconify-icon icon="icon-park-outline:search" width="18"></iconify-icon>
                        </span>
                        <input type="text" id="filtroBusca" class="form-control" placeholder="Digite para buscar em Entidade (nome) e Documento">
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-3" style="margin-top: 15px;">
                <table class="table table-striped table-hover" id="tabelaContas">
                    <thead>
                    <tr>
                        <th style="width:30px;"></th>
                        <th style="width:30px;"></th>
                        <th style="width:40px; text-align:center;">Tipo</th>
                        <th>Entidade</th>
                        <th>Documento</th>
                        <th>Emissão</th>
                        <th>Vencimento</th>
                        <th>Observação</th>
                        <th>Banco</th>
                        <th class="text-center">Rateio</th>
                        <th>Status</th>
                        <th>Baixa</th>
                        <th class="text-right">Valor</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalExportF360" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Exportar para F360</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="expInfo" class="mb-2"><small class="muted">Listando contas em aberto (débito) ainda não exportadas…</small></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tblExportF360">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Número</th>
                            <th>Observação</th>
                            <th>Cliente / Fornecedor</th>
                            <th>Emissão</th>
                            <th>Vencimento</th>
                            <th class="text-right">Valor</th>
                            <th>Plano de Conta</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                        <tr>
                            <th colspan="6" class="text-right">Total:</th>
                            <th class="text-right" id="expTotal">R$ 0,00</th>
                            <th></th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnDoExportF360" disabled>
                    <iconify-icon icon="icon-park-outline:file-excel" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> Exportar XLSX
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaConta" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-gray">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeNovaConta" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditConta" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-gray">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeEditConta" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // === Configs ===
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token   = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';

    $('#btnOpenExportF360').hide();

    // === Helpers ===
    function toBRL(v){
        if (v === null || v === undefined || v === '') return 'R$ 0,00';
        const num = Number(v) || 0;
        return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }

    function setDefaultMonth(){
        const today = new Date();
        const y = today.getFullYear();
        const m = today.getMonth();
        const first = new Date(y, m, 1);
        const last  = new Date(y, m + 1, 0);
        const toInput = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
        $('#filtroDataInicial').val(toInput(first));
        $('#filtroDataFinal').val(toInput(last));
        $('#filtroTipoData').val('vencimento');
        $('#filtroTipo').val('');
        $('#filtroStatus').val('');
        $('#filtroRateio').val('');
    }

    let contas = [];

    $(document).ready(function () {
        setDefaultMonth();
        checarIntegracaoF360();

        $('#btnBuscar').click(buscar);
        $('#filtroStatus, #filtroRateio').on('change input', aplicarFiltrosLocais);
        $('#filtroBusca').on('input', aplicarFiltrosLocais);

        buscar();
    });

    async function buscar(){
        if (!token || !unit_id){
            Swal.fire('Atenção', 'Parâmetros ausentes na URL (token e/ou unit_id).', 'warning');
            return;
        }

        const data_inicial = $('#filtroDataInicial').val();
        const data_final   = $('#filtroDataFinal').val();
        const tipoData     = $('#filtroTipoData').val();
        const tipo         = $('#filtroTipo').val();

        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });

        try {
            const payload = {
                method: 'listContas',
                token,
                data: { system_unit_id: Number(unit_id), data_inicial, data_final, tipoData, ...(tipo ? { tipo } : {}) }
            };
            const res = await axios.post(baseUrl, payload);

            if (Array.isArray(res.data)) { contas = res.data; }
            else if (res.data && res.data.success && Array.isArray(res.data.data)) { contas = res.data.data; }
            else if (Array.isArray(res.data?.response)) { contas = res.data.response; }
            else { contas = []; }

            aplicarFiltrosLocais();
            Swal.close();
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function norm(s){
        return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    }

    function aplicarFiltrosLocais(){
        const status = $('#filtroStatus').val();
        const rateio = $('#filtroRateio').val();
        const termo  = norm($('#filtroBusca').val());

        let lista = contas.slice();

        if (status === 'aberto') lista = lista.filter(n => !n.baixa_dt);
        else if (status === 'pago') lista = lista.filter(n => !!n.baixa_dt);

        if (rateio === '1') lista = lista.filter(n => String(n.rateio) == '1');
        else if (rateio === '0') lista = lista.filter(n => String(n.rateio) != '1');

        if (termo) {
            lista = lista.filter(n => {
                const nome = norm(n.nome);
                const doc  = norm(n.doc);
                return (nome && nome.includes(termo)) || (doc && doc.includes(termo));
            });
        }

        renderTabela(lista);
        renderTotais(lista);
    }

    function renderTotais(lista){
        let totalCreditos = 0;
        let totalDebitos  = 0;

        for (const row of lista){
            const val = Number(row.valor) || 0;
            const t = (row.tipo || '').toString().trim().toLowerCase();
            if (t === 'c') totalCreditos += val;
            else if (t === 'd') totalDebitos += val;
        }

        const diferenca = totalCreditos - totalDebitos;
        $('#kpiCreditos').text(toBRL(totalCreditos));
        $('#kpiDebitos').text(toBRL(totalDebitos));
        $('#kpiDiferenca').text(toBRL(diferenca));
    }

    function renderTabela(lista){
        const tbody = $('#tabelaContas tbody');
        tbody.empty();

        if (!lista || !lista.length){
            tbody.append('<tr><td colspan="13" class="text-center muted">Nenhum registro encontrado.</td></tr>');
            return;
        }

        for (const n of lista){
            const emissao    = fmtDate(n.emissao);
            const vencimento = fmtDate(n.vencimento);
            const pagamento  = fmtDate(n.baixa_dt);

            const isQuitado = !!n.baixa_dt;
            const statusBadge = isQuitado
                ? '<span class="label label-success">Quitado</span>'
                : '<span class="label label-danger">Não Quitado</span>';

            const isRateio = String(n.rateio) == '1';
            const rateioBadge = isRateio
                ? '<span class="label label-info">Sim</span>'
                : '<span class="label label-default">Não</span>';

            const t = (n.tipo || '').toString().trim().toLowerCase();
            let tipoIcon = '<span class="icon-circle"><iconify-icon icon="icon-park-outline:help"></iconify-icon></span>';
            if (t === 'c') tipoIcon = '<span class="icon-circle green" title="Crédito"><iconify-icon icon="icon-park-outline:plus"></iconify-icon></span>';
            if (t === 'd') tipoIcon = '<span class="icon-circle red" title="Débito"><iconify-icon icon="icon-park-outline:minus"></iconify-icon></span>';

            let bancoTexto = n.banco_codigo && n.banco_nome ? `${n.banco_codigo} - ${n.banco_nome}` : (n.banco_nome || n.banco_codigo || '');

            tbody.append(`
              <tr>
                <td>
                  <a href="#" class="btn-edit-conta" title="Editar" data-id="${n.id}" style="color:var(--mrk-blue);">
                    <iconify-icon icon="icon-park-outline:edit" width="18"></iconify-icon>
                  </a>
                </td>
                <td>
                  <a href="#" class="btn-delete-conta" title="Excluir"
                     data-id="${n.id}" data-nome="${(n.nome ?? '').replace(/"/g,'&quot;')}"
                     data-doc="${n.doc ?? ''}" data-emissao="${emissao}" data-vencimento="${vencimento}" data-valor="${n.valor ?? 0}"
                     style="color:var(--mrk-red);">
                    <iconify-icon icon="icon-park-outline:delete" width="18"></iconify-icon>
                  </a>
                </td>
                <td class="text-center">${tipoIcon}</td>
                <td>${n.nome ?? ''}</td>
                <td>${n.doc ?? ''}</td>
                <td>${emissao}</td>
                <td>${vencimento}</td>
                <td title="${n.obs ?? ''}">${n.obs ? String(n.obs).slice(0, 50) + '...' : ''}</td>
                <td>${bancoTexto}</td>
                <td class="text-center">${rateioBadge}</td>
                <td>${statusBadge}</td>
                <td>${pagamento}</td>
                <td class="text-right"><strong>${toBRL(n.valor)}</strong></td>
              </tr>
            `);
        }
    }

    function fmtDate(iso) {
        if (!iso) return '';
        const s = String(iso).slice(0, 10);
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            const [y, m, d] = s.split('-');
            return `${d}/${m}/${y}`;
        }
        return '';
    }

    // --- Export F360 ---
    let expRows = [];
    const F360_EMPRESA_CNPJ = '26.144.579/0001-50'; // Ajuste conforme necessário

    $(document).on('click', '#btnOpenExportF360', function () {
        $('#modalExportF360').modal('show');
        listarParaExportF360();
    });

    async function listarParaExportF360() {
        $('#tblExportF360 tbody').empty();
        $('#btnDoExportF360').prop('disabled', true);
        $('#expTotal').text('R$ 0,00');

        try {
            Swal.fire({ title:'Carregando...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, { method: 'exportContasF360', token, data: { system_unit_id: Number(unit_id) } });
            Swal.close();

            if (!res.data || !res.data.success) {
                expRows = [];
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Falha ao listar.</td></tr>');
                return;
            }
            expRows = res.data.rows || [];
            if (!expRows.length) {
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Sem contas elegíveis para exportação.</td></tr>');
                return;
            }
            renderTabelaExportF360(expRows);
            $('#btnDoExportF360').prop('disabled', false);
        } catch (e) { Swal.close(); Swal.fire('Erro', 'Falha na comunicação.', 'error'); }
    }

    function renderTabelaExportF360(rows){
        const tbody = $('#tblExportF360 tbody').empty();
        let total = 0;
        rows.forEach((r, i) => {
            total += Number(r.valor) || 0;
            tbody.append(`<tr><td>${i+1}</td><td>${r.numero??''}</td><td title="${(r.observacao??'').replace(/"/g,'&quot;')}">${r.observacao?String(r.observacao).slice(0,50):''}</td><td>${r.cliente_fornecedor??''}</td><td>${r.emissao??''}</td><td>${r.vencimento??''}</td><td class="text-right">${toBRL(r.valor)}</td><td>${r.plano_de_conta??''}</td></tr>`);
        });
        $('#expTotal').text(toBRL(total));
    }

    $(document).on('click', '#btnDoExportF360', exportarXLSXF360);

    function exportarXLSXF360(){
        if (!expRows.length) return Swal.fire('Atenção','Não há contas para exportar.','warning');
        const header = ['Empresa (CNPJ)', 'Tipo Título', 'Número', 'OBSERVAÇÃO', 'Cliente / Fornecedor', 'Competência', 'Emissão', 'Vencimento', 'Valor', 'Tipo de Documento', 'Conta Bancária', 'Meio de Pagamento', 'Plano de Conta', 'Centro de Custo'];
        const data = expRows.map(r => ([F360_EMPRESA_CNPJ, 'PAGAR', r.numero??'', r.observacao??'', r.cliente_fornecedor??'', '', r.emissao??'', r.vencimento??'', Number(r.valor)||0, 'Outros', 'SICOOB PITUBA', (r.forma_pagamento??''), r.plano_de_conta??'', 'RED BURGER N BAR | PITUBA']));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
        XLSX.utils.book_append_sheet(wb, ws, 'Exportação F360');
        const now = new Date();
        const fname = `f360_export_${now.toISOString().slice(0,19).replace(/[-:T]/g,'')}.xlsx`;
        XLSX.writeFile(wb, fname);
        marcarExportadoF360(expRows.map(r => r.id));
    }

    async function marcarExportadoF360(ids){
        try {
            if (!ids || !ids.length) return;
            const res = await axios.post(baseUrl, { method: 'marcarExportadoF360', token, data: { system_unit_id: Number(unit_id), ids: ids } });
            if (res.data.success) Swal.fire('Sucesso', `Exportadas e marcadas: ${res.data.marcados}.`, 'success');
            listarParaExportF360();
        } catch (e) { Swal.fire('Erro', 'Falha ao marcar exportados.', 'error'); }
    }

    async function checarIntegracaoF360() {
        try {
            if (!token || !unit_id) return;
            const res = await axios.post(baseUrl, { method: 'hasF360Integration', token, data: { system_unit_id: Number(unit_id) } });
            if (res.data && res.data.success && res.data.active === 1) $('#btnOpenExportF360').show();
        } catch (e) { console.error(e); }
    }

    // --- Modais ---
    $(document).on('click', '#btnNovaConta', function () {
        var url = baseUrlRedirect + '/external/createFinanceiroConta.html?user_id=' + encodeURIComponent(username) + '&token=' + encodeURIComponent(token) + '&system_unit_id=' + encodeURIComponent(unit_id);
        $('#iframeNovaConta').attr('src', url);
        $('#modalNovaConta').modal({ backdrop: 'static', keyboard: true }).modal('show');
    });
    $('#modalNovaConta').on('hidden.bs.modal', function () { $('#iframeNovaConta').attr('src', 'about:blank'); if (typeof buscar === 'function') buscar(); });

    $(document).on('click', '.btn-edit-conta', function (e) {
        e.preventDefault();
        const id = $(this).data('id');
        if (!id) return;
        const url = baseUrlRedirect + '/external/editFinanceiroConta.html?user_id=' + encodeURIComponent(username) + '&token=' + encodeURIComponent(token) + '&system_unit_id=' + encodeURIComponent(unit_id) + '&id=' + encodeURIComponent(id);
        $('#iframeEditConta').attr('src', url);
        $('#modalEditConta').modal({ backdrop: 'static', keyboard: true }).modal('show');
    });
    $('#modalEditConta').on('hidden.bs.modal', function () { $('#iframeEditConta').attr('src', 'about:blank'); if (typeof buscar === 'function') buscar(); });

    // Exclusão
    $(document).on('click', '.btn-delete-conta', function(e){
        e.preventDefault();
        const id = $(this).data('id');
        const info = { id, nome: $(this).data('nome'), doc: $(this).data('doc'), emissao: $(this).data('emissao'), vencimento: $(this).data('vencimento'), valor: $(this).data('valor') };
        abrirPopupExclusao(info);
    });

    async function abrirPopupExclusao(info){
        const htmlResumo = `<div style="text-align:left"><p><strong>Entidade:</strong> ${info.nome||'-'}</p><p><strong>Valor:</strong> ${toBRL(info.valor)}</p></div><hr><label>Motivo</label><textarea id="motivoExclusao" class="swal2-textarea" rows="3"></textarea>`;
        const { isConfirmed, value } = await Swal.fire({
            title: 'Excluir conta?', html: htmlResumo, icon: 'warning', showCancelButton: true, confirmButtonText: 'Excluir', confirmButtonColor: '#D32F2F',
            preConfirm: () => {
                const m = document.getElementById('motivoExclusao').value;
                if(!m) Swal.showValidationMessage('Informe o motivo');
                return m;
            }
        });
        if (isConfirmed) await excluirConta(info.id, value);
    }

    async function excluirConta(id, motivo){
        try {
            Swal.fire({ title:'Excluindo...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, { method: 'deleteConta', token, data: { id: Number(id), usuario_id: username, motivo: motivo } });
            Swal.close();
            if (!res.data || !res.data.success) return Swal.fire('Erro', res.data?.message || 'Falha ao excluir.', 'error');
            await Swal.fire('Sucesso', 'Conta excluída.', 'success');
            buscar();
        } catch (e){ Swal.fire('Erro', 'Falha na comunicação.', 'error'); }
    }
</script>
</body>
</html>