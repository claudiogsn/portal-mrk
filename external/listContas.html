<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Contas - Lista e Totais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* Estilos para a Multi-seleção */
        .linha-conta:hover {
            background-color: rgba(11, 70, 172, 0.05) !important;
        }
        .linha-selecionada {
            background-color: rgba(11, 70, 172, 0.15) !important;
        }

        /* Estilos para os Cards de Quitação em Lote */
        .card-quitacao {
            border: 1px solid #ddd;
            border-left: 4px solid var(--mrk-blue);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            background: #fafafa;
        }
        .card-quitacao h5 {
            margin-top: 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        /* Aumentar um pouco a área de clique do checkbox para facilitar */
        .check-conta {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:bill" width="24" style="color: #0B46AC; vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                RELAÇÃO DE CONTAS
            </h2>
            <button class="btn btn-primary btn-header-right" id="btnOpenExportF360" style="display:none;">
                Export F360
                <img src="https://f360.com.br/wp-content/uploads/2023/08/79pcxj07x5p-768x333.png.webp" alt="F360">
            </button>
        </div>
        <div class="body">

            <div class="row clearfix">
                <div class="col-lg-2 col-md-3 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-lg-2 col-md-3 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Tipo de Data</label>
                    <select id="filtroTipoData" class="form-control">
                        <option value="emissao">Emissão</option>
                        <option value="vencimento" selected>Vencimento</option>
                    </select>
                </div>
                <div class="col-lg-1 col-md-3 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Tipo</label>
                    <select id="filtroTipo" class="form-control">
                        <option value="">Todas</option>
                        <option value="c">Crédito</option>
                        <option value="d">Débito</option>
                    </select>
                </div>
                <div class="col-lg-1 col-md-4 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Rateio</label>
                    <select id="filtroRateio" class="form-control">
                        <option value="">Todos</option>
                        <option value="1">Sim</option>
                        <option value="0">Não</option>
                    </select>
                </div>
                <div class="col-lg-1 col-md-4 col-sm-6 col-xs-12" style="margin-bottom: 15px;">
                    <label class="muted">Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todos</option>
                        <option value="aberto">Não Quitado</option>
                        <option value="pago">Quitado</option>
                    </select>
                </div>

                <div class="col-lg-3 col-md-4 col-sm-12 col-xs-12" style="margin-bottom: 15px;">
                    <label class="hidden-sm hidden-xs">&nbsp;</label><br class="hidden-sm hidden-xs">
                    <div style="display: flex; gap: 5px; justify-content: flex-end; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="btnBuscar" title="Buscar">
                            <iconify-icon icon="icon-park-outline:search" width="16" style="vertical-align: middle;"></iconify-icon>
                        </button>
                        <button class="btn btn-warning" id="btnQuitarEmLote" title="Quitar Selecionadas">
                            <iconify-icon icon="icon-park-outline:check-one" width="16" style="vertical-align: middle;"></iconify-icon> Quitar
                        </button>
                        <button class="btn btn-success" id="btnNovaConta" title="Nova Conta">
                            <iconify-icon icon="icon-park-outline:add" width="16" style="vertical-align: middle;"></iconify-icon> Nova
                        </button>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 15px;">
                <div class="col-md-4">
                    <div class="kpi green">
                        <small>Total de Créditos</small>
                        <h4 id="kpiCreditos">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi orange" style="border-left-color: var(--mrk-red) !important;"> <small style="color: var(--mrk-red);">Total de Débitos</small>
                        <h4 id="kpiDebitos" style="color: var(--mrk-red);">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi blue">
                        <small>Diferença (Créditos − Débitos)</small>
                        <h4 id="kpiDiferenca">R$ 0,00</h4>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 10px;">
                <div class="col-md-6">
                    <label class="muted">Buscar</label>
                    <div class="input-group">
                        <span class="input-group-addon">
                            <iconify-icon icon="icon-park-outline:search" width="18"></iconify-icon>
                        </span>
                        <input type="text" id="filtroBusca" class="form-control" placeholder="Digite para buscar em Entidade (nome) e Documento">
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-3" style="margin-top: 15px;">
                <table class="table table-striped table-hover" id="tabelaContas">
                    <thead>
                    <tr>
                        <th style="width:30px; text-align:center;">
                            <input type="checkbox" id="checkAllContas" title="Selecionar Toda a Lista">
                            <label for="checkAllContas" style="margin-bottom: 0; cursor: pointer;" title="Selecionar Toda a Lista"></label>
                        </th>
                        <th style="width:30px;"></th>
                        <th style="width:30px;"></th>
                        <th style="width:40px; text-align:center;">Tipo</th>
                        <th>Entidade</th>
                        <th>Documento</th>
                        <th>Emissão</th>
                        <th>Vencimento</th>
                        <th>Observação</th>
                        <th>Banco</th>
                        <th class="text-center">Rateio</th>
                        <th>Status</th>
                        <th>Baixa</th>
                        <th class="text-right">Valor</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalQuitarLote" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Quitação de Contas em Lote</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <p class="muted mb-3">Preencha os dados de quitação para as contas selecionadas.</p>
                <div id="containerCardsQuitar" style="max-height: 55vh; overflow-y: auto; padding-right: 5px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarQuitarLote">
                    <iconify-icon icon="icon-park-outline:check" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> Confirmar Quitação
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalExportF360" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Exportar para F360</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="expInfo" class="mb-2"><small class="muted">Listando contas em aberto (débito) ainda não exportadas…</small></div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tblExportF360">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Número</th>
                            <th>Observação</th>
                            <th>Cliente / Fornecedor</th>
                            <th>Emissão</th>
                            <th>Vencimento</th>
                            <th class="text-right">Valor</th>
                            <th>Plano de Conta</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                        <tr>
                            <th colspan="6" class="text-right">Total:</th>
                            <th class="text-right" id="expTotal">R$ 0,00</th>
                            <th></th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnDoExportF360" disabled>
                    <iconify-icon icon="icon-park-outline:file-excel" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> Exportar XLSX
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNovaConta" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-gray">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeNovaConta" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditConta" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-gray">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeEditConta" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // === Configs ===
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token   = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';

    $('#btnOpenExportF360').hide();

    // === Helpers ===
    function toBRL(v){
        if (v === null || v === undefined || v === '') return 'R$ 0,00';
        const num = Number(v) || 0;
        return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    }

    function setDefaultMonth(){
        const today = new Date();
        const y = today.getFullYear();
        const m = today.getMonth();
        const first = new Date(y, m, 1);
        const last  = new Date(y, m + 1, 0);
        const toInput = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().substring(0,10);
        $('#filtroDataInicial').val(toInput(first));
        $('#filtroDataFinal').val(toInput(last));
        $('#filtroTipoData').val('vencimento');
        $('#filtroTipo').val('');
        $('#filtroStatus').val('');
        $('#filtroRateio').val('');
    }

    // === Variáveis Globais ===
    let contas = [];
    let contasFiltradasVisiveis = [];
    let listaFormasPagamento = [];

    $(document).ready(function () {
        setDefaultMonth();
        checarIntegracaoF360();
        carregarFormasPagamento();

        $('#btnBuscar').click(buscar);
        $('#filtroStatus, #filtroRateio').on('change input', aplicarFiltrosLocais);
        $('#filtroBusca').on('input', aplicarFiltrosLocais);

        buscar();
    });

    // === Funções Base ===
    async function carregarFormasPagamento(){
        try {
            const res = await axios.post(baseUrl, {
                method: 'listFormasPagamento',
                token,
                data: { system_unit_id: Number(unit_id), apenasAtivos: true }
            });
            listaFormasPagamento = Array.isArray(res.data) ? res.data : (res.data?.data || []);
        } catch(e) {
            console.error("Erro ao carregar formas de pagamento", e);
        }
    }

    async function buscar(){
        if (!token || !unit_id){
            Swal.fire('Atenção', 'Parâmetros ausentes na URL (token e/ou unit_id).', 'warning');
            return;
        }

        const data_inicial = $('#filtroDataInicial').val();
        const data_final   = $('#filtroDataFinal').val();
        const tipoData     = $('#filtroTipoData').val();
        const tipo         = $('#filtroTipo').val();

        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });

        try {
            const payload = {
                method: 'listContas',
                token,
                data: { system_unit_id: Number(unit_id), data_inicial, data_final, tipoData, ...(tipo ? { tipo } : {}) }
            };
            const res = await axios.post(baseUrl, payload);

            if (Array.isArray(res.data)) { contas = res.data; }
            else if (res.data && res.data.success && Array.isArray(res.data.data)) { contas = res.data.data; }
            else if (Array.isArray(res.data?.response)) { contas = res.data.response; }
            else { contas = []; }

            aplicarFiltrosLocais();
            Swal.close();
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function norm(s){
        return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();
    }

    function aplicarFiltrosLocais(){
        const status = $('#filtroStatus').val();
        const rateio = $('#filtroRateio').val();
        const termo  = norm($('#filtroBusca').val());

        let lista = contas.slice();

        if (status === 'aberto') lista = lista.filter(n => !n.baixa_dt);
        else if (status === 'pago') lista = lista.filter(n => !!n.baixa_dt);

        if (rateio === '1') lista = lista.filter(n => String(n.rateio) == '1');
        else if (rateio === '0') lista = lista.filter(n => String(n.rateio) != '1');

        if (termo) {
            lista = lista.filter(n => {
                const nome = norm(n.nome);
                const doc  = norm(n.doc);
                return (nome && nome.includes(termo)) || (doc && doc.includes(termo));
            });
        }

        contasFiltradasVisiveis = lista;

        renderTabela(lista);
        renderTotais(lista);

        $('#checkAllContas').prop('checked', false);
    }

    function renderTotais(lista){
        let totalCreditos = 0;
        let totalDebitos  = 0;

        for (const row of lista){
            const val = Number(row.valor) || 0;
            const t = (row.tipo || '').toString().trim().toLowerCase();
            if (t === 'c') totalCreditos += val;
            else if (t === 'd') totalDebitos += val;
        }

        const diferenca = totalCreditos - totalDebitos;
        $('#kpiCreditos').text(toBRL(totalCreditos));
        $('#kpiDebitos').text(toBRL(totalDebitos));
        $('#kpiDiferenca').text(toBRL(diferenca));
    }

    function renderTabela(lista){
        const tbody = $('#tabelaContas tbody');
        tbody.empty();

        if (!lista || !lista.length){
            tbody.append('<tr><td colspan="14" class="text-center muted">Nenhum registro encontrado.</td></tr>');
            return;
        }

        for (const n of lista){
            const emissao    = fmtDate(n.emissao);
            const vencimento = fmtDate(n.vencimento);
            const pagamento  = fmtDate(n.baixa_dt);

            const isQuitado = !!n.baixa_dt;
            const statusBadge = isQuitado
                ? '<span class="label label-success">Quitado</span>'
                : '<span class="label label-danger">Não Quitado</span>';

            const isRateio = String(n.rateio) == '1';
            const rateioBadge = isRateio
                ? '<span class="label label-info">Sim</span>'
                : '<span class="label label-default">Não</span>';

            const t = (n.tipo || '').toString().trim().toLowerCase();
            let tipoIcon = '<span class="icon-circle"><iconify-icon icon="icon-park-outline:help"></iconify-icon></span>';
            if (t === 'c') tipoIcon = '<span class="icon-circle green" title="Crédito"><iconify-icon icon="icon-park-outline:plus"></iconify-icon></span>';
            if (t === 'd') tipoIcon = '<span class="icon-circle red" title="Débito"><iconify-icon icon="icon-park-outline:minus"></iconify-icon></span>';

            let bancoTexto = n.banco_codigo && n.banco_nome ? `${n.banco_codigo} - ${n.banco_nome}` : (n.banco_nome || n.banco_codigo || '');

            tbody.append(`
              <tr class="linha-conta" title="Use Ctrl+Clique para selecionar (ou clique na caixa)" style="cursor: pointer;">
               <td class="text-center" style="vertical-align: middle;">
                    <input type="checkbox" id="check_${n.id}" name="check_${n.id}" class="check-conta" value="${n.id}">
                    <label for="check_${n.id}" style="margin-bottom: 0; cursor: pointer;"></label>
                </td>
                <td style="vertical-align: middle;">
                  <a href="#" class="btn-edit-conta" title="Editar" data-id="${n.id}" style="color:var(--mrk-blue);">
                    <iconify-icon icon="icon-park-outline:edit" width="18"></iconify-icon>
                  </a>
                </td>
                <td style="vertical-align: middle;">
                  <a href="#" class="btn-delete-conta" title="Excluir"
                     data-id="${n.id}" data-nome="${(n.nome ?? '').replace(/"/g,'&quot;')}"
                     data-doc="${n.doc ?? ''}" data-emissao="${emissao}" data-vencimento="${vencimento}" data-valor="${n.valor ?? 0}"
                     style="color:var(--mrk-red);">
                    <iconify-icon icon="icon-park-outline:delete" width="18"></iconify-icon>
                  </a>
                </td>
                <td class="text-center" style="vertical-align: middle;">${tipoIcon}</td>
                <td style="vertical-align: middle;">${n.nome ?? ''}</td>
                <td style="vertical-align: middle;">${n.doc ?? ''}</td>
                <td style="vertical-align: middle;">${emissao}</td>
                <td style="vertical-align: middle;">${vencimento}</td>
                <td title="${n.obs ?? ''}" style="vertical-align: middle;">${n.obs ? String(n.obs).slice(0, 50) + '...' : ''}</td>
                <td style="vertical-align: middle;">${bancoTexto}</td>
                <td class="text-center" style="vertical-align: middle;">${rateioBadge}</td>
                <td style="vertical-align: middle;">${statusBadge}</td>
                <td style="vertical-align: middle;">${pagamento}</td>
                <td class="text-right" style="vertical-align: middle;"><strong>${toBRL(n.valor)}</strong></td>
              </tr>
            `);
        }
    }

    function fmtDate(iso) {
        if (!iso) return '';
        const s = String(iso).slice(0, 10);
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
            const [y, m, d] = s.split('-');
            return `${d}/${m}/${y}`;
        }
        return '';
    }

    // ==========================================
    // MULTI-SELEÇÃO E TOTAIS COM FEEDBACK VISUAL
    // ==========================================
    function atualizarTotaisPorSelecao() {
        const idsSelecionados = $('.check-conta:checked').map(function() {
            return String($(this).val());
        }).get();

        if (idsSelecionados.length === 0) {
            renderTotais(contasFiltradasVisiveis);
            return;
        }

        const listaSelecionada = contasFiltradasVisiveis.filter(n => idsSelecionados.includes(String(n.id)));
        renderTotais(listaSelecionada);
    }

    $(document).on('change', '#checkAllContas', function() {
        const isChecked = $(this).is(':checked');
        $('.check-conta').prop('checked', isChecked);

        if (isChecked) {
            $('.linha-conta').addClass('linha-selecionada');
        } else {
            $('.linha-conta').removeClass('linha-selecionada');
        }

        atualizarTotaisPorSelecao();
    });

    // Se a pessoa clica direto na caixa de seleção, mudamos a cor da linha
    $(document).on('change', '.check-conta', function() {
        const $tr = $(this).closest('tr');

        if ($(this).is(':checked')) {
            $tr.addClass('linha-selecionada');
        } else {
            $tr.removeClass('linha-selecionada');
        }

        const total = $('.check-conta').length;
        const marcados = $('.check-conta:checked').length;
        $('#checkAllContas').prop('checked', total > 0 && total === marcados);

        atualizarTotaisPorSelecao();
    });

    // Se a pessoa clica na LINHA COM CTRL (impedimos conflito se ela clicou direto na caixinha)
    $(document).on('click', '.linha-conta', function(e) {
        // Se a pessoa clicou exatamente num link, botão ou na própria checkbox, não fazemos nada,
        // deixamos o evento natural da checkbox ou botão rodar
        if ($(e.target).closest('a, button, input[type="checkbox"]').length) return;

        // Se clicou segurando Ctrl ou Cmd (Mac)
        if (e.ctrlKey || e.metaKey) {
            const $chk = $(this).find('.check-conta');
            $chk.prop('checked', !$chk.prop('checked')).trigger('change');

            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
        }
    });

    // ==========================================
    // QUITAÇÃO EM LOTE
    // ==========================================
    $(document).on('click', '#btnQuitarEmLote', function() {
        const selecionadas = $('.check-conta:checked');

        if (selecionadas.length === 0) {
            return Swal.fire('Atenção', 'Selecione ao menos uma conta para quitar.', 'warning');
        }

        if (selecionadas.length > 10) {
            return Swal.fire('Atenção', `Você selecionou ${selecionadas.length} contas. O limite máximo para quitação em lote é de 10 contas por vez.`, 'warning');
        }

        const container = $('#containerCardsQuitar');
        container.empty();

        const hoje = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().substring(0, 10);

        let optionsFormas = '<option value="">Selecione...</option>';
        listaFormasPagamento.forEach(f => {
            const idValue = f.id || f.codigo;
            optionsFormas += `<option value="${idValue}">${f.codigo} - ${f.nome}</option>`;
        });

        selecionadas.each(function() {
            const id = $(this).val();
            const conta = contasFiltradasVisiveis.find(c => String(c.id) === String(id));

            if (conta) {
                const cardHtml = `
                    <div class="card-quitacao" data-id="${conta.id}">
                        <h5><iconify-icon icon="icon-park-outline:bill"></iconify-icon> ${conta.nome || '-'} (Doc: ${conta.doc || '-'}) - <strong>${toBRL(conta.valor)}</strong></h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Data de Baixa</label>
                                <input type="date" class="form-control input-baixa-dt" value="${hoje}" required>
                            </div>
                            <div class="col-md-6">
                                <label>Forma de Pagamento</label>
                                <select class="form-control input-forma-pgto" required>
                                    ${optionsFormas}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                container.append(cardHtml);
            }
        });

        $('#modalQuitarLote').modal({ backdrop: 'static', keyboard: false }).modal('show');
    });

    $(document).on('click', '#btnConfirmarQuitarLote', async function() {
        const cards = $('.card-quitacao');
        const payloadData = [];
        let formValido = true;

        cards.each(function() {
            const id = $(this).data('id');
            const baixa_dt = $(this).find('.input-baixa-dt').val();
            const forma_pagamento = $(this).find('.input-forma-pgto').val();

            if (!baixa_dt || !forma_pagamento) {
                formValido = false;
            }

            payloadData.push({
                id: Number(id),
                usuario_id: username ? Number(username) : 0,
                baixa_dt: baixa_dt,
                forma_pagamento: Number(forma_pagamento)
            });
        });

        if (!formValido) {
            return Swal.fire('Atenção', 'Preencha Data e Forma de Pagamento em todos os cards.', 'warning');
        }

        try {
            Swal.fire({ title: 'Processando quitação...', didOpen: () => Swal.showLoading() });

            const payload = {
                method: 'baixarContasEmLote',
                token: token,
                data: payloadData
            };

            const res = await axios.post(baseUrl, payload);
            Swal.close();

            if (res.data && res.data.success !== false) {
                Swal.fire('Sucesso', 'Contas quitadas com sucesso!', 'success');
                $('#modalQuitarLote').modal('hide');

                $('#checkAllContas').prop('checked', false);
                buscar();
            } else {
                Swal.fire('Erro', res.data?.message || 'Ocorreu um erro ao baixar as contas.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor durante a quitação em lote.', 'error');
        }
    });

    // === Export F360 ===
    let expRows = [];
    const F360_EMPRESA_CNPJ = '26.144.579/0001-50';

    $(document).on('click', '#btnOpenExportF360', function () {
        $('#modalExportF360').modal('show');
        listarParaExportF360();
    });

    async function listarParaExportF360() {
        $('#tblExportF360 tbody').empty();
        $('#btnDoExportF360').prop('disabled', true);
        $('#expTotal').text('R$ 0,00');

        try {
            Swal.fire({ title:'Carregando...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, { method: 'exportContasF360', token, data: { system_unit_id: Number(unit_id) } });
            Swal.close();

            if (!res.data || !res.data.success) {
                expRows = [];
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Falha ao listar.</td></tr>');
                return;
            }
            expRows = res.data.rows || [];
            if (!expRows.length) {
                $('#tblExportF360 tbody').append('<tr><td colspan="8" class="text-center">Sem contas elegíveis para exportação.</td></tr>');
                return;
            }
            renderTabelaExportF360(expRows);
            $('#btnDoExportF360').prop('disabled', false);
        } catch (e) { Swal.close(); Swal.fire('Erro', 'Falha na comunicação.', 'error'); }
    }

    function renderTabelaExportF360(rows){
        const tbody = $('#tblExportF360 tbody').empty();
        let total = 0;
        rows.forEach((r, i) => {
            total += Number(r.valor) || 0;
            tbody.append(`<tr><td>${i+1}</td><td>${r.numero??''}</td><td title="${(r.observacao??'').replace(/"/g,'&quot;')}">${r.observacao?String(r.observacao).slice(0,50):''}</td><td>${r.cliente_fornecedor??''}</td><td>${r.emissao??''}</td><td>${r.vencimento??''}</td><td class="text-right">${toBRL(r.valor)}</td><td>${r.plano_de_conta??''}</td></tr>`);
        });
        $('#expTotal').text(toBRL(total));
    }

    $(document).on('click', '#btnDoExportF360', exportarXLSXF360);

    function exportarXLSXF360(){
        if (!expRows.length) return Swal.fire('Atenção','Não há contas para exportar.','warning');
        const header = ['Empresa (CNPJ)', 'Tipo Título', 'Número', 'OBSERVAÇÃO', 'Cliente / Fornecedor', 'Competência', 'Emissão', 'Vencimento', 'Valor', 'Tipo de Documento', 'Conta Bancária', 'Meio de Pagamento', 'Plano de Conta', 'Centro de Custo'];
        const data = expRows.map(r => ([F360_EMPRESA_CNPJ, 'PAGAR', r.numero??'', r.observacao??'', r.cliente_fornecedor??'', '', r.emissao??'', r.vencimento??'', Number(r.valor)||0, 'Outros', 'SICOOB PITUBA', (r.forma_pagamento??''), r.plano_de_conta??'', 'RED BURGER N BAR | PITUBA']));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
        XLSX.utils.book_append_sheet(wb, ws, 'Exportação F360');
        const now = new Date();
        const fname = `f360_export_${now.toISOString().slice(0,19).replace(/[-:T]/g,'')}.xlsx`;
        XLSX.writeFile(wb, fname);
        marcarExportadoF360(expRows.map(r => r.id));
    }

    async function marcarExportadoF360(ids){
        try {
            if (!ids || !ids.length) return;
            const res = await axios.post(baseUrl, { method: 'marcarExportadoF360', token, data: { system_unit_id: Number(unit_id), ids: ids } });
            if (res.data.success) Swal.fire('Sucesso', `Exportadas e marcadas: ${res.data.marcados}.`, 'success');
            listarParaExportF360();
        } catch (e) { Swal.fire('Erro', 'Falha ao marcar exportados.', 'error'); }
    }

    async function checarIntegracaoF360() {
        try {
            if (!token || !unit_id) return;
            const res = await axios.post(baseUrl, { method: 'hasF360Integration', token, data: { system_unit_id: Number(unit_id) } });
            if (res.data && res.data.success && res.data.active === 1) $('#btnOpenExportF360').show();
        } catch (e) { console.error(e); }
    }

    // === Modais Edição, Deleção e Inserção ===
    $(document).on('click', '#btnNovaConta', function () {
        var url = baseUrlRedirect + '/external/createFinanceiroConta.html?user_id=' + encodeURIComponent(username) + '&token=' + encodeURIComponent(token) + '&system_unit_id=' + encodeURIComponent(unit_id);
        $('#iframeNovaConta').attr('src', url);
        $('#modalNovaConta').modal({ backdrop: 'static', keyboard: true }).modal('show');
    });
    $('#modalNovaConta').on('hidden.bs.modal', function () { $('#iframeNovaConta').attr('src', 'about:blank'); if (typeof buscar === 'function') buscar(); });

    $(document).on('click', '.btn-edit-conta', function (e) {
        e.preventDefault();
        const id = $(this).data('id');
        if (!id) return;
        const url = baseUrlRedirect + '/external/editFinanceiroConta.html?user_id=' + encodeURIComponent(username) + '&token=' + encodeURIComponent(token) + '&system_unit_id=' + encodeURIComponent(unit_id) + '&id=' + encodeURIComponent(id);
        $('#iframeEditConta').attr('src', url);
        $('#modalEditConta').modal({ backdrop: 'static', keyboard: true }).modal('show');
    });
    $('#modalEditConta').on('hidden.bs.modal', function () { $('#iframeEditConta').attr('src', 'about:blank'); if (typeof buscar === 'function') buscar(); });

    // Exclusão
    $(document).on('click', '.btn-delete-conta', function(e){
        e.preventDefault();
        const id = $(this).data('id');
        const info = { id, nome: $(this).data('nome'), doc: $(this).data('doc'), emissao: $(this).data('emissao'), vencimento: $(this).data('vencimento'), valor: $(this).data('valor') };
        abrirPopupExclusao(info);
    });

    async function abrirPopupExclusao(info){
        const htmlResumo = `<div style="text-align:left"><p><strong>Entidade:</strong> ${info.nome||'-'}</p><p><strong>Valor:</strong> ${toBRL(info.valor)}</p></div><hr><label>Motivo</label><textarea id="motivoExclusao" class="swal2-textarea" rows="3"></textarea>`;
        const { isConfirmed, value } = await Swal.fire({
            title: 'Excluir conta?', html: htmlResumo, icon: 'warning', showCancelButton: true, confirmButtonText: 'Excluir', confirmButtonColor: '#D32F2F',
            preConfirm: () => {
                const m = document.getElementById('motivoExclusao').value;
                if(!m) Swal.showValidationMessage('Informe o motivo');
                return m;
            }
        });
        if (isConfirmed) await excluirConta(info.id, value);
    }

    async function excluirConta(id, motivo){
        try {
            Swal.fire({ title:'Excluindo...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, { method: 'deleteConta', token, data: { id: Number(id), usuario_id: username, motivo: motivo } });
            Swal.close();
            if (!res.data || !res.data.success) return Swal.fire('Erro', res.data?.message || 'Falha ao excluir.', 'error');
            await Swal.fire('Sucesso', 'Conta excluída.', 'success');
            buscar();
        } catch (e){ Swal.fire('Erro', 'Falha na comunicação.', 'error'); }
    }
</script>
</body>
</html>