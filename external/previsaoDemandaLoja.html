<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsão Demanda - Loja</title>

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet" />
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet" />
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet" />
    <link href="style/mrk.css" rel="stylesheet" />

    <style>
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <h2> </h2>
        <br>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="header">
                    <h2>
                        <iconify-icon icon="icon-park-outline:chart-line" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                        PREVISÃO DEMANDA - LOJA
                    </h2>
                </div>
                <div class="body">
                    <form id="transferForm">

                        <div class="row clearfix">
                            <div class="col-md-12 text-center">
                                <p style="margin-bottom: 8px; color: #777; font-family: 'Kanit', sans-serif;"><b>SELECIONE O MÉTODO DE CÁLCULO</b></p>

                                <input type="checkbox" id="calc-method-toggle" style="display:none;">

                                <div class="segmented-control">
                                    <div class="segment-option active" id="seg-historico" onclick="toggleSegment(false)">
                                        <iconify-icon icon="icon-park-outline:history" width="18" style="margin-right: 6px;"></iconify-icon>
                                        Média Histórica
                                    </div>
                                    <div class="segment-option" id="seg-projecao" onclick="toggleSegment(true)">
                                        <iconify-icon icon="icon-park-outline:analysis" width="18" style="margin-right: 6px;"></iconify-icon>
                                        Projeção Definida
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="row">
                            <div class="col-md-12">
                                <h5 style="color: #0B46AC; margin-bottom: 15px; font-family: 'Kanit', sans-serif;">PERÍODO DE ANÁLISE</h5>
                                <div class="demo-checkbox">
                                    <input type="checkbox" id="day_0" class="chk-col-blue" /> <label for="day_0">Domingo</label>
                                    <input type="checkbox" id="day_1" class="chk-col-blue" /> <label for="day_1">Segunda</label>
                                    <input type="checkbox" id="day_2" class="chk-col-blue" /> <label for="day_2">Terça</label>
                                    <input type="checkbox" id="day_3" class="chk-col-blue" /> <label for="day_3">Quarta</label>
                                    <input type="checkbox" id="day_4" class="chk-col-blue" /> <label for="day_4">Quinta</label>
                                    <input type="checkbox" id="day_5" class="chk-col-blue" /> <label for="day_5">Sexta</label>
                                    <input type="checkbox" id="day_6" class="chk-col-blue" /> <label for="day_6">Sábado</label>
                                </div>
                            </div>
                        </div>
                        <br>

                        <div class="row">
                            <div class="col-md-4">
                                <label for="unit-select" style="font-family: 'Kanit', sans-serif;">Empresa</label>
                                <select id="unit-select" class="form-control" style="width: 100%;" required>
                                    <option value="">Carregando...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="modelos-select" style="font-family: 'Kanit', sans-serif;">Modelo de Balanço:</label>
                                <select id="modelos-select" name="modelos-select" class="form-control"></select>
                            </div>
                            <div class="col-md-2" style="margin-top: 25px;">
                                <button type="button" id="add-item" class="btn btn-primary waves-effect btn-block">
                                    <iconify-icon icon="icon-park-outline:search" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                                    CONSULTAR
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="body table-responsive">
            <table id="result-table" class="table table-striped table-hover">
                <thead>
                <tr style="background-color: #f0f0f0;">
                    <th width="10%">Código</th>
                    <th width="35%">Produto</th>
                    <th width="15%">Vendas (+)</th>
                    <th width="15%">Saldo (-)</th>
                    <th width="15%">Recomendado (=)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <center>
        <div class="text-center" style="margin-top: 20px; margin-bottom: 40px;">
            <button id="print-filtered-button" class="btn btn-primary waves-effect">
                <iconify-icon icon="icon-park-outline:printer" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                Imprimir Filtrado
            </button>
            <button id="print-full-button" class="btn btn-default waves-effect">
                <iconify-icon icon="icon-park-outline:printer" width="18" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                Imprimir Completo
            </button>
        </div>
    </center>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="bsb/plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    window.toggleSegment = function(isProjecao) {
        const check = document.getElementById('calc-method-toggle');
        const btnHist = document.getElementById('seg-historico');
        const btnProj = document.getElementById('seg-projecao');
        check.checked = isProjecao;
        if (isProjecao) {
            btnHist.classList.remove('active');
            btnProj.classList.add('active');
        } else {
            btnHist.classList.add('active');
            btnProj.classList.remove('active');
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        const baseUrl = window.location.hostname !== 'localhost'
            ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
            : 'http://localhost/portal-mrk/api/v1/index.php';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const username = urlParams.get('username');

        let importedProductCodes = [];
        let unitName = '';
        let userName = '';

        function getSelectedDayIndices() {
            const dias = [];
            for (let i = 0; i <= 6; i++) { if (document.getElementById(`day_${i}`).checked) dias.push(i); }
            return dias;
        }

        function calcularUltimas4DatasPorSemana() {
            const today = new Date();
            const diasSelecionados = getSelectedDayIndices();
            if (diasSelecionados.length === 0) {
                Swal.fire('Atenção', 'Selecione pelo menos um dia da semana.', 'warning');
                return [];
            }
            function getLastDatesForDay(dayOfWeek) {
                const dates = [];
                let currentDate = new Date(today);
                currentDate.setDate(currentDate.getDate() - 1);
                while (dates.length < 4) {
                    if (currentDate.getDay() === dayOfWeek) dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() - 1);
                }
                return dates;
            }
            const allDates = [];
            diasSelecionados.forEach(day => allDates.push(...getLastDatesForDay(day)));
            return Array.from(new Set(allDates.map(date => date.toISOString().split('T')[0]))).sort();
        }

        async function loadUnidades() {
            try {
                const res = await axios.post(baseUrl, { method: 'getFiliaisByMatriz', token: token, data: { unit_matriz_id: username } });
                const select = document.getElementById('unit-select');
                select.innerHTML = '<option value="">Selecione uma empresa</option>';
                res.data.forEach(filial => {
                    select.appendChild(new Option(filial.filial_nome, filial.filial_id));
                });
                $('#unit-select').select2({ placeholder: 'Pesquise a empresa...', allowClear: true });
                $('#unit-select').on('select2:select', function (e) { loadModelos(e.params.data.id); });
            } catch(e) {
                console.error("Erro unidades", e);
                $('#unit-select').html('<option>Erro ao carregar</option>');
            }
        }

        async function loadModelos(unitId) {
            const select = document.getElementById('modelos-select');
            select.innerHTML = '<option disabled selected>Carregando...</option>';
            try {
                const res = await axios.post(baseUrl, { method: 'listModelosWithProducts', token: token, data: { unit_id: unitId } });
                select.innerHTML = '<option value="">Selecione um modelo</option>';
                res.data.modelos.forEach(modelo => select.appendChild(new Option(modelo.nome, modelo.tag)));
            } catch (e) { select.innerHTML = '<option value="">Erro ao carregar</option>'; }
        }

        async function loadProdutosDoModelo(tag) {
            try {
                const res = await axios.post(baseUrl, { method: 'getModelByTag', data: { tag: tag } });
                const produtosModelo = res.data.itens;
                importedProductCodes = [];
                for (const cat in produtosModelo) {
                    produtosModelo[cat].forEach(i => importedProductCodes.push(i.codigo_produto));
                }
            } catch(e) { console.error("Erro produtos", e); }
        }

        async function calcularNecessidades() {
            const selectedUnitId = $('#unit-select').val();
            const allSelectedProducts = importedProductCodes;
            const isProjecao = document.getElementById('calc-method-toggle').checked;
            const diasIndices = getSelectedDayIndices();

            if (!selectedUnitId || diasIndices.length === 0 || allSelectedProducts.length === 0) {
                Swal.fire('Atenção', 'Preencha empresa, dias e modelo.', 'warning');
                return;
            }

            const thVendas = document.querySelector('#result-table thead th:nth-child(3)');
            thVendas.innerText = isProjecao ? "Projeção (+)" : "Média Vendas (+)";

            Swal.fire({ title: 'Calculando...', didOpen: () => Swal.showLoading() });

            try {
                let result;
                if (isProjecao) {
                    const response = await axios.post(baseUrl, { method: 'getInsumoProjection', token: token, data: { system_unit_id: selectedUnitId, daysOfWeek: diasIndices, insumoIds: allSelectedProducts, user_id: username } });
                    result = response.data;
                } else {
                    const dates = calcularUltimas4DatasPorSemana();
                    const configResp = await axios.post(baseUrl, { method: 'getConfigGroupByUnitId', token: token, data: { system_unit_id: selectedUnitId } });
                    const useTop3 = configResp?.data?.consumo_media3 == 1;
                    const metodo = useTop3 ? 'getInsumoConsumptionTop3' : 'getInsumoConsumption';
                    const response = await axios.post(baseUrl, { method: metodo, token: token, data: { system_unit_id: selectedUnitId, dates: dates, productCodes: allSelectedProducts, insumoIds: allSelectedProducts, username: username, user_id: username } });
                    result = response.data;
                }

                if (!result || !Array.isArray(result.consumos)) throw new Error("Erro API");

                unitName = result.unidade;
                userName = result.usuario;

                const produtosAgrupados = result.consumos.reduce((acc, produto) => {
                    if (!acc[produto.categoria]) acc[produto.categoria] = [];
                    acc[produto.categoria].push(produto);
                    return acc;
                }, {});

                renderItensByCategory(produtosAgrupados);
                Swal.close();
            } catch (error) { console.error(error); Swal.fire('Erro', 'Falha ao processar.', 'error'); }
        }

        function renderItensByCategory(itens) {
            const tbody = $('#result-table tbody');
            tbody.empty();
            for (const categoria in itens) {
                tbody.append(`<tr class="category-header"><td colspan="5" style="background-color: #f9f9f9; font-weight: bold;">${categoria}</td></tr>`);
                itens[categoria].forEach(produto => {
                    tbody.append(`<tr>
                        <td>${produto.codigo}</td>
                        <td>${produto.nome || 'Produto não encontrado'}</td>
                        <td>${produto.sales}</td>
                        <td>${produto.saldo}</td>
                        <td><input type="number" step="0.01" class="form-control recomendado-input" value="${produto.recomendado}" /></td>
                    </tr>`);
                });
            }
        }

        // ==========================================
        // LÓGICA DE IMPRESSÃO CORRIGIDA E INTEGRADA
        // ==========================================

        function printFilteredTable(event) {
            event.preventDefault();
            const table = document.getElementById('result-table');
            const rows = Array.from(table.getElementsByTagName('tr'));

            // 1. Aplica Filtro: Oculta linhas com Recomendado = 0
            rows.forEach(row => {
                if(row.classList.contains('category-header')) return; // Pula cabeçalhos por enquanto

                const cells = row.getElementsByTagName('td');
                // Coluna 4 (índice 4) é onde está o input
                if (cells.length >= 5) {
                    const input = cells[4].querySelector('input');
                    const recomendado = input ? (parseFloat(input.value) || 0) : 0;

                    if (recomendado === 0) {
                        row.classList.add('temp-hidden');
                        row.style.display = 'none';
                    }
                }
            });

            // 2. Aplica Filtro: Oculta categorias vazias
            // Percorre as linhas para ver se a categoria tem filhos visíveis
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].classList.contains('category-header')) {
                    let hasVisibleProduct = false;
                    for (let j = i + 1; j < rows.length; j++) {
                        if (rows[j].classList.contains('category-header')) break; // Próxima categoria
                        if (rows[j].style.display !== 'none') {
                            hasVisibleProduct = true;
                            break;
                        }
                    }
                    if (!hasVisibleProduct) {
                        rows[i].classList.add('temp-hidden');
                        rows[i].style.display = 'none';
                    }
                }
            }

            // 3. Chama impressão escondendo colunas 2 e 3 (Vendas e Saldo)
            printTable([2, 3]);

            // 4. Restaura visualização
            rows.forEach(row => {
                if (row.classList.contains('temp-hidden')) {
                    row.style.display = '';
                    row.classList.remove('temp-hidden');
                }
            });
        }

        function printFullTable(event) {
            event.preventDefault();
            printTable([]); // Sem esconder colunas
        }

        function printTable(columnsToHide) {
            const originalTable = document.getElementById('result-table');

            // Cria um clone para manipular o HTML para impressão sem estragar a tela atual
            const tableClone = originalTable.cloneNode(true);
            const rows = Array.from(tableClone.getElementsByTagName('tr'));

            // 1. Atualiza valores dos inputs no CLONE para texto (para imprimir bonito)
            // Precisamos pegar os valores REAIS dos inputs da tabela original
            const originalInputs = originalTable.querySelectorAll('input.recomendado-input');
            const cloneInputs = tableClone.querySelectorAll('input.recomendado-input');

            originalInputs.forEach((origInput, index) => {
                if(cloneInputs[index]) {
                    const parent = cloneInputs[index].parentElement;
                    parent.innerHTML = `<strong>${origInput.value}</strong>`;
                    parent.style.textAlign = 'center';
                }
            });

            // 2. Remove linhas que estavam ocultas (display: none não vai no outerHTML as vezes dependendo do browser, melhor remover do clone)
            // Mas como usamos outerHTML abaixo e o display:none está inline no clone (copiado do original manipulado), deve funcionar.
            // Para garantir, vamos adicionar uma classe para esconder colunas.

            // 3. Esconder Colunas Específicas (Vendas e Saldo)
            if (columnsToHide.length > 0) {
                // Header
                const headerCells = tableClone.getElementsByTagName('th');
                for (let i = 0; i < headerCells.length; i++) {
                    if (columnsToHide.includes(i)) headerCells[i].classList.add('hide-print');
                }
                // Body
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    for (let j = 0; j < cells.length; j++) {
                        // Cuidado com colspan nas categorias
                        if (!rows[i].classList.contains('category-header')) {
                            if (columnsToHide.includes(j)) cells[j].classList.add('hide-print');
                        } else {
                            // Se for categoria, ajusta o colspan
                            if(cells[0]) cells[0].setAttribute('colspan', 5 - columnsToHide.length);
                        }
                    }
                }
            }

            const currentDateTime = new Date().toLocaleString('pt-BR');

            const printContent = `
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <title>Previsão de Demanda</title>
                    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@600&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
                    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
                    <style>
                        body { font-family: 'Poppins', sans-serif; margin: 20px; color: #000; }
                        h3 { font-family: 'Kanit', sans-serif; color: #0B46AC; margin: 0; }
                        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0B46AC; padding-bottom: 10px; margin-bottom: 20px; }
                        .header img { max-height: 50px; }
                        table { width: 100%; border-collapse: collapse; font-size: 12px; }
                        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
                        th { background-color: #f0f0f0; font-family: 'Kanit', sans-serif; }
                        .category-header td { background-color: #e9e9e9; font-weight: bold; text-transform: uppercase; }
                        .signature-line { margin-top: 60px; text-align: center; font-size: 14px; }
                        .signature-line span { display: inline-block; margin-top: 10px; border-top: 1px solid #000; width: 300px; }
                        .hide-print { display: none !important; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div>
                            <h3>Portal MRK - Previsão de Demanda</h3>
                            <p style="margin:0; font-size:12px;"><strong>Empresa:</strong> ${unitName}</p>
                            <p style="margin:0; font-size:12px;"><strong>Responsável:</strong> ${userName}</p>
                            <p style="margin:0; font-size:12px;"><strong>Data:</strong> ${currentDateTime}</p>
                        </div>
                        <div>
                            <img id="logo-img" src="https://portal.mrksolucoes.com.br/app/templates/theme5/images/logo.png" alt="Logo">
                        </div>
                    </div>
                    ${tableClone.outerHTML}
                    <div class="signature-line">
                        <span>Assinatura do Responsável</span>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank', 'height=700,width=900');
            win.document.write(printContent);
            win.document.close();

            const logoImg = win.document.getElementById('logo-img');
            if (logoImg) {
                logoImg.onload = function() { win.print(); win.close(); };
            } else {
                setTimeout(() => { win.print(); win.close(); }, 500);
            }
        }

        // Listeners Impressão
        document.getElementById('print-filtered-button').addEventListener('click', printFilteredTable);
        document.getElementById('print-full-button').addEventListener('click', printFullTable);

        // Outros Listeners
        document.getElementById('modelos-select').addEventListener('change', function() { if (this.value) loadProdutosDoModelo(this.value); });
        document.getElementById('add-item').addEventListener('click', calcularNecessidades);

        loadUnidades();
    });
</script>

</body>
</html>