<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Entrada de Nota (Estoque)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== AJUSTES DE IFRAME ====== */
        html, body { background: transparent !important; }
        body.theme-blue { background: transparent !important; }
        .container-fluid { background: transparent !important; padding-bottom: 20px; }

        /* Card Transparente */
        .card { background: rgba(255, 255, 255, 0.98) !important; box-shadow: none !important; border: 1px solid #eee; margin-bottom: 0; }
        .card .header { border-bottom: 2px solid var(--mrk-blue); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card .header h2 { margin: 0; font-size: 18px; color: var(--mrk-blue); display: flex; align-items: center; gap: 8px; }

        /* Campos Readonly */
        .readonly-field { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 6px 12px; border-radius: 4px; min-height: 34px; line-height: 20px; color: #555; font-family: 'Poppins', sans-serif; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Box de Sincronização */
        .sync-box { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; height: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.03); position: relative; }
        .sync-box h5 { font-family: 'Kanit', sans-serif; font-weight: 600; color: var(--mrk-blue); margin-top: 0; margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }

        /* Calculadora Visual */
        .calc-strip { background: #fcfcfc; border: 1px solid #eee; border-radius: 6px; padding: 10px; margin-top: 15px; }
        .calc-eq { display: flex; gap: 6px; align-items: baseline; font-family: 'Poppins', monospace; font-size: 12px; color: #666; justify-content: center; margin-top: 5px; }
        .eq-val { font-weight: 700; color: #333; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .eq-op { color: var(--mrk-blue); font-weight: bold; }

        /* Tabela de Itens */
        .table-items thead th { background-color: #f5f5f5; color: var(--mrk-blue); font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 12px; border-bottom: 2px solid #ddd; }
        .row-pendente { background-color: #fff8e1 !important; }
        .row-pendente-selected { background-color: #ffe0b2 !important; border-left: 4px solid var(--mrk-amber); }
        .row-ok-selected { background-color: #e3f2fd !important; border-left: 4px solid var(--mrk-blue); }
        .status-icon { font-size: 18px; vertical-align: middle; }
        .icon-pendente { color: var(--mrk-amber); }
        .icon-ok { color: var(--mrk-green); }

        /* Transfer Alert */
        .transfer-hint { margin-top: 5px; padding: 8px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 4px; font-size: 12px; display: none; font-family: 'Poppins', sans-serif; }
        .transfer-alert .select2-selection { border-color: #ffc107 !important; box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25); }

        /* Dados Transferencia Realizada */
        .transfer-details { background: #e8f5e9; border: 1px solid #c8e6c9; color: #2e7d32; padding: 10px; border-radius: 4px; font-size: 12px; margin-top: 5px; display: none; }
        .transfer-details strong { font-weight: 600; }

        /* Select2 */
        .select2-container .select2-selection--single { height: 34px !important; border: 1px solid #ccc !important; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 34px !important; color: #555; }

        label { font-family: 'Kanit', sans-serif; font-weight: 500; font-size: 12px; color: #666; margin-bottom: 4px; }
        .k-hint { font-size: 11px; color: #999; display: block; margin-top: 2px; }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br/>
    <div class="card">
        <div class="header">
            <h2>
                <iconify-icon icon="icon-park-outline:dolly" width="24"></iconify-icon>
                ENTRADA DE NOTA
            </h2>
            <span id="flagEstoque" class="badge bg-grey">Carregando status...</span>
        </div>

        <div class="body">
            <div class="row">
                <div class="col-md-7">
                    <div class="row clearfix">
                        <div class="col-md-12 mb-2">
                            <label>Fornecedor</label>
                            <div id="notaFornecedor" class="readonly-field">-</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label>Nº Nota</label>
                            <div id="notaNumero" class="readonly-field">-</div>
                        </div>
                        <div class="col-md-2 mb-2">
                            <label>Série</label>
                            <div id="notaSerie" class="readonly-field">-</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label>Emissão</label>
                            <div id="notaEmissao" class="readonly-field">-</div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label>Data Entrada</label>
                            <input type="date" id="notaDataEntrada" class="form-control">
                        </div>
                        <div class="col-md-12 mb-2">
                            <label>Chave de Acesso</label>
                            <div id="notaChave" class="readonly-field" style="font-family: monospace; font-size: 11px;">-</div>
                        </div>

                        <div class="col-md-12 mt-2">
                            <label style="color: var(--mrk-blue);">
                                <iconify-icon icon="icon-park-outline:shop" style="vertical-align: -2px;"></iconify-icon>
                                Loja de Destino (Estoque)
                            </label>
                            <select id="selLojaDestino" class="form-control" style="width: 100%;"></select>

                            <div id="transferHint" class="transfer-hint">
                                <iconify-icon icon="icon-park-outline:attention" style="vertical-align: -2px;"></iconify-icon>
                                <b>Atenção:</b> Os itens serão transferidos automaticamente para a loja selecionada.
                            </div>

                            <div id="boxTransferenciaInfo" class="transfer-details">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>
                                        <iconify-icon icon="icon-park-outline:check-one" style="vertical-align: -2px;"></iconify-icon>
                                        <b>Transferência Realizada!</b>
                                    </span>
                                    <small id="txtDataTransferencia" style="opacity: 0.8;"></small>
                                </div>
                                <hr style="margin: 5px 0; border-top: 1px solid #a5d6a7;">
                                <div class="row">
                                    <div class="col-xs-6">Doc. Saída: <strong id="txtDocSaida">-</strong></div>
                                    <div class="col-xs-6">Doc. Entrada: <strong id="txtDocEntrada">-</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="sync-box">
                        <h5>
                            <iconify-icon icon="icon-park-outline:connection" style="vertical-align: -2px;"></iconify-icon>
                            SINCRONIZAR ITEM
                        </h5>

                        <label>Produto no Sistema</label>
                        <div class="input-group">
                            <select id="selInsumo" class="form-control" style="width: 100%;"></select>
                            <span class="input-group-btn">
                                <button id="btnNovoInsumo" class="btn btn-success" type="button" title="Cadastrar Novo" style="height: 34px;">
                                    <iconify-icon icon="icon-park-outline:plus"></iconify-icon>
                                </button>
                            </span>
                        </div>

                        <div class="row clearfix" style="margin-top: 5px;">
                            <div class="col-xs-4">
                                <small class="text-muted">Código</small>
                                <div id="insumoCodigo" style="font-weight: bold; font-size: 12px;">-</div>
                            </div>
                            <div class="col-xs-4">
                                <small class="text-muted">Unidade</small>
                                <div id="insumoUn" style="font-weight: bold; font-size: 12px;">-</div>
                            </div>
                            <div class="col-xs-12 mt-1">
                                <small class="text-muted">Descrição</small>
                                <div id="insumoNome" style="font-weight: 500; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
                            </div>
                        </div>

                        <div class="calc-strip">
                            <div class="row clearfix">
                                <div class="col-xs-4">
                                    <label>Qtd. Nota</label>
                                    <div class="readonly-field text-center" style="background: #fff;">
                                        <span id="qtdNotaPreviewVal" style="font-weight: bold;">-</span>
                                        <small id="qtdNotaPreviewUnit" class="text-muted" style="font-size: 10px;"></small>
                                    </div>
                                </div>
                                <div class="col-xs-4">
                                    <label>Fator Conv.</label>
                                    <input type="number" step="0.000001" min="0.000001" id="fatorConv" class="form-control text-center" value="1" style="font-weight: bold; color: var(--mrk-blue);">
                                </div>
                                <div class="col-xs-4">
                                    <label>Qtd. Estoque</label>
                                    <div class="readonly-field text-center" style="background: #e3f2fd; color: var(--mrk-blue);">
                                        <span id="qtdInternaPreview" style="font-weight: bold;">-</span>
                                        <small id="qtdInternaUnit" style="font-size: 10px; opacity: 0.8;"></small>
                                    </div>
                                </div>
                            </div>
                            <div id="formulaPreview" class="text-center"></div>
                        </div>

                        <div id="syncNotaInfo" style="margin-top: 10px; padding: 8px; background: #fff8e1; border-radius: 4px; font-size: 11px; color: #666; border: 1px solid #ffecb3;">
                            <iconify-icon icon="icon-park-outline:info" style="vertical-align: -2px;"></iconify-icon>
                            Selecione um item na tabela abaixo para vincular.
                        </div>
                        <br/>

                        <button class="btn btn-primary btn-block mt-2" id="btnGravarVinculo" disabled style="background-color: var(--mrk-blue) !important;">
                            <iconify-icon icon="icon-park-outline:check-one" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            CONFIRMAR VÍNCULO
                        </button>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 20px; margin-bottom: 5px;">
                <div class="col-md-12" style="font-size: 11px; color: #777;">
                    <span style="display:inline-block; width:10px; height:10px; background:#fff8e1; border:1px solid #ddd; margin-right:5px;"></span> Pendente
                    <span style="display:inline-block; width:10px; height:10px; background:#fff; border:1px solid #ddd; margin-left:15px; margin-right:5px;"></span> Vinculado
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-items" id="tabelaItens">
                    <thead>
                    <tr>
                        <th colspan="6" class="text-center" style="border-right: 1px solid #ddd;">DADOS DA NOTA</th>
                        <th colspan="5" class="text-center" style="background-color: #e3f2fd; color: var(--mrk-blue);">DADOS DO SISTEMA</th>
                        <th></th>
                    </tr>
                    <tr>
                        <th>#</th>
                        <th>Cód.</th>
                        <th>Descrição</th>
                        <th>UN</th>
                        <th>Qtd</th>
                        <th style="border-right: 1px solid #ddd;">Unit.</th>

                        <th style="background-color: #f1f8ff;">Cód.</th>
                        <th style="background-color: #f1f8ff;">Descrição Interna</th>
                        <th style="background-color: #f1f8ff;">UN</th>
                        <th style="background-color: #f1f8ff;">Qtd</th>
                        <th style="background-color: #f1f8ff;">Unit.</th>

                        <th class="text-center" style="width: 50px;">Ação</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="12" class="text-center text-muted" style="padding: 20px;">Carregando itens...</td></tr>
                    </tbody>
                </table>
            </div>

            <br>

            <div class="text-center" style="border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn btn-danger" id="btnFecharTela" style="margin-right: 10px; background-color: var(--mrk-red) !important;">
                    <iconify-icon icon="icon-park-outline:close" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> FECHAR
                </button>

                <button class="btn btn-success" id="btnGravarNota" disabled style="background-color: var(--mrk-green) !important; padding: 8px 30px;">
                    <iconify-icon icon="icon-park-outline:save" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                    LANÇAR NO ESTOQUE
                </button>
            </div>

        </div></div></div>

<div class="modal fade" id="modalNovoInsumoIframe" tabindex="-1" role="dialog">
    <div class="modal-dialog" style="width:95%; max-width:980px;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="font-family: 'Kanit', sans-serif;">Novo Produto</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body" style="padding:0; height:80vh;">
                <iframe id="iframeNovoProduto" src="" style="width:100%;height:100%;border:0;"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    'use strict';

    // ===== Configs =====
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlredirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/external'
        : 'http://localhost/portal-mrk/external';

    const params = new URLSearchParams(window.location.search);
    const system_unit_id = params.get('system_unit_id');
    const chave_acesso = params.get('chave_acesso');
    const fornecedor_id = params.get('fornecedor_id');
    const token = params.get('token');
    const usuario_id = params.get('usuario_id');

    // Estado
    let nota = null;
    let itens = [];
    let insumos = [];
    let selectedIndex = null;

    // ===== Helpers =====
    const INT_UNITS = ['UN', 'U', 'UND', 'PC', 'PÇ', 'PÇS'];
    const isIntUnit = u => INT_UNITS.includes(String(u || '').toUpperCase());

    function fmtMoneyBR(v){
        const n = Number(v);
        if (!isFinite(n)) return '';
        return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatQtyByUnit(unit, val){
        const x = Number(val) || 0;
        if (isIntUnit(unit)) {
            return String(Math.round(x));
        }
        return (Math.round(x * 1000) / 1000).toFixed(3).replace('.', ',');
    }

    function fmtDateBR(s){
        if (!s) return '';
        const d = new Date(s);
        return isNaN(d) ? '' : d.toLocaleDateString('pt-BR');
    }

    const allSynced = () => itens.every(it => it.codigo_produto_interno !== null && it.unidade_interno && Number(it.fator_conversao) > 0);

    // ===== Init =====
    $(document).ready(function () {
        if (!system_unit_id || !chave_acesso || !fornecedor_id || !token) {
            Swal.fire('Erro', 'Parâmetros de URL inválidos.', 'error');
            return;
        }

        $('#selInsumo').select2({ placeholder: 'Pesquise o produto...', allowClear: true, width: '100%' });

        $('#fatorConv').on('input', atualizarPreviewConversao);
        $('#selInsumo').on('change', onChangeInsumo);
        $('#btnGravarVinculo').on('click', gravarVinculo);
        $('#btnGravarNota').on('click', gravarNota);
        $('#btnFecharTela').on('click', fecharTelaConfirm);
        $('#btnNovoInsumo').on('click', abrirNovoProdutoModalViaIframe);

        $('#selLojaDestino').on('change', function () {
            const dest = String($(this).val());
            const $container = $(this).next('.select2-container');
            if (dest && dest !== String(system_unit_id)) {
                $container.parent().addClass('transfer-alert');
                $('#transferHint').slideDown();
            } else {
                $container.parent().removeClass('transfer-alert');
                $('#transferHint').slideUp();
            }
        });

        $('#modalNovoInsumoIframe').on('hidden.bs.modal', function () {
            $('#iframeNovoProduto').attr('src', '');
        });

        $(function () {
            $('[data-toggle="tooltip"]').tooltip({ container: 'body' });
        });

        // Carregamento inicial em cadeia para garantir que lojas estejam prontas antes de setar valor
        carregarLojasDestino().then(() => {
            carregarNotaEItens();
        });

        carregarInsumos();
    });

    // ===== Core Logic =====
    async function carregarNotaEItens(){
        Swal.fire({ title:'Carregando Nota...', didOpen:()=>Swal.showLoading() });
        try{
            const res = await axios.post(baseUrl, {
                method: 'getNotaItensFornecedorPayload',
                token,
                data: {
                    system_unit_id: Number(system_unit_id),
                    chave_acesso: String(chave_acesso),
                    fornecedor_id: Number(fornecedor_id)
                }
            });

            if (!res.data.success) throw new Error(res.data.error);

            nota = res.data.data.nota;
            itens = res.data.data.itens || [];

            // Preenche Header
            $('#notaFornecedor').text(nota.fornecedor_nome || nota.fornecedor_razao || '-');
            $('#notaNumero').text(nota.numero_nf || '-');
            $('#notaSerie').text(nota.serie || '-');
            $('#notaEmissao').text(fmtDateBR(nota.data_emissao));
            $('#notaChave').text(nota.chave_acesso || '-');

            setFlagEstoque(nota);

            // Data entrada default
            const hoje = new Date().toISOString().split('T')[0];
            $('#notaDataEntrada').val(nota.data_entrada ? nota.data_entrada.substring(0,10) : hoje);

            // ===== Lógica de Transferência e Bloqueio =====
            const info = nota.transferencia_info || {};
            const lojaAtual = Number(system_unit_id);
            const lojaDestino = info.destino_id ? Number(info.destino_id) : lojaAtual;

            // Seta o select
            $('#selLojaDestino').val(String(lojaDestino)).trigger('change');

            // REGRA: Só permite mudar se NÃO foi transferida OU se o destino for a própria loja (estorno lógico/transferência para si mesmo)
            const isLocked = (info.foi_transferida === true && lojaDestino !== lojaAtual);

            if (isLocked) {
                $('#selLojaDestino').prop('disabled', true);

                // Mostra painel de detalhes
                $('#boxTransferenciaInfo').slideDown();
                $('#txtDataTransferencia').text(fmtDateBR(info.data_saida));
                $('#txtDocSaida').text(info.doc_saida || '-');
                $('#txtDocEntrada').text(info.doc_entrada || '-');

                // Esconde hint de atenção pois já foi feito
                $('#transferHint').hide();
            } else {
                $('#selLojaDestino').prop('disabled', false);
                $('#boxTransferenciaInfo').hide();
            }

            renderTabela();
            toggleGravarNota();
            Swal.close();
        }catch(e){
            console.error(e);
            Swal.fire('Erro', e.message || 'Erro ao carregar nota.', 'error');
        }
    }

    async function carregarLojasDestino(){
        try {
            const res = await axios.post(baseUrl, { method: 'getGroupByUser', token, data: { user_id: Number(usuario_id) } });
            if(res.data?.lojas_por_grupo){
                const $sel = $('#selLojaDestino');
                $sel.empty();
                // Flatten lojas
                const lojas = [];
                Object.values(res.data.lojas_por_grupo).forEach(g => g.forEach(l => lojas.push(l)));
                // Unique
                const uniqueLojas = [...new Map(lojas.map(item => [item['id'], item])).values()];

                uniqueLojas.forEach(l => $sel.append(new Option(l.name, l.id)));

                // Pré-seleciona loja atual por padrão
                $sel.select2({width:'100%'}).val(String(system_unit_id)).trigger('change');
            }
        } catch(e){ console.error(e); }
    }

    async function carregarInsumos(selectCodigo = null){
        try{
            const res = await axios.post(baseUrl, {
                method: 'listInsumos', token, data: { unit_id: String(system_unit_id) }
            });
            insumos = res.data.insumos || [];

            const $sel = $('#selInsumo');
            $sel.empty().append('<option value=""></option>');

            insumos.forEach(i => {
                $sel.append(new Option(`${i.codigo} - ${i.nome}`, String(i.codigo)));
            });

            if (selectCodigo) $sel.val(String(selectCodigo)).trigger('change');
        }catch(e){ console.error(e); }
    }

    function renderTabela(){
        const tbody = $('#tabelaItens tbody');
        tbody.empty();

        if (!itens.length) {
            tbody.append('<tr><td colspan="12" class="text-center text-muted" style="padding:20px;">Nota sem itens.</td></tr>');
            return;
        }

        itens.forEach((it, idx) => {
            const pendente = (it.codigo_produto_interno === null || !it.unidade_interno || !(Number(it.fator_conversao) > 0));

            // Dados NF
            const qtdNF = Number(it.quantidade_nota || 0);
            const vUnitNF = fmtMoneyBR(it.valor_unitario_nota);

            // Dados Sistema (Calculados)
            const fator = Number(it.fator_conversao || 1);
            const qtdInt = Number(it.quantidade_interno ?? (qtdNF * fator));
            const unInt = String(it.unidade_interno || '-');
            const qtdIntFmt = formatQtyByUnit(unInt, qtdInt);

            let vUnitInt = '-';
            if (!pendente && fator > 0 && it.valor_unitario_nota != null) {
                vUnitInt = fmtMoneyBR(Number(it.valor_unitario_nota) / fator);
            }

            const trClass = pendente ? 'row-pendente' : '';
            const iconStatus = pendente
                ? '<iconify-icon icon="icon-park-outline:attention" class="status-icon icon-pendente" title="Pendente"></iconify-icon>'
                : '<iconify-icon icon="icon-park-solid:check-one" class="status-icon icon-ok" title="Sincronizado"></iconify-icon>';

            tbody.append(`
            <tr class="${trClass}" data-idx="${idx}" style="cursor:pointer;">
            <td>${it.numero_item_nota}</td>
            <td><b>${it.codigo_produto_nota}</b></td>
            <td>${it.descricao_nota}</td>
            <td>${it.unidade_nota}</td>
            <td>${qtdNF}</td>
            <td style="border-right: 1px solid #ddd;">${vUnitNF}</td>

            <td style="background-color: ${pendente ? 'transparent' : '#f1f8ff'};"><b>${it.codigo_produto_interno ?? '-'}</b></td>
            <td style="background-color: ${pendente ? 'transparent' : '#f1f8ff'};">${it.descricao_interno ?? '-'}</td>
            <td style="background-color: ${pendente ? 'transparent' : '#f1f8ff'};">${unInt}</td>
            <td style="background-color: ${pendente ? 'transparent' : '#f1f8ff'};">${pendente ? '-' : qtdIntFmt}</td>
            <td style="background-color: ${pendente ? 'transparent' : '#f1f8ff'};">${vUnitInt}</td>

            <td class="text-center">${iconStatus}</td>
            </tr>
            `);
        });

        $('#tabelaItens tbody tr').click(function() {
            const idx = $(this).data('idx');
            carregarParaEdicao(idx);
        });
    }

    function carregarParaEdicao(index){
        selectedIndex = index;
        const it = itens[index];

        // Marca linha
        $('#tabelaItens tbody tr').removeClass('row-pendente-selected row-ok-selected');
        const tr = $(`#tabelaItens tbody tr[data-idx="${index}"]`);
        const pend = (it.codigo_produto_interno === null);
        tr.addClass(pend ? 'row-pendente-selected' : 'row-ok-selected');

        // Preenche Info do Item Nota
        $('#syncNotaInfo').html(`
        <b>Item ${it.numero_item_nota}:</b> ${it.descricao_nota} (${it.quantidade_nota} ${it.unidade_nota})
        `).css({'background': '#e3f2fd', 'color': '#0d47a1', 'border-color': '#90caf9'});

        // Preenche Formulário
        if(it.codigo_produto_interno) {
            $('#selInsumo').val(String(it.codigo_produto_interno)).trigger('change');
        } else {
            $('#selInsumo').val(null).trigger('change');
        }

        $('#fatorConv').val(Number(it.fator_conversao || 1));

        // Preview inicial
        atualizarPreviewConversao();
        $('#btnGravarVinculo').prop('disabled', false);
    }

    function onChangeInsumo(){
        const codigo = $('#selInsumo').val();
        if(!codigo){
            $('#insumoCodigo').text('-'); $('#insumoUn').text('-'); $('#insumoNome').text('-');
            return;
        }
        const ins = insumos.find(x => String(x.codigo) === String(codigo));
        if(ins){
            $('#insumoCodigo').text(ins.codigo);
            $('#insumoUn').text(ins.und);
            $('#insumoNome').text(ins.nome);
            atualizarPreviewConversao();
        }
    }

    function atualizarPreviewConversao(){
        if(selectedIndex === null) return;
        const it = itens[selectedIndex];
        const fator = Number($('#fatorConv').val() || 1);
        const qtdNota = Number(it.quantidade_nota || 0);

        const unInt = $('#insumoUn').text() !== '-' ? $('#insumoUn').text() : (it.unidade_interno || '');
        const qtdFinal = qtdNota * fator;

        $('#qtdNotaPreviewVal').text(qtdNota);
        $('#qtdNotaPreviewUnit').text(it.unidade_nota);

        $('#qtdInternaPreview').text(formatQtyByUnit(unInt, qtdFinal));
        $('#qtdInternaUnit').text(unInt);

        // Fórmula Visual
        $('#formulaPreview').html(`
        <div class="calc-eq">
        <span class="eq-val">${qtdNota} ${it.unidade_nota}</span>
        <span class="eq-op">×</span>
        <span class="eq-val">${fator}</span>
        <span class="eq-op">=</span>
        <span class="eq-val" style="background:#c8e6c9; color:#2e7d32;">${formatQtyByUnit(unInt, qtdFinal)} ${unInt}</span>
        </div>
        `);
    }

    async function gravarVinculo(){
        if (selectedIndex === null) return;
        const it = itens[selectedIndex];
        const codProd = $('#selInsumo').val();
        const fator = Number($('#fatorConv').val());
        const ins = insumos.find(x => String(x.codigo) === String(codProd));

        if (!ins) return Swal.fire('Atenção', 'Selecione um produto do sistema.', 'warning');
        if (fator <= 0) return Swal.fire('Atenção', 'Fator deve ser maior que zero.', 'warning');

        try {
            Swal.showLoading();
            const res = await axios.post(baseUrl, {
                method: 'vincularItemNotaFornecedor',
                token,
                data: {
                    system_unit_id: Number(system_unit_id),
                    fornecedor_id: Number(fornecedor_id),
                    produto_codigo: Number(ins.codigo),
                    codigo_nota: String(it.codigo_produto_nota),
                    descricao_nota: String(it.descricao_nota),
                    unidade_nota: String(it.unidade_nota),
                    fator_conversao: fator,
                    unidade_item: ins.und
                }
            });

            if(!res.data.success) throw new Error(res.data.error);

            // Atualiza array local
            it.codigo_produto_interno = Number(ins.codigo);
            it.descricao_interno = ins.nome;
            it.unidade_interno = ins.und;
            it.fator_conversao = fator;

            renderTabela();
            toggleGravarNota();
            Swal.fire('Sucesso', 'Vínculo salvo.', 'success');

            // Limpa form
            selectedIndex = null;
            $('#syncNotaInfo').html('<iconify-icon icon="icon-park-outline:info"></iconify-icon> Selecione um item na tabela.').css({'background':'#fff8e1','color':'#666'});
            $('#selInsumo').val(null).trigger('change');
            $('#fatorConv').val(1);
            $('#btnGravarVinculo').prop('disabled', true);

        } catch(e) {
            Swal.fire('Erro', e.message, 'error');
        }
    }

    async function gravarNota(){
        if(!allSynced()) return Swal.fire('Pendente', 'Vincule todos os itens antes de gravar.', 'warning');

        const dataEntrada = $('#notaDataEntrada').val();
        if(!dataEntrada) return Swal.fire('Atenção', 'Informe a Data de Entrada.', 'warning');

        // Lógica de Destino
        const lojaDestino = $('#selLojaDestino').val();
        const transferir = lojaDestino && String(lojaDestino) !== String(system_unit_id);

        const payload = {
            system_unit_id: Number(system_unit_id),
            usuario_id: Number(usuario_id),
            chave_acesso: String(chave_acesso),
            data_entrada: dataEntrada,
            transferir_destino: transferir,
            system_unit_id_destino: transferir ? Number(lojaDestino) : null,
            itens: itens.map(it => ({
                numero_item_nota: it.numero_item_nota,
                codigo_produto_interno: it.codigo_produto_interno,
                unidade_interno: it.unidade_interno,
                quantidade_interno: Number(it.quantidade_nota) * Number(it.fator_conversao),
                fator_conversao: Number(it.fator_conversao)
            }))
        };

        try {
            Swal.fire({ title: 'Processando Entrada...', didOpen:()=>Swal.showLoading() });
            const res = await axios.post(baseUrl, {
                method: 'lancarItensNotaNoEstoque',
                token,
                data: payload
            });

            if(!res.data.success) throw new Error(res.data.message);

            nota.incluida_estoque = 1;
            setFlagEstoque(nota);
            Swal.fire('Sucesso!', 'Entrada de estoque realizada.', 'success');

        } catch(e) {
            Swal.fire('Erro', e.message, 'error');
        }
    }

    // Auxiliares
    function setFlagEstoque(n){
        const el = $('#flagEstoque');
        const btn = $('#btnGravarNota');

        if(Number(n?.incluida_estoque) === 1){
            el.attr('class', 'badge bg-green').html('<iconify-icon icon="icon-park-outline:check"></iconify-icon> ESTOQUE LANÇADO');
            // Muda o texto para indicar que pode atualizar/corrigir
            btn.html('<iconify-icon icon="icon-park-outline:refresh" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> ATUALIZAR ENTRADA');
        } else {
            el.attr('class', 'badge bg-orange').html('<iconify-icon icon="icon-park-outline:time"></iconify-icon> PENDENTE ESTOQUE');
            btn.html('<iconify-icon icon="icon-park-outline:save" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> LANÇAR NO ESTOQUE');
        }

        // LIBERA O BOTÃO: O botão agora depende apenas da sincronização dos itens
        toggleGravarNota();
    }

    function toggleGravarNota(){
        // Habilita se todos os itens estiverem vinculados, independente se já foi lançada ou não
        $('#btnGravarNota').prop('disabled', !allSynced());
    }

    // function toggleGravarNota(){
    //     // Se ainda não foi incluída (flag != 1), habilita/desabilita baseado no vínculo
    //     // if(Number(nota?.incluida_estoque)!==1) {
    //     //     $('#btnGravarNota').prop('disabled', !allSynced());
    //     // }
    // }

    // Novo Produto Iframe
    function abrirNovoProdutoModalViaIframe(){
        const qs = `system_unit_id=${system_unit_id}&token=${token}`;
        const url = `${baseUrlredirect}/novo-produto-modal.html?${qs}`;

        window.onNovoProdutoSalvo = function(prod){
            $('#modalNovoInsumoIframe').modal('hide');
            carregarInsumos(prod.codigo);
            Swal.fire('Sucesso', 'Produto cadastrado.', 'success');
        };

        $('#iframeNovoProduto').attr('src', url);
        $('#modalNovoInsumoIframe').modal('show');
    }

    function fecharTelaConfirm(){
        if(Number(nota?.incluida_estoque)!==1){
            Swal.fire({
                title: 'Sair sem salvar?',
                text: 'A entrada no estoque ainda não foi concluída.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sair mesmo assim'
            }).then((r)=>{ if(r.isConfirmed) closeParentModal(); });
        } else {
            closeParentModal();
        }
    }

    function closeParentModal(){
        try { window.parent.$('#modalEntradaEstoque').modal('hide'); } catch(e){}
    }

</script>
</body>
</html>