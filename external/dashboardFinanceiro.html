<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Financeiro</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- n√£o usado, mas mantido como no estoque -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root{
            --mrk-blue: #0B46AC;
            --mrk-green: #08A794;
            --mrk-gray: #EBEBEB;
            --mrk-black: #191F2A;
        }

        .animate-number { transition: all 1s ease-in-out; }
        .btn-mrk {
            background: color-mix(in srgb, var(--mrk-blue) 12%, white);
            color: var(--mrk-blue);
            border: 1px solid color-mix(in srgb, var(--mrk-blue) 25%, white);
        }
        .btn-mrk:hover {
            background: color-mix(in srgb, var(--mrk-blue) 20%, white);
        }

        /* üî• Popup extra grande s√≥ pra lista de contas */
        .swal2-popup.swal2-xl {
            width: 90vw !important;
            max-width: 1400px !important;
        }

        /* Garante que o conte√∫do role dentro do modal grande */
        .swal2-html-container {
            max-height: 70vh;
            overflow: auto;
        }

        .cal-grid { display:grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 8px; }
        .cal-dow { font-size: 11px; color:#6b7280; text-transform: uppercase; letter-spacing: .06em; text-align:center; }
        .cal-day {
            background:#fff;
            border:1px solid #eee;
            border-radius: 14px;
            padding: 10px;
            min-height: 84px;
            position: relative;
            cursor: pointer;
            transition: transform .08s ease, box-shadow .08s ease;
        }
        .cal-day:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,.06); }
        .cal-day.muted { opacity: .40; cursor: default; }
        .cal-day.hasdata { border-color: rgba(11,70,172,.25); background: color-mix(in srgb, var(--mrk-blue) 6%, white); }
        .cal-num { font-weight: 800; font-size: 13px; color: var(--mrk-black); }
        .cal-total { position:absolute; bottom:10px; left:10px; right:10px; font-size: 12px; font-weight: 800; color: var(--mrk-black); }
        .cal-badge {
            position:absolute; top:10px; right:10px;
            font-size: 11px; font-weight: 800;
            padding: 2px 8px;
            border-radius: 999px;
            background: color-mix(in srgb, var(--mrk-green) 14%, white);
            color: var(--mrk-green);
            border:1px solid color-mix(in srgb, var(--mrk-green) 30%, white);
        }
        .cal-empty { color:#9ca3af; font-size:12px; font-weight:700; position:absolute; bottom:10px; left:10px; }
    </style>
</head>

<body class="text-gray-800" style="background: var(--mrk-gray);">

<div class="p-6">
    <!-- FILTROS -->
    <div class="mb-6">
        <div class="flex items-center gap-4 flex-wrap">
            <button onclick="setRange('hoje')" class="btn-mrk px-3 py-1 rounded shadow">Hoje</button>
            <button onclick="setRange('ontem')" class="btn-mrk px-3 py-1 rounded shadow">Ontem</button>
            <button onclick="setRange('7dias')" class="btn-mrk px-3 py-1 rounded shadow">√öltimos 7 dias</button>
            <button onclick="setRange('mes')" class="btn-mrk px-3 py-1 rounded shadow">√öltimos 30 dias</button>

            <input type="date" id="startDate" onchange="fetchData()" class="border p-2 rounded-md shadow bg-white" />
            <input type="date" id="endDate" onchange="fetchData()" class="border p-2 rounded-md shadow bg-white" />

            <select id="tipoData" class="border p-2 rounded-md shadow bg-white">
                <option value="vencimento">Data de Vencimento</option>
                <option value="emissao">Data de Emiss√£o</option>
            </select>

            <select id="filtroGrupo" class="border p-2 rounded-md shadow bg-white">
                <option value="">Todos os Grupos</option>
            </select>

            <select id="filtroLoja" class="border p-2 rounded-md shadow bg-white">
                <option value="">Todas as lojas</option>
            </select>
        </div>
    </div>

    <!-- CARDS -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">

        <!-- Contas a Vencer 7 dias -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex flex-col justify-between"
             style="border-color: var(--mrk-blue);">
            <div class="flex items-center gap-4">
                <div class="text-4xl" style="color: var(--mrk-blue);">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div>
                    <div class="text-sm font-semibold" style="color: var(--mrk-black);">
                        Contas a vencer nos pr√≥ximos 7 dias
                    </div>
                    <div class="text-2xl md:text-3xl font-extrabold animate-number" id="contasVencer7"
                         style="color: var(--mrk-black);">R$ 0,00</div>
                </div>
            </div>
            <div class="mt-3 flex justify-between items-center text-xs text-gray-600">
                <span id="qtdContas7">0 contas</span>
                <button class="text-xs font-semibold text-blue-700 hover:underline"
                        onclick="mostrarContasPrazo(7)">
                    Ver mais
                </button>
            </div>
        </div>

        <!-- Contas a Vencer 30 dias -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex flex-col justify-between"
             style="border-color: var(--mrk-green);">
            <div class="flex items-center gap-4">
                <div class="text-4xl" style="color: var(--mrk-green);">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div>
                    <div class="text-sm font-semibold" style="color: var(--mrk-black);">
                        Contas a vencer nos pr√≥ximos 30 dias
                    </div>
                    <div class="text-2xl md:text-3xl font-extrabold animate-number" id="contasVencer30"
                         style="color: var(--mrk-black);">R$ 0,00</div>
                </div>
            </div>
            <div class="mt-3 flex justify-between items-center text-xs text-gray-600">
                <span id="qtdContas30">0 contas</span>
                <button class="text-xs font-semibold text-blue-700 hover:underline"
                        onclick="mostrarContasPrazo(30)">
                    Ver mais
                </button>
            </div>
        </div>

        <!-- Soma D√©bitos -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4"
             style="border-color: var(--mrk-black);">
            <div class="text-4xl" style="color: var(--mrk-black);">
                <i class="fas fa-arrow-down-long"></i>
            </div>
            <div>
                <div class="text-sm font-semibold" style="color: var(--mrk-black);">
                    D√©bito
                </div>
                <div class="text-2xl md:text-3xl font-extrabold animate-number" id="totalDebitos"
                     style="color: var(--mrk-black);">R$ 0,00</div>
            </div>
        </div>

        <!-- Soma Cr√©ditos -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4"
             style="border-color: var(--mrk-black);">
            <div class="text-4xl" style="color: var(--mrk-black);">
                <i class="fas fa-arrow-up-long"></i>
            </div>
            <div>
                <div class="text-sm font-semibold" style="color: var(--mrk-black);">
                    Cr√©ditos
                </div>
                <div class="text-2xl md:text-3xl font-extrabold animate-number" id="totalCreditos"
                     style="color: var(--mrk-black);">R$ 0,00</div>
            </div>
        </div>

    </div>

    <!-- GR√ÅFICO: PLANOS DE CONTAS -->
    <div class="grid grid-cols-1 gap-6 mb-6">
        <div class="w-full bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4" style="color: var(--mrk-black);">
                Somat√≥rio das Contas por Plano de Contas
            </h2>
            <p class="text-xs text-gray-500 mb-2">
                Considerando apenas contas em aberto no per√≠odo e tipo de data selecionado.
            </p>
            <div id="chartPlanosContas" style="width:100%; height:360px;"></div>
        </div>
    </div>
    <!-- CALEND√ÅRIO: MAPA DE CONTAS -->
    <div class="w-full bg-white p-6 rounded-lg shadow mt-6">
        <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
                <h2 class="text-lg font-semibold" style="color: var(--mrk-black);">
                    Calend√°rio de Contas (Mapa do M√™s)
                </h2>
                <p class="text-xs text-gray-500">
                    Clique em um dia para ver as contas daquele dia (conforme o tipo de data selecionado).
                </p>
            </div>

            <div class="flex items-center gap-2">
                <button class="btn-mrk px-3 py-1 rounded shadow" onclick="navMes(-1)">
                    <i class="fa fa-chevron-left"></i>
                </button>

                <div class="px-3 py-1 rounded shadow bg-white border text-sm font-extrabold" id="calTituloMes">
                    ‚Äî
                </div>

                <button class="btn-mrk px-3 py-1 rounded shadow" onclick="navMes(1)">
                    <i class="fa fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="mt-4 cal-grid" id="calDows"></div>
        <div class="mt-2 cal-grid" id="calGrid"></div>

        <div class="mt-4 text-xs text-gray-500" id="calHint"></div>
    </div>
</div>






<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlFinanceiro = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id'));
    const user_id = parseInt(urlParams.get('user_id'));
    const token = urlParams.get('token');

    // üé® PALETA MRK
    const MRK = {
        blue:  '#0B46AC',
        green: '#08A794',
        gray:  '#EBEBEB',
        black: '#191F2A',
        series: ['#0B46AC', '#08A794', '#191F2A', '#0B46AC80', '#08A79480']
    };

    let grupoId = null;
    let gruposDisponiveis = {};
    let lojasPorGrupo = {};
    let lojasGrupo = [];

    // Estado bruto vindo do backend financeiro
    let dashboardFinanceiro = null;

    function animateValue(id, start, end, duration, isCurrency = false) {
        const element = document.getElementById(id);
        if (!element) return;

        let startTimestamp = null;

        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);

            element.textContent = isCurrency
                ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                : Math.floor(value);

            if (progress < 1) window.requestAnimationFrame(step);
        };

        window.requestAnimationFrame(step);
    }

    function formatBRL(valor) {
        const numero = Number(valor) || 0;
        return numero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function setRange(tipo) {
        const now = new Date();
        const start = new Date();
        if (tipo === 'ontem') {
            start.setDate(now.getDate() - 1);
            now.setDate(now.getDate() - 1);
        } else if (tipo === '7dias') {
            start.setDate(now.getDate() - 7);
        } else if (tipo === 'mes') {
            start.setMonth(now.getMonth() - 1);
        }

        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        fetchData();
    }

    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, {
            method: 'getGroupByUnit',
            token,
            data: { system_unit_id }
        });

        if (Array.isArray(res.data) && res.data.length > 0) {
            grupoId = res.data[0].id;
        }

        await carregarGruposUsuario();
    }

    async function carregarGruposUsuario() {
        const res = await axios.post(baseUrl, {
            method: 'getGroupByUser',
            token,
            data: { user_id }
        });

        const { grupos, lojas_por_grupo } = res.data;
        gruposDisponiveis = grupos || [];
        lojasPorGrupo = lojas_por_grupo || {};

        const grupoSelect = document.getElementById('filtroGrupo');
        grupoSelect.innerHTML = '';

        gruposDisponiveis.forEach(grupo => {
            grupoSelect.innerHTML += `<option value="${grupo.id}" ${grupo.id == grupoId ? 'selected' : ''}>${grupo.nome}</option>`;
        });

        grupoSelect.addEventListener('change', () => {
            grupoId = parseInt(grupoSelect.value);
            dashboardFinanceiro = null;
            limparCharts();
            atualizarFiltroLoja();
            document.getElementById('filtroLoja').value = "";
            fetchData();
        });

        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        const filtro = document.getElementById('filtroLoja');

        filtro.innerHTML = '<option value="">Todas as lojas</option>';
        lojas.forEach(loja => {
            filtro.innerHTML += `<option value="${loja.id}">${loja.name}</option>`;
        });
    }

    async function carregarLojasGrupo() {
        const res = await axios.post(baseUrl, {
            method: 'getUnitsByGroup',
            token,
            data: { group_id: grupoId }
        });
        lojasGrupo = res.data || [];
    }

    function limparCharts() {
        const ids = ['chartPlanosContas'];
        ids.forEach(id => {
            const dom = document.getElementById(id);
            if (!dom) return;
            const inst = echarts.getInstanceByDom(dom);
            if (inst) inst.dispose();
        });
    }

    async function fetchData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const tipoData = document.getElementById('tipoData').value || 'vencimento';

        if (!grupoId) {
            Swal.fire('Aten√ß√£o', 'Nenhum grupo selecionado/encontrado.', 'warning');
            return;
        }

        if (!startDate || !endDate) {
            return; // espera o usu√°rio escolher as datas
        }

        const dt_inicio = startDate; // formato Y-m-d
        const dt_fim = endDate;

        Swal.fire({
            title: 'Carregando...',
            html: 'Buscando dados financeiros.',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            await carregarLojasGrupo();

            const res = await axios.post(baseUrlFinanceiro, {
                method: 'getDashboardFinanceiroPorGrupo',
                token,
                data: {
                    group_id: grupoId,
                    dt_inicio,
                    dt_fim,
                    tipo_data: tipoData
                }
            });

            if (!res.data || !res.data.success) {
                throw new Error(res.data?.message || 'Erro ao carregar dashboard financeiro.');
            }

            dashboardFinanceiro = res.data.data || null;

            aplicarFiltroLoja();
            await atualizarCalendario();

        } catch (err) {
            console.error(err);
            Swal.fire('Erro ao carregar', err.message || 'Falha ao buscar dados.', 'error');
        } finally {
            Swal.close();
        }
    }

    function getNomeLojaById(lojaId) {
        const lojas = lojasPorGrupo[grupoId] || [];
        const l = lojas.find(x => parseInt(x.id) === parseInt(lojaId));
        return l ? l.name : null;
    }

    function getUnidadesArray() {
        if (!dashboardFinanceiro || !dashboardFinanceiro.por_unidade) return [];
        const pu = dashboardFinanceiro.por_unidade;
        if (Array.isArray(pu)) return pu;
        return Object.values(pu);
    }

    function aplicarFiltroLoja() {
        if (!dashboardFinanceiro) return;

        const filtroLojaEl = document.getElementById('filtroLoja');
        let selectedLoja = parseInt(filtroLojaEl.value) || null;

        const lojasValidas = (lojasPorGrupo[grupoId] || []).map(l => parseInt(l.id));
        if (selectedLoja && !lojasValidas.includes(selectedLoja)) {
            selectedLoja = null;
            filtroLojaEl.value = "";
        }

        const unidades = getUnidadesArray();

        let unidadesFiltradas = unidades;
        if (selectedLoja) {
            unidadesFiltradas = unidades.filter(u => parseInt(u.system_unit_id) === selectedLoja);
        }

        // Totais D√©bito / Cr√©dito
        let totalDebitos = 0;
        let totalCreditos = 0;

        unidadesFiltradas.forEach(u => {
            totalDebitos += Number(u.totais?.debitos || 0);
            totalCreditos += Number(u.totais?.creditos || 0);
        });

        animateValue('totalDebitos', 0, totalDebitos, 1000, true);
        animateValue('totalCreditos', 0, totalCreditos, 1000, true);

        // Contas a vencer 7 e 30 (sempre tipo D por vencimento, filtradas por loja se houver)
        const contas7 = (dashboardFinanceiro.contas_vencer_7 || []).filter(c =>
            !selectedLoja || parseInt(c.system_unit_id) === selectedLoja
        );
        const contas30 = (dashboardFinanceiro.contas_vencer_30 || []).filter(c =>
            !selectedLoja || parseInt(c.system_unit_id) === selectedLoja
        );

        const total7 = contas7.reduce((acc, c) => acc + Number(c.valor || 0), 0);
        const total30 = contas30.reduce((acc, c) => acc + Number(c.valor || 0), 0);

        animateValue('contasVencer7', 0, total7, 1000, true);
        animateValue('contasVencer30', 0, total30, 1000, true);

        document.getElementById('qtdContas7').textContent = `${contas7.length} conta(s)`;
        document.getElementById('qtdContas30').textContent = `${contas30.length} conta(s)`;

        // Gr√°fico por planos
        let planos = [];

        if (selectedLoja) {
            const unidade = unidades.find(u => parseInt(u.system_unit_id) === selectedLoja);
            planos = unidade?.planos || [];
        } else {
            planos = dashboardFinanceiro.planos_geral || [];
        }

        renderChartPlanos(planos);
    }

    function renderChartPlanos(planos) {
        const dom = document.getElementById('chartPlanosContas');
        if (!dom) return;

        const old = echarts.getInstanceByDom(dom);
        if (old) old.dispose();

        const chart = echarts.init(dom);

        if (!planos || planos.length === 0) {
            chart.setOption({
                title: {
                    text: 'Sem dados para exibir no per√≠odo selecionado.',
                    left: 'center',
                    top: 'middle',
                    textStyle: { color: '#999', fontSize: 14 }
                }
            });
            return;
        }

        const labels = planos.map(p => (p.plano_descricao || p.plano_codigo || '').substring(0, 20));
        const debitos = planos.map(p => Number(p.total_debitos || 0));
        const creditos = planos.map(p => Number(p.total_creditos || 0));

        const option = {
            color: MRK.series,
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: (params) => {
                    let idx = params[0].dataIndex;
                    const plano = planos[idx];
                    const nome = plano.plano_descricao || plano.plano_codigo;
                    const d = Number(plano.total_debitos || 0);
                    const c = Number(plano.total_creditos || 0);
                    const tot = d + c;

                    return `
                        <b>${nome}</b><br/>
                        D√©bitos: <b>${formatBRL(d)}</b><br/>
                        Cr√©ditos: <b>${formatBRL(c)}</b><br/>
                        Total: <b>${formatBRL(tot)}</b>
                    `;
                }
            },
            legend: {
                top: 0,
                textStyle: { color: MRK.black }
            },
            grid: { left: '3%', right: '4%', bottom: '10%', top: 40, containLabel: true },
            xAxis: {
                type: 'category',
                data: labels,
                axisLabel: {
                    fontSize: 11,
                    rotate: labels.length > 10 ? 35 : 0,
                    color: MRK.black
                },
                axisLine: { lineStyle: { color: MRK.black } }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: v => `R$ ${Number(v).toLocaleString('pt-BR')}`,
                    color: MRK.black
                },
                splitLine: { lineStyle: { color: MRK.gray } }
            },
            series: [
                {
                    name: 'D√©bitos',
                    type: 'bar',
                    stack: 'total',
                    data: debitos,
                    itemStyle: { color: MRK.series[0] }
                },
                {
                    name: 'Cr√©ditos',
                    type: 'bar',
                    stack: 'total',
                    data: creditos,
                    itemStyle: { color: MRK.series[1] }
                }
            ]
        };

        chart.setOption(option);
    }

    function mostrarContasPrazo(dias) {
        if (!dashboardFinanceiro) return;

        const filtroLojaEl = document.getElementById('filtroLoja');
        let selectedLoja = parseInt(filtroLojaEl.value) || null;

        const listaBruta = dias === 7
            ? (dashboardFinanceiro.contas_vencer_7 || [])
            : (dashboardFinanceiro.contas_vencer_30 || []);

        const lista = listaBruta.filter(c =>
            !selectedLoja || parseInt(c.system_unit_id) === selectedLoja
        );

        if (lista.length === 0) {
            Swal.fire('Sem contas', `Nenhuma conta a vencer nos pr√≥ximos ${dias} dias para o filtro atual.`, 'info');
            return;
        }

        let html = `
            <div style="max-height:400px;overflow:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                    <thead>
                        <tr>
                            <th style="border-bottom:1px solid #ccc;padding:4px;text-align:left;">Loja</th>
                            <th style="border-bottom:1px solid #ccc;padding:4px;text-align:center;">Nome</th>
                            <th style="border-bottom:1px solid #ccc;padding:4px;text-align:left;">Doc</th>
                            <th style="border-bottom:1px solid #ccc;padding:4px;text-align:left;">Vencimento</th>
                            <th style="border-bottom:1px solid #ccc;padding:4px;text-align:left;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        lista.forEach(c => {
            const venc = c.vencimento
                ? new Date(c.vencimento).toLocaleDateString('pt-BR')
                : '';
            const lojaNome = getNomeLojaById(c.system_unit_id) || c.system_unit_id;
            html += `
                <tr>
                    <td style="border-bottom:1px solid #eee;padding:4px;text-align:left;">${lojaNome}</td>
                    <td style="border-bottom:1px solid #eee;padding:4px;">${c.nome || ''}</td>
                    <td style="border-bottom:1px solid #eee;padding:4px;text-align:left;">${c.doc || ''}</td>
                    <td style="border-bottom:1px solid #eee;padding:4px;text-align:left;">${venc}</td>
                    <td style="border-bottom:1px solid #eee;padding:4px;text-align:left;">${formatBRL(c.valor)}</td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        Swal.fire({
            title: `Contas a vencer nos pr√≥ximos ${dias} dias`,
            html,
            customClass: {
                popup: 'swal2-xl'
            },
            confirmButtonText: 'Fechar'
        });
    }

    // ====== Calend√°rio (Mapa de Contas) ======
    let mapaDeContas = null;          // resposta do getMapaDeContas
    let calAnoMesAtual = null;        // "YYYY-MM"
    const DOWS = ['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];

    function toAnoMes(dateStr) {
        // dateStr: YYYY-MM-DD
        if (!dateStr) return null;
        return dateStr.slice(0, 7);
    }

    function addMonths(anoMes, delta) {
        // anoMes: "YYYY-MM"
        const [y, m] = anoMes.split('-').map(Number);
        const d = new Date(y, m - 1, 1);
        d.setMonth(d.getMonth() + delta);
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return `${yy}-${mm}`;
    }

    function tituloMes(anoMes) {
        const [y, m] = anoMes.split('-').map(Number);
        const dt = new Date(y, m - 1, 1);
        return dt.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    }

    async function fetchMapaDeContas(anoMes, unitId, tipoData) {
        // chama seu m√©todo novo
        const res = await axios.post(baseUrlFinanceiro, {
            method: 'getMapaDeContas',
            token,
            data: {
                unit_id: unitId,
                ano_mes: anoMes,
                tipo_data: tipoData
            }
        });

        if (!res.data || !res.data.success) {
            throw new Error(res.data?.error || res.data?.message || 'Falha ao buscar mapa de contas.');
        }
        return res.data.data;
    }

    function montarMapaDias(mapa) {
        const byDate = {};
        (mapa?.dias || []).forEach(d => {
            byDate[d.data] = d;
        });
        return byDate;
    }

    function renderCalendario(mapa, anoMes) {
        const grid = document.getElementById('calGrid');
        const dows = document.getElementById('calDows');
        const titulo = document.getElementById('calTituloMes');
        const hint = document.getElementById('calHint');

        if (!grid || !dows || !titulo || !hint) return;

        // cabe√ßalho DOW
        dows.innerHTML = DOWS.map(x => `<div class="cal-dow">${x}</div>`).join('');

        titulo.textContent = tituloMes(anoMes);

        // se n√£o tem mapa, limpa
        if (!mapa || !anoMes) {
            grid.innerHTML = '';
            hint.innerHTML = `<span class="text-gray-500">Sem dados para exibir.</span>`;
            return;
        }

        const byDate = montarMapaDias(mapa);

        const [yy, mm] = anoMes.split('-').map(Number);
        const first = new Date(yy, mm - 1, 1);
        const last = new Date(yy, mm, 0); // √∫ltimo dia do m√™s
        const daysInMonth = last.getDate();
        const startDow = first.getDay(); // 0..6

        // grade 6 semanas (42 c√©lulas)
        const totalCells = 42;

        let html = '';
        for (let i = 0; i < totalCells; i++) {
            const dayNum = i - startDow + 1;
            const isInMonth = dayNum >= 1 && dayNum <= daysInMonth;

            if (!isInMonth) {
                html += `<div class="cal-day muted"></div>`;
                continue;
            }

            const dateStr = `${anoMes}-${String(dayNum).padStart(2, '0')}`;
            const dia = byDate[dateStr];
            const total = dia ? Number(dia.total || 0) : 0;
            const qtd = dia ? (dia.itens || []).length : 0;

            const has = dia && qtd > 0;

            html += `
      <div class="cal-day ${has ? 'hasdata' : ''}" ${has ? `onclick="abrirDia('${dateStr}')"` : ''}>
        <div class="cal-num">${dayNum}</div>
        ${has ? `<div class="cal-badge">${qtd}</div>` : ''}
        ${has
                ? `<div class="cal-total">${formatBRL(total)}</div>`
                : `<div class="cal-empty">‚Äî</div>`
            }
      </div>
    `;
        }

        grid.innerHTML = html;

        const totalGeral = Number(mapa?.totais?.valor_total || 0);
        const qtdItens = Number(mapa?.totais?.qtd_itens || 0);
        hint.innerHTML = `
    <b>Total do m√™s:</b> ${formatBRL(totalGeral)} &nbsp; ‚Ä¢ &nbsp;
    <b>Itens:</b> ${qtdItens}
  `;
    }

    function abrirDia(dateStr) {
        if (!mapaDeContas) return;

        const dia = (mapaDeContas.dias || []).find(d => d.data === dateStr);
        if (!dia || !dia.itens || dia.itens.length === 0) {
            Swal.fire('Sem contas', 'Nenhuma conta nesse dia.', 'info');
            return;
        }

        const totalDia = Number(dia.total || 0);

        let html = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
      <div style="font-size:12px;color:#666;">
        <b>Data:</b> ${new Date(dateStr).toLocaleDateString('pt-BR')}
      </div>
      <div style="font-size:12px;">
        <b>Total:</b> ${formatBRL(totalDia)}
      </div>
    </div>

    <div style="max-height:520px;overflow:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:12px;">
        <thead>
          <tr>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:left;">Fornecedor</th>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:center;">Doc</th>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:center;">Dup</th>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:center;">Emiss√£o</th>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:center;">Venc.</th>
            <th style="border-bottom:1px solid #ccc;padding:6px;text-align:right;">Valor</th>
          </tr>
        </thead>
        <tbody>
  `;

        dia.itens.forEach(i => {
            const em = i.emissao ? new Date(i.emissao).toLocaleDateString('pt-BR') : '';
            const vc = i.vencimento ? new Date(i.vencimento).toLocaleDateString('pt-BR') : '';
            html += `
      <tr>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:left;">${i.fornecedor_nome || ''}</td>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:center;">${i.documento || ''}</td>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:center;">${i.numero_duplicata || '-'}</td>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:center;">${em}</td>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:center;">${vc}</td>
        <td style="border-bottom:1px solid #eee;padding:6px;text-align:right;">${formatBRL(i.valor)}</td>
      </tr>
    `;
        });

        html += `</tbody></table></div>`;

        Swal.fire({
            title: `Contas do dia`,
            html,
            customClass: { popup: 'swal2-xl' },
            confirmButtonText: 'Fechar'
        });
    }

    async function atualizarCalendario() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const tipoData = document.getElementById('tipoData').value || 'vencimento';

        // m√™s do endDate (mais intuitivo)
        const anoMes = toAnoMes(endDate || startDate);
        calAnoMesAtual = anoMes;

        const filtroLojaEl = document.getElementById('filtroLoja');
        const selectedLoja = parseInt(filtroLojaEl.value) || null;

        if (!anoMes) {
            mapaDeContas = null;
            renderCalendario(null, null);
            return;
        }

        if (!selectedLoja) {
            mapaDeContas = null;
            renderCalendario(null, anoMes);
            document.getElementById('calHint').innerHTML =
                `<span class="text-gray-500">Selecione uma <b>loja</b> para exibir o calend√°rio desse m√™s.</span>`;
            return;
        }

        try {
            // loader leve (sem travar o dashboard)
            document.getElementById('calHint').innerHTML =
                `<span class="text-gray-500">Carregando calend√°rio do m√™s...</span>`;

            const data = await fetchMapaDeContas(anoMes, selectedLoja, tipoData);
            mapaDeContas = data;
            renderCalendario(mapaDeContas, anoMes);
        } catch (e) {
            console.error(e);
            mapaDeContas = null;
            renderCalendario(null, anoMes);
            document.getElementById('calHint').innerHTML =
                `<span class="text-red-600">Erro ao carregar calend√°rio: ${e.message || 'falha.'}</span>`;
        }
    }

    function navMes(delta) {
        if (!calAnoMesAtual) {
            const endDate = document.getElementById('endDate').value;
            calAnoMesAtual = toAnoMes(endDate);
        }
        if (!calAnoMesAtual) return;

        const novo = addMonths(calAnoMesAtual, delta);
        calAnoMesAtual = novo;

        // Ajusta os inputs de data para esse m√™s (mantendo o ‚Äúrange‚Äù do m√™s)
        const [yy, mm] = novo.split('-').map(Number);
        const first = new Date(yy, mm - 1, 1);
        const last = new Date(yy, mm, 0);

        document.getElementById('startDate').value = first.toISOString().split('T')[0];
        document.getElementById('endDate').value = last.toISOString().split('T')[0];

        // Recarrega dashboard + calend√°rio
        fetchData();
    }


    window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('filtroLoja').addEventListener('change', async () => {
            aplicarFiltroLoja();
            await atualizarCalendario();
        });        document.getElementById('tipoData').addEventListener('change', fetchData);

        await carregarGrupoInicial();
        setRange('7dias');
    });
</script>

</body>
</html>
