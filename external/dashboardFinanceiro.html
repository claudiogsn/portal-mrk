<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Financeiro | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <style>
        html, body { background: transparent !important; }

        :root {
            --mrk-blue: #0B46AC;
            --mrk-green: #2e7d32;
            --mrk-amber: #ffa000;
            --mrk-red: #d32f2f;
            --bg-gray: #F4F7F6;
        }

        body { font-family: 'Poppins', sans-serif; }
        h1, h2, h3, .kanit { font-family: 'Kanit', sans-serif; }

        /* Card MRK */
        .mrk-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-top: 3px solid var(--mrk-blue);
        }
        .card-green { border-top-color: var(--mrk-green); }
        .card-amber { border-top-color: var(--mrk-amber); }
        .card-black { border-top-color: #191F2A; }

        /* Inputs */
        label { font-family: 'Kanit', sans-serif; font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .form-control { height: 38px; border-radius: 6px; border: 1px solid #d1d5db; padding: 0 10px; font-size: 13px; width: 100%; }

        /* Botões */
        .btn-mrk {
            padding: 6px 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;
            font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.2s;
        }
        .btn-mrk:hover { border-color: var(--mrk-blue); color: var(--mrk-blue); background: #f0f4fa; }

        /* Calendário */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-dow { font-size: 11px; font-weight: 700; text-align: center; color: #666; text-transform: uppercase; padding-bottom: 5px; }
        .cal-day {
            background: #fff; border: 1px solid #eee; border-radius: 8px; min-height: 80px; padding: 8px; position: relative; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .cal-day:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: var(--mrk-blue); }
        .cal-day.hasdata { background: #f8fbff; border-color: #dbeafe; }
        .cal-day.muted { background: #f9fafb; opacity: 0.5; pointer-events: none; }

        .cal-num { font-family: 'Kanit'; font-weight: 700; font-size: 14px; color: #333; }
        .cal-badge { position: absolute; top: 8px; right: 8px; background: var(--mrk-blue); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
        .cal-total { position: absolute; bottom: 8px; right: 8px; font-size: 12px; font-weight: 700; color: #333; }
        .cal-empty { position: absolute; bottom: 8px; right: 8px; font-size: 18px; color: #eee; }

        /* Skeletons */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 4px; color: transparent !important;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Modal Grande */
        .swal2-xl { width: 90vw !important; max-width: 1200px !important; }
    </style>
</head>

<body class="text-gray-800">
<div class="p-6 mx-auto">

    <div class="mrk-card p-4 mb-6" style="border-top-width: 2px;">
        <div class="flex items-end gap-4 flex-wrap">
            <div class="flex-1 min-w-[300px]">
                <label>Atalhos de Período</label>
                <div class="flex gap-2">
                    <button onclick="setRange('hoje')" class="btn-mrk">Hoje</button>
                    <button onclick="setRange('ontem')" class="btn-mrk">Ontem</button>
                    <button onclick="setRange('7dias')" class="btn-mrk">7 Dias</button>
                    <button onclick="setRange('mes')" class="btn-mrk">30 Dias</button>
                </div>
            </div>
            <div class="w-36">
                <label>Data Início</label>
                <input type="date" id="startDate" onchange="fetchData()" class="form-control" />
            </div>
            <div class="w-36">
                <label>Data Fim</label>
                <input type="date" id="endDate" onchange="fetchData()" class="form-control" />
            </div>
            <div class="w-40">
                <label>Considerar por</label>
                <select id="tipoData" class="form-control">
                    <option value="vencimento">Vencimento</option>
                    <option value="emissao">Emissão</option>
                </select>
            </div>
            <div class="w-48">
                <label>Grupo Econômico</label>
                <select id="filtroGrupo" class="form-control"></select>
            </div>
            <div class="w-48">
                <label>Loja / Unidade</label>
                <select id="filtroLoja" class="form-control"></select>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">

        <div class="mrk-card p-5 card-amber flex flex-col justify-between h-[140px]">
            <div class="flex items-start justify-between">
                <div>
                    <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider mb-1">A Vencer (7 Dias)</div>
                    <div class="text-2xl font-bold kanit kpi-value" id="contasVencer7">R$ 0,00</div>
                </div>
                <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 text-xl">
                    <iconify-icon icon="icon-park-outline:calendar-dot"></iconify-icon>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs mt-2 border-t pt-2 border-gray-100">
                <span class="font-medium text-gray-600 kpi-value" id="qtdContas7">0 contas</span>
                <button onclick="mostrarContasPrazo(7)" class="text-amber-700 font-bold hover:underline">VER DETALHES</button>
            </div>
        </div>

        <div class="mrk-card p-5 card-amber flex flex-col justify-between h-[140px]">
            <div class="flex items-start justify-between">
                <div>
                    <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider mb-1">A Vencer (30 Dias)</div>
                    <div class="text-2xl font-bold kanit kpi-value" id="contasVencer30">R$ 0,00</div>
                </div>
                <div class="w-10 h-10 rounded-full bg-amber-50 flex items-center justify-center text-amber-600 text-xl">
                    <iconify-icon icon="icon-park-outline:calendar-thirty"></iconify-icon>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs mt-2 border-t pt-2 border-gray-100">
                <span class="font-medium text-gray-600 kpi-value" id="qtdContas30">0 contas</span>
                <button onclick="mostrarContasPrazo(30)" class="text-amber-700 font-bold hover:underline">VER DETALHES</button>
            </div>
        </div>

        <div class="mrk-card p-5 card-black flex items-center gap-4 h-[140px]">
            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 text-2xl">
                <iconify-icon icon="icon-park-outline:arrow-circle-down"></iconify-icon>
            </div>
            <div>
                <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Total Débitos</div>
                <div class="text-2xl font-bold kanit kpi-value" id="totalDebitos">R$ 0,00</div>
            </div>
        </div>

        <div class="mrk-card p-5 card-green flex items-center gap-4 h-[140px]">
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-green-700 text-2xl">
                <iconify-icon icon="icon-park-outline:arrow-circle-up"></iconify-icon>
            </div>
            <div>
                <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Total Créditos</div>
                <div class="text-2xl font-bold kanit kpi-value" id="totalCreditos">R$ 0,00</div>
            </div>
        </div>
    </div>

    <div class="mrk-card p-6 mb-6 relative">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-md font-bold uppercase flex items-center gap-2">
                <iconify-icon icon="icon-park-outline:chart-histogram" class="text-blue-700"></iconify-icon>
                Movimentação por Plano de Contas
            </h2>
        </div>
        <div id="chartPlanosContas" style="width:100%; height:360px;"></div>
        <div id="skel-chartPlanos" class="absolute inset-0 bg-white z-10 hidden p-6"><div class="skeleton h-full w-full rounded"></div></div>
    </div>

    <div class="mrk-card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-md font-bold uppercase flex items-center gap-2">
                    <iconify-icon icon="icon-park-outline:calendar" class="text-blue-700"></iconify-icon>
                    Mapa de Vencimentos
                </h2>
                <p class="text-xs text-gray-500 mt-1">Clique no dia para visualizar os lançamentos previstos.</p>
            </div>
            <div class="flex items-center gap-2 bg-gray-100 p-1 rounded-lg">
                <button class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-blue-700" onclick="navMes(-1)"><iconify-icon icon="icon-park-outline:left"></iconify-icon></button>
                <div class="px-4 font-bold text-sm min-w-[120px] text-center" id="calTituloMes">-</div>
                <button class="w-8 h-8 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-blue-700" onclick="navMes(1)"><iconify-icon icon="icon-park-outline:right"></iconify-icon></button>
            </div>
        </div>

        <div class="cal-grid mb-2" id="calDows"></div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="mt-4 text-xs text-right text-gray-500 font-medium border-t pt-2" id="calHint"></div>
    </div>

</div>

<script>
    'use strict';

    const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/index.php' : 'http://localhost/portal-mrk/api/v1/index.php';
    const baseUrlFinanceiro = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php' : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id')), user_id = parseInt(urlParams.get('user_id')), token = urlParams.get('token');

    const MRK = { blue: '#0B46AC', green: '#2e7d32', gray: '#EBEBEB', black: '#191F2A', series: ['#0B46AC', '#08A794', '#191F2A', '#ffa000'] };
    const formatBRL = (v) => Number(v||0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // === CORREÇÃO CRÍTICA DE DATAS (TIMEZONE FIX) ===
    const parseDateLocal = (dateStr) => {
        if (!dateStr) return null;
        const [y, m, d] = dateStr.split('-').map(Number);
        return new Date(y, m - 1, d);
    };

    let grupoId = null, gruposDisponiveis = [], lojasPorGrupo = {}, lojasGrupo = [], dashboardFinanceiro = null, mapaDeContas = null, calAnoMesAtual = null;
    const DOWS = ['DOM','SEG','TER','QUA','QUI','SEX','SÁB'];

    function toggleSkeletons(isLoading) {
        if(isLoading) {
            $('.kpi-value').addClass('skeleton');
            $('#skel-chartPlanos').removeClass('hidden');
        } else {
            $('.kpi-value').removeClass('skeleton');
            $('#skel-chartPlanos').addClass('hidden');
        }
    }

    function animateValue(id, start, end, duration, isCurrency=false) {
        const el = document.getElementById(id); if(!el) return;
        el.classList.remove('skeleton');
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);
            el.textContent = isCurrency ? formatBRL(value) : Math.floor(value);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function setRange(tipo) {
        const now = new Date(), start = new Date();
        if (tipo === 'ontem') { start.setDate(now.getDate()-1); now.setDate(now.getDate()-1); }
        else if (tipo === '7dias') start.setDate(now.getDate()-7);
        else if (tipo === 'mes') start.setMonth(now.getMonth()-1);
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        fetchData();
    }

    async function fetchData() {
        const start = document.getElementById('startDate').value, end = document.getElementById('endDate').value;
        const tipoData = document.getElementById('tipoData').value;
        if(!grupoId || !start || !end) return;

        toggleSkeletons(true);

        try {
            await carregarLojasGrupo();
            const res = await axios.post(baseUrlFinanceiro, {
                method: 'getDashboardFinanceiroPorGrupo',
                token,
                data: { group_id: grupoId, dt_inicio: start, dt_fim: end, tipo_data: tipoData }
            });

            if (!res.data.success) throw new Error(res.data.message);
            dashboardFinanceiro = res.data.data;
            aplicarFiltroLoja();
            await atualizarCalendario();
        } catch (e) { Swal.fire('Erro', 'Falha ao buscar dados.', 'error'); }
        finally { toggleSkeletons(false); }
    }

    function aplicarFiltroLoja() {
        if (!dashboardFinanceiro) return;
        const lojaId = parseInt($('#filtroLoja').val()) || null;

        const unidades = Object.values(dashboardFinanceiro.por_unidade || {});
        const unidadesFiltradas = lojaId ? unidades.filter(u => parseInt(u.system_unit_id) === lojaId) : unidades;

        let deb = 0, cred = 0;
        unidadesFiltradas.forEach(u => { deb += Number(u.totais?.debitos||0); cred += Number(u.totais?.creditos||0); });
        animateValue('totalDebitos', 0, deb, 800, true);
        animateValue('totalCreditos', 0, cred, 800, true);

        // Contas a Vencer
        const filterContas = (list) => list.filter(c => !lojaId || parseInt(c.system_unit_id) === lojaId);
        const c7 = filterContas(dashboardFinanceiro.contas_vencer_7 || []);
        const c30 = filterContas(dashboardFinanceiro.contas_vencer_30 || []);

        animateValue('contasVencer7', 0, c7.reduce((a,b)=>a+Number(b.valor),0), 800, true);
        animateValue('contasVencer30', 0, c30.reduce((a,b)=>a+Number(b.valor),0), 800, true);
        $('#qtdContas7').text(`${c7.length} contas`);
        $('#qtdContas30').text(`${c30.length} contas`);

        // Gráfico
        const planos = lojaId
            ? (unidades.find(u => parseInt(u.system_unit_id) === lojaId)?.planos || [])
            : (dashboardFinanceiro.planos_geral || []);
        renderChartPlanos(planos);
    }

    function renderChartPlanos(planos) {
        const dom = document.getElementById('chartPlanosContas'); if(!dom) return;
        const chart = echarts.init(dom);
        if(!planos.length) { chart.clear(); return; }

        const labels = planos.map(p => (p.plano_descricao||p.plano_codigo).slice(0,20));
        chart.setOption({
            color: [MRK.blue, MRK.green],
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { top: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: { type: 'category', data: labels, axisLabel: { rotate: 30, fontSize: 10 } },
            yAxis: { type: 'value', axisLabel: { formatter: v => v.toLocaleString('pt-BR',{compactDisplay:'short', notation:'compact'}) } },
            series: [
                { name: 'Débitos', type: 'bar', stack: 'total', data: planos.map(p => Number(p.total_debitos)), itemStyle: { borderRadius: [0,0,4,4] } },
                { name: 'Créditos', type: 'bar', stack: 'total', data: planos.map(p => Number(p.total_creditos)), itemStyle: { borderRadius: [4,4,0,0] } }
            ]
        }, true);
    }

    function mostrarContasPrazo(dias) {
        const lojaId = parseInt($('#filtroLoja').val()) || null;
        const list = (dias === 7 ? dashboardFinanceiro.contas_vencer_7 : dashboardFinanceiro.contas_vencer_30)
            .filter(c => !lojaId || parseInt(c.system_unit_id) === lojaId);

        if(!list.length) return Swal.fire('Tudo pago!', `Nenhuma conta a vencer nos próximos ${dias} dias.`, 'success');

        let html = `<div class="max-h-[50vh] overflow-y-auto border rounded"><table class="w-full text-xs text-left">
            <thead class="bg-gray-100 sticky top-0 shadow-sm"><tr><th class="p-2">Loja</th><th class="p-2">Favorecido</th><th class="p-2">Vencimento</th><th class="p-2 text-right">Valor</th></tr></thead>
            <tbody>${list.map(c => `<tr class="border-b"><td class="p-2">${getNomeLoja(c.system_unit_id)}</td><td class="p-2">${c.nome}</td><td class="p-2">${parseDateLocal(c.vencimento).toLocaleDateString('pt-BR')}</td><td class="p-2 text-right font-bold">${formatBRL(c.valor)}</td></tr>`).join('')}</tbody>
        </table></div>`;
        Swal.fire({ title: `A Vencer (${dias} Dias)`, html, width: '800px', confirmButtonColor: MRK.blue });
    }

    // ====== CALENDÁRIO ======
    async function atualizarCalendario() {
        const start = document.getElementById('startDate').value, end = document.getElementById('endDate').value;
        const lojaId = parseInt($('#filtroLoja').val()) || null;
        const anoMes = (end || start).slice(0, 7);
        calAnoMesAtual = anoMes;

        if(!lojaId) {
            document.getElementById('calGrid').innerHTML = '<div class="col-span-7 text-center py-10 text-gray-400">Selecione uma loja para ver o calendário detalhado.</div>';
            document.getElementById('calTituloMes').textContent = '-';
            return;
        }

        try {
            const res = await axios.post(baseUrlFinanceiro, { method: 'getMapaDeContas', token, data: { unit_id: lojaId, ano_mes: anoMes, tipo_data: $('#tipoData').val() } });
            mapaDeContas = res.data.data;
            renderCalendario(mapaDeContas, anoMes);
        } catch (e) { console.error(e); }
    }

    function renderCalendario(mapa, anoMes) {
        const [y, m] = anoMes.split('-').map(Number);
        const first = new Date(y, m-1, 1), last = new Date(y, m, 0);
        const daysInMonth = last.getDate(), startDow = first.getDay();

        $('#calTituloMes').text(first.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase());
        $('#calDows').html(DOWS.map(d => `<div class="cal-dow">${d}</div>`).join(''));

        let html = '', byDate = {};
        (mapa?.dias || []).forEach(d => byDate[d.data] = d);

        for(let i=0; i<42; i++) {
            const day = i - startDow + 1;
            if(day < 1 || day > daysInMonth) { html += '<div class="cal-day muted"></div>'; continue; }

            const dateStr = `${anoMes}-${String(day).padStart(2,'0')}`;
            const dados = byDate[dateStr];
            const has = dados && dados.itens.length > 0;

            html += `<div class="cal-day ${has?'hasdata':''}" ${has?`onclick="abrirDia('${dateStr}')"`:''}>
                <div class="cal-num">${day}</div>
                ${has ? `<div class="cal-badge">${dados.itens.length}</div><div class="cal-total">${formatBRL(dados.total)}</div>` : '<div class="cal-empty"><iconify-icon icon="icon-park-outline:check-small"></iconify-icon></div>'}
            </div>`;
        }
        $('#calGrid').html(html);
        $('#calHint').html(`Total Mês: <b>${formatBRL(mapa?.totais?.valor_total)}</b>`);
    }

    function abrirDia(dateStr) {
        const dia = mapaDeContas.dias.find(d => d.data === dateStr);
        if(!dia) return;
        let html = `<div class="max-h-[50vh] overflow-y-auto border rounded"><table class="w-full text-xs text-left">
            <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2">Fornecedor</th><th class="p-2">Doc</th><th class="p-2">Vencimento</th><th class="p-2 text-right">Valor</th></tr></thead>
            <tbody>${dia.itens.map(i => `<tr><td class="p-2">${i.fornecedor_nome}</td><td class="p-2">${i.documento}</td><td class="p-2">${parseDateLocal(i.vencimento).toLocaleDateString('pt-BR')}</td><td class="p-2 text-right font-bold">${formatBRL(i.valor)}</td></tr>`).join('')}</tbody>
        </table></div>`;
        Swal.fire({ title: `Contas de ${parseDateLocal(dateStr).toLocaleDateString('pt-BR')}`, html, width: '800px', confirmButtonColor: MRK.blue });
    }

    function navMes(delta) {
        if(!calAnoMesAtual) return;
        const [y, m] = calAnoMesAtual.split('-').map(Number);
        const next = new Date(y, m-1+delta, 1);
        const lastDay = new Date(y, m+delta, 0);
        document.getElementById('startDate').value = next.toISOString().slice(0,10);
        document.getElementById('endDate').value = lastDay.toISOString().slice(0,10);
        fetchData();
    }

    // --- CARGAS INICIAIS ---
    async function carregarLojasGrupo() {
        const res = await axios.post(baseUrl, { method: 'getUnitsByGroup', token, data: { group_id: grupoId } });
        lojasGrupo = res.data;
    }
    function getNomeLoja(id) { return lojasGrupo.find(l => l.id == id)?.name || id; }

    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUnit', token, data: { system_unit_id } });
        if (res.data?.length > 0) grupoId = res.data[0].id;
        const resG = await axios.post(baseUrl, { method: 'getGroupByUser', token, data: { user_id } });
        gruposDisponiveis = resG.data.grupos; lojasPorGrupo = resG.data.lojas_por_grupo;

        $('#filtroGrupo').html(gruposDisponiveis.map(g => `<option value="${g.id}" ${g.id == grupoId ? 'selected' : ''}>${g.nome}</option>`).join(''));
        $('#filtroGrupo').change(function() { grupoId = parseInt(this.value); atualizarFiltroLoja(); fetchData(); });
        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        $('#filtroLoja').html('<option value="">Todas as lojas</option>' + lojas.map(l => `<option value="${l.id}">${l.name}</option>`).join(''));
        $('#filtroLoja').change(async function() { aplicarFiltroLoja(); await atualizarCalendario(); });
    }

    window.addEventListener('DOMContentLoaded', async () => {
        $('#tipoData').change(fetchData);
        await carregarGrupoInicial();
        setRange('7dias');
    });
</script>
</body>
</html>