<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Gestão de Unidades | Portal MRK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <style>
        html, body { background: transparent !important; }

        body { padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
            background: #fff;
        }

        /* Header Flex */
        .header-flex { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid #eee; }
        .header-flex h2 { margin: 0; font-family: 'Kanit'; font-size: 20px; color: var(--mrk-blue); display: flex; align-items: center; gap: 8px; }

        .body { padding: 20px; }

        /* Filtros */
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }
        .form-control { height: 38px; box-shadow: none; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .form-control:focus { border-color: var(--mrk-blue); }
        .input-group .form-control { border-top-left-radius: 0; border-bottom-left-radius: 0; }

        /* Tabela */
        .table-responsive { border: 1px solid #eee; border-radius: 6px; }
        .table { margin-bottom: 0; }
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            text-transform: uppercase;
            padding: 12px;
        }
        .table tbody td {
            font-size: 13px;
            vertical-align: middle !important;
            border-top: 1px solid #f1f1f1;
            padding: 12px;
            color: #555;
        }
        .table-hover tbody tr:hover { background-color: #f0f4f8; }

        /* Ações (Estilo Link com Ícone) */
        .btn-action {
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            display: inline-block;
            margin: 0 6px;
            text-decoration: none !important;
        }
        .btn-action:hover { transform: scale(1.2); }

        .action-blue { color: var(--mrk-blue); }
        .action-green { color: var(--mrk-green); }
        .action-red { color: var(--mrk-red); }
        .action-orange { color: var(--mrk-amber); }

        /* Badges Suaves */
        .badge-status { padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .bg-green-light { background: #e8f5e9; color: var(--mrk-green); border: 1px solid #c8e6c9; }
        .bg-red-light { background: #ffebee; color: var(--mrk-red); border: 1px solid #ffcdd2; }
        .bg-blue-light { background: #e3f2fd; color: var(--mrk-blue); border: 1px solid #bbdefb; }
        .bg-gray-light { background: #f5f5f5; color: #999; border: 1px solid #e0e0e0; }

        /* Skeleton */
        .skeleton-wrapper { display: none; margin-top: 10px; }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 45px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Modal Clean */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px 20px; border-radius: 6px 6px 0 0; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-blue); font-weight: 600; font-size: 18px; margin: 0; display: flex; align-items: center; gap: 8px; }
        .modal-content { border: none; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .modal-footer { border-top: 1px solid #eee; background: #fff; padding: 15px 20px; border-radius: 0 0 6px 6px; }

        .btn-success { background-color: var(--mrk-green) !important; border:none; padding: 8px 16px; border-radius: 4px; font-family: 'Kanit'; color:#fff; }
        .btn-primary { background-color: var(--mrk-blue) !important; border:none; padding: 8px 16px; border-radius: 4px; font-family: 'Kanit'; color:#fff; }
        .btn-default { border: 1px solid #ddd; background: #fff; color: #666; padding: 8px 16px; border-radius: 4px; font-family: 'Kanit'; }

        .muted { color: #888; font-size: 12px; margin-bottom: 5px; display: block; font-weight: 500; }

        /* Tabs no Modal */
        .nav-tabs { border-bottom: 2px solid #eee; margin-top: 15px; margin-bottom: 20px; }
        .nav-tabs > li > a {
            color: #666; font-weight: 500; border: none; border-bottom: 3px solid transparent;
            padding: 10px 20px; font-family: 'Kanit'; margin-right: 2px;
        }
        .nav-tabs > li.active > a, .nav-tabs > li.active > a:hover, .nav-tabs > li.active > a:focus {
            color: var(--mrk-blue); border-bottom: 3px solid var(--mrk-blue); background: transparent; cursor: default;
        }
        .nav-tabs > li > a:hover { background: #f9f9f9; border-bottom-color: #ddd; }

        /* Switches Cards */
        .switch-card {
            border: 1px solid #eee; border-radius: 6px; padding: 15px; margin-bottom: 10px; background: #fff;
            display: flex; align-items: center; justify-content: space-between; transition: 0.2s;
        }
        .switch-card:hover { border-color: #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .switch-info h5 { margin: 0 0 3px; font-size: 13px; font-weight: 700; color: #444; font-family: 'Kanit'; }
        .switch-info p { margin: 0; font-size: 11px; color: #888; }

        .switch label input[type=checkbox]:checked + .lever { background-color: #80aaff; }
        .switch label input[type=checkbox]:checked + .lever:after { background-color: var(--mrk-blue); left: 24px; }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:shop"></iconify-icon>
                GESTÃO DE UNIDADES
            </h2>
            <button id="btnNovaUnidade" class="btn btn-success waves-effect">
                <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                NOVA UNIDADE
            </button>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-12">
                        <label class="muted">Buscar Unidade</label>
                        <div class="input-group" style="margin-bottom: 0;">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                            <input type="text" id="filtroUnidade" class="form-control" placeholder="Digite o nome, CNPJ ou código...">
                        </div>
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="tabela-unidades">
                    <thead>
                    <tr>
                        <th class="text-center" width="100">Ações</th>
                        <th width="60">ID</th>
                        <th>Nome Fantasia</th>
                        <th>CNPJ</th>
                        <th>Cód. Custom</th>
                        <th class="text-center">Consolidação</th>
                        <th class="text-center">Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="7" class="text-center muted" style="padding: 30px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalCriarUnidade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><iconify-icon icon="icon-park-outline:plus"></iconify-icon> Nova Unidade</h4>
            </div>
            <div class="modal-body">
                <form id="formCriarUnidade">
                    <div class="form-group">
                        <label class="muted">Nome da Unidade *</label>
                        <input type="text" class="form-control" id="novoNome" placeholder="Ex: Matriz Centro" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="muted">CNPJ</label>
                                <input type="text" class="form-control" id="novoCnpj" placeholder="00.000.000/0000-00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="muted">Código Customizado</label>
                                <input type="text" class="form-control" id="novoCustomCode" placeholder="Ex: LOJA01">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" id="btnSalvarNovaUnidade" class="btn btn-primary">SALVAR UNIDADE</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarUnidade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"><iconify-icon icon="icon-park-outline:edit"></iconify-icon> Editar Unidade</h4>
            </div>
            <div class="modal-body" style="padding-top: 0; background-color: #fcfcfc;">

                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active">
                        <a href="#tab_dados" aria-controls="tab_dados" role="tab" data-toggle="tab">
                            <iconify-icon icon="icon-park-outline:info"></iconify-icon> Dados Gerais
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#tab_integracoes" aria-controls="tab_integracoes" role="tab" data-toggle="tab">
                            <iconify-icon icon="icon-park-outline:api"></iconify-icon> Integrações
                        </a>
                    </li>
                    <li role="presentation">
                        <a href="#tab_automacao" aria-controls="tab_automacao" role="tab" data-toggle="tab">
                            <iconify-icon icon="icon-park-outline:robot"></iconify-icon> Automação
                        </a>
                    </li>
                </ul>

                <div class="tab-content" style="padding: 10px;">

                    <div role="tabpanel" class="tab-pane active" id="tab_dados">
                        <div class="row">
                            <div class="col-md-2">
                                <label class="muted">ID</label>
                                <input type="text" id="editId" class="form-control" readonly style="background: #eee;">
                            </div>
                            <div class="col-md-7">
                                <label class="muted">Nome da Unidade</label>
                                <input type="text" class="form-control" id="editNome">
                            </div>
                            <div class="col-md-3">
                                <label class="muted">Status</label>
                                <select id="editStatus" class="form-control">
                                    <option value="1">Ativo</option>
                                    <option value="0">Inativo</option>
                                </select>
                            </div>
                        </div>
                        <div class="row" style="margin-top: 15px;">
                            <div class="col-md-6">
                                <label class="muted">CNPJ</label>
                                <input type="text" class="form-control" id="editCnpj">
                            </div>
                            <div class="col-md-6">
                                <label class="muted">Custom Code</label>
                                <input type="text" class="form-control" id="editCustomCode">
                            </div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="tab_integracoes">

                        <div class="switch-card">
                            <div class="switch-info">
                                <h5>Módulo Financeiro</h5>
                                <p>Habilita lançamentos e fluxo de caixa.</p>
                            </div>
                            <div class="switch">
                                <label><input type="checkbox" id="editFinanceiro"><span class="lever"></span></label>
                            </div>
                        </div>

                        <h6 style="color:var(--mrk-blue); margin: 20px 0 10px 0; font-family:'Kanit';">Integração MENEW</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="switch-card">
                                    <div class="switch-info"><h5>Importar Faturamento</h5></div>
                                    <div class="switch"><label><input type="checkbox" id="editMenewFaturamento"><span class="lever"></span></label></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="switch-card">
                                    <div class="switch-info"><h5>Sincronizar Estoque</h5></div>
                                    <div class="switch"><label><input type="checkbox" id="editMenewEstoque"><span class="lever"></span></label></div>
                                </div>
                            </div>
                        </div>

                        <h6 style="color:var(--mrk-blue); margin: 15px 0 10px 0; font-family:'Kanit';">Integração ZIG PAY</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="switch-card">
                                    <div class="switch-info"><h5>Importar Faturamento</h5></div>
                                    <div class="switch"><label><input type="checkbox" id="editZigFaturamento"><span class="lever"></span></label></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="switch-card">
                                    <div class="switch-info"><h5>Sincronizar Estoque</h5></div>
                                    <div class="switch"><label><input type="checkbox" id="editZigEstoque"><span class="lever"></span></label></div>
                                </div>
                            </div>
                        </div>

                        <div id="zigCampos" style="display:none; background:#f1f1f1; padding:15px; border-radius:6px; margin-top:5px;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="muted">Token Zig</label>
                                    <input type="text" class="form-control" id="editTokenZig">
                                </div>
                                <div class="col-md-6">
                                    <label class="muted">Rede Zig</label>
                                    <input type="text" class="form-control" id="editRedeZig">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="tab_automacao">
                        <div class="switch-card">
                            <div class="switch-info">
                                <h5>Consolidação Automática</h5>
                                <p>Processa os dados noturnos automaticamente sem intervenção.</p>
                            </div>
                            <div class="switch">
                                <label><input type="checkbox" id="editConsolidacaoAutomatica"><span class="lever"></span></label>
                            </div>
                        </div>

                        <div class="switch-card">
                            <div class="switch-info">
                                <h5>Exportação F360</h5>
                                <p>Envia o DRE e fluxo de caixa para a plataforma F360 diariamente.</p>
                            </div>
                            <div class="switch">
                                <label><input type="checkbox" id="editF360Integration"><span class="lever"></span></label>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">CANCELAR</button>
                <button type="button" id="btnSalvarEdicao" class="btn btn-primary">SALVAR ALTERAÇÕES</button>
            </div>
        </div>
    </div>
</div>

<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const token = new URLSearchParams(window.location.search).get('token');

    // Helper: Skeleton
    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    function limparCnpj(v) { return v ? v.replace(/\D/g, '') : ''; }

    $(document).ready(() => {
        $('#novoCnpj, #editCnpj').mask('00.000.000/0000-00');

        listarUnidades();

        $('#filtroUnidade').on('input', function() {
            const t = $(this).val().toLowerCase();
            $('#tabela-unidades tbody tr').each(function() {
                const txt = $(this).text().toLowerCase();
                $(this).toggle(txt.indexOf(t) > -1);
            });
        });

        $('#btnNovaUnidade').click(() => {
            $('#formCriarUnidade')[0].reset();
            $('#modalCriarUnidade').modal('show');
        });

        $('#btnSalvarNovaUnidade').click(async () => {
            const nome = $('#novoNome').val();
            if (!nome) return Swal.fire('Erro', 'O nome é obrigatório.', 'warning');

            Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
            try {
                await axios.post(baseUrl, {
                    method: 'salvarSystemUnit', token,
                    data: { name: nome, cnpj: limparCnpj($('#novoCnpj').val()), custom_code: $('#novoCustomCode').val() }
                });
                Swal.close(); $('#modalCriarUnidade').modal('hide'); listarUnidades();
            } catch (e) { Swal.fire('Erro', 'Falha ao salvar.', 'error'); }
        });

        $('#btnSalvarEdicao').click(async () => {
            const data = {
                id: $('#editId').val(), name: $('#editNome').val(), cnpj: limparCnpj($('#editCnpj').val()), custom_code: $('#editCustomCode').val(),
                intg_financeiro: $('#editFinanceiro').is(':checked')?'1':'0',
                zig_integration_faturamento: $('#editZigFaturamento').is(':checked')?'1':'0',
                zig_integration_estoque: $('#editZigEstoque').is(':checked')?'1':'0',
                menew_integration_faturamento: $('#editMenewFaturamento').is(':checked')?'1':'0',
                menew_integration_estoque: $('#editMenewEstoque').is(':checked')?'1':'0',
                token_zig: $('#editTokenZig').val(), rede_zig: $('#editRedeZig').val(),
                f360_integration: $('#editF360Integration').is(':checked')?'1':'0',
                consolidacao_automatica: $('#editConsolidacaoAutomatica').is(':checked')?1:0,
                status: $('#editStatus').val()
            };

            Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
            try {
                await axios.post(baseUrl, { method: 'salvarSystemUnit', token, data });
                Swal.close(); $('#modalEditarUnidade').modal('hide'); listarUnidades();
            } catch (e) { Swal.fire('Erro', 'Falha ao salvar.', 'error'); }
        });

        $('#editZigFaturamento, #editZigEstoque').change(toggleCamposZig);
    });

    async function listarUnidades() {
        toggleLoading(true);
        try {
            const res = await axios.post(baseUrl, { method: 'listSystemUnits', token, data: {} });
            const tbody = $('#tabela-unidades tbody').empty();

            if(!res.data.unidades || !res.data.unidades.length) {
                tbody.html('<tr><td colspan="7" class="text-center muted" style="padding:30px;">Nenhuma unidade encontrada.</td></tr>');
            } else {
                res.data.unidades.forEach(u => {
                    const statusHtml = u.status == 1
                        ? '<span class="badge-status bg-green-light">ATIVO</span>'
                        : '<span class="badge-status bg-red-light">INATIVO</span>';

                    const consolHtml = u.consolidacao_automatica == 1
                        ? '<span class="badge-status bg-blue-light"><iconify-icon icon="icon-park-outline:check-one"></iconify-icon> AUTO</span>'
                        : '<span class="badge-status bg-gray-light">MANUAL</span>';

                    // === CORREÇÃO AQUI: TAG <A> COM CLASSE BTN-ACTION ===
                    const btnEditar = `<a class="btn-action action-blue" onclick="editarUnidade(${u.id})" title="Editar"><iconify-icon icon="icon-park-outline:edit"></iconify-icon></a>`;
                    const btnStatus = `<a class="btn-action ${u.status==1 ? 'action-red' : 'action-green'}" onclick="toggleAtivo(${u.id}, ${u.status})" title="${u.status==1 ? 'Desativar' : 'Ativar'}"><iconify-icon icon="icon-park-outline:power"></iconify-icon></a>`;

                    tbody.append(`
                        <tr>
                            <td class="text-center nowrap">${btnEditar} ${btnStatus}</td>
                            <td><b>${u.id}</b></td>
                            <td>${u.name}</td>
                            <td>${u.cnpj || '-'}</td>
                            <td>${u.custom_code || '-'}</td>
                            <td class="text-center">${consolHtml}</td>
                            <td class="text-center">${statusHtml}</td>
                        </tr>
                    `);
                });
            }
            toggleLoading(false);
        } catch (e) {
            console.error(e); toggleLoading(false);
            $('#tabela-unidades tbody').html('<tr><td colspan="7" class="text-center text-danger">Erro de conexão.</td></tr>');
        }
    }

    async function editarUnidade(id) {
        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });
        try {
            const res = await axios.post(baseUrl, { method: 'getSystemUnitById', token, data: { id } });
            const u = res.data; Swal.close();

            $('#editId').val(u.id); $('#editNome').val(u.name); $('#editCnpj').val(u.cnpj).trigger('input'); $('#editCustomCode').val(u.custom_code);
            $('#editFinanceiro').prop('checked', u.intg_financeiro == '1');
            $('#editZigFaturamento').prop('checked', u.zig_integration_faturamento == '1');
            $('#editZigEstoque').prop('checked', u.zig_integration_estoque == '1');
            $('#editMenewFaturamento').prop('checked', u.menew_integration_faturamento == '1');
            $('#editMenewEstoque').prop('checked', u.menew_integration_estoque == '1');
            $('#editTokenZig').val(u.token_zig); $('#editRedeZig').val(u.rede_zig);
            $('#editF360Integration').prop('checked', u.f360_integration == '1');
            $('#editConsolidacaoAutomatica').prop('checked', u.consolidacao_automatica == 1);
            $('#editStatus').val(u.status);

            toggleCamposZig();
            $('.nav-tabs a[href="#tab_dados"]').tab('show'); // Reseta para primeira aba
            $('#modalEditarUnidade').modal('show');
        } catch (e) { Swal.fire('Erro', 'Falha ao carregar.', 'error'); }
    }

    async function toggleAtivo(id, status) {
        const res = await Swal.fire({ title: `Deseja ${status?'desativar':'ativar'}?`, icon: 'question', showCancelButton: true });
        if(res.isConfirmed) {
            await axios.post(baseUrl, { method: 'toggleSystemUnitStatus', token, data: { id } });
            listarUnidades();
        }
    }

    function toggleCamposZig() {
        const show = $('#editZigFaturamento').is(':checked') || $('#editZigEstoque').is(':checked');
        $('#zigCampos').toggle(show);
    }
</script>
</body>
</html>