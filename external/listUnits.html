<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Gestão de Unidades</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/materialize.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- jQuery Mask para CNPJ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <link href="style/mrk.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">


    <style>
        .form-control { margin-bottom: 10px; }

        .section-title {
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .switch-group small {
            display: block;
            font-size: 11px;
            color: #777;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            body, .form-control, .modal-content, table, th, td, button, .section-title {
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br />
    <div class="card">
        <div class="header"><h2>Estabelecimentos</h2></div>
        <div class="body">
            <div class="row">
                <div class="col-md-6">
                    <input type="text" id="filtroUnidade" class="form-control" placeholder="Filtrar por nome" />
                </div>
                <div class="col-md-6 text-right">
                    <button class="btn btn-success" id="btnNovaUnidade">Nova Unidade</button>
                </div>
            </div>
            <div class="table-responsive">
                <!-- TABELA DE UNIDADES -->
                <table class="table table-striped table-hover" id="tabela-unidades">
                    <thead>
                    <tr>
                        <th style="width: 28px; padding: 0;" class="text-center"></th> <!-- Editar -->
                        <th style="width: 28px; padding: 0;" class="text-center"></th> <!-- Ativar/Desativar -->
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Custom Code</th>
                        <th>Consol. Auto.</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edição/Cadastro - NOVA UNIDADE -->
<div class="modal fade" id="modalCriarUnidade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header"><h4 class="modal-title">Nova Unidade</h4></div>
            <div class="modal-body">
                <form id="formCriarUnidade">
                    <label>Nome *</label>
                    <input type="text" class="form-control" id="novoNome" placeholder="Nome da unidade" required>

                    <label>CNPJ</label>
                    <input type="text" class="form-control" id="novoCnpj" placeholder="00.000.000/0000-00">

                    <label>Custom Code</label>
                    <input type="text" class="form-control" id="novoCustomCode" placeholder="Código customizado (opcional)">
                </form>
            </div>
            <div class="modal-footer">
                <button id="btnSalvarNovaUnidade" class="btn btn-primary">Salvar</button>
                <button class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edição -->
<div class="modal fade" id="modalEditarUnidade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header"><h3 class="modal-title">Editar Unidade</h3></div>
            <div class="modal-body">
                <form id="formEditarUnidade">
                    <!-- DADOS PRINCIPAIS -->
                    <div class="section-title">Dados da Unidade</div>
                    <div class="row">
                        <div class="col-md-2">
                            <label>ID:</label>
                            <input type="text" id="editId" class="form-control" readonly>
                        </div>

                        <div class="col-md-4">
                            <label>Nome:</label>
                            <input type="text" class="form-control" id="editNome" required>
                        </div>

                        <div class="col-md-3">
                            <label>CNPJ:</label>
                            <input type="text" class="form-control" id="editCnpj" placeholder="00.000.000/0000-00">
                        </div>

                        <div class="col-md-3">
                            <label>Custom Code:</label>
                            <input type="text" class="form-control" id="editCustomCode">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3">
                            <label>Status:</label>
                            <select id="editStatus" class="form-control">
                                <option value="1">Ativo</option>
                                <option value="0">Inativo</option>
                            </select>
                        </div>
                    </div>

                    <hr>

                    <!-- MENew -->
                    <div class="section-title">Integração Menew</div>
                    <div class="row switch-group">
                        <div class="col-sm-4">
                            <div class="demo-switch-title">Faturamento</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editMenewFaturamento">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Importar vendas/faturamento da Menew.</small>
                        </div>
                        <div class="col-sm-4">
                            <div class="demo-switch-title">Estoque</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editMenewEstoque">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Sincronizar movimentações de estoque.</small>
                        </div>
                        <div class="col-sm-4">
                            <div class="demo-switch-title">Financeiro</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editFinanceiro">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Habilita integração com módulo financeiro.</small>
                        </div>
                    </div>

                    <hr>

                    <!-- ZIG -->
                    <div class="section-title">Integração Zig Pay</div>
                    <div class="row switch-group">
                        <div class="col-sm-4">
                            <div class="demo-switch-title">Faturamento</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editZigFaturamento">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Busca vendas direto da Zig.</small>
                        </div>
                        <div class="col-sm-4">
                            <div class="demo-switch-title">Estoque</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editZigEstoque">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Atualiza estoque com base nos dados da Zig.</small>
                        </div>
                    </div>

                    <div class="row" id="zigCampos" style="margin-top: 10px; display: none;">
                        <div class="col-md-6">
                            <label>Token Zig:</label>
                            <input type="text" class="form-control" id="editTokenZig">
                        </div>
                        <div class="col-md-6">
                            <label>Rede Zig:</label>
                            <input type="text" class="form-control" id="editRedeZig">
                        </div>
                    </div>

                    <hr>

                    <!-- CONSOLIDAÇÃO E F360 -->
                    <div class="section-title">Automação & Consolidação</div>
                    <div class="row switch-group">
                        <div class="col-sm-6">
                            <div class="demo-switch-title">Consolidação Automática</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editConsolidacaoAutomatica">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Se ativo, executa a consolidação de dados de forma automática.</small>
                        </div>
                        <div class="col-sm-6">
                            <div class="demo-switch-title">Integração F360</div>
                            <div class="switch">
                                <label>
                                    <input type="checkbox" id="editF360Integration">
                                    <span class="lever switch-col-blue"></span>
                                </label>
                            </div>
                            <small>Envia dados financeiros para o F360.</small>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button id="btnSalvarEdicao" class="btn btn-primary">Salvar</button>
                <button class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>


<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const token = new URLSearchParams(window.location.search).get('token');

    // helper para limpar CNPJ (só dígitos)
    function limparCnpj(valor) {
        if (!valor) return '';
        return valor.replace(/\D/g, '');
    }

    $(document).ready(() => {
        // máscaras
        $('#novoCnpj').mask('00.000.000/0000-00');
        $('#editCnpj').mask('00.000.000/0000-00');

        listarUnidades();

        $('#btnNovaUnidade').click(() => {
            $('#formCriarUnidade')[0].reset();
            $('#modalCriarUnidade').modal('show');
        });

        $('#btnSalvarNovaUnidade').click(async () => {
            const nome = $('#novoNome').val();
            const cnpj = limparCnpj($('#novoCnpj').val());
            const custom_code = $('#novoCustomCode').val();

            if (!nome) {
                return Swal.fire('Erro', 'O nome é obrigatório.', 'error');
            }

            Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                await axios.post(baseUrl, {
                    method: 'salvarSystemUnit',
                    token,
                    data: {
                        name: nome,
                        cnpj: cnpj || null,
                        custom_code: custom_code
                    }
                });

                Swal.close();
                $('#modalCriarUnidade').modal('hide');
                listarUnidades();
            } catch (e) {
                console.error(e);
                Swal.fire('Erro', 'Erro ao salvar a unidade.', 'error');
            }
        });

        $('#btnSalvarEdicao').click(async () => {
            const cnpjLimpo = limparCnpj($('#editCnpj').val());

            const data = {
                id: $('#editId').val(),
                name: $('#editNome').val(),
                cnpj: cnpjLimpo || null,
                custom_code: $('#editCustomCode').val(),
                intg_financeiro: $('#editFinanceiro').is(':checked') ? '1' : '0',
                zig_integration_faturamento: $('#editZigFaturamento').is(':checked') ? '1' : '0',
                zig_integration_estoque: $('#editZigEstoque').is(':checked') ? '1' : '0',
                menew_integration_faturamento: $('#editMenewFaturamento').is(':checked') ? '1' : '0',
                menew_integration_estoque: $('#editMenewEstoque').is(':checked') ? '1' : '0',
                token_zig: $('#editTokenZig').val(),
                rede_zig: $('#editRedeZig').val(),
                f360_integration: $('#editF360Integration').is(':checked') ? '1' : '0',
                consolidacao_automatica: $('#editConsolidacaoAutomatica').is(':checked') ? 1 : 0,
                status: $('#editStatus').val()
            };

            if (!data.name) {
                return Swal.fire('Erro', 'O nome é obrigatório.', 'error');
            }

            Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                await axios.post(baseUrl, {
                    method: 'salvarSystemUnit',
                    token,
                    data
                });

                Swal.close();
                $('#modalEditarUnidade').modal('hide');
                listarUnidades();
            } catch (e) {
                console.error(e);
                Swal.fire('Erro', 'Erro ao salvar a edição.', 'error');
            }
        });

        $('#editZigFaturamento, #editZigEstoque').change(toggleCamposZig);

        $('#filtroUnidade').on('input', function () {
            const termo = $(this).val().toLowerCase();
            $('#tabela-unidades tbody tr').each(function () {
                const nome = $(this).find('td:nth-child(4)').text().toLowerCase();
                $(this).toggle(nome.includes(termo));
            });
        });
    });

    async function listarUnidades() {
        try {
            const res = await axios.post(baseUrl, { method: 'listSystemUnits', token, data: {} });
            const tbody = $('#tabela-unidades tbody');
            tbody.empty();

            (res.data.unidades || []).forEach(unidade => {
                const ativo = unidade.status == 1
                    ? '<span class="label label-success">Sim</span>'
                    : '<span class="label label-danger">Não</span>';

                const consolAuto = parseInt(unidade.consolidacao_automatica || 0) === 1
                    ? '<span class="label label-info">Sim</span>'
                    : '<span class="label label-default">Não</span>';

                const row = `
                <tr>
                    <td class="text-center">
                        <a href="#" onclick="editarUnidade(${unidade.id})"><i class="far fa-edit blue"></i></a>
                    </td>
                    <td class="text-center">
                        <a href="#" onclick="toggleAtivo(${unidade.id}, ${unidade.status})">
                            <i class="fa fa-power-off ${unidade.status == 1 ? 'red' : 'green'}"></i>
                        </a>
                    </td>
                    <td>${unidade.id}</td>
                    <td>${unidade.name}</td>
                    <td>${unidade.custom_code || '-'}</td>
                    <td class="text-center">${consolAuto}</td>
                    <td class="text-center">${ativo}</td>
                </tr>`;
                tbody.append(row);
            });
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Erro ao carregar unidades.', 'error');
        }
    }

    async function editarUnidade(id) {
        try {
            const res = await axios.post(baseUrl, {
                method: 'getSystemUnitById',
                token,
                data: { id }
            });

            const u = res.data;

            $('#editId').val(u.id);
            $('#editNome').val(u.name || '');
            $('#editCnpj').val(u.cnpj || '').trigger('input'); // máscara aplica
            $('#editCustomCode').val(u.custom_code || '');

            $('#editFinanceiro').prop('checked', u.intg_financeiro === '1');
            $('#editZigFaturamento').prop('checked', u.zig_integration_faturamento === '1');
            $('#editZigEstoque').prop('checked', u.zig_integration_estoque === '1');
            $('#editMenewFaturamento').prop('checked', u.menew_integration_faturamento === '1');
            $('#editMenewEstoque').prop('checked', u.menew_integration_estoque === '1');

            $('#editTokenZig').val(u.token_zig || '');
            $('#editRedeZig').val(u.rede_zig || '');

            $('#editF360Integration').prop('checked', (u.f360_integration === '1'));
            $('#editConsolidacaoAutomatica').prop('checked', parseInt(u.consolidacao_automatica || 0) === 1);

            $('#editStatus').val(u.status != null ? u.status : 1);

            toggleCamposZig();

            $('#modalEditarUnidade').modal('show');
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Erro ao carregar unidade.', 'error');
        }
    }

    async function toggleAtivo(id, statusAtual) {
        const confirmar = await Swal.fire({
            title: `Deseja ${statusAtual ? 'desativar' : 'ativar'} esta unidade?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar'
        });

        if (!confirmar.isConfirmed) return;

        Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            await axios.post(baseUrl, {
                method: 'toggleSystemUnitStatus',
                token,
                data: { id }
            });
            Swal.close();
            listarUnidades();
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Erro ao alterar status.', 'error');
        }
    }

    function toggleCamposZig() {
        const mostrar = $('#editZigFaturamento').is(':checked') || $('#editZigEstoque').is(':checked');
        $('#zigCampos').toggle(mostrar);
    }
</script>
</body>
</html>
