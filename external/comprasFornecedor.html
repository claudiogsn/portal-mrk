<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Relatório - Compras por Fornecedor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Header e Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        .table tbody td { font-size: 12px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        /* Linha Expansível */
        td.cell-toggle { cursor: pointer; color: var(--mrk-blue); transition: transform 0.2s; }
        td.cell-toggle:hover { color: var(--mrk-black); }
        tr.itens-row { display: none; }
        tr.itens-row td { background: #fdfdfd !important; padding: 15px !important; box-shadow: inset 0 3px 6px rgba(0,0,0,0.02); }

        /* Subtabela */
        .subtable { border: 1px solid #eee; margin-bottom: 0; background: #fff; }
        .subtable th { background: #f1f1f1 !important; color: #666 !important; font-size: 11px !important; }

        /* Select2 Custom */
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ccc; border-radius: 4px; min-height: 34px;
        }
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: var(--mrk-blue);
        }

        /* Skeleton Loader */
        .skeleton-wrapper { display: none; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        .sk-kpi { height: 80px; width: 100%; border-radius: 6px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:shopping-bag" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                COMPRAS POR FORNECEDOR
            </h2>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-3">
                        <label class="muted">Data Inicial</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dtInicio" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Data Final</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dtFim" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Considerar Data de:</label>
                        <select id="tipoData" class="form-control">
                            <option value="entrada">Entrada</option>
                            <option value="emissao">Emissão</option>
                        </select>
                    </div>
                    <div class="col-md-3" style="margin-top: 22px;">
                        <button id="btnAtualizar" class="btn btn-primary btn-block waves-effect">
                            <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            ATUALIZAR
                        </button>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-bottom: 20px;">
                <div class="col-md-4">
                    <div class="kpi gray">
                        <small>Qtd. Notas</small>
                        <h4 id="totQtd">0</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi green">
                        <small>Valor Total (R$)</small>
                        <h4 id="totValor">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi orange">
                        <small>Ticket Médio</small>
                        <h4 id="totMedia">R$ 0,00</h4>
                    </div>
                </div>
            </div>

            <div class="row clearfix" style="margin-bottom: 15px;">
                <div class="col-md-6">
                    <label class="muted">Filtrar Fornecedor</label>
                    <select id="filtroFornecedor" class="form-control" multiple="multiple"></select>
                </div>
                <div class="col-md-6">
                    <label class="muted">Busca Rápida</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                        <input type="text" id="filtroTexto" class="form-control" placeholder="Nota, Chave, Produto...">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <button id="btnExpandirTudo" class="btn btn-default btn-sm waves-effect">
                        <iconify-icon icon="icon-park-outline:expand-down"></iconify-icon> Expandir
                    </button>
                    <button id="btnRecolherTudo" class="btn btn-default btn-sm waves-effect">
                        <iconify-icon icon="icon-park-outline:expand-up"></iconify-icon> Recolher
                    </button>
                </div>
                <span class="muted text-small" id="infoStatus"></span>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="tabela-notas">
                    <thead>
                    <tr>
                        <th style="width:40px;"></th>
                        <th class="nowrap">Nota</th>
                        <th class="nowrap">Fornecedor</th>
                        <th class="nowrap">Emissão</th>
                        <th class="nowrap">Entrada</th>
                        <th class="text-right nowrap">Valor Total</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="6" class="text-center muted" style="padding: 30px;">Clique em <b>ATUALIZAR</b> para carregar os dados.</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // ================= CONFIG =================
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('unit_id');

    // ================= STATE =================
    let dadosBrutos = [];
    let notasFiltradas = [];
    let expandedSet = new Set();

    // ================= HELPER FUNCTIONS =================
    function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function brMoney(v) { return Number(v || 0).toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); }

    function formatBRDate(dt) {
        if (!dt) return '';
        const s = String(dt).slice(0, 10);
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
            const [y, m, d] = s.split('-');
            return `${d}/${m}/${y}`;
        }
        return '';
    }

    function makeNotaKey(n) {
        const chave = (n.chave_acesso || '').trim();
        const nf = (n.numero_nf || '').trim();
        const serie = (n.serie || '').trim();
        return chave ? `CH:${chave}` : `NF:${nf}|${serie}|F:${n.fornecedor_id || ''}`;
    }

    function toggleLoader(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    function debounce(fn, ms){
        let t; return function(){ clearTimeout(t); const args = arguments; t = setTimeout(() => fn.apply(null, args), ms); }
    }

    // ================= INIT =================
    $(document).ready(() => {
        // Select2 Config
        $('#filtroFornecedor').select2({
            placeholder: 'Selecione Fornecedores...',
            width: '100%',
            allowClear: true,
            closeOnSelect: false
        });

        // Datas Padrão
        const hoje = new Date();
        const y = hoje.getFullYear();
        const m = String(hoje.getMonth() + 1).padStart(2, '0');
        const d = String(hoje.getDate()).padStart(2, '0');
        $('#dtFim').val(`${y}-${m}-${d}`);

        const ini = new Date(hoje.getTime() - 7*24*60*60*1000);
        const y2 = ini.getFullYear();
        const m2 = String(ini.getMonth() + 1).padStart(2, '0');
        const d2 = String(ini.getDate()).padStart(2, '0');
        $('#dtInicio').val(`${y2}-${m2}-${d2}`);

        // Eventos
        $('#btnAtualizar').on('click', fetchBackend);
        $('#filtroFornecedor').on('change', applyFiltrosTempoReal);
        $('#filtroTexto').on('input', debounce(applyFiltrosTempoReal, 300));
        $('#btnExpandirTudo').on('click', () => expandCollapseAll(true));
        $('#btnRecolherTudo').on('click', () => expandCollapseAll(false));

        if (!token || !system_unit_id) {
            Swal.fire('Atenção', 'URL inválida (token/unit_id).', 'warning');
        }
    });

    // ================= BACKEND =================
    async function fetchBackend(){
        const dt_inicio = $('#dtInicio').val();
        const dt_fim    = $('#dtFim').val();
        const tipoData  = $('#tipoData').val();

        if (!dt_inicio || !dt_fim) {
            return Swal.fire('Atenção', 'Informe o período.', 'warning');
        }

        toggleLoader(true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'getComprasPorPeriodo',
                token,
                data: {
                    system_unit_id: Number(system_unit_id),
                    dt_inicio,
                    dt_fim,
                    tipoData
                }
            });

            if (!res.data || res.data.success === false) {
                toggleLoader(false);
                dadosBrutos = [];
                buildFiltroFornecedores([]);
                applyFiltrosTempoReal();
                $('#infoStatus').text('Nenhum dado retornado.');
                return Swal.fire('Aviso', res.data?.message || 'Nenhum registro encontrado.', 'info');
            }

            const notas = Array.isArray(res.data.notas) ? res.data.notas : [];
            dadosBrutos = notas;
            expandedSet = new Set();

            buildFiltroFornecedores(notas);
            applyFiltrosTempoReal();

            toggleLoader(false);

        } catch (e) {
            console.error(e);
            toggleLoader(false);
            Swal.fire('Erro', 'Falha na conexão.', 'error');
        }
    }

    // ================= FILTROS & RENDER =================
    function buildFiltroFornecedores(notas){
        const mapa = {};
        notas.forEach(n => {
            const id = n.fornecedor_id;
            const nome = n.fornecedor_nome || 'Sem Nome';
            if (id && !mapa[id]) mapa[id] = nome;
        });

        const $sel = $('#filtroFornecedor');
        $sel.empty();

        Object.keys(mapa).sort((a,b) => Number(a) - Number(b)).forEach(id => {
            let nomeF = mapa[id];
            if(nomeF.length > 60) nomeF = nomeF.substring(0,60) + '...';
            $sel.append(`<option value="${escapeHtml(id)}">${escapeHtml(nomeF)}</option>`);
        });
        $sel.val(null).trigger('change');
    }

    function applyFiltrosTempoReal(){
        let arr = [...dadosBrutos];
        const selFor = $('#filtroFornecedor').val() || [];
        const termo = ($('#filtroTexto').val() || '').trim().toLowerCase();

        // Filtro Fornecedor
        if (selFor.length > 0) {
            const setSel = new Set(selFor.map(String));
            arr = arr.filter(n => setSel.has(String(n.fornecedor_id || '')));
        }

        // Filtro Texto (Deep Search)
        if (termo) {
            arr = arr.filter(n => {
                // Busca no cabeçalho
                const headerMatch = [n.fornecedor_nome, n.numero_nf, n.chave_acesso]
                    .some(field => String(field || '').toLowerCase().includes(termo));

                if (headerMatch) return true;

                // Busca nos itens
                const itens = Array.isArray(n.itens) ? n.itens : [];
                return itens.some(it =>
                    String(it.produto_nome || '').toLowerCase().includes(termo) ||
                    String(it.produto || '').toLowerCase().includes(termo)
                );
            });
        }

        notasFiltradas = arr;
        renderTotalizadores(arr);
        renderTabela(arr);
        renderInfoStatus();
    }

    function renderTotalizadores(notas) {
        let qtd = notas.length;
        let totalValor = 0;
        notas.forEach(n => totalValor += Number(n.valor_total || 0));
        let media = qtd > 0 ? (totalValor / qtd) : 0;

        $('#totQtd').text(qtd);
        $('#totValor').text(brMoney(totalValor));
        $('#totMedia').text(brMoney(media));
    }

    function renderInfoStatus(){
        const total = dadosBrutos.length;
        const filtrados = notasFiltradas.length;
        if(total > 0) $('#infoStatus').html(`Exibindo <b>${filtrados}</b> de <b>${total}</b> registros.`);
        else $('#infoStatus').html('');
    }

    function renderTabela(notas){
        const $tbody = $('#tabela-notas tbody');
        $tbody.empty();

        if (notas.length === 0) {
            $tbody.html('<tr><td colspan="6" class="text-center muted" style="padding: 20px;">Nenhum registro encontrado.</td></tr>');
            return;
        }

        // Limite para performance
        const limiteRender = 300;
        const renderList = notas.slice(0, limiteRender);

        renderList.forEach(n => {
            const key = makeNotaKey(n);
            const isExpanded = expandedSet.has(key);

            // Icon Logic
            const iconName = isExpanded ? 'icon-park-outline:down' : 'icon-park-outline:right';

            $tbody.append(`
                <tr class="nota-row" data-key="${escapeHtml(key)}">
                  <td class="cell-toggle text-center" data-key="${escapeHtml(key)}">
                    <iconify-icon icon="${iconName}" width="18" style="vertical-align: middle;"></iconify-icon>
                  </td>
                  <td class="nowrap"><strong>${escapeHtml(n.numero_nf || '-')}</strong></td>
                  <td>${escapeHtml(n.fornecedor_nome || '')}</td>
                  <td class="nowrap">${formatBRDate(n.data_emissao)}</td>
                  <td class="nowrap">${formatBRDate(n.data_entrada)}</td>
                  <td class="text-right nowrap"><strong>${brMoney(n.valor_total)}</strong></td>
                </tr>
            `);

            if (isExpanded) {
                const itensHtml = renderSubTabelaItens(n);
                $tbody.append(`
                    <tr class="itens-row" data-key="${escapeHtml(key)}" style="display: table-row;">
                      <td colspan="6">${itensHtml}</td>
                    </tr>
                `);
            }
        });

        if (notas.length > limiteRender) {
            $tbody.append(`<tr><td colspan="6" class="text-center text-warning">Exibindo os primeiros ${limiteRender} de ${notas.length}. Refine a busca.</td></tr>`);
        }

        // Toggle Event
        $('.cell-toggle').off('click').on('click', function(e){
            e.preventDefault();
            const key = $(this).data('key');
            toggleRow(key);
        });
    }

    function renderSubTabelaItens(nota){
        const itens = Array.isArray(nota.itens) ? nota.itens : [];
        if (itens.length === 0) return '<div class="muted text-center p-2">Sem itens.</div>';

        let rows = itens.map(it => `
            <tr>
              <td>${it.seq || '-'}</td>
              <td>${it.produto || ''}</td>
              <td>${escapeHtml(it.produto_nome || '')}</td>
              <td>${it.produto_unidade || ''}</td>
              <td class="text-right">${Number(it.quantidade || 0).toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
              <td class="text-right">${brMoney(it.valor_unitario)}</td>
              <td class="text-right"><strong>${brMoney(it.valor_total)}</strong></td>
            </tr>
        `).join('');

        return `
            <div style="background: #fff; border:1px solid #eee; border-radius:4px; overflow:hidden;">
              <table class="table subtable table-hover mb-0">
                <thead>
                  <tr>
                    <th width="50">#</th>
                    <th width="80">Cód.</th>
                    <th>Produto</th>
                    <th width="60">Und</th>
                    <th width="100" class="text-right">Qtd</th>
                    <th width="120" class="text-right">Vlr Unit.</th>
                    <th width="120" class="text-right">Total</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
        `;
    }

    function toggleRow(key){
        if (expandedSet.has(key)) expandedSet.delete(key);
        else expandedSet.add(key);
        // Re-renderiza para atualizar ícone e mostrar/ocultar linha
        // (Poderia ser manipulado via DOM direto para ultra-performance, mas renderTabela é rápido o suficiente com paginação virtual)
        renderTabela(notasFiltradas);
    }

    function expandCollapseAll(expandir){
        if (expandir) {
            if(notasFiltradas.length > 500) {
                return Swal.fire('Aviso', 'Muitos registros para expandir. Filtre mais dados antes.', 'warning');
            }
            expandedSet = new Set(notasFiltradas.map(makeNotaKey));
        } else {
            expandedSet = new Set();
        }
        renderTabela(notasFiltradas);
    }
</script>

</body>
</html>