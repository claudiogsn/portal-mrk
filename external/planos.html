<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>DRE Gerencial</title>
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <!-- Fonts e Ícones -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- CSS -->
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

    <style>
        .table-container {
            overflow-x: auto;
            white-space: nowrap;
        }

        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f9f9f9;
            z-index: 2;
        }

        .total-column {
            position: sticky;
            right: 0;
            background-color: #f9f9f9;
            z-index: 2;
        }

        .header-card {
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="theme-blue">

    <!-- Carregador -->
   

    <!-- Conteúdo -->
    <div class="container-fluid">

        <!-- Filtros -->
        <div class="header-card">
            <div class="row">
                <div class="col-md-3">
                    <select id="ano" class="form-control">
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="visao" class="form-control">
                        <option value="mensal" selected>Mensal</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="regime" class="form-control">
                        <option value="competencia" selected>Competência</option>
                    </select>
                </div>
                <div class="col-md-3 text-right">
                    <button id="btnGerarRelatorio" class="btn btn-success">Gerar Relatório</button>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="card">
            <div class="header">
                <h2>DRE Gerencial</h2>
                <p>De 01/01/2024 à 31/12/2024 - Visão Mensal - Regime Competência</p>
            </div>
            <div class="body table-responsive">
                <div class="table-container">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th class="fixed-column">Categoria</th>
                                <th>Janeiro</th>
                                <th>Fevereiro</th>
                                <th>Março</th>
                                <th>Abril</th>
                                <th>Maio</th>
                                <th>Junho</th>
                                <th>Julho</th>
                                <th>Agosto</th>
                                <th>Setembro</th>
                                <th>Outubro</th>
                                <th>Novembro</th>
                                <th>Dezembro</th>
                                <th class="total-column">Total</th>
                            </tr>
                        </thead>
                        <tbody id="dreTableBody">
                            <!-- Dados Dinâmicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="bsb/plugins/sweetalert/sweetalert.min.js"></script>
    <script>
        $(document).ready(function () {
            const baseUrl = window.location.hostname !== 'localhost' ?
                'https://portal.mrksolucoes.com.br/api/v1/financeiro.php' :
                'https://portal.mrksolucoes.com.br/api/v1/financeiro.php';

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const unitId = urlParams.get('unit_id');

            $('#btnGerarRelatorio').on('click', function () {
                const ano = $('#ano').val();
                const dataInicial = `${ano}-01-01`;
                const dataFinal = `${ano}-12-31`;

                swal({
                    title: "Aguarde...",
                    text: "Estamos gerando o relatório.",
                    icon: "info",
                    buttons: false,
                    closeOnClickOutside: false
                });

                const requestData = {
                    method: 'getDreGerencial',
                    token: token,
                    data: {
                        system_unit_id: unitId,
                        data_inicial: dataInicial,
                        data_final: dataFinal
                    }
                };

                axios.post(baseUrl, requestData)
                    .then(response => {
                        if (response.data.success) {
                            swal.close();
                            renderTable(response.data.data.categories);
                        } else {
                            swal("Erro", response.data.message, "error");
                        }
                    })
                    .catch(() => {
                        swal("Erro", "Não foi possível gerar o relatório.", "error");
                    });
            });

            function renderTable(categories) {
                const tbody = $('#dreTableBody');
                tbody.empty();

                categories.forEach(category => {
                    const row = $('<tr></tr>');

                    // Categoria
                    const categoryCell = $('<td class="fixed-column"></td>').text(category.name);
                    row.append(categoryCell);

                    // Valores mensais
                    const monthlyValues = Array.isArray(category.monthly_values) ? category.monthly_values : Object.values(category.monthly_values);
                    monthlyValues.forEach(value => {
                        const cell = $('<td></td>').text(`R$ ${value.toFixed(2)}`);
                        row.append(cell);
                    });

                    // Total
                    const total = monthlyValues.reduce((sum, val) => sum + val, 0);
                    const totalCell = $('<td class="total-column"></td>').text(`R$ ${total.toFixed(2)}`);
                    row.append(totalCell);

                    tbody.append(row);
                });
            }
        });
    </script>
</body>

</html>
