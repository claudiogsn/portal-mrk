<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>DRE Gerencial</title>
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <!-- Fonts e Ícones -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- CSS -->
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
          .header-card {
            margin-top: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }
        .table-container {
            overflow-x: auto;
            white-space: nowrap;
        }

        .fixed-column {
            position: sticky;
            left: 0;
            background-color: #f9f9f9;
            z-index: 2;
        }

        .total-column {
            position: sticky;
            right: 0;
            background-color: #f9f9f9;
            z-index: 2;
        }

        .header-card {
            margin-bottom: 20px;
        }

        .parent-category {
            font-weight: bold;
            background-color: #dfe6e9; /* Default pastel color */
        }

        .parent-category:nth-child(1n) {
            background-color: #dfe6e9; /* Light gray */
        }

        .parent-category:nth-child(2n) {
            background-color: #b2bec3; /* Slightly darker gray */
        }

        .parent-category:nth-child(3n) {
            background-color: #74b9ff; /* Light blue */
        }

        .parent-category:nth-child(4n) {
            background-color: #81ecec; /* Light cyan */
        }
    </style>
</head>

<body class="theme-blue">

    <!-- Carregador -->
    <div class="page-loader-wrapper">
        <div class="loader">
            <div class="preloader">
                <div class="spinner-layer pl-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
            <p>Aguarde...</p>
        </div>
    </div>

    <!-- Conteúdo -->
    <div class="container-fluid">

        <!-- Filtros -->
        <div class="header-card">
            <div class="row">
                <div class="col-md-3">
                    <select id="ano" class="form-control">
                        <option value="2024" selected>2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="col-md-3 text-right">
                    <button id="btnGerarRelatorio" class="btn btn-success">Gerar Relatório</button>
                </div>
            </div>
        </div>

        <!-- Tabela -->
        <div class="card">
            <div class="header">
                <h2>DRE Gerencial</h2>
            </div>
            <div class="body table-responsive">
                <div class="table-container">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th class="fixed-column">Categoria</th>
                                <th>Janeiro</th>
                                <th>Fevereiro</th>
                                <th>Março</th>
                                <th>Abril</th>
                                <th>Maio</th>
                                <th>Junho</th>
                                <th>Julho</th>
                                <th>Agosto</th>
                                <th>Setembro</th>
                                <th>Outubro</th>
                                <th>Novembro</th>
                                <th>Dezembro</th>
                                <th class="total-column">Total</th>
                            </tr>
                        </thead>
                        <tbody id="dreTableBody">
                            <!-- Dados Dinâmicos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const baseUrl = window.location.hostname !== 'localhost' ?
                'https://portal.mrksolucoes.com.br/api/v1/financeiro.php' :
                'https://portal.mrksolucoes.com.br/api/v1/financeiro.php';

            const token = new URLSearchParams(window.location.search).get('token');
            const unitId = new URLSearchParams(window.location.search).get('unit_id');

            function hidePageLoader() {
                const loader = document.querySelector('.page-loader-wrapper');
                if (loader) {
                    loader.style.display = 'none';
                }
            }

            function formatCurrency(value) {
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function getRowColor(planoContas) {
                if (planoContas.startsWith('01')) return 'green';
                if (planoContas.startsWith('02')) return 'orange';
                if (planoContas.startsWith('03')) return 'red';
                if (planoContas.startsWith('04')) return 'black';
                return 'inherit';
            }

            async function handleCellClick(planoContas, month, year) {
                Swal.fire({
                    title: 'Aguarde...',
                    html: 'Carregando os dados, por favor espere.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const requestData = {
                    method: 'getContaByMonth',
                    token: token,
                    data: {
                        system_unit_id: unitId,
                        plano_contas: planoContas,
                        month: month,
                        year: year
                    }
                };

                try {
                    const response = await axios.post(baseUrl, requestData);

                    if (response.data.success) {
                        Swal.close();
                        const contas = response.data.data;
                        let modalHtml = '<table class="table table-bordered"><thead><tr><th>Código</th><th>Nome</th><th>Doc</th><th>Emissão</th><th>Vencimento</th><th>Valor</th><th>Origem</th></tr></thead><tbody>';

                        contas.forEach(conta => {
                            modalHtml += `<tr>
                                <td>${conta.codigo}</td>
                                <td>${conta.nome}</td>
                                <td>${conta.doc}</td>
                                <td>${conta.emissao}</td>
                                <td>${conta.vencimento}</td>
                                <td>${formatCurrency(parseFloat(conta.valor))}</td>
                                <td>${conta.origem}</td>
                            </tr>`;
                        });

                        modalHtml += '</tbody></table>';

                        Swal.fire({
                            title: `Contas do plano ${planoContas} em ${month}/${year}`,
                            html: modalHtml,
                            width: '80%',
                            customClass: {
                                popup: 'swal-wide'
                            },
                            confirmButtonText: 'Fechar'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: response.data.message
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Erro ao buscar os dados.'
                    });
                }
            }

            function renderTable(categories) {
                const tbody = document.getElementById('dreTableBody');
                tbody.innerHTML = '';

                categories.forEach(category => {
                    const row = document.createElement('tr');
                    row.style.color = getRowColor(category.code);

                    // Categoria
                    const categoryCell = document.createElement('td');
                    categoryCell.classList.add('fixed-column');
                    categoryCell.textContent = `${category.code} - ${category.name}`;
                    row.appendChild(categoryCell);

                    // Valores mensais
                    const monthlyValues = Array.isArray(category.monthly_values) ? category.monthly_values : Object.values(category.monthly_values);
                    monthlyValues.forEach((value, index) => {
                        const cell = document.createElement('td');
                        const month = (index + 1).toString().padStart(2, '0');
                        const year = new Date().getFullYear();

                        cell.id = `${category.code}-${month}-${year}`;
                        cell.textContent = formatCurrency(value);
                        cell.addEventListener('click', () => handleCellClick(category.code, month, year));

                        row.appendChild(cell);
                    });

                    // Total
                    const total = monthlyValues.reduce((sum, val) => sum + val, 0);
                    const totalCell = document.createElement('td');
                    totalCell.classList.add('total-column');
                    totalCell.textContent = formatCurrency(total);
                    row.appendChild(totalCell);

                    tbody.appendChild(row);
                });
            }

            // Ocultar o loader ao carregar a página
            hidePageLoader();

            document.getElementById('btnGerarRelatorio').addEventListener('click', async () => {
                const ano = document.getElementById('ano').value;
                const dataInicial = `${ano}-01-01`;
                const dataFinal = `${ano}-12-31`;

                Swal.fire({
                    title: 'Aguarde...',
                    html: 'Carregando os dados, por favor espere.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const requestData = {
                    method: 'getDreGerencial',
                    token: token,
                    data: {
                        system_unit_id: unitId,
                        data_inicial: dataInicial,
                        data_final: dataFinal
                    }
                };

                try {
                    const response = await axios.post(baseUrl, requestData);
                    if (response.data.success) {
                        Swal.close();
                        renderTable(response.data.data.categories);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: response.data.message
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: 'Erro ao buscar os dados.'
                    });
                }
            });
        });
    </script>
</body>

</html>
