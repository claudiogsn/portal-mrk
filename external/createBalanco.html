<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Criar Modelo de Balanço</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

  <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
  <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
  <link href="bsb/css/style.css" rel="stylesheet">
  <link href="style/mrk.css" rel="stylesheet">

  <style>
    body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

    /* Card Principal */
    .card {
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #eee;
      border-top: 3px solid var(--mrk-blue) !important;
      margin-bottom: 20px;
      border-radius: 6px;
    }

    /* Header e Filtros */
    .header-flex { display: flex; align-items: center; justify-content: space-between; }
    .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
    .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

    /* Tabela */
    .table thead th {
      font-family: 'Kanit', sans-serif; color: var(--mrk-blue); font-weight: 600; font-size: 12px;
      background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; white-space: nowrap;
    }
    .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

    /* Botões de Ação */
    .btn-icon-only { padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; background: #fff; color: #555; }
    .btn-icon-only:hover { background: #eee; }

    /* Modal Custom */
    .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px; }
    .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-black); font-weight: 600; }
    .modal-body { padding: 0; }
    .modal-footer { border-top: 1px solid #eee; background: #fff; padding: 15px; }

    /* Toggle Custom (Modal) */
    .toggle-group { display: flex; border-bottom: 1px solid #eee; }
    .toggle-btn {
      flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: 500; color: #777; background: #f9f9f9;
      border-right: 1px solid #eee; transition: all 0.2s;
    }
    .toggle-btn:last-child { border-right: none; }
    .toggle-btn.active { background: #fff; color: var(--mrk-blue); border-bottom: 3px solid var(--mrk-blue); font-weight: 700; }
    .toggle-btn:hover { background: #f0f4f8; }

    /* Lista de Seleção (Modal) */
    .selection-list { max-height: 400px; overflow-y: auto; padding: 10px; }
    .selection-item {
      padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center;
    }
    .selection-item:hover { background-color: #f5f5f5; }
    .selection-item input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
    .selection-item label { cursor: pointer; font-weight: 400; margin: 0; width: 100%; }

    /* Skeleton */
    .skeleton-wrapper { display: none; margin-top: 20px; }
    .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
    .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  </style>
</head>

<body class="theme-blue">

<div class="container-fluid">

  <div class="card">
    <div class="header header-flex">
      <h2>
        <iconify-icon icon="icon-park-outline:add-web" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
        CRIAR MODELO DE BALANÇO
      </h2>
      <button id="btnListModelo" class="btn btn-default waves-effect">
        <iconify-icon icon="icon-park-outline:list" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
        VER LISTA
      </button>
    </div>

    <div class="body">

      <div class="filter-box">
        <div class="row clearfix">
          <div class="col-md-3">
            <label class="muted">Nome do Modelo</label>
            <input type="text" id="modelName" class="form-control" placeholder="Ex: Bebidas Fim de Ano" oninput="generateTag()">
          </div>
          <div class="col-md-3">
            <label class="muted">Tag (Identificador Único)</label>
            <input type="text" id="modelTag" class="form-control" readonly style="background-color: #eee;">
            <small id="tagValidationMessage" class="text-danger" style="display: none; font-size: 11px;">Tag já existe!</small>
          </div>
          <div class="col-md-6">
            <label class="muted">URL Gerada</label>
            <div class="input-group">
              <input type="text" id="modelUrl" class="form-control" readonly style="background-color: #fff;">
              <span class="input-group-btn">
                                <button class="btn btn-default btn-icon-only" type="button" id="btnCopyUrl" title="Copiar URL">
                                    <iconify-icon icon="icon-park-outline:copy"></iconify-icon>
                                </button>
                                <button class="btn btn-default btn-icon-only" type="button" id="btnShareWhatsapp" title="Enviar WhatsApp" style="color: #25D366;">
                                    <iconify-icon icon="icon-park-outline:whatsapp"></iconify-icon>
                                </button>
                            </span>
            </div>
          </div>
        </div>

        <div class="row clearfix mt-2">
          <div class="col-md-12">
            <button id="btnAddCategory" class="btn btn-primary waves-effect">
              <iconify-icon icon="icon-park-outline:add-three" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
              ADICIONAR PRODUTOS / CATEGORIAS
            </button>
          </div>
        </div>
      </div>

      <div id="skeleton-area" class="skeleton-wrapper">
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
        <div class="skeleton sk-row"></div>
      </div>

      <div class="table-responsive mt-4" id="table-area">
        <table class="table table-hover" id="balancoTable">
          <thead>
          <tr>
            <th width="100">Código</th>
            <th>Produto / Insumo</th>
            <th width="100">Unidade</th>
            <th width="80" class="text-center">Ação</th>
          </tr>
          </thead>
          <tbody>
          <tr><td colspan="4" class="text-center muted" style="padding: 30px;">Nenhum item adicionado ainda.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="row clearfix" style="margin-top: 30px; border-top: 1px dashed #ddd; padding-top: 20px;">
        <div class="col-md-6 text-left">
          <button id="limparBalanco" class="btn btn-warning waves-effect">
            <iconify-icon icon="icon-park-outline:delete"></iconify-icon> LIMPAR TUDO
          </button>
        </div>
        <div class="col-md-6 text-right">
          <button id="finalizarLancamento" class="btn btn-success waves-effect" disabled>
            <iconify-icon icon="icon-park-outline:check"></iconify-icon> SALVAR MODELO
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalCategoriaProduto" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="border-radius: 8px; border:none; height: 80vh; display: flex; flex-direction: column;">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">
          <iconify-icon icon="icon-park-outline:shopping-bag" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon>
          Selecionar Itens
        </h4>
      </div>

      <div class="toggle-group">
        <div class="toggle-btn active" data-mode="categoria" onclick="setSelectMode('categoria')">
          POR CATEGORIA
        </div>
        <div class="toggle-btn" data-mode="produto" onclick="setSelectMode('produto')">
          POR PRODUTO
        </div>
      </div>

      <div style="padding: 15px; background: #fff; border-bottom: 1px solid #eee;">
        <input type="text" id="searchSelect" class="form-control" placeholder="Buscar..." oninput="filterList()">
      </div>

      <div class="modal-body" style="flex: 1; overflow-y: auto; background: #fff;">
        <div id="list-container" class="selection-list">
        </div>
      </div>

      <div class="modal-footer">
                <span class="pull-left muted" style="margin-top: 8px;">
                    Selecionados: <b id="countSelected">0</b>
                </span>
        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Fechar</button>
        <button id="btnConfirmarAdicionar" type="button" class="btn btn-primary waves-effect">ADICIONAR</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  // Configurações
  const baseUrl = window.location.hostname !== 'localhost'
          ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
          : 'http://localhost/portal-mrk/api/v1/index.php';

  const baseUrlRedirect = window.location.hostname !== 'localhost'
          ? 'https://portal.mrksolucoes.com.br'
          : 'http://localhost/portal-mrk';

  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  const unitId = urlParams.get('unit_id');
  const username = urlParams.get('username');

  let allCategories = []; // Dados brutos da API
  let productsInBalance = []; // Itens já adicionados à tabela
  let currentMode = 'categoria'; // 'categoria' ou 'produto'

  // Helper: Skeleton
  function toggleLoading(isLoading) {
    if (isLoading) {
      $('#table-area').hide();
      $('#skeleton-area').show();
    } else {
      $('#skeleton-area').hide();
      $('#table-area').fadeIn();
    }
  }

  $(document).ready(() => {
    // Validação Inicial
    if (!token || !unitId) {
      Swal.fire('Atenção', 'Parâmetros de URL ausentes.', 'warning');
      return;
    }

    // Carrega dados iniciais
    loadData();

    // Eventos
    $('#btnListModelo').click(() => {
      window.location.href = `${baseUrlRedirect}/external/listModelBalanco.html?username=${username}&token=${token}&unit_id=${unitId}`;
    });

    $('#btnAddCategory').click(() => {
      $('#searchSelect').val('');
      renderList();
      $('#modalCategoriaProduto').modal('show');
      setTimeout(() => $('#searchSelect').focus(), 500);
    });

    $('#btnConfirmarAdicionar').click(addSelectedItems);
    $('#limparBalanco').click(clearAll);
    $('#finalizarLancamento').click(saveModel);

    // Copy / Share
    $('#btnCopyUrl').click(() => {
      const url = $('#modelUrl').val();
      if(!url) return;
      navigator.clipboard.writeText(url);
      Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Copiado!', timer: 1500, showConfirmButton: false });
    });

    $('#btnShareWhatsapp').click(() => {
      const url = $('#modelUrl').val();
      if(!url) return;
      window.open(`https://wa.me/?text=${encodeURIComponent('Modelo de Balanço: ' + url)}`, '_blank');
    });
  });

  // --- Lógica de Dados ---

  async function loadData() {
    try {
      // Pode demorar, mas carrega tudo de uma vez para o modal ser rápido
      const res = await axios.post(baseUrl, {
        method: 'listProductsByCategory',
        token: token,
        data: { unit_id: unitId }
      });

      if (res.data && res.data.success) {
        allCategories = res.data.products_by_category || [];
      }
    } catch (e) {
      console.error(e);
      Swal.fire('Erro', 'Falha ao carregar produtos.', 'error');
    }
  }

  // --- Modal Logic ---

  window.setSelectMode = function(mode) {
    currentMode = mode;
    $('.toggle-btn').removeClass('active');
    $(`.toggle-btn[data-mode="${mode}"]`).addClass('active');
    renderList();
  }

  window.filterList = function() {
    const term = $('#searchSelect').val().toLowerCase();
    $('.selection-item').each(function() {
      const text = $(this).text().toLowerCase();
      $(this).toggle(text.includes(term));
    });
  }

  function renderList() {
    const container = $('#list-container');
    container.empty();
    $('#countSelected').text('0');

    if (currentMode === 'categoria') {
      allCategories.forEach(cat => {
        const html = `
                    <div class="selection-item">
                        <input type="checkbox" id="cat_${cat.id}" value="${cat.id}" class="chk-item">
                        <label for="cat_${cat.id}">
                            <strong>${cat.categoria}</strong>
                            <span class="text-muted text-small">(${cat.itens ? cat.itens.length : 0} itens)</span>
                        </label>
                    </div>
                `;
        container.append(html);
      });
    } else {
      // Modo Produto (Flattened)
      allCategories.forEach(cat => {
        if (cat.itens) {
          cat.itens.forEach(prod => {
            const val = `${cat.id}|${prod.codigo}`; // ID composto para recuperar depois
            const html = `
                            <div class="selection-item">
                                <input type="checkbox" id="prod_${prod.codigo}" value="${val}" class="chk-item">
                                <label for="prod_${prod.codigo}">
                                    <strong>${prod.nome}</strong>
                                    <span class="text-muted text-small">[${prod.codigo}] - ${cat.categoria}</span>
                                </label>
                            </div>
                        `;
            container.append(html);
          });
        }
      });
    }

    // Bind Checkbox Count
    $('.chk-item').change(function() {
      $('#countSelected').text($('.chk-item:checked').length);
    });
  }

  function addSelectedItems() {
    const selected = [];
    $('.chk-item:checked').each(function() {
      selected.push($(this).val());
    });

    if (selected.length === 0) {
      $('#modalCategoriaProduto').modal('hide');
      return;
    }

    let newItems = [];

    if (currentMode === 'categoria') {
      // Adiciona todos os produtos das categorias selecionadas
      selected.forEach(catId => {
        const cat = allCategories.find(c => c.id == catId);
        if (cat && cat.itens) {
          newItems = newItems.concat(cat.itens);
        }
      });
    } else {
      // Adiciona produtos específicos
      selected.forEach(val => {
        const [catId, prodCod] = val.split('|');
        const cat = allCategories.find(c => c.id == catId);
        if (cat && cat.itens) {
          const prod = cat.itens.find(p => p.codigo == prodCod);
          if (prod) newItems.push(prod);
        }
      });
    }

    // Merge evitando duplicatas
    newItems.forEach(item => {
      if (!productsInBalance.some(p => p.codigo === item.codigo)) {
        productsInBalance.push(item);
      }
    });

    renderTable();
    $('#modalCategoriaProduto').modal('hide');
    validateForm();
  }

  // --- Tabela Principal ---

  function renderTable() {
    const tbody = $('#balancoTable tbody');
    tbody.empty();

    if (productsInBalance.length === 0) {
      tbody.html('<tr><td colspan="4" class="text-center muted" style="padding: 30px;">Nenhum item adicionado ainda.</td></tr>');
      return;
    }

    productsInBalance.forEach(item => {
      tbody.append(`
                <tr>
                    <td><strong>${item.codigo}</strong></td>
                    <td>${item.nome}</td>
                    <td>${item.und || '-'}</td>
                    <td class="text-center">
                        <button class="btn btn-default btn-xs" onclick="removeItem('${item.codigo}')" title="Remover">
                            <iconify-icon icon="icon-park-outline:delete" style="color: var(--mrk-red);"></iconify-icon>
                        </button>
                    </td>
                </tr>
            `);
    });
  }

  window.removeItem = function(codigo) {
    productsInBalance = productsInBalance.filter(p => p.codigo != codigo); // Loose equality para garantir
    renderTable();
    validateForm();
  }

  function clearAll() {
    productsInBalance = [];
    renderTable();
    $('#modelName').val('');
    $('#modelTag').val('');
    $('#modelUrl').val('');
    validateForm();
  }

  // --- Lógica de Tag e Salvar ---

  window.generateTag = async function() {
    const name = $('#modelName').val().trim();
    if (!name) {
      $('#modelTag').val('');
      $('#modelUrl').val('');
      validateForm();
      return;
    }

    const tag = `${unitId}-${name.toLowerCase().replace(/\s+/g, '-')}`;
    const url = `${baseUrlRedirect}/balanco/${tag}`;

    $('#modelTag').val(tag);
    $('#modelUrl').val(url);

    // Debounce Validation
    clearTimeout(window.tagTimeout);
    window.tagTimeout = setTimeout(async () => {
      try {
        const res = await axios.post(baseUrl, {
          method: 'validateTagExists',
          token: token,
          data: { tag }
        });

        if (!res.data.success) {
          $('#tagValidationMessage').show();
          $('#modelTag').css('border-color', 'var(--mrk-red)');
          $('#finalizarLancamento').prop('disabled', true);
        } else {
          $('#tagValidationMessage').hide();
          $('#modelTag').css('border-color', '#ccc');
          validateForm();
        }
      } catch (e) {
        console.error(e);
      }
    }, 500);
  }

  function validateForm() {
    const hasName = $('#modelName').val().trim().length > 0;
    const hasItems = productsInBalance.length > 0;
    const tagError = $('#tagValidationMessage').is(':visible');

    $('#finalizarLancamento').prop('disabled', !(hasName && hasItems && !tagError));
  }

  async function saveModel() {
    const nome = $('#modelName').val().trim();
    const tag = $('#modelTag').val().trim();

    if (!nome || !tag || productsInBalance.length === 0) return;

    Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });

    try {
      const res = await axios.post(baseUrl, {
        method: 'createModelo',
        token: token,
        data: {
          system_unit_id: unitId,
          nome: nome,
          tag: tag,
          usuario_id: username,
          itens: productsInBalance
        }
      });

      if (res.data.success) {
        await Swal.fire('Sucesso!', 'Modelo criado com sucesso.', 'success');
        window.location.href = `${baseUrlRedirect}/external/listModelBalanco.html?username=${username}&token=${token}&unit_id=${unitId}`;
      } else {
        Swal.fire('Erro', res.data.message || 'Erro ao criar modelo.', 'error');
      }
    } catch (e) {
      Swal.fire('Erro', 'Falha na conexão.', 'error');
    }
  }

</script>
</body>
</html>