<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Produtos</title>
    <!-- Favicon-->
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* Ajustes para o Select no Header da Tabela */
        .th-select {
            color: #333;
            font-weight: normal;
            font-size: 11px;
            height: 25px;
            padding: 2px;
            margin-top: 4px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            background-color: #fff;
            font-family: 'Poppins', sans-serif;
        }

        /* Modal ajustado para Iframe */
        .modal-dialog { width: 95%; max-width: 1200px; margin: 20px auto; }
        .modal-content { border-radius: 8px; overflow: hidden; }
        .modal-header { padding: 15px; border-bottom: 2px solid var(--mrk-blue); background: #fff; }
        .modal-body { padding: 0; height: 85vh; background: #f9f9f9; }

        iframe { width: 100%; height: 100%; border: none; }

        /* Badges */
        .badge-tag { font-size: 10px; padding: 3px 6px; border-radius: 4px; margin-right: 3px; font-weight: 500; }
        .bg-venda { background-color: #E3F2FD; color: #1565C0; border: 1px solid #BBDEFB; }
        .bg-insumo { background-color: #FFF3E0; color: #E65100; border: 1px solid #FFE0B2; }
        .bg-composicao { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #C8E6C9; }
        .bg-compravel { background-color: #F3E5F5; color: #7B1FA2; border: 1px solid #E1BEE7; }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:ad-product" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                PRODUTOS
            </h2>
            <small class="muted" style="display:block; margin-top:5px; margin-left: 29px;">
                Gerencie seu catálogo, fichas técnicas e estoques.
            </small>

            <button class="btn btn-success waves-effect" onclick="abrirModalProduto()" style="margin-left: auto;">
                <iconify-icon icon="icon-park-outline:add" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                Novo Produto
            </button>
        </div>

        <div class="body">
            <div class="row clearfix" style="margin-bottom: 20px;">
                <div class="col-md-4">
                    <label class="muted">Busca Rápida</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                        <input type="text" id="filtroNome" class="form-control" placeholder="Nome, Código ou EAN...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="muted">Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todos</option>
                        <option value="1">Ativo</option>
                        <option value="0">Inativo</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label class="muted">Tags</label>
                    <div class="demo-checkbox" style="padding-top: 5px;">
                        <input type="checkbox" id="filtroVenda" class="chk-col-blue"/> <label for="filtroVenda">Venda</label>
                        <input type="checkbox" id="filtroComposicao" class="chk-col-blue"/> <label for="filtroComposicao">Composição</label>
                        <input type="checkbox" id="filtroInsumo" class="chk-col-blue"/> <label for="filtroInsumo">Insumo</label>
                        <input type="checkbox" id="filtroCompravel" class="chk-col-blue"/> <label for="filtroCompravel">Comprável</label>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover" id="tabela-produtos">
                    <thead>
                    <tr>
                        <th style="width: 100px; text-align: center;">Ações</th>
                        <th style="cursor:pointer" onclick="ordenarPor('codigo')">Cód <i id="icon-codigo" class="fa fa-sort"></i></th>
                        <th style="cursor:pointer" onclick="ordenarPor('nome')">Nome <i id="icon-nome" class="fa fa-sort"></i></th>
                        <th>EAN</th>

                        <th style="min-width: 140px;">
                            Categoria
                            <select id="headerFiltroCategoria" class="form-control th-select" onchange="aplicarFiltros()">
                                <option value="">Todas</option>
                            </select>
                        </th>

                        <th>Tags</th>
                        <th>Und</th>
                        <th class="text-right">Saldo</th>
                        <th class="text-right">Custo</th>
                        <th class="text-right">Venda</th>
                        <th class="text-center">%CV</th>
                        <th class="text-center">Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalIframeProduto" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="carregarProdutos()">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="tituloModal" style="color: var(--mrk-black);">
                    <iconify-icon icon="icon-park-outline:ad-product" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon>
                    Gerenciar Produto
                </h4>
            </div>
            <div class="modal-body">
                <iframe id="iframeProduto" src=""></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const token = new URLSearchParams(window.location.search).get('token');
    const system_unit_id = new URLSearchParams(window.location.search).get('system_unit_id');
    const currentUser = new URLSearchParams(window.location.search).get('user');

    let todosProdutos = [];
    let listaCategoriasGlobal = [];
    let ordenacaoCampo = 'codigo';
    let ordenacaoAsc = true;

    // Escuta mensagens vindas do Iframe (filho)
    window.addEventListener('message', function(event) {
        if (event.data === 'produtoSalvo' || event.data === 'fecharModal') {
            $('#modalIframeProduto').modal('hide');
            carregarProdutos(); // Atualiza a grid
        }
    });

    $(document).ready(() => {
        initCategorias();
        carregarProdutos();

        // Eventos de filtro
        $('#filtroNome, #filtroStatus').on('input change', aplicarFiltros);
        $('#filtroVenda, #filtroComposicao, #filtroInsumo, #filtroCompravel').on('change', aplicarFiltros);
    });

    async function initCategorias() {
        try {
            const response = await axios.post(baseUrl, { method: 'listCategorias', token, data: { unit_id: system_unit_id } });
            listaCategoriasGlobal = response.data.categorias || [];

            const headerSelect = $('#headerFiltroCategoria');
            headerSelect.find('option:not(:first)').remove();
            listaCategoriasGlobal.forEach(c => {
                headerSelect.append(`<option value="${c.codigo}">${c.nome}</option>`);
            });
        } catch (e) { console.error('Erro categorias', e); }
    }

    async function carregarProdutos() {
        try {
            const res = await axios.post(baseUrl, { method: 'listProdutosDetalhado', token, data: { unit_id: system_unit_id } });
            todosProdutos = res.data.produtos;
            aplicarFiltros();
        } catch (e) { console.error(e); }
    }

    function abrirModalProduto(codigo = null) {
        let url = `createProduct.html?token=${token}&system_unit_id=${system_unit_id}&user=${currentUser}&mode=iframe`;

        if (codigo) {
            $('#tituloModal').html('<iconify-icon icon="icon-park-outline:edit" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon> Editar Produto');
            url += `&codigo=${codigo}`;
        } else {
            $('#tituloModal').html('<iconify-icon icon="icon-park-outline:add" style="vertical-align: middle; color: var(--mrk-green);"></iconify-icon> Novo Produto');
        }

        $('#iframeProduto').attr('src', url);
        $('#modalIframeProduto').modal('show');
    }

    function aplicarFiltros() {
        const termo = $('#filtroNome').val().toLowerCase().trim();
        const status = $('#filtroStatus').val();
        const cat = $('#headerFiltroCategoria').val();

        const fVenda = $('#filtroVenda').is(':checked');
        const fComp = $('#filtroComposicao').is(':checked');
        const fIns = $('#filtroInsumo').is(':checked');
        const fBuy = $('#filtroCompravel').is(':checked');

        const tbody = $('#tabela-produtos tbody');
        tbody.empty();

        const filtrados = todosProdutos.filter(p => {
            const matchTermo = !termo || String(p.nome).toLowerCase().includes(termo) || String(p.codigo).includes(termo) || String(p.ean).includes(termo);
            const matchStatus = status === '' || String(p.status) === status;
            const matchCat = cat === '' || String(p.categoria) === String(cat);

            const matchTags = (!fVenda || p.venda == 1) && (!fComp || p.composicao == 1) && (!fIns || p.insumo == 1) && (!fBuy || p.compravel == 1);

            return matchTermo && matchStatus && matchCat && matchTags;
        });

        // Ordenação
        filtrados.sort((a, b) => {
            let valA = a[ordenacaoCampo];
            let valB = b[ordenacaoCampo];

            if (ordenacaoCampo === 'codigo') { valA = Number(valA); valB = Number(valB); }
            else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); }

            if (valA < valB) return ordenacaoAsc ? -1 : 1;
            if (valA > valB) return ordenacaoAsc ? 1 : -1;
            return 0;
        });

        filtrados.forEach(p => {
            const statusBadge = p.status == 1 ? '<span class="badge-status st-1">Ativo</span>' : '<span class="badge-status st-0">Inativo</span>';

            let tags = '';
            if (p.venda == 1) tags += '<span class="badge-tag bg-venda">Venda</span>';
            if (p.composicao == 1) tags += '<span class="badge-tag bg-composicao">Comp</span>';
            if (p.insumo == 1) tags += '<span class="badge-tag bg-insumo">Insumo</span>';
            if (p.compravel == 1) tags += '<span class="badge-tag bg-compravel">Compra</span>';

            const catObj = listaCategoriasGlobal.find(c => String(c.codigo) === String(p.categoria));
            const catNome = catObj ? catObj.nome : '-';

            // Tratamento simples para o preço de venda (caso venha 0 no JSON, mostra "R$ 0.00" para manter padrão visual)
            const precoVenda = p.preco ? `R$ ${parseFloat(p.preco).toFixed(2)}` : 'R$ 0.00';

            tbody.append(`
            <tr>
                <td class="text-center actions-cell">
                    <a href="#" onclick="abrirModalProduto('${p.codigo}')" title="Editar">
                        <iconify-icon icon="icon-park-outline:edit" width="18" style="color:var(--mrk-blue)"></iconify-icon>
                    </a>
                </td>
                <td><strong>${p.codigo}</strong></td>
                <td>${p.nome}</td>
                <td>${p.ean || ''}</td>
                <td>${catNome}</td>
                <td>${tags}</td>
                <td>${p.und || ''}</td>
                <td class="text-right">${p.saldo}</td>
                <td class="text-right">${p.preco_custo}</td>
                <td class="text-right">${precoVenda}</td>
                <td class="text-center"><small>${p.percentual_cv}</small></td>
                <td class="text-center">${statusBadge}</td>
            </tr>
        `);
        });
    }
    function ordenarPor(campo) {
        if (ordenacaoCampo === campo) ordenacaoAsc = !ordenacaoAsc;
        else { ordenacaoCampo = campo; ordenacaoAsc = true; }
        aplicarFiltros();
    }
</script>
</body>
</html>