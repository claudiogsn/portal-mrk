<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Gestão de Produtos Compráveis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; cursor: pointer; user-select: none; }

        /* Linha Selecionada */
        tr.selected-row td { background-color: #e3f2fd !important; }

        /* Toggle Switch Customizado */
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--mrk-green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Skeleton */
        .skeleton-wrapper { display: none; margin-top: 20px; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body class="theme-blue">

<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:shopping-cart-one" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                GESTÃO DE PRODUTOS COMPRÁVEIS
            </h2>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-4">
                        <label class="muted">Filtrar Produto</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                            <input type="text" id="filtroProduto" class="form-control" placeholder="Código ou Nome...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Status Atual</label>
                        <select id="filtroCompravel" class="form-control">
                            <option value="">Todos</option>
                            <option value="1">Apenas Compráveis</option>
                            <option value="0">Apenas Não Compráveis</option>
                        </select>
                    </div>
                    <div class="col-md-5 text-right" style="margin-top: 23px;">
                        <button class="btn btn-default waves-effect" id="btnLimparSelecao" disabled style="margin-right: 5px;">
                            <iconify-icon icon="icon-park-outline:close-small"></iconify-icon>
                            <span id="labelSelecionados">0</span> Selecionados
                        </button>
                        <button class="btn btn-primary waves-effect" id="btnAtualizarEmMassa">
                            <iconify-icon icon="icon-park-outline:edit-two"></iconify-icon> ALTERAR EM MASSA
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <small class="muted"><iconify-icon icon="icon-park-outline:info"></iconify-icon> Clique nas linhas para selecionar múltiplos itens.</small>
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="tabela-produtos">
                    <thead>
                    <tr>
                        <th width="100">Código</th>
                        <th>Nome do Produto</th>
                        <th width="120" class="text-center">Comprável</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="3" class="text-center muted" style="padding: 30px;">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // Config
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id') || urlParams.get('unit_id');

    // Helper: Skeleton
    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    $(document).ready(() => {
        if (!token || !system_unit_id) {
            Swal.fire('Erro', 'Parâmetros de sistema ausentes.', 'error');
            return;
        }

        carregarProdutos();

        // Filtros
        $('#filtroProduto, #filtroCompravel').on('input change', filtrarTabela);

        // Ações em Massa
        $('#btnLimparSelecao').click(() => {
            $('tr.selected-row').removeClass('selected-row');
            atualizarContador();
        });

        $('#btnAtualizarEmMassa').click(confirmarAtualizacaoEmMassa);
    });

    async function carregarProdutos() {
        toggleLoading(true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'listProdutosCompraveis',
                token,
                data: { system_unit_id }
            });

            if (res.data.success) {
                renderTabela(res.data.produtos);
            } else {
                Swal.fire('Aviso', res.data.message, 'warning');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Não foi possível carregar os produtos.', 'error');
        } finally {
            toggleLoading(false);
        }
    }

    function renderTabela(produtos) {
        const tbody = $('#tabela-produtos tbody');
        tbody.empty();

        if (produtos.length === 0) {
            tbody.html('<tr><td colspan="3" class="text-center muted" style="padding:20px;">Nenhum produto encontrado.</td></tr>');
            return;
        }

        produtos.forEach(prod => {
            const isChecked = prod.compravel == 1 ? 'checked' : '';

            const toggleHtml = `
                <label class="switch" onclick="event.stopPropagation();">
                    <input type="checkbox" class="toggle-compravel" data-codigo="${prod.codigo}" ${isChecked}>
                    <span class="slider round"></span>
                </label>
            `;

            const row = `
                <tr class="linha-produto" data-codigo="${prod.codigo}">
                    <td><strong>${prod.codigo}</strong></td>
                    <td>${prod.nome}</td>
                    <td class="text-center">${toggleHtml}</td>
                </tr>`;

            tbody.append(row);
        });

        bindEvents();
    }

    function bindEvents() {
        // Toggle Individual
        $('.toggle-compravel').off('change').on('change', async function () {
            const codigo_produto = $(this).data('codigo');
            const compravel = $(this).is(':checked') ? 1 : 0;

            try {
                // Toast silencioso para feedback rápido
                const toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });

                await axios.post(baseUrl, {
                    method: 'updateCompravel',
                    token,
                    data: {
                        system_unit_id,
                        itens: [{ codigo_produto, compravel }]
                    }
                });

                toast.fire({ icon: 'success', title: 'Status atualizado' });

            } catch (e) {
                // Reverte em caso de erro
                $(this).prop('checked', !compravel);
                Swal.fire('Erro', 'Falha ao atualizar o status.', 'error');
            }
        });

        // Seleção de Linha
        $('.linha-produto').off('click').on('click', function (e) {
            // Ignora se clicou direto no switch (já tratado pelo onclick do label)
            if ($(e.target).closest('.switch').length > 0) return;

            $(this).toggleClass('selected-row');
            atualizarContador();
        });
    }

    function filtrarTabela() {
        const termo = $('#filtroProduto').val().toLowerCase();
        const filtroCompravel = $('#filtroCompravel').val();

        $('#tabela-produtos tbody tr').each(function () {
            const nome = $(this).find('td:nth-child(2)').text().toLowerCase();
            const codigo = $(this).find('td:nth-child(1)').text().toLowerCase();
            const compravel = $(this).find('input.toggle-compravel').is(':checked') ? '1' : '0';

            const textoMatch = nome.includes(termo) || codigo.includes(termo);
            const statusMatch = filtroCompravel === "" || filtroCompravel === compravel;

            $(this).toggle(textoMatch && statusMatch);
        });

        // Reseta seleção ao filtrar para evitar confusão visual?
        // Melhor manter seleção apenas dos visíveis ou limpar tudo. Vamos limpar para segurança.
        // $('tr.selected-row').removeClass('selected-row');
        atualizarContador();
    }

    function atualizarContador() {
        const qtd = $('tr.selected-row:visible').length; // Conta apenas visíveis selecionados
        $('#labelSelecionados').text(qtd);
        $('#btnLimparSelecao').prop('disabled', qtd === 0);

        // Muda cor do botão se tiver seleção
        if(qtd > 0) {
            $('#btnLimparSelecao').removeClass('btn-default').addClass('btn-warning').css('color', '#fff');
        } else {
            $('#btnLimparSelecao').removeClass('btn-warning').addClass('btn-default').css('color', '#555');
        }
    }

    async function confirmarAtualizacaoEmMassa() {
        const selecionados = $('tr.selected-row:visible');
        if (selecionados.length === 0) {
            return Swal.fire('Aviso', 'Selecione pelo menos um produto na tabela.', 'info');
        }

        const result = await Swal.fire({
            title: `Alterar ${selecionados.length} produtos`,
            text: "Qual status deseja aplicar aos itens selecionados?",
            icon: 'question',
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: 'MARCAR como Comprável',
            denyButtonText: 'DESMARCAR (Não Comprável)',
            confirmButtonColor: 'var(--mrk-green)',
            denyButtonColor: 'var(--mrk-red)',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            aplicarStatusEmMassa(1, selecionados);
        } else if (result.isDenied) {
            aplicarStatusEmMassa(0, selecionados);
        }
    }

    async function aplicarStatusEmMassa(novoStatus, elementosSelecionados) {
        const itens = [];
        elementosSelecionados.each(function() {
            itens.push({
                codigo_produto: $(this).data('codigo'),
                compravel: novoStatus
            });
        });

        try {
            Swal.fire({ title: 'Atualizando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

            await axios.post(baseUrl, {
                method: 'updateCompravel',
                token,
                data: { system_unit_id, itens }
            });

            // Atualiza visualmente sem recarregar tudo
            elementosSelecionados.find('.toggle-compravel').prop('checked', novoStatus === 1);
            $('tr.selected-row').removeClass('selected-row');
            atualizarContador();

            Swal.fire({ title: 'Sucesso', text: 'Produtos atualizados!', icon: 'success', timer: 1500, showConfirmButton: false });

        } catch {
            Swal.fire('Erro', 'Erro ao atualizar em massa.', 'error');
        }
    }
</script>
</body>
</html>