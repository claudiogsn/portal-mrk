<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Extrato do Insumo</title>
  <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

  <!-- Fonts e Ícones -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- CSS -->
  <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
  <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
  <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
  <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
  <link href="bsb/css/style.css" rel="stylesheet">
  <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

  <style>
    .header-card {
      margin-top: 20px;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 10px;
    }

    .timeline-day {
      margin-bottom: 20px;
    }

    .movimentacao {
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
      color: white;
    }

    .entrada {
      background-color: #4CAF50;
    }

    .saida {
      background-color: #F44336;
    }

    .balanco {
      background-color: #2196F3;
    }
  </style>
</head>

<body class="theme-blue">
  <div class="page-loader-wrapper">
    <div class="loader">
      <div class="preloader">
        <div class="spinner-layer pl-blue">
          <div class="circle-clipper left">
            <div class="circle"></div>
          </div>
          <div class="circle-clipper right">
            <div class="circle"></div>
          </div>
        </div>
      </div>
      <p>Aguarde...</p>
    </div>
  </div>

  <div class="container-fluid">
    <div class="header-card">
      <div class="row">
        <div class="col-md-4">
          <label for="dataInicial">Data Inicial</label>
          <input type="date" id="dataInicial" class="form-control">
        </div>
        <div class="col-md-4">
          <label for="dataFinal">Data Final</label>
          <input type="date" id="dataFinal" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="insumo_id">ID do Insumo</label>
          <input type="number" id="insumo_id" class="form-control" value="11000">
        </div>
        <div class="col-md-1 text-right">
          <button id="btnFiltrar" class="btn btn-primary">Buscar</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="header">
        <h2>Extrato por Dia</h2>
        <small id="saldo_inicial" class="text-primary font-bold">Saldo inicial: -</small>
      </div>
      <div class="body">
        <div id="timeline"></div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="bsb/plugins/node-waves/waves.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    $(document).ready(function () {
      const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      const unitId = urlParams.get('unit_id');

      function showLoader() {
        $('.page-loader-wrapper').fadeIn();
      }

      function hideLoader() {
        $('.page-loader-wrapper').fadeOut();
      }

      $('#btnFiltrar').on('click', async function () {
        const dt_inicio = $('#dataInicial').val();
        const dt_fim = $('#dataFinal').val();
        const insumo_id = $('#insumo_id').val();

        if (!dt_inicio || !dt_fim) {
          Swal.fire('Erro', 'Preencha as datas!', 'error');
          return;
        }

        showLoader();

        try {
          const response = await axios.post(baseUrl, {
            method: 'extratoInsumo',
            token: token,
            data: {
              system_unit_id: parseInt(unitId),
              insumo_id: parseInt(insumo_id),
              dt_inicio,
              dt_fim
            }
          });

          const result = response.data;
          $('#saldo_inicial').text('Saldo inicial: ' + result.saldo_inicial);

          const timeline = $('#timeline');
          timeline.empty();

          result.extrato.forEach(item => {
            const box = $('<div class="timeline-day"></div>');
            box.append(`<h5><b>${formatarData(item.data)}</b></h5>`);

            item.movimentacoes.forEach(mov => {
              const cor = mov.tipo_mov === 'entrada' ? 'entrada' : mov.tipo_mov === 'saida' ? 'saida' : 'balanco';
              const simbolo = mov.tipo_mov === 'entrada' ? '+' : mov.tipo_mov === 'saida' ? '-' : '=';
              const movBox = $(`<div class="movimentacao ${cor}">${simbolo} <b>${mov.quantidade}</b> | Doc: ${mov.doc}</div>`);
              box.append(movBox);
            });

            timeline.append(box);
          });
        } catch (err) {
          Swal.fire('Erro', 'Não foi possível carregar o extrato.', 'error');
          console.error(err);
        } finally {
          hideLoader();
        }
      });

      function formatarData(dataStr) {
        const [ano, mes, dia] = dataStr.split('-');
        return `${dia}/${mes}/${ano}`;
      }

      // Preencher campos com hoje
      const hoje = new Date().toISOString().split('T')[0];
      $('#dataInicial').val(hoje);
      $('#dataFinal').val(hoje);
    });
  </script>
</body>

</html>
