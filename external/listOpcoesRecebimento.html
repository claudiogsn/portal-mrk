<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Opções de Recebimento</title>

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* Ajustes Específicos */
        .select2-container { width: 100% !important; z-index: 9999; }

        .badge-taxa { background-color: var(--mrk-red); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-prazo { background-color: var(--mrk-blue); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        .badge-banco {
            background-color: #f5f5f5;
            color: #555;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            border: 1px solid #ddd;
            display: inline-flex; align-items: center; gap: 5px;
        }

        .plano-code {
            font-family: 'Poppins', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            background: #e3f2fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Ações na Tabela */
        .actions-cell a {
            display: inline-flex;
            text-decoration: none;
            margin: 0 5px;
            transition: transform 0.2s;
        }
        .actions-cell a:hover { transform: scale(1.15); }

        /* Modo Iframe */
        body.iframe-mode { background: #fff; padding: 10px; }
        body.iframe-mode .card { box-shadow: none; border: 1px solid #eee; margin-bottom: 0; }
    </style>

    <script>
        // Detecção de Modo Iframe
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'iframe') {
                document.body.classList.add('iframe-mode');
                if(urlParams.get('action') === 'new') setTimeout(abrirModalNovo, 500);
            }
        });
    </script>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:bank-card" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                OPÇÕES DE RECEBIMENTO
            </h2>
            <small class="muted" style="display:block; margin-top:5px; margin-left:29px;">
                Gerencie taxas, prazos e vínculos com o PDV.
            </small>
        </div>
        <div class="body">

            <div class="row clearfix">
                <div class="col-md-3">
                    <label class="muted">Filtrar Código</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:topic"></iconify-icon></span>
                        <input type="text" id="filtroCodigo" class="form-control" placeholder="Cód.">
                    </div>
                </div>
                <div class="col-md-5">
                    <label class="muted">Filtrar Nome</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                        <input type="text" id="filtroNome" class="form-control" placeholder="Nome da opção...">
                    </div>
                </div>
                <div class="col-md-4 text-right" style="padding-top: 25px;">
                    <button class="btn btn-success waves-effect" id="btnNovaOpcao">
                        <iconify-icon icon="icon-park-outline:add" width="16" style="vertical-align: middle; margin-right: 4px;"></iconify-icon>
                        Nova Opção
                    </button>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabela-opcoes">
                    <thead>
                    <tr>
                        <th style="width: 120px; text-align: center;">Ações</th>
                        <th style="width: 100px;">Código</th>
                        <th>Nome</th>
                        <th style="width: 100px;">Taxa</th>
                        <th style="width: 100px;">Prazo</th>
                        <th>Plano de Contas</th>
                        <th>Banco Vinculado</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalOpcao" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="border-bottom: 2px solid var(--mrk-blue);">
                <h4 class="modal-title" id="modalTitle" style="color: var(--mrk-black);">
                    <iconify-icon icon="icon-park-outline:edit" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon>
                    Cadastrar Opção
                </h4>
            </div>
            <div class="modal-body">
                <form id="formOpcao">
                    <input type="hidden" id="opcaoId">

                    <div class="row clearfix">
                        <div class="col-md-4">
                            <label class="muted">Código (Interno)</label>
                            <input type="text" class="form-control" id="codigo" placeholder="Ex: CREDIT01">
                        </div>
                        <div class="col-md-8">
                            <label class="muted">Nome *</label>
                            <input type="text" class="form-control" id="nome" placeholder="Ex: Visa Crédito" required>
                        </div>
                    </div>

                    <div class="row clearfix">
                        <div class="col-md-6">
                            <label class="muted">Taxa (%)</label>
                            <input type="number" step="0.01" class="form-control" id="taxa" value="0.00">
                        </div>
                        <div class="col-md-6">
                            <label class="muted">Prazo (Dias)</label>
                            <input type="number" class="form-control" id="prazo" value="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="muted">Plano de Contas</label>
                        <select id="plano_contas_id" class="form-control" style="width: 100%;">
                            <option value="">Selecione...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="muted">Banco para Depósito</label>
                        <select id="banco_id" class="form-control" style="width: 100%;">
                            <option value="">Sem vínculo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvar">Salvar Dados</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalVinculos" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="background: #fff8e1; border-bottom: 2px solid var(--mrk-amber);">
                <h4 class="modal-title" style="color: var(--mrk-black);">
                    <iconify-icon icon="icon-park-outline:link-one" style="vertical-align: middle; color: var(--mrk-amber);"></iconify-icon>
                    Vincular Meios do PDV
                    <br><small id="tituloVinculoOpcao" class="muted" style="font-size:12px;">Opção: ...</small>
                </h4>
            </div>
            <div class="modal-body">

                <div class="well" style="background: #fff; border: 1px solid #eee; box-shadow: none;">
                    <div class="row clearfix">
                        <div class="col-md-3">
                            <label class="muted">Código PDV *</label>
                            <input type="text" id="vinc_codigo_meio" class="form-control" placeholder="Ex: VISA">
                        </div>
                        <div class="col-md-5">
                            <label class="muted">Nome PDV *</label>
                            <input type="text" id="vinc_nome_meio" class="form-control" placeholder="Ex: Visa Crédito">
                        </div>
                        <div class="col-md-4" style="padding-top: 25px;">
                            <button type="button" class="btn btn-success btn-block waves-effect" onclick="adicionarVinculo()">
                                <iconify-icon icon="icon-park-outline:add" style="vertical-align: middle;"></iconify-icon> Adicionar
                            </button>
                        </div>
                    </div>
                </div>

                <h5 class="muted" style="font-size:13px; text-transform:uppercase; margin-bottom:10px;">Vínculos Existentes</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabela-vinculos">
                        <thead>
                        <tr>
                            <th>Código PDV</th>
                            <th>Nome PDV</th>
                            <th>Data Criação</th>
                            <th style="width: 50px;">Ação</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id');

    let opcoesCache = [];
    let currentOpcaoCodigo = null;
    let currentOpcaoNome = null;

    $(document).ready(() => {
        if (!token || !system_unit_id) {
            Swal.fire('Erro', 'Token ou System Unit ID ausentes.', 'error');
            return;
        }

        // Select2
        $('#plano_contas_id').select2({ dropdownParent: $('#modalOpcao'), width: '100%', placeholder: 'Selecione o plano...', allowClear: true });
        $('#banco_id').select2({ dropdownParent: $('#modalOpcao'), width: '100%', placeholder: 'Selecione o banco...', allowClear: true });

        carregarComboBancos();
        carregarPlanos();
        listarOpcoes();

        $('#filtroCodigo, #filtroNome').on('input', filtrarTabela);
        $('#btnNovaOpcao').click(abrirModalNovo);
        $('#btnSalvar').click(salvarOpcao);
    });

    async function carregarComboBancos() {
        try {
            const res = await axios.post(baseUrl, { method: 'listBancos', token, data: { system_unit_id } });
            let options = '<option value="">Sem vínculo</option>';
            const dados = res.data.data || res.data;
            if(Array.isArray(dados)) dados.forEach(b => options += `<option value="${b.id}">${b.nome}</option>`);
            $('#banco_id').html(options);
        } catch (e) { console.error(e); }
    }

    async function carregarPlanos() {
        try {
            const res = await axios.post(baseUrl, { method: 'listPlanos', token, data: { system_unit_id } });
            const planos = res.data.data || res.data;
            if(Array.isArray(planos)){
                planos.sort((a,b) => a.codigo.localeCompare(b.codigo));
                $('#plano_contas_id').empty().append('<option value="">Selecione...</option>');
                planos.forEach(p => {
                    const nivel = Math.floor((p.codigo.length - 2) / 2);
                    const indent = '\u00A0'.repeat(nivel * 4);
                    $('#plano_contas_id').append(new Option(`${indent}${p.codigo} - ${p.descricao}`, p.codigo));
                });
            }
        } catch (e) { console.error(e); }
    }

    async function listarOpcoes() {
        try {
            const res = await axios.post(baseUrl, { method: 'listOpcoesRecebimento', token, data: { system_unit_id } });
            opcoesCache = res.data.data || res.data;
            const tbody = $('#tabela-opcoes tbody').empty();

            if (!opcoesCache || opcoesCache.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center muted" style="padding:20px;">Nenhum registro encontrado.</td></tr>');
                return;
            }

            opcoesCache.forEach(o => {
                const infoPlano = o.plano_contas_id
                    ? `<div><span class="plano-code">${o.plano_contas_id}</span></div><div style="font-size: 10px; color: #777;">${o.nome_plano_contas || ''}</div>`
                    : '<span class="muted" style="font-size:11px;">-</span>';

                const infoBanco = o.nome_banco
                    ? `<span class="badge-banco"><iconify-icon icon="icon-park-outline:bank"></iconify-icon> ${o.nome_banco}</span>`
                    : '<small class="muted">Nenhum</small>';

                tbody.append(`
                <tr data-id="${o.id}" data-codigo="${o.codigo || ''}" data-nome="${o.nome}">
                    <td class="text-center actions-cell">
                        <a href="javascript:void(0)" class="btn-vincular" title="Vincular Meios" style="color:var(--mrk-amber);">
                            <iconify-icon icon="icon-park-outline:link-one" width="18"></iconify-icon>
                        </a>
                        <a href="javascript:void(0)" class="btn-editar" title="Editar" style="color:var(--mrk-blue);">
                            <iconify-icon icon="icon-park-outline:edit" width="18"></iconify-icon>
                        </a>
                        <a href="javascript:void(0)" class="btn-excluir" title="Excluir" style="color:var(--mrk-red);">
                            <iconify-icon icon="icon-park-outline:delete" width="18"></iconify-icon>
                        </a>
                    </td>
                    <td><strong>${o.codigo || '-'}</strong></td>
                    <td>${o.nome}</td>
                    <td><span class="badge-taxa">${parseFloat(o.taxa || 0).toFixed(2)}%</span></td>
                    <td><span class="badge-prazo">${o.prazo || 0} d</span></td>
                    <td>${infoPlano}</td>
                    <td>${infoBanco}</td>
                </tr>
                `);
            });
            filtrarTabela();
        } catch (e) { console.error(e); Swal.fire('Erro', 'Falha ao listar.', 'error'); }
    }

    function abrirModalNovo() {
        $('#modalTitle').html('<iconify-icon icon="icon-park-outline:add-mode" style="vertical-align: middle; color: var(--mrk-green);"></iconify-icon> Cadastrar Opção');
        $('#opcaoId').val('');
        $('#formOpcao')[0].reset();
        $('#plano_contas_id').val('').trigger('change');
        $('#banco_id').val('').trigger('change');
        $('#modalOpcao').modal('show');
    }

    $(document).on('click', '.btn-editar', function() {
        const id = $(this).closest('tr').data('id');
        const o = opcoesCache.find(x => x.id == id);
        if (!o) return;
        $('#modalTitle').html('<iconify-icon icon="icon-park-outline:edit" style="vertical-align: middle; color: var(--mrk-blue);"></iconify-icon> Editar: ' + o.nome);
        $('#opcaoId').val(o.id);
        $('#codigo').val(o.codigo);
        $('#nome').val(o.nome);
        $('#taxa').val(o.taxa);
        $('#prazo').val(o.prazo);
        $('#banco_id').val(o.banco_id).trigger('change');
        $('#plano_contas_id').val(o.plano_contas_id).trigger('change');
        $('#modalOpcao').modal('show');
    });

    async function salvarOpcao() {
        const id = $('#opcaoId').val();
        const data = {
            id, system_unit_id,
            codigo: $('#codigo').val(),
            nome: $('#nome').val(),
            taxa: $('#taxa').val(),
            prazo: $('#prazo').val(),
            banco_id: $('#banco_id').val(),
            plano_contas_id: String($('#plano_contas_id').val() || "")
        };

        if(!data.nome || data.nome.trim() === "") return Swal.fire('Atenção', 'Nome obrigatório.', 'warning');

        Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });

        try {
            const method = id ? 'updateOpcaoRecebimento' : 'createOpcaoRecebimento';
            const res = await axios.post(baseUrl, { method, token, data });
            Swal.close();
            if(res.data.success) {
                Swal.fire('Sucesso!', 'Salvo.', 'success');
                $('#modalOpcao').modal('hide');
                listarOpcoes();
            } else { Swal.fire('Erro', res.data.message, 'error'); }
        } catch (e) { Swal.fire('Erro', 'Falha na conexão.', 'error'); }
    }

    $(document).on('click', '.btn-excluir', async function() {
        const id = $(this).closest('tr').data('id');
        const conf = await Swal.fire({ title: 'Excluir?', icon: 'warning', showCancelButton: true });
        if(!conf.isConfirmed) return;
        try {
            const res = await axios.post(baseUrl, { method: 'deleteOpcaoRecebimento', token, data: { id } });
            if(res.data.success) { listarOpcoes(); Swal.fire('Feito!', '', 'success'); }
            else { Swal.fire('Erro', res.data.message, 'error'); }
        } catch (e) { console.error(e); }
    });

    // LÓGICA DE VÍNCULOS
    $(document).on('click', '.btn-vincular', function() {
        const tr = $(this).closest('tr');
        currentOpcaoCodigo = tr.data('codigo');
        currentOpcaoNome   = tr.data('nome');

        if(!currentOpcaoCodigo || currentOpcaoCodigo === 'undefined') {
            return Swal.fire('Atenção', 'Adicione um Código à esta Opção antes de vincular.', 'warning');
        }

        $('#tituloVinculoOpcao').text(`Opção: ${currentOpcaoNome} (${currentOpcaoCodigo})`);
        $('#vinc_codigo_meio').val(''); $('#vinc_nome_meio').val('');
        $('#modalVinculos').modal('show');
        carregarListaVinculos();
    });

    async function carregarListaVinculos() {
        const tbody = $('#tabela-vinculos tbody').empty();
        tbody.append('<tr><td colspan="5" class="text-center"><iconify-icon icon="icon-park-outline:loading-four" class="fa-spin"></iconify-icon></td></tr>');
        try {
            const res = await axios.post(baseUrl, { method: 'listMeiosPorOpcao', token, data: { system_unit_id, codigo_opcao: currentOpcaoCodigo } });
            tbody.empty();
            const lista = res.data.data || [];
            if(lista.length === 0) { tbody.append('<tr><td colspan="5" class="text-center muted">Sem vínculos.</td></tr>'); return; }

            lista.forEach(m => {
                const data = m.created_at ? new Date(m.created_at).toLocaleDateString('pt-BR') : '-';
                tbody.append(`
                    <tr>
                        <td style="color:var(--mrk-blue); font-weight:600;">${m.codigo_meio}</td>
                        <td>${m.nome_meio}</td>
                        <td>${data}</td>
                        <td class="text-center">
                            <button class="btn btn-default btn-xs" onclick="removerVinculo(${m.id})" title="Remover">
                                <iconify-icon icon="icon-park-outline:close" style="color:var(--mrk-red);"></iconify-icon>
                            </button>
                        </td>
                    </tr>
                `);
            });
        } catch(e) { tbody.html('<tr><td colspan="5">Erro.</td></tr>'); }
    }

    async function adicionarVinculo() {
        const cod = $('#vinc_codigo_meio').val();
        const nome = $('#vinc_nome_meio').val();
        if(!cod || !nome) return Swal.fire('Atenção', 'Preencha Código e Nome.', 'warning');

        try {
            const res = await axios.post(baseUrl, {
                method: 'vincularMeioPagamento',
                token,
                data: { system_unit_id, codigo_opcao: currentOpcaoCodigo, nome_opcao: currentOpcaoNome, codigo_meio: cod, nome_meio: nome }
            });
            if(res.data.success) {
                Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'Adicionado' });
                $('#vinc_codigo_meio').val(''); $('#vinc_nome_meio').val('');
                carregarListaVinculos();
            } else { Swal.fire('Erro', res.data.message, 'error'); }
        } catch(e) { Swal.fire('Erro', 'Falha ao vincular.', 'error'); }
    }

    async function removerVinculo(id) {
        const conf = await Swal.fire({ title: 'Remover?', icon: 'question', showCancelButton: true });
        if(!conf.isConfirmed) return;
        try {
            const res = await axios.post(baseUrl, { method: 'desvincularMeio', token, data: { id } });
            if(res.data.success) carregarListaVinculos();
            else Swal.fire('Erro', res.data.message, 'error');
        } catch(e) { console.error(e); }
    }

    function filtrarTabela() {
        const c = $('#filtroCodigo').val().toLowerCase();
        const n = $('#filtroNome').val().toLowerCase();
        $('#tabela-opcoes tbody tr').each(function() {
            const tc = $(this).find('td:nth-child(2)').text().toLowerCase();
            const tn = $(this).find('td:nth-child(3)').text().toLowerCase();
            $(this).toggle(tc.includes(c) && tn.includes(n));
        });
    }
</script>
</body>
</html>