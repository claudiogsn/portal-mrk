<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório Curva ABC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; }

        /* === CARD PADRÃO MRK === */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important; /* Identidade MRK */
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* === KPIS MODERNOS === */
        .kpi-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }

        .kpi-icon {
            width: 50px; height: 50px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
            flex-shrink: 0;
        }
        .kpi-icon.blue { background: #e3f2fd; color: var(--mrk-blue); }
        .kpi-icon.green { background: #e8f5e9; color: var(--mrk-green); }
        .kpi-icon.orange { background: #fff3e0; color: var(--mrk-amber); }
        .kpi-icon.gray { background: #f5f5f5; color: #666; }

        .kpi-content { flex-grow: 1; }
        .kpi-content h4 { margin: 0; font-size: 20px; font-weight: 600; font-family: 'Kanit', sans-serif; color: var(--mrk-black); }
        .kpi-content small { color: #888; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* === BADGES CLASSE ABC === */
        .badge-abc {
            width: 28px; height: 28px;
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 6px; /* Soft Square */
            font-weight: 700; font-family: 'Kanit', sans-serif;
            font-size: 13px;
        }
        .abc-A { background-color: #e8f5e9; color: var(--mrk-green); border: 1px solid #c8e6c9; }
        .abc-B { background-color: #fff8e1; color: var(--mrk-amber); border: 1px solid #ffecb3; }
        .abc-C { background-color: #f5f5f5; color: #9e9e9e; border: 1px solid #e0e0e0; }

        /* === BOX DE RESUMO LATERAL === */
        .summary-box {
            background: #fcfcfc;
            border: 1px solid #eee;
            border-left: 3px solid var(--mrk-blue);
            border-radius: 6px;
            padding: 15px;
        }
        .summary-row {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px dashed #eee;
            padding: 8px 0;
            font-size: 13px;
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-row b { color: var(--mrk-black); font-weight: 600; }

        /* === SKELETON LOADING === */
        .skeleton-wrapper { display: none; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 45px; width: 100%; margin-bottom: 10px; }
        .sk-kpi { height: 90px; width: 100%; border-radius: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* === TABELA === */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 13px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }
    </style>
</head>

<body>

<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-solid:chart-histogram" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                CURVA ABC
            </h2>
            <small class="muted hidden-xs">Análise de Pareto (80/15/5)</small>
        </div>

        <div class="body">
            <div class="row clearfix">
                <div class="col-md-3">
                    <label class="muted">Data Inicial</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                        <input type="date" id="dtInicio" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="muted">Data Final</label>
                    <div class="input-group">
                        <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                        <input type="date" id="dtFim" class="form-control">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="muted">Tipo de Análise</label>
                    <select id="tipoRel" class="form-control">
                        <option value="FATURAMENTO">Faturamento (Vendas)</option>
                        <option value="COMPRAS">Compras (Insumos)</option>
                    </select>
                </div>
                <div class="col-md-3" style="margin-top: 22px;">
                    <button id="btnConsultar" class="btn btn-primary waves-effect btn-block">
                        <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                        CONSULTAR
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="skeleton-area" class="skeleton-wrapper">
        <div class="row">
            <div class="col-md-3"><div class="skeleton sk-kpi"></div></div>
            <div class="col-md-3"><div class="skeleton sk-kpi"></div></div>
            <div class="col-md-3"><div class="skeleton sk-kpi"></div></div>
            <div class="col-md-3"><div class="skeleton sk-kpi"></div></div>
        </div>
        <br>
        <div class="card" style="padding: 20px;">
            <div class="skeleton sk-row"></div>
            <div class="skeleton sk-row"></div>
            <div class="skeleton sk-row"></div>
            <div class="skeleton sk-row"></div>
            <div class="skeleton sk-row"></div>
        </div>
    </div>

    <div id="result-area" style="display: none;">

        <div class="row clearfix">
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-icon blue"><iconify-icon icon="icon-park-outline:dollar"></iconify-icon></div>
                    <div class="kpi-content">
                        <small>Valor Total</small>
                        <h4 id="kpiTotal">R$ 0,00</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-icon gray"><iconify-icon icon="icon-park-outline:cube"></iconify-icon></div>
                    <div class="kpi-content">
                        <small>Quantidade Total</small>
                        <h4 id="kpiQtd">0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-icon green"><iconify-icon icon="icon-park-outline:list-numbers"></iconify-icon></div>
                    <div class="kpi-content">
                        <small>Itens Totais</small>
                        <h4 id="kpiItens">0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-icon orange"><iconify-icon icon="icon-park-outline:filter"></iconify-icon></div>
                    <div class="kpi-content">
                        <small>Itens Filtrados</small>
                        <h4 id="kpiFiltrados">0</h4>
                    </div>
                </div>
            </div>
        </div>

        <div class="row clearfix" style="margin-top: 15px;">

            <div class="col-md-8">
                <div class="card" style="min-height: 200px;">
                    <div class="header">
                        <h2>Detalhamento dos Itens</h2>
                    </div>
                    <div class="body">
                        <div class="row clearfix" style="margin-bottom: 15px;">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                                    <input type="text" id="filtroTexto" class="form-control" placeholder="Filtrar por código ou nome...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select id="filtroClasse" class="form-control">
                                    <option value="">Todas as Classes</option>
                                    <option value="A">Classe A (80%)</option>
                                    <option value="B">Classe B (15%)</option>
                                    <option value="C">Classe C (5%)</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover" id="tabela-resultado">
                                <thead>
                                <tr>
                                    <th class="text-center" width="50">#</th>
                                    <th width="80">Código</th>
                                    <th>Produto</th>
                                    <th class="text-right">Qtd</th>
                                    <th class="text-right">Valor Total</th>
                                    <th class="text-right">%</th>
                                    <th class="text-right">% Acum.</th>
                                    <th class="text-center" width="80">Classe</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="header">
                        <h2>Resumo por Classe</h2>
                    </div>
                    <div class="body">
                        <div class="summary-box">
                            <div class="summary-row">
                                <span><span class="badge-abc abc-A">A</span> Alta Importância</span>
                                <span class="text-right">
                                    <b id="resA">0</b> itens<br>
                                    <small id="resAValor" class="muted">R$ 0,00</small>
                                </span>
                            </div>
                            <div class="summary-row">
                                <span><span class="badge-abc abc-B">B</span> Média Importância</span>
                                <span class="text-right">
                                    <b id="resB">0</b> itens<br>
                                    <small id="resBValor" class="muted">R$ 0,00</small>
                                </span>
                            </div>
                            <div class="summary-row">
                                <span><span class="badge-abc abc-C">C</span> Baixa Importância</span>
                                <span class="text-right">
                                    <b id="resC">0</b> itens<br>
                                    <small id="resCValor" class="muted">R$ 0,00</small>
                                </span>
                            </div>
                        </div>

                        <div style="margin-top: 20px; font-size: 11px; color: #777; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                            <iconify-icon icon="icon-park-outline:info" style="vertical-align: middle; margin-right: 4px;"></iconify-icon>
                            <strong>Conceito Pareto (80/20):</strong>
                            <ul style="padding-left: 15px; margin-bottom: 0; margin-top: 5px;">
                                <li><b>A:</b> Itens vitais. Representam 80% do valor movimentado.</li>
                                <li><b>B:</b> Itens intermediários (15% do valor).</li>
                                <li><b>C:</b> Itens triviais. Muitos itens, mas apenas 5% do valor.</li>
                            </ul>
                        </div>

                        <button id="btnLimpar" class="btn btn-default waves-effect btn-block" style="margin-top: 20px;">
                            <iconify-icon icon="icon-park-outline:clear" style="vertical-align: middle;"></iconify-icon>
                            LIMPAR DADOS
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // URL da API
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = Number(urlParams.get('system_unit_id') || urlParams.get('unit_id') || 0);

    // Estado Local
    let dadosBrutos = [];
    let dadosABC = [];
    let dadosFiltrados = [];

    // --- Helpers ---
    const brMoney = v => Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const brNum = (v, d=2) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: d, maximumFractionDigits: d });

    function showSkeleton() {
        $('#result-area').hide();
        $('#skeleton-area').show();
    }

    function hideSkeleton() {
        $('#skeleton-area').hide();
        $('#result-area').fadeIn();
    }

    // --- Lógica ABC ---
    function computeABC(itens) {
        // Clona e ordena por Valor Decrescente
        const arr = [...itens].sort((a,b) => Number(b.valor) - Number(a.valor));
        const total = arr.reduce((sum, it) => sum + Number(it.valor), 0);

        let acumulado = 0;

        return {
            total,
            itens: arr.map((it, idx) => {
                const val = Number(it.valor);
                const share = total > 0 ? (val / total) : 0;
                acumulado += share;

                let classe = 'C';
                if (acumulado <= 0.80001) classe = 'A';
                else if (acumulado <= 0.95001) classe = 'B';

                return {
                    ...it,
                    rank: idx + 1,
                    perc: share,
                    percAcum: acumulado,
                    classe
                };
            })
        };
    }

    // --- Renderização ---
    function renderTabela(itens) {
        const tbody = $('#tabela-resultado tbody');
        tbody.empty();

        if (itens.length === 0) {
            tbody.html('<tr><td colspan="8" class="text-center muted" style="padding: 30px;">Nenhum dado encontrado para os filtros selecionados.</td></tr>');
            return;
        }

        // Limita renderização para performance (Top 500)
        const limit = 500;

        itens.slice(0, limit).forEach(it => {
            tbody.append(`
                <tr>
                    <td class="text-center text-small muted">${it.rank}</td>
                    <td><strong>${it.codigo}</strong></td>
                    <td>${it.nome}</td>
                    <td class="text-right">${brNum(it.quantidade)}</td>
                    <td class="text-right"><strong>${brMoney(it.valor)}</strong></td>
                    <td class="text-right">${(it.perc * 100).toFixed(2)}%</td>
                    <td class="text-right text-small muted">${(it.percAcum * 100).toFixed(2)}%</td>
                    <td class="text-center"><span class="badge-abc abc-${it.classe}">${it.classe}</span></td>
                </tr>
            `);
        });

        if (itens.length > limit) {
            tbody.append(`<tr><td colspan="8" class="text-center muted" style="padding:10px;">Exibindo os top ${limit} de ${itens.length} itens. Utilize os filtros para ver mais.</td></tr>`);
        }
    }

    function renderKPIs(all, filtered, totalVal) {
        const totalQtd = all.reduce((acc, it) => acc + Number(it.quantidade), 0);

        $('#kpiTotal').text(brMoney(totalVal));
        $('#kpiQtd').text(brNum(totalQtd, 0));
        $('#kpiItens').text(all.length);
        $('#kpiFiltrados').text(filtered.length);

        // Resumo ABC
        const counts = { A: {n:0, v:0}, B: {n:0, v:0}, C: {n:0, v:0} };
        all.forEach(it => {
            if(counts[it.classe]) {
                counts[it.classe].n++;
                counts[it.classe].v += Number(it.valor);
            }
        });

        // Atualiza Box Lateral
        ['A', 'B', 'C'].forEach(c => {
            $(`#res${c}`).text(counts[c].n);
            $(`#res${c}Valor`).text(brMoney(counts[c].v));
        });
    }

    // --- Filtros em Tempo Real ---
    function applyLocalFilters() {
        const termo = $('#filtroTexto').val().toLowerCase();
        const classe = $('#filtroClasse').val();

        dadosFiltrados = dadosABC.filter(it => {
            const matchTermo = it.nome.toLowerCase().includes(termo) || String(it.codigo).includes(termo);
            const matchClasse = classe === '' || it.classe === classe;
            return matchTermo && matchClasse;
        });

        renderTabela(dadosFiltrados);
        $('#kpiFiltrados').text(dadosFiltrados.length);
    }

    // --- API Calls ---
    async function onConsultar() {
        const dtInicio = $('#dtInicio').val();
        const dtFim = $('#dtFim').val();
        const tipo = $('#tipoRel').val();

        if (!dtInicio || !dtFim) {
            Swal.fire('Atenção', 'Selecione o período.', 'warning');
            return;
        }

        showSkeleton();

        try {
            const method = (tipo === 'COMPRAS') ? 'getCurvaABCCompras' : 'getCurvaABCFaturamento';

            const res = await axios.post(baseUrl, {
                method: method,
                token: token,
                data: {
                    system_unit_id: system_unit_id,
                    dt_inicio: dtInicio,
                    dt_fim: dtFim
                }
            });

            if (!res.data || res.data.success === false) {
                hideSkeleton();
                Swal.fire('Aviso', res.data?.message || 'Nenhum dado retornado.', 'info');
                return;
            }

            // Normaliza Dados
            const raw = res.data.itens || res.data.produtos || [];
            dadosBrutos = raw.map(it => ({
                codigo: it.codigo || it.cod_material || it.product_id,
                nome: it.nome || it.descricao || it.produto_nome,
                quantidade: Number(it.quantidade || it.qtd || 0),
                valor: Number(it.valor_total || it.valor || 0)
            }));

            // Calcula Matemática ABC
            const calculated = computeABC(dadosBrutos);
            dadosABC = calculated.itens;
            window.__totalValor = calculated.total;

            // Renderiza Inicial
            dadosFiltrados = dadosABC;
            renderKPIs(dadosABC, dadosFiltrados, window.__totalValor);
            renderTabela(dadosFiltrados);

            hideSkeleton();

        } catch (e) {
            console.error(e);
            hideSkeleton();
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function onLimpar() {
        $('#filtroTexto').val('');
        $('#filtroClasse').val('');
        $('#result-area').hide();
        dadosABC = [];
    }

    // --- Init ---
    $(document).ready(() => {
        const date = new Date();
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        const today = date.toISOString().split('T')[0];

        $('#dtInicio').val(firstDay);
        $('#dtFim').val(today);

        $('#btnConsultar').click(onConsultar);
        $('#btnLimpar').click(onLimpar);

        let timeout = null;
        $('#filtroTexto').on('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(applyLocalFilters, 300);
        });

        $('#filtroClasse').change(applyLocalFilters);
    });

</script>
</body>
</html>