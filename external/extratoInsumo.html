<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Extrato do Insumo</title>
    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <!-- Fonts e Ícones -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- CSS -->
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

    <style>
        .header-card {
            margin-top: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }
        .badge-tipo {
            display: inline-block;
            min-width: 70px;
        }
        .badge-entrada { background: #d4edda; color: #155724; border: 1px solid #28a745; }
        .badge-saida   { background: #ffe5b4; color: #7c4a03; border: 1px solid #ff9800; }
        .badge-saldo   { background: #fefefe; color: #444;    border: 1px solid #6c757d; }
        .badge-balanco { background: #e0f7ff; color: #014d76; border: 1px solid #007bff; }
        .table-extrato td, .table-extrato th { vertical-align: middle !important; }
        .nowrap { white-space: nowrap; }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="header-card">
        <div class="row">
            <div class="col-md-3">
                <label for="dataInicial">Data Inicial</label>
                <input type="date" id="dataInicial" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="dataFinal">Data Final</label>
                <input type="date" id="dataFinal" class="form-control">
            </div>
            <div class="col-md-3">
                <label for="item-description">Produto</label>
                <input type="hidden" id="item-id" name="item_id">
                <input type="text" id="item-description" class="form-control" readonly
                       placeholder="Clique para selecionar um produto" data-toggle="modal" data-target="#itemModal">
            </div>
            <div class="col-md-1 text-right">
                <button id="btnFiltrar" class="btn btn-primary" style="margin-top:24px;">Buscar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Seleção de Produto -->
    <div class="modal fade" id="itemModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Selecionar Produto</h4>
                </div>
                <div class="modal-body">
                    <input type="text" id="item-search" class="form-control" placeholder="Buscar por código ou descrição">
                    <br />
                    <table class="table table-striped table-hover" id="item-table">
                        <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descrição</th>
                            <th>Unidade</th>
                            <th>Ação</th>
                        </tr>
                        </thead>
                        <tbody><!-- dinâmico --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="header">
            <h2>Extrato por Período</h2>
            <small id="saldo_inicial" class="text-primary font-bold">Saldo inicial: -</small>
        </div>
        <div class="body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-extrato" id="extrato-table">
                    <thead>
                    <tr>
                        <th class="nowrap">Data</th>
                        <th>Tipo</th>
                        <th>Documento</th>
                        <th class="text-right nowrap">Quantidade</th>
                        <th>Observação</th>
                    </tr>
                    </thead>
                    <tbody><!-- dinâmico --></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="bsb/plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    $(document).ready(function () {
        const baseUrl = window.location.hostname !== 'localhost'
            ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
            : 'http://localhost/portal-mrk/api/v1/index.php';

        const urlParams = new URLSearchParams(window.location.search);
        const token  = urlParams.get('token');
        const unitId = urlParams.get('unit_id');

        function showLoader() { $('.page-loader-wrapper').fadeIn(); }
        function hideLoader() { $('.page-loader-wrapper').fadeOut(); }

        $('#item-description').on('click', function () {
            loadItems(unitId);
        });

        // Buscar extrato -> agora preenche tabela
        $('#btnFiltrar').on('click', async function () {
            const dt_inicio = $('#dataInicial').val();
            const dt_fim    = $('#dataFinal').val();
            const insumo_id = $('#item-id').val();

            if (!dt_inicio || !dt_fim) {
                Swal.fire('Erro', 'Preencha as datas!', 'error');
                return;
            }
            if (!insumo_id) {
                Swal.fire('Erro', 'Selecione um produto.', 'error');
                return;
            }

            showLoader();

            try {
                const response = await axios.post(baseUrl, {
                    method: 'extratoInsumo',
                    token: token,
                    data: {
                        system_unit_id: parseInt(unitId),
                        insumo_id: parseInt(insumo_id),
                        dt_inicio,
                        dt_fim
                    }
                });

                const result = response.data;
                $('#saldo_inicial').text('Saldo inicial: ' + (result.saldo_inicial ?? '-'));

                montarTabelaExtrato(result.extrato || []);
            } catch (err) {
                Swal.fire('Erro', 'Não foi possível carregar o extrato.', 'error');
                console.error(err);
            } finally {
                hideLoader();
            }
        });

        function montarTabelaExtrato(extrato) {
            const $tb = $('#extrato-table tbody');
            $tb.empty();

            // percorre dias
            extrato.forEach(dia => {
                const diaFmt = formatarData(dia.data);

                // Saldo anterior (se existir)
                if (dia.saldo_anterior) {
                    $tb.append(linhaTabela(
                        diaFmt,
                        'Saldo Anterior',
                        dia.saldo_anterior.doc || '',
                        dia.saldo_anterior.quantidade,
                        'Saldo do início do dia',
                        'saldo'
                    ));
                }

                // Movimentações (entradas/saídas)
                (dia.movimentacoes || []).forEach(mov => {
                    const tipoLabel = mov.tipo_mov === 'entrada' ? 'Entrada' : 'Saída';
                    const sinal = mov.tipo_mov === 'entrada' ? '+' : '-';
                    $tb.append(linhaTabela(
                        diaFmt,
                        tipoLabel,
                        mov.doc || '',
                        (sinal === '-' ? -1 : 1) * parseFloat(mov.quantidade || 0),
                        '',
                        mov.tipo_mov === 'entrada' ? 'entrada' : 'saida'
                    ));
                });

                // Saldo estimado
                if (typeof dia.saldo_estimado !== 'undefined' && dia.saldo_estimado !== null) {
                    $tb.append(linhaTabela(
                        diaFmt,
                        'Saldo Estimado',
                        '',
                        dia.saldo_estimado,
                        'Saldo projetado ao final do dia',
                        'saldo'
                    ));
                }

                // Balanço (se houver)
                if (dia.balanco) {
                    $tb.append(linhaTabela(
                        diaFmt,
                        'Balanço',
                        dia.balanco.doc || '',
                        dia.balanco.quantidade,
                        'Conferência de estoque',
                        'balanco'
                    ));
                }
            });
        }

        function linhaTabela(dataFmt, tipo, documento, quantidade, obs, classeTipo) {
            const q = (quantidade === null || typeof quantidade === 'undefined' || isNaN(+quantidade))
                ? ''
                : Number(quantidade).toFixed(2);

            const badgeClass =
                classeTipo === 'entrada' ? 'badge-entrada' :
                    classeTipo === 'saida'   ? 'badge-saida'   :
                        classeTipo === 'balanco' ? 'badge-balanco' : 'badge-saldo';

            return `
          <tr>
            <td class="nowrap">${dataFmt}</td>
            <td><span class="badge badge-tipo ${badgeClass}">${tipo}</span></td>
            <td>${documento || ''}</td>
            <td class="text-right nowrap">${q}</td>
            <td>${obs || ''}</td>
          </tr>
        `;
        }

        async function loadItems(unitId) {
            if (!unitId) {
                Swal.fire('Atenção', 'Selecione a unidade de origem antes de buscar produtos.', 'warning');
                return;
            }

            try {
                const response = await axios.post(baseUrl, {
                    method: 'listInsumos',
                    token: token,
                    data: { unit_id: unitId }
                });

                if (response.data.success) {
                    const items = response.data.insumos || [];
                    const tbody = $('#item-table tbody');
                    tbody.empty();

                    items.forEach(item => {
                        const row = `
                <tr>
                  <td>${item.codigo}</td>
                  <td>${item.nome}</td>
                  <td>${item.und || ''}</td>
                  <td>
                    <button class="btn btn-primary select-item"
                            data-codigo="${item.codigo}"
                            data-nome="${item.nome}">
                      Selecionar
                    </button>
                  </td>
                </tr>`;
                        tbody.append(row);
                    });

                    // Filtro local
                    $('#item-search').off('input').on('input', function () {
                        const termo = $(this).val().toLowerCase();
                        $('#item-table tbody tr').each(function () {
                            const cod  = $(this).find('td:nth-child(1)').text().toLowerCase();
                            const nome = $(this).find('td:nth-child(2)').text().toLowerCase();
                            $(this).toggle(cod.includes(termo) || nome.includes(termo));
                        });
                    });

                    // Selecionar item
                    $('.select-item').off('click').on('click', function () {
                        const id = $(this).data('codigo');
                        const nome = $(this).data('nome');

                        $('#item-id').val(id);
                        $('#item-description').val(nome);

                        $('#itemModal').modal('hide');
                    });
                } else {
                    Swal.fire('Erro', 'Não foi possível carregar os produtos.', 'error');
                }
            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'Erro ao buscar produtos.', 'error');
            }
        }

        function formatarData(dataStr) {
            if (!dataStr) return '';
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // Datas padrão = hoje
        const hoje = new Date().toISOString().split('T')[0];
        $('#dataInicial').val(hoje);
        $('#dataFinal').val(hoje);
    });
</script>
</body>
</html>
