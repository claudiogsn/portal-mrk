<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Modelos de Balanço</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS / Libs iguais ao modelo -->
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <!-- JS / Libs iguais ao modelo -->
    <script src="https://kit.fontawesome.com/313adf4cdc.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header"><h2>Modelos de Balanço</h2></div>
        <div class="body">
            <div class="row">
                <div class="col-md-6">
                    <input type="text" id="filtroModelo" class="form-control mb-2" placeholder="Filtrar por nome ou tag">
                </div>
                <div class="col-md-6">
                    <input type="checkbox" id="filtroApenasAtivos" class="chk-col-blue" checked>
                    <label for="filtroApenasAtivos">Apenas Ativos</label>
                </div>

                <div class="col-md-6 text-right mb-2">
                    <button id="btnNovoModelo" class="btn btn-success">Novo Modelo</button>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabela-modelos">
                    <thead>
                    <tr>
                        <th style="width: 18px;"></th> <!-- Detalhes -->
                        <th style="width: 18px;"></th> <!-- Editar -->
                        <th style="width: 18px;"></th> <!-- Realizar -->
                        <th style="width: 18px;"></th> <!-- Ativar/Inativar -->
                        <th style="width: 18px;"></th> <!-- Ativar/Inativar -->
                        <th style="width: 18px;"></th> <!-- Replicar -->
                        <th>Tag</th>
                        <th>Nome</th>
                        <th>URL</th>
                        <th>Itens</th>
                        <th>Criado por</th>
                        <th>Criado em</th>
                        <th>Atualizado em</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitle">Detalhes do Balanço</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="detalhesTable">
                        <thead>
                        <tr>
                            <th>Nome Produto</th>
                            <th>Unidade</th>
                            <th>Código Produto</th>
                        </tr>
                        </thead>
                        <tbody><!-- dinâmico --></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Replicação -->
<div class="modal fade" id="modalReplicar" tabindex="-1" role="dialog" aria-labelledby="modalReplicarTitulo">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalReplicarTitulo">Replicar Modelo de Balanço</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Origem -->
                <div class="form-group">
                    <label>Unidade de origem</label>
                    <input type="text" id="replicaOrigem" class="form-control" readonly
                           value="">
                </div>

                <!-- Modelo (somente ativos da tela) -->
                <div class="form-group">
                    <label>Modelo (apenas ativos)</label>
                    <select id="replicaModeloTag" class="form-control"></select>
                </div>

                <!-- Destino (unidades do mesmo grupo - apenas uma) -->
                <div class="form-group">
                    <label>Unidade de destino</label>
                    <select id="replicaDestino" class="form-control">
                        <option value="">Carregando...</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" id="btnConfirmarReplicacao">Replicar</button>
                <button class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>


<script>
    // Endpoints iguais aos seus padrões
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const token    = new URLSearchParams(window.location.search).get('token') || '';
    const unitId   = new URLSearchParams(window.location.search).get('unit_id') || '';
    const username = new URLSearchParams(window.location.search).get('username') || '';

    let modelosCache = [];

    const brDate = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? '' : d.toLocaleDateString('pt-BR');
    };

    const makeURL = (tag) => `${baseUrlRedirect}/balanco/${encodeURIComponent(tag)}`;

    $(document).ready(() => {
        listarModelos();

        $('#filtroModelo').on('input', filtrarModelos);
        $('#filtroApenasAtivos').on('change', filtrarModelos);

        $('#btnNovoModelo').on('click', () => {
            window.location.href =
                `${baseUrlRedirect}/external/createBalanco.html?username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}&unit_id=${encodeURIComponent(unitId)}`;
        });
    });

    async function listarModelos() {
        try {
            console.log('chamou')
            // carrega todos e filtra local (para ficar idêntico ao modelo enviado)
            const res = await axios.post(baseUrl, {
                method: 'listModelosWithProducts',
                token,
                data: { unit_id: unitId }
            });

            if (!res.data || !res.data.success) {
                return Swal.fire('Erro', 'Falha ao carregar modelos: ' + (res.data?.message || ''), 'error');
            }

            const lst = Array.isArray(res.data.modelos) ? res.data.modelos : [];
            // normaliza itens count
            lst.forEach(m => { if (m && !Array.isArray(m.itens)) m.itens = m.itens || []; });
            modelosCache = lst;

            montarTabela(lst);
            filtrarModelos(); // aplica "apenas ativos" + texto
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Erro ao carregar modelos.', 'error');
        }
    }

    // helper: detectar se a linha é ativa
    function isLinhaAtiva($tr) {
        const val = ($tr.attr('data-ativo') || '').toString().toLowerCase().trim();
        if (val === '1' || val === 'true') return true;
        if (val === '0' || val === 'false') return false;

        const status = ($tr.find('td').last().text() || '').toLowerCase().trim();
        const temAtivo = status.includes('ativo');
        const temInativo = status.includes('inativo');
        return temAtivo && !temInativo;
    }

    // filtro texto + checkbox
    function filtrarModelos() {
        const termo = ($('#filtroModelo').val() || '').toLowerCase();
        const apenasAtivos = $('#filtroApenasAtivos').is(':checked');

        $('#tabela-modelos tbody tr').each(function () {
            const $tr = $(this);
            const nome = ($tr.data('nome') || '').toString().toLowerCase();
            const tag = ($tr.data('tagvalor') || '').toString().toLowerCase();
            const ativo = isLinhaAtiva($tr);

            const matchTexto = nome.includes(termo) || tag.includes(termo);
            const matchStatus = !apenasAtivos || ativo;

            $tr.toggle(matchTexto && matchStatus);
        });
    }

    // adicionar na criação da linha no montarTabela:
    function montarTabela(lista) {
        const tbody = $('#tabela-modelos tbody');
        tbody.empty();

        lista.forEach(m => {
            const ativo = (m.ativo === 1 || m.ativo === '1' || m.ativo === true || m.ativo === 'true');
            const statusHtml = ativo
                ? '<span class="label label-success">Ativo</span>'
                : '<span class="label label-danger">Inativo</span>';

            const url = `${baseUrlRedirect}/balanco/${encodeURIComponent(m.tag)}`;

            tbody.append(`
      <tr data-nome="${(m.nome || '').toLowerCase()}" data-tagvalor="${(m.tag || '').toLowerCase()}" data-ativo="${ativo ? '1' : '0'}">
        <!-- Ações -->
        <td class="text-center">
          <a href="#" onclick="abrirDetalhes('${m.tag}')" title="Ver Detalhes"><i class="fa fa-list green"></i></a>
        </td>
        <td class="text-center">
          <a href="#" onclick="editarModelo('${m.tag}')" title="Editar"><i class="fa fa-edit blue"></i></a>
        </td>
        <td class="text-center">
          <a href="${url}" target="_blank" title="Realizar Balanço"><i class="fa fa-play orange"></i></a>
        </td>
        <td class="text-center">
          <a href="#" onclick="copiarTexto('${url}')" title="Copiar URL"><i class="fa fa-clone purple"></i></a>
        </td>
        <td class="text-center">
          <a href="#" onclick="toggleStatus('${m.tag}', ${ativo ? 1 : 0})" title="${ativo ? 'Desativar' : 'Ativar'}">
            <i class="fa fa-power-off ${ativo ? 'red' : 'green'}"></i>
          </a>
        </td>
        <td class="text-center">
          <a href="#" onclick="abrirModalReplicar('${m.tag}')" title="Replicar Modelo">
            <i class="fa fa-copy teal"></i>
          </a>
        </td>

        <!-- Colunas de dados -->
        <td>${m.tag || '-'}</td>
        <td>${m.nome || '-'}</td>
        <td><a href="${url}" target="_blank" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;max-width:280px;">${url}</a></td>
        <td>${Array.isArray(m.itens) ? m.itens.length : 0}</td>
        <td>${m.usuario_login || '-'}</td>
        <td>${brDate(m.created_at)}</td>
        <td>${brDate(m.updated_at)}</td>
        <td>${statusHtml}</td>
      </tr>
    `);
        });
    }

    // Função copiarTexto (reutilizável)
    function copiarTexto(text) {
        const input = document.createElement('input');
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'URL copiada!',
            showConfirmButton: false,
            timer: 1000
        });
    }



    function editarModelo(tag) {
        const href = `${baseUrlRedirect}/external/editBalanco.html?username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}&unit_id=${encodeURIComponent(unitId)}&tag=${encodeURIComponent(tag)}`;
        window.location.href = href;
    }

    async function toggleStatus(tag, statusAtual) {
        const confirmacao = await Swal.fire({
            title: statusAtual ? 'Desativar modelo?' : 'Ativar modelo?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmacao.isConfirmed) return;

        try {
            await axios.post(baseUrl, {
                method: 'toggleModeloStatus',
                token,
                data: { unit_id: unitId, tag, status: statusAtual ? 0 : 1 }
            });

            // Atualiza o cache e a tabela sem recarregar tudo
            const idx = modelosCache.findIndex(x => x.tag === tag);
            if (idx > -1) {
                modelosCache[idx].ativo = statusAtual ? 0 : 1;
            }
            montarTabela(modelosCache);
            filtrarModelos();
        } catch (e) {
            Swal.fire('Erro', 'Erro ao alterar status.', 'error');
        }
    }

    async function abrirDetalhes(tag) {
        try {
            $('#modalTitle').text('Detalhes do Balanço');
            $('#detalhesTable tbody').html('<tr><td colspan="3">Carregando...</td></tr>');
            $('#modalDetalhes').modal('show');

            const response = await axios.post(baseUrl, {
                method: 'getModelByTag',
                token,
                data: { tag }
            });

            if (!response.data || !response.data.success) {
                $('#detalhesTable tbody').html('<tr><td colspan="3">Erro ao carregar detalhes.</td></tr>');
                return;
            }

            const modelo = response.data.modelo;
            const itens = response.data.itens || {};
            $('#modalTitle').text(`Detalhes do Balanço: ${modelo.tag}`);

            const tbody = $('#detalhesTable tbody');
            tbody.empty();

            for (const categoria in itens) {
                tbody.append(`
          <tr>
            <td colspan="3" style="font-weight:bold;background:#f5f5f5;">${categoria}</td>
          </tr>
        `);
                itens[categoria].forEach(item => {
                    tbody.append(`
            <tr>
              <td>${item.nome_produto || ''}</td>
              <td>${item.und_produto || ''}</td>
              <td>${item.codigo_produto || ''}</td>
            </tr>
          `);
                });
            }
        } catch (e) {
            $('#detalhesTable tbody').html('<tr><td colspan="3">Erro ao carregar detalhes.</td></tr>');
        }
    }

    // Abre o modal de replicação.
    // Se vier uma tag de uma linha clicada, já seleciona no dropdown.
    async function abrirModalReplicar(tagSelecionada) {
        try {
            // mostra unidade de origem
            $('#replicaOrigem').val(unitId);

            // popula select de modelos (apenas ativos da tela)
            popularModelosAtivos(tagSelecionada);

            // carrega unidades destino (mesmo grupo, sem incluir a atual)
            await carregarUnidadesDestino();

            // bind do botão confirmar (evita múltiplos binds)
            $('#btnConfirmarReplicacao').off('click').on('click', replicarModelo);

            // ao fechar, recarrega a tela (como você pediu)
            $('#modalReplicar').off('hidden.bs.modal').on('hidden.bs.modal', function () {
                listarModelos();
            });

            $('#modalReplicar').modal('show');
        } catch (e) {
            Swal.fire('Erro', 'Não foi possível abrir o modal de replicação.', 'error');
        }
    }

    // Preenche o select com os modelos ativos já carregados na tela
    function popularModelosAtivos(tagSelecionada) {
        const $sel = $('#replicaModeloTag');
        $sel.empty();

        const ativos = (modelosCache || []).filter(m => (m.ativo === 1 || m.ativo === '1' || m.ativo === true || m.ativo === 'true'));

        if (!ativos.length) {
            $sel.append('<option value="">Não há modelos ativos</option>');
            $sel.prop('disabled', true);
            return;
        }

        $sel.prop('disabled', false);

        // Exibir "tag - nome" para facilitar
        ativos.forEach(m => {
            const optText = `${m.tag} — ${m.nome || ''}`.trim();
            $sel.append(`<option value="${m.tag}">${optText}</option>`);
        });

        if (tagSelecionada) {
            $sel.val(tagSelecionada);
        }
    }

    // Busca as unidades do mesmo grupo (sem incluir a atual) e preenche o select
    async function carregarUnidadesDestino() {
        const $sel = $('#replicaDestino');
        $sel.empty().append('<option value="">Carregando...</option>');

        try {
            const resp = await axios.post(baseUrl, {
                method: 'listSystemUnitsSameGroup',
                token,
                data: { system_unit_id: parseInt(unitId, 10), incluirAtual: false }
            });

            $sel.empty();

            if (resp.data && resp.data.success && Array.isArray(resp.data.unidades) && resp.data.unidades.length) {
                $sel.append('<option value="">Selecione uma unidade</option>');
                resp.data.unidades.forEach(u => {
                    $sel.append(`<option value="${u.id}">${u.id} — ${u.name || '(sem nome)'}</option>`);
                });
            } else {
                $sel.append('<option value="">Nenhuma unidade disponível</option>');
            }
        } catch (e) {
            $sel.empty().append('<option value="">Erro ao carregar unidades</option>');
        }
    }

    // Envia a replicação para a API
    async function replicarModelo() {
        const tag = $('#replicaModeloTag').val();
        const destino = $('#replicaDestino').val();

        if (!tag)   return Swal.fire('Atenção', 'Selecione um modelo.', 'warning');
        if (!destino) return Swal.fire('Atenção', 'Selecione a unidade de destino.', 'warning');

        try {
            Swal.fire({ title: 'Replicando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const resp = await axios.post(baseUrl, {
                method: 'replicateModelo',
                token,
                data: {
                    system_unit_id: parseInt(unitId, 10),
                    system_unit_id_destino: parseInt(destino, 10),
                    tag
                }
            });

            Swal.close();

            if (resp.data && resp.data.success) {
                Swal.fire('Sucesso', 'Modelo replicado com sucesso.', 'success');
                // fecha modal -> o hidden.bs.modal já chama listarModelos()
                $('#modalReplicar').modal('hide');
            } else {
                Swal.fire('Erro', resp.data?.message || 'Falha na replicação.', 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Erro ao replicar o modelo.', 'error');
        }
    }

</script>
</body>
</html>
