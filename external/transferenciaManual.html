<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferência de Itens</title>

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet" />
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet" />
    <link href="bsb/plugins/jquery-datatable/skin/bootstrap/css/dataTables.bootstrap.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet" />

    <style>
        .form-control { margin-bottom: 10px; }
        table { margin-top: 20px; }
        .select2-container--bootstrap .select2-selection {
            border-radius: 0;
            border: none;
            border-bottom: 1px solid #ddd;
            box-shadow: none;
        }
        .card { padding: 20px; }
        #transfer-button { margin-top: 20px; padding: 10px 30px; }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <br>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="header">
                    <h2>Transferência de Itens</h2>
                </div>
                <div class="body">
                    <form id="transferForm">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="transfer-date">Data</label>
                                <input type="date" id="transfer-date" class="form-control" required>
                            </div>
                            <div class="col-md-5">
                                <label for="origin-unit">Unidade de Origem</label>
                                <select id="origin-unit" class="form-control" required>
                                    <option value="">Selecione a Origem</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label for="destination-unit">Unidade de Destino</label>
                                <select id="destination-unit" class="form-control" required>
                                    <option value="">Selecione o Destino</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <label for="item-select">Produto (Código, Nome ou EAN)</label>
                                <select id="item-select" class="form-control select2">
                                    <option value="">Selecione a Unidade de Origem primeiro</option>
                                </select>
                                <input type="hidden" id="item-codigo">
                                <input type="hidden" id="item-unit">
                                <input type="hidden" id="item-nome">
                            </div>
                            <div class="col-md-2">
                                <label for="item-quantity">Quantidade</label>
                                <input type="text" inputmode="numeric" id="item-quantity" class="form-control" placeholder="0,000">
                            </div>
                            <div class="col-md-2">
                                <label>&nbsp;</label>
                                <button type="button" id="add-item" class="btn btn-primary btn-block waves-effect">ADICIONAR</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="row">
            <div class="col-md-12">
                <table id="result-table" class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th width="15%">Cod.</th>
                        <th>Descrição</th>
                        <th width="15%">Quant</th>
                        <th width="10%">Ações</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <center>
        <button type="button" id="transfer-button" class="btn btn-success btn-lg waves-effect">REALIZAR TRANSFERÊNCIA</button>
    </center>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const baseUrl = window.location.hostname !== 'localhost' ?
            'https://portal.mrksolucoes.com.br/api/v1/index.php' :
            'http://localhost/portal-mrk/api/v1/index.php';

        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const username = urlParams.get('username');

        // Inicializar Select2
        $('#item-select').select2({
            theme: "bootstrap",
            placeholder: "Busque por código, nome ou EAN",
            allowClear: true,
            width: '100%'
        });

        // Configurar data de hoje
        const today = new Date().toISOString().split('T')[0];
        $('#transfer-date').val(today).attr('max', today);

        // Carregar Unidades
        async function loadUnidades() {
            try {
                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        method: 'getFiliaisByMatriz',
                        token: token,
                        data: { unit_matriz_id: username }
                    })
                });
                const filiais = await response.json();
                const originSelect = $('#origin-unit');
                const destinationSelect = $('#destination-unit');

                originSelect.append(new Option('RED Burguer - Produção', '10'));

                filiais.forEach(filial => {
                    originSelect.append(new Option(filial.filial_nome, filial.filial_id));
                    destinationSelect.append(new Option(filial.filial_nome, filial.filial_id));
                });
            } catch (error) {
                Swal.fire('Erro', 'Erro ao carregar unidades', 'error');
            }
        }

        // Carregar Itens no Select2 quando mudar origem
        $('#origin-unit').on('change', async function() {
            const unitId = $(this).val();
            if (!unitId) return;

            try {
                const response = await axios.post(baseUrl, {
                    method: 'listInsumos',
                    token: token,
                    data: { unit_id: unitId }
                });

                if (response.data.success) {
                    const select = $('#item-select');
                    select.empty().append('<option value="">Selecione um produto</option>');

                    response.data.insumos.forEach(item => {
                        // Criamos o texto que permite busca por código, nome ou ean
                        const text = `${item.codigo} - ${item.nome} ${item.ean ? '['+item.ean+']' : ''}`;
                        const newOption = new Option(text, item.codigo, false, false);

                        // Guardamos os dados úteis no elemento
                        $(newOption).data('und', item.und);
                        $(newOption).data('nome', item.nome);

                        select.append(newOption);
                    });
                    select.trigger('change');
                }
            } catch (error) {
                Swal.fire('Erro', 'Não foi possível carregar os itens desta unidade.', 'error');
            }
        });

        // Ao selecionar item no Select2, atualizar campos ocultos
        $('#item-select').on('select2:select', function (e) {
            const data = $(e.params.data.element);
            $('#item-codigo').val(e.params.data.id);
            $('#item-unit').val(data.data('und'));
            $('#item-nome').val(data.data('nome'));
        });

        // Máscara básica para quantidade (KG/LT)
        $('#item-quantity').on('input', function () {
            const unidade = $('#item-unit').val();
            if (['KG', 'LT', 'L'].includes(unidade)) {
                let valor = $(this).val().replace(/[^\d]/g, '');
                valor = (valor / 1000).toFixed(3);
                $(this).val(valor.replace('.', ','));
            } else {
                $(this).val($(this).val().replace(/[^\d]/g, ''));
            }
        });

        // Adicionar Item à Tabela
        $('#add-item').click(function () {
            const codigo = $('#item-codigo').val();
            const nome = $('#item-nome').val();
            const quantidade = $('#item-quantity').val();

            if (!codigo || !quantidade || quantidade === "0,000") {
                Swal.fire('Atenção', 'Selecione o produto e informe a quantidade.', 'warning');
                return;
            }

            const row = `
            <tr>
                <td>${codigo}</td>
                <td>${nome}</td>
                <td>${quantidade}</td>
                <td><button type="button" class="btn btn-danger btn-xs remove-item">Remover</button></td>
            </tr>
        `;

            $('#result-table tbody').append(row);

            // Limpar campos e resetar Select2
            $('#item-select').val(null).trigger('change');
            $('#item-codigo').val('');
            $('#item-nome').val('');
            $('#item-unit').val('');
            $('#item-quantity').val('');

            // Focar no Select2 novamente para facilitar a próxima busca
            $('#item-select').select2('open');
        });

        // Remover item da tabela
        $(document).on('click', '.remove-item', function () {
            $(this).closest('tr').remove();
        });

        // Finalizar Transferência
        $('#transfer-button').click(async function () {
            const transferDate = $('#transfer-date').val();
            const originUnit = $('#origin-unit').val();
            const destinationUnit = $('#destination-unit').val();
            const items = [];

            $('#result-table tbody tr').each(function(index, row) {
                items.push({
                    codigo: $(row).find('td:eq(0)').text(),
                    seq: index + 1,
                    quantidade: $(row).find('td:eq(2)').text()
                });
            });

            if (!originUnit || !destinationUnit || items.length === 0) {
                Swal.fire('Erro', 'Preencha as unidades e adicione ao menos um item.', 'error');
                return;
            }

            if (originUnit === destinationUnit) {
                Swal.fire('Erro', 'Origem e destino não podem ser iguais.', 'error');
                return;
            }

            const confirm = await Swal.fire({
                title: 'Confirmar Transferência?',
                text: `Total de ${items.length} itens serão transferidos.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar'
            });

            if (confirm.isConfirmed) {
                Swal.showLoading();
                try {
                    const response = await axios.post(baseUrl, {
                        method: 'createTransferItems',
                        token: token,
                        data: {
                            system_unit_id: originUnit,
                            system_unit_id_destino: destinationUnit,
                            transfer_date: transferDate,
                            itens: items,
                            usuario_id: username
                        }
                    });

                    if (response.data.success) {
                        Swal.fire('Sucesso!', 'Transferência concluída.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('Erro', response.data.message, 'error');
                    }
                } catch (error) {
                    Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
                }
            }
        });

        loadUnidades();
    });
</script>

</body>
</html>