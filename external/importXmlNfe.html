<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Importar Notas Fiscais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://unpkg.com/filepond@^4/dist/filepond.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== AJUSTES DE IFRAME TRANSPARENTE ====== */
        html, body { background: transparent !important; }
        body.theme-blue { background: transparent !important; }
        .container-fluid, .tab-content { background: transparent !important; }

        /* Card Transparente/Branco */
        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            box-shadow: none !important;
            border: 1px solid #eee;
        }

        /* Abas Personalizadas */
        .nav-tabs { border-bottom: 2px solid #ddd; }
        .nav-tabs > li > a {
            font-family: 'Kanit', sans-serif;
            color: #666;
            border: none;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            padding: 10px 20px;
        }
        .nav-tabs > li.active > a,
        .nav-tabs > li.active > a:hover,
        .nav-tabs > li.active > a:focus {
            color: var(--mrk-blue);
            border: none;
            border-bottom: 3px solid var(--mrk-blue);
            background-color: transparent;
        }
        .nav-tabs > li > a:hover { background-color: rgba(0,0,0,0.02); }

        /* Ajustes FilePond */
        .filepond--root { font-family: 'Poppins', sans-serif; }
        .filepond--drop-label { color: #666; }
        .filepond--label-action { text-decoration-color: var(--mrk-blue); color: var(--mrk-blue); }
        .filepond--list, .filepond--file-info, .filepond--file-status { display: none !important; } /* Esconde lista padrão pois usamos tabela */

        /* Tabelas */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            background: #f9f9f9;
            border-bottom: 2px solid #eee;
        }
        .selected-row { background-color: #e3f2fd !important; }

        /* Status */
        .status-ok { color: var(--mrk-green); font-weight: 600; font-size: 12px; }
        .status-erro { color: var(--mrk-red); font-weight: 600; font-size: 12px; }
        .small-text { font-size: 11px; color: #777; font-family: 'Poppins', sans-serif; }

        /* Labels */
        .label { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-family: 'Kanit', sans-serif; font-size: 10px; }
        .bg-green { background-color: var(--mrk-green); }
        .bg-orange { background-color: var(--mrk-amber); }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>

    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#tab-xml" aria-controls="tab-xml" role="tab" data-toggle="tab">
                <iconify-icon icon="icon-park-outline:code" style="vertical-align: -2px; margin-right: 5px;"></iconify-icon>
                XML Manual
            </a>
        </li>
        <li role="presentation">
            <a href="#tab-sefaz" aria-controls="tab-sefaz" role="tab" data-toggle="tab">
                <iconify-icon icon="icon-park-outline:cloud-download" style="vertical-align: -2px; margin-right: 5px;"></iconify-icon>
                Via SEFAZ
            </a>
        </li>
        <li role="presentation">
            <a href="#tab-chave" aria-controls="tab-chave" role="tab" data-toggle="tab">
                <iconify-icon icon="icon-park-outline:key" style="vertical-align: -2px; margin-right: 5px;"></iconify-icon>
                Via Chave de Acesso
            </a>
        </li>
    </ul>

    <div class="tab-content" style="margin-top: 15px;">
        <div role="tabpanel" class="tab-pane active" id="tab-xml">
            <div class="card">
                <div class="body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="file" id="inputXml" accept=".xml" multiple>
                        </div>
                        <div class="col-md-4 text-right" style="padding-top: 10px;">
                            <button class="btn btn-primary btn-block" id="btnImportarXml" disabled>
                                <iconify-icon icon="icon-park-outline:download-one" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                                IMPORTAR ARQUIVOS
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive" style="margin-top: 20px;">
                        <table class="table table-hover" id="tabelaArquivos">
                            <thead>
                            <tr>
                                <th>Nome do Arquivo</th>
                                <th style="width: 200px;">Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td colspan="2" class="text-center text-muted" style="padding: 20px;">Nenhum arquivo selecionado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="tab-sefaz">
            <div class="card">
                <div class="body">
                    <div class="row clearfix">
                        <div class="col-sm-3">
                            <label class="muted">Data Inicial</label>
                            <input type="date" class="form-control" id="dataIni">
                        </div>
                        <div class="col-sm-3">
                            <label class="muted">Data Final</label>
                            <input type="date" class="form-control" id="dataFim">
                        </div>
                        <div class="col-sm-3">
                            <label>&nbsp;</label>
                            <div class="checkbox" style="margin-top:8px;">
                                <input type="checkbox" id="ckMostrarImportadas" class="chk-col-blue">
                                <label for="ckMostrarImportadas">Mostrar Importadas</label>
                            </div>
                        </div>
                        <div class="col-sm-3 text-right">
                            <label>&nbsp;</label><br>
                            <button class="btn btn-info btn-block" id="btnBuscar" style="background-color: var(--mrk-blue) !important;">
                                <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> BUSCAR
                            </button>
                        </div>
                    </div>

                    <div class="row clearfix" style="margin-top:10px;">
                        <div class="col-sm-4">
                            <label class="muted">Filtrar Número da Nota</label>
                            <input type="text" class="form-control" id="filtroNumeroNf" placeholder="Digite para filtrar...">
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-sm-6">
                            <button class="btn btn-success" id="btnImportarSelecionadas" disabled style="background-color: var(--mrk-green) !important;">
                                <iconify-icon icon="icon-park-outline:download" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                                IMPORTAR SELECIONADAS
                            </button>
                        </div>
                        <div class="col-sm-6 text-right" style="padding-top: 10px;">
                            <span id="resumoNotas" class="small-text badge bg-orange"></span>
                        </div>
                    </div>

                    <div class="table-responsive" style="margin-top:15px;">
                        <table class="table table-striped table-hover" id="tabelaSefaz">
                            <thead>
                            <tr>
                                <th style="width:40px;">
                                    <input class="chk-col-blue" type="checkbox" id="selectAll" title="Todos">
                                    <label for="selectAll" style="margin-bottom: 0;"></label>
                                </th>
                                <th style="width: 40px;"></th> <th>Chave de Acesso</th>
                                <th>Nº Nota</th>
                                <th>Emitente</th>
                                <th>Valor</th>
                                <th>Emissão</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div role="tabpanel" class="tab-pane" id="tab-chave">
            <div class="card">
                <div class="body">
                    <div class="row">
                        <div class="col-sm-9">
                            <label class="muted">Chave de Acesso</label>
                            <input type="text" id="chaveAcessoInput" class="form-control" maxlength="44" placeholder="Digite os 44 números da chave">
                            <span class="small-text"><iconify-icon icon="icon-park-outline:info"></iconify-icon> Informe apenas números.</span>
                        </div>
                        <div class="col-sm-3 text-right">
                            <label>&nbsp;</label><br>
                            <button class="btn btn-success btn-block" id="btnImportarChave" style="background-color: var(--mrk-green) !important;">
                                <iconify-icon icon="icon-park-outline:download" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                                IMPORTAR
                            </button>
                        </div>
                    </div>
                    <hr>
                    <div id="resultadoChave" class="small-text text-center" style="font-size: 14px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/filepond@^4/dist/filepond.js"></script>

<script>
    // ==============================
    // CONFIGURAÇÃO
    // ==============================
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const user_id = urlParams.get('user_id');

    // ==============================
    // XML MANUAL (FILEPOND)
    // ==============================
    let arquivosSelecionados = [];

    const pond = FilePond.create(document.querySelector('#inputXml'), {
        allowMultiple: true,
        credits: false,
        labelIdle: 'Arraste arquivos XML aqui ou <span class="filepond--label-action">Procure</span>',
        acceptedFileTypes: ['application/xml', 'text/xml'],
        maxFiles: 50,
    });

    pond.on('updatefiles', (fileItems) => {
        arquivosSelecionados = fileItems.map(f => f.file);
        renderTabelaArquivos();
        $("#btnImportarXml").prop("disabled", arquivosSelecionados.length === 0);
    });

    function renderTabelaArquivos() {
        const tbody = $("#tabelaArquivos tbody");
        tbody.empty();
        if (arquivosSelecionados.length === 0) {
            tbody.append('<tr><td colspan="2" class="text-center text-muted" style="padding: 20px;">Nenhum arquivo selecionado.</td></tr>');
            return;
        }
        arquivosSelecionados.forEach((file, idx) => {
            tbody.append(`
                <tr data-idx="${idx}">
                  <td><iconify-icon icon="icon-park-outline:file-code" style="color:#0B46AC; margin-right:5px;"></iconify-icon> ${file.name}</td>
                  <td class="status"><span class="badge bg-grey">Aguardando</span></td>
                </tr>
            `);
        });
    }

    $("#btnImportarXml").on('click', async function() {
        if (arquivosSelecionados.length === 0) return;

        const confirm = await Swal.fire({
            title: "Confirmar Importação",
            text: `Importar ${arquivosSelecionados.length} arquivos XML?`,
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Sim, importar",
            confirmButtonColor: '#0B46AC',
            cancelButtonColor: '#d33'
        });
        if (!confirm.isConfirmed) return;

        $("#btnImportarXml").prop("disabled", true);
        let ok = 0, fail = 0, detalhes = [];

        for (let i = 0; i < arquivosSelecionados.length; i++) {
            const file = arquivosSelecionados[i];
            const row = $(`#tabelaArquivos tbody tr[data-idx="${i}"] .status`);
            row.html('<span class="text-info"><i class="fas fa-spinner fa-spin"></i> Processando...</span>');

            try {
                const xmlText = await file.text();
                const { data: resp } = await axios.post(baseUrl, {
                    method: "importNotaFiscal",
                    token,
                    data: { system_unit_id: unit_id, xml: xmlText }
                });

                if (resp && resp.success) {
                    ok++;
                    row.html('<span class="status-ok"><iconify-icon icon="icon-park-outline:check-one"></iconify-icon> Sucesso</span>');
                } else {
                    fail++;
                    const msg = resp.message || "Erro desconhecido";
                    row.html('<span class="status-erro"><iconify-icon icon="icon-park-outline:close-one"></iconify-icon> Falha</span>');
                    detalhes.push(`<li><b>${file.name}</b>: ${msg}</li>`);
                }
            } catch (e) {
                fail++;
                row.html('<span class="status-erro">Erro Req.</span>');
                detalhes.push(`<li><b>${file.name}</b>: ${e.message}</li>`);
            }
        }

        $("#btnImportarXml").prop("disabled", false);

        const htmlResumo = detalhes.length ? `<hr><ul style="text-align:left; font-size:12px; max-height:150px; overflow:auto;">${detalhes.join('')}</ul>` : '';
        Swal.fire({
            title: fail === 0 ? "Sucesso!" : "Importação Finalizada",
            html: `<p>Importados: <b>${ok}</b> | Falhas: <b>${fail}</b></p>${htmlResumo}`,
            icon: fail === 0 ? "success" : "warning",
            confirmButtonColor: '#0B46AC'
        });
    });

    // ==============================
    // VIA SEFAZ
    // ==============================
    let notasSefaz = [];

    $("#btnBuscar").click(buscarSefaz);
    $("#ckMostrarImportadas").change(renderTabelaSefaz);
    $("#filtroNumeroNf").on('input', renderTabelaSefaz);

    // Select All
    $("#selectAll").change(function() {
        $(".row-selector:enabled").prop('checked', $(this).is(':checked')).trigger('change');
    });

    $(document).on('change', '.row-selector', function() {
        const tr = $(this).closest('tr');
        if($(this).is(':checked')) tr.addClass('selected-row');
        else tr.removeClass('selected-row');

        const total = $(".row-selector:enabled").length;
        const checked = $(".row-selector:checked").length;
        $("#selectAll").prop('checked', total > 0 && total === checked);
        $("#btnImportarSelecionadas").prop('disabled', checked === 0);
    });

    async function buscarSefaz() {
        const di = $("#dataIni").val();
        const df = $("#dataFim").val();
        if(!di || !df) return Swal.fire("Atenção", "Informe o período.", "warning");

        $("#btnBuscar").prop("disabled", true).html('<i class="fas fa-spinner fa-spin"></i> Buscando...');

        try {
            const { data: resp } = await axios.post(baseUrl, {
                method: "listarChavesNfeComStatusImportacao",
                token,
                data: { system_unit_id: unit_id, data_inicial: di, data_final: df }
            });

            if (!resp.success) throw new Error(resp.message);

            notasSefaz = (resp.data?.notas || []).map(n => ({
                chave: n.chave_acesso,
                numero: n.numero_nf || '',
                razao: n.emitente_razao || n.emitente_fantasia || '',
                valor: Number(n.valor_total || 0),
                emissao: n.data_emissao,
                status: n.status || 'nao_importada'
            }));

            renderTabelaSefaz();

        } catch (e) {
            Swal.fire("Erro", e.message || "Falha na busca.", "error");
        } finally {
            $("#btnBuscar").prop("disabled", false).html('<iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> BUSCAR');
        }
    }

    function renderTabelaSefaz() {
        const tbody = $("#tabelaSefaz tbody");
        tbody.empty();

        let lista = notasSefaz;
        if (!$("#ckMostrarImportadas").is(":checked")) {
            lista = lista.filter(n => n.status !== 'importada');
        }

        const filtroNum = $("#filtroNumeroNf").val().trim();
        if (filtroNum) lista = lista.filter(n => n.numero.includes(filtroNum));

        $("#resumoNotas").text(`Total: ${notasSefaz.length} | Visíveis: ${lista.length}`);

        if (lista.length === 0) {
            tbody.append('<tr><td colspan="9" class="text-center text-muted" style="padding:20px;">Nenhuma nota encontrada.</td></tr>');
            $("#btnImportarSelecionadas").prop("disabled", true);
            return;
        }

        lista.forEach((n, idx) => {
            const jaImportada = n.status === 'importada';
            const checkbox = jaImportada ?
                '<input type="checkbox" disabled>' :
                `<input type="checkbox" class="chk-col-blue row-selector" id="chk-${idx}" data-chave="${n.chave}"> <label for="chk-${idx}"></label>`;

            const badge = jaImportada ?
                '<span class="label bg-green">IMPORTADA</span>' :
                '<span class="label bg-orange">PENDENTE</span>';

            tbody.append(`
                <tr>
                    <td>${checkbox}</td>
                    <td class="text-center"><a href="#" class="btnViewPdf" data-chave="${n.chave}"><i class="fas fa-file-pdf" style="color:#d32f2f;"></i></a></td>
                    <td><small style="font-family:monospace; color:#555;">${n.chave}</small></td>
                    <td><b>${n.numero}</b></td>
                    <td>${truncate(n.razao, 25)}</td>
                    <td>R$ ${n.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td>${formatDateBr(n.emissao)}</td>
                    <td>${badge}</td>
                    <td><button class="btn btn-danger btn-xs btnDevolverNota" data-chave="${n.chave}" title="Marcar Indevida"><i class="fas fa-ban"></i></button></td>
                </tr>
            `);
        });
    }

    $("#btnImportarSelecionadas").click(async function() {
        const chaves = $(".row-selector:checked").map((_, el) => $(el).data('chave')).get();
        if(!chaves.length) return;

        Swal.fire({
            title: 'Importando...',
            html: '<div id="progressoImport">Iniciando...</div>',
            allowOutsideClick: false,
            didOpen: async () => {
                Swal.showLoading();
                let ok=0, fail=0;

                for(let i=0; i<chaves.length; i++) {
                    $("#progressoImport").text(`Processando ${i+1} de ${chaves.length}`);
                    try {
                        const {data} = await axios.post(baseUrl, {
                            method: "importNotasPorChaves",
                            token,
                            data: { system_unit_id: unit_id, chaves: [chaves[i]] }
                        });
                        if(data?.data?.itens?.[0]?.success) ok++; else fail++;
                    } catch(e) { fail++; }
                }

                Swal.close();
                Swal.fire("Concluído", `Sucesso: ${ok} | Falhas: ${fail}`, "success");
                buscarSefaz(); // Refresh
            }
        });
    });

    // ==============================
    // VIA CHAVE
    // ==============================
    $("#btnImportarChave").click(async function() {
        const chave = $("#chaveAcessoInput").val().replace(/\D/g, '');
        if(chave.length !== 44) return Swal.fire("Erro", "Chave inválida (deve ter 44 dígitos).", "error");

        $("#btnImportarChave").prop("disabled", true).html("Importando...");
        $("#resultadoChave").html("");

        try {
            const {data} = await axios.post(baseUrl, {
                method: "importNotasPorChaves",
                token,
                data: { system_unit_id: unit_id, chaves: [chave] }
            });

            const item = data?.data?.itens?.[0];
            if(item?.success) {
                $("#resultadoChave").html('<span class="status-ok"><i class="fas fa-check"></i> Importada com sucesso!</span>');
                Swal.fire("Sucesso", "Nota importada.", "success");
            } else {
                $("#resultadoChave").html(`<span class="status-erro"><i class="fas fa-times"></i> ${item?.message || 'Erro'}</span>`);
            }
        } catch(e) {
            $("#resultadoChave").html('<span class="status-erro">Erro de conexão</span>');
        } finally {
            $("#btnImportarChave").prop("disabled", false).html('<iconify-icon icon="icon-park-outline:download" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> IMPORTAR');
        }
    });

    // ==============================
    // UTILS
    // ==============================
    function truncate(str, n){ return (str.length > n) ? str.substr(0, n-1) + '…' : str; }
    function formatDateBr(s) { if(!s) return ''; const d = new Date(s); return isNaN(d) ? s : d.toLocaleDateString('pt-BR'); }

    // Visualizar PDF
    $(document).on('click', '.btnViewPdf', async function(e) {
        e.preventDefault();
        const chave = $(this).data('chave');
        Swal.showLoading();
        try {
            const {data} = await axios.post(baseUrl, { method: "baixarArquivo", token, data: { system_unit_id: Number(unit_id), chave, tipo: "pdf" } });
            if(data.success) {
                const blob = b64toBlob(data.content, 'application/pdf');
                window.open(URL.createObjectURL(blob), '_blank');
                Swal.close();
            } else throw new Error(data.message);
        } catch(e) { Swal.fire("Erro", "PDF indisponível", "error"); }
    });

    function b64toBlob(b64Data, contentType) {
        const byteCharacters = atob(b64Data.replace(/\s/g, ''));
        const byteArrays = [];
        for (let offset = 0; offset < byteCharacters.length; offset += 512) {
            const slice = byteCharacters.slice(offset, offset + 512);
            const byteNumbers = new Array(slice.length);
            for (let i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
            byteArrays.push(new Uint8Array(byteNumbers));
        }
        return new Blob(byteArrays, {type: contentType});
    }

    // Devolver Nota
    $(document).on('click', '.btnDevolverNota', async function() {
        const chave = $(this).data('chave');
        const {value: motivo} = await Swal.fire({
            title: "Marcar Indevida",
            input: 'text',
            inputPlaceholder: 'Motivo da devolução (Controle Interno)',
            showCancelButton: true,
            confirmButtonColor: '#d33'
        });

        if(motivo) {
            try {
                await axios.post(baseUrl, { method: "marcarNotaComoDevolvida", token, data: { system_unit_id: Number(unit_id), chave, motivo, usuario_id: user_id } });
                notasSefaz = notasSefaz.filter(n => n.chave !== chave);
                renderTabelaSefaz();
                Swal.fire("OK", "Nota marcada como devolvida.", "success");
            } catch(e) { Swal.fire("Erro", "Falha ao marcar nota.", "error"); }
        }
    });

</script>
</body>
</html>