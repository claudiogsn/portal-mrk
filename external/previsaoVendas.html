<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Projeção de Vendas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <style>
        /* Tabela Limpa */
        .table-clean > thead > tr > th,
        .table-clean > tbody > tr > td {
            border-right: none !important;
            border-left: none !important;
            vertical-align: middle;
        }
        .table-clean > tbody > tr > td { padding: 8px 5px; }

        /* Input de Quantidade */
        .input-qty {
            width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 6px;
            text-align: center; font-weight: bold; color: #555; transition: all 0.3s;
        }
        .input-qty:focus { border-color: #2196F3; background-color: #e3f2fd; outline: none; }

        /* Animação de Linha Nova */
        .highlight-row { animation: highlightFade 2s forwards; }
        @keyframes highlightFade { 0% { background-color: #fff3e0; } 100% { background-color: transparent; } }

        /* Select2 */
        .select2-container .select2-selection--single { height: 40px !important; padding: 5px; border: 1px solid #ddd; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 40px !important; }

        /* Cabeçalhos */
        .th-day { text-align: center; color: #777; font-size: 12px; text-transform: uppercase; }
        .td-prod { font-weight: bold; color: #333; font-size: 13px; }
        .td-code { color: #999; font-size: 11px; }

        /* --- NOVO: Botão Pendente (Pulsando) --- */
        .btn-pending {
            background-color: #FF9800 !important; /* Laranja */
            color: #fff !important;
            animation: pulse-orange 2s infinite;
        }
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header" style="display:flex; justify-content:space-between; align-items:center;">
            <h2>
                Projeção de Vendas
                <small>Defina a estimativa de vendas, para que a projecao seja realizada</small>
            </h2>
            <button class="btn btn-success waves-effect" id="btnSalvarTudo">
                <i class="fa fa-save"></i> SALVAR
            </button>
        </div>

        <div class="body">

            <div class="row clearfix" style="margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 5px;">
                <div class="col-md-12">
                    <label>Pesquisar Produto (Adicionar à lista)</label>
                    <select id="produto_select" class="form-control" style="width: 100%;">
                        <option value="">Carregando lista de produtos...</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover table-clean" id="tabelaProjecao">
                    <thead>
                    <tr>
                        <th width="5%">Cód.</th>
                        <th width="25%">Produto</th>
                        <th class="th-day">Segunda</th>
                        <th class="th-day">Terça</th>
                        <th class="th-day">Quarta</th>
                        <th class="th-day">Quinta</th>
                        <th class="th-day">Sexta</th>
                        <th class="th-day">Sábado</th>
                        <th class="th-day">Domingo</th>
                        <th width="5%" class="text-center"><i class="fa fa-trash"></i></th>
                    </tr>
                    </thead>
                    <tbody id="tbodyProjecao">
                    </tbody>
                </table>
            </div>

            <div id="loading" class="text-center" style="display:none; padding: 20px;">
                <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                <p>Carregando dados...</p>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- Configuração ---
    const urlParams = new URLSearchParams(window.location.search);
    const token     = urlParams.get('token');
    const unit_id   = urlParams.get('system_unit_id') || urlParams.get('unit_id');

    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    // --- ESTADO DA PÁGINA ---
    let alteracoesPendentes = false; // Controla se o usuário mexeu em algo

    $(document).ready(function(){
        inicializarTela();

        $('#btnSalvarTudo').click(salvarTudo);

        // EVENTO 1: Detectar digitação em qualquer input da tabela
        $(document).on('input', '.input-qty', function() {
            marcarComoPendente();
        });

        // EVENTO 2: Detectar tecla ENTER nos inputs da tabela
        $(document).on('keypress', '.input-qty', function(e) {
            if(e.which === 13) { // 13 = Enter
                e.preventDefault(); // Evita comportamento padrão se houver
                $('#btnSalvarTudo').click(); // Dispara o clique do botão salvar
                $(this).blur(); // Remove foco do input
            }
        });

        // EVENTO 3: Proteção ao sair da página
        window.onbeforeunload = function() {
            if (alteracoesPendentes) {
                return "Você tem alterações não salvas. Deseja realmente sair?";
            }
        };
    });

    // --- Funções Visuais de Estado ---

    function marcarComoPendente() {
        if (!alteracoesPendentes) {
            alteracoesPendentes = true;
            const btn = $('#btnSalvarTudo');
            btn.removeClass('btn-success').addClass('btn-pending');
            btn.html('<i class="fa fa-exclamation-circle"></i> SALVAR (PENDENTE)');
        }
    }

    function marcarComoSalvo() {
        alteracoesPendentes = false;
        const btn = $('#btnSalvarTudo');
        btn.removeClass('btn-pending').addClass('btn-success');
        btn.html('<i class="fa fa-save"></i> SALVAR');
    }

    // --- Inicialização ---

    async function inicializarTela() {
        $('#loading').show();
        try {
            await Promise.all([
                carregarProdutosParaSelect(),
                carregarGridProjeccoes()
            ]);
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha ao carregar dados iniciais.', 'error');
        } finally {
            $('#loading').hide();
        }
    }

    async function carregarProdutosParaSelect() {
        try {
            const res = await axios.post(baseUrl, {
                method: 'listItemVenda',
                token: token,
                data: { unit_id: unit_id, search: '' }
            });

            let listaProdutos = [];
            if (res.data.success && Array.isArray(res.data.produtos)) {
                listaProdutos = res.data.produtos;
            } else if (Array.isArray(res.data)) {
                listaProdutos = res.data;
            }

            if (listaProdutos.length > 0) {
                const dadosFormatados = listaProdutos.map(p => ({
                    id: p.codigo,
                    text: `${p.codigo} - ${p.nome}`,
                    nome_produto: p.nome
                }));

                $('#produto_select').empty().select2({
                    data: dadosFormatados,
                    placeholder: 'Digite código ou nome para filtrar...',
                    allowClear: true,
                    language: { noResults: () => "Produto não encontrado na lista" }
                });

                $('#produto_select').val(null).trigger('change');

                $('#produto_select').on('select2:select', function(e){
                    const data = e.params.data;
                    adicionarOuMoverProduto(data.id, data.nome_produto);
                    $(this).val(null).trigger('change');
                });
            }
        } catch (e) {
            console.error("Erro select", e);
        }
    }

    async function carregarGridProjeccoes() {
        try {
            const res = await axios.post(baseUrl, {
                method: 'getProjeccoes',
                token: token,
                data: { unit_id: unit_id }
            });

            let lista = [];
            if (Array.isArray(res.data)) {
                lista = res.data;
            } else if (res.data.success && Array.isArray(res.data.data)) {
                lista = res.data.data;
            }

            $('#tbodyProjecao').empty();

            if (lista.length > 0) {
                lista.forEach(item => renderizarLinha(item, false));
            } else {
                $('#tbodyProjecao').html('<tr><td colspan="10" class="text-center text-muted">Nenhuma projeção cadastrada.</td></tr>');
            }
        } catch (error) {
            console.error(error);
        }
    }

    // --- Manipulação da Tabela ---

    function adicionarOuMoverProduto(codigo, nome) {
        const linha = $(`tr[data-codigo="${codigo}"]`);

        if (linha.length > 0) {
            linha.prependTo('#tbodyProjecao');
            linha.removeClass('highlight-row');
            void linha[0].offsetWidth;
            linha.addClass('highlight-row');
            linha.find('input').first().focus();
        } else {
            const novoItem = {
                codigo: codigo,
                nome: nome,
                segunda: 0, terca: 0, quarta: 0, quinta: 0, sexta: 0, sabado: 0, domingo: 0
            };
            renderizarLinha(novoItem, true);
            marcarComoPendente(); // Adicionar produto novo é uma alteração pendente
        }
    }

    function renderizarLinha(item, isPrepend) {
        const seg = item.segunda || 0;
        const ter = item.terca || 0;
        const qua = item.quarta || 0;
        const qui = item.quinta || 0;
        const sex = item.sexta || 0;
        const sab = item.sabado || 0;
        const dom = item.domingo || 0;

        const tr = `
            <tr data-codigo="${item.codigo}" class="${isPrepend ? 'highlight-row' : ''}">
                <td class="td-code">${item.codigo}</td>
                <td class="td-prod">${item.nome}</td>
                ${gerarInput(seg, 'segunda')}
                ${gerarInput(ter, 'terca')}
                ${gerarInput(qua, 'quarta')}
                ${gerarInput(qui, 'quinta')}
                ${gerarInput(sex, 'sexta')}
                ${gerarInput(sab, 'sabado')}
                ${gerarInput(dom, 'domingo')}
                <td class="text-center">
                    <button class="btn btn-xs btn-danger" onclick="removerLinha(this, '${item.codigo}')" title="Remover">
                        <i class="fa fa-times"></i>
                    </button>
                </td>
            </tr>
        `;

        if (isPrepend) {
            $('#tbodyProjecao').prepend(tr);
            $(`tr[data-codigo="${item.codigo}"]`).find('input').first().focus();
        } else {
            $('#tbodyProjecao').append(tr);
        }
    }

    function gerarInput(valor, dia) {
        return `<td>
            <input inputmode="numeric" type="number" step="0.01" class="input-qty"
                   data-dia="${dia}" value="${valor}"
                   onfocus="this.select()">
        </td>`;
    }

    // --- Salvar e Remover ---

    async function salvarTudo() {
        const itens = [];
        const linhas = $('#tbodyProjecao tr');

        if (linhas.length === 0) return Swal.fire('Aviso', 'Nada para salvar.', 'info');

        // Feedback visual
        Swal.fire({
            title: 'Salvando...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        linhas.each(function(){
            const tr = $(this);
            const codigo = tr.data('codigo');

            tr.find('.input-qty').each(function(){
                const input = $(this);
                itens.push({
                    product_codigo: codigo,
                    day: input.data('dia'),
                    qty: parseFloat(input.val()) || 0
                });
            });
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'saveProjecaoBatch',
                token: token,
                data: { unit_id: unit_id, itens: itens }
            });

            const success = res.data.success || (res.data.message && res.data.message.includes('sucesso'));

            if (success) {
                marcarComoSalvo(); // Reseta o estado "Sujo"

                Swal.fire({
                    icon: 'success',
                    title: 'Salvo!',
                    text: 'Projeções atualizadas.',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire('Erro', res.data.message || 'Erro desconhecido', 'error');
            }
        } catch (e) {
            Swal.fire('Erro', 'Falha na conexão.', 'error');
        }
    }

    function removerLinha(btn, codigo) {
        Swal.fire({
            title: 'Remover produto?',
            text: 'As metas deste produto serão zeradas.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Sim, remover'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await axios.post(baseUrl, {
                        method: 'clearProjecaoProduto',
                        token: token,
                        data: { unit_id: unit_id, product_codigo: codigo }
                    });

                    const success = res.data.success || (res.data.message && res.data.message.includes('limpas'));

                    if (success) {
                        $(btn).closest('tr').fadeOut(300, function(){ $(this).remove(); });
                        // Remover linha não marca como pendente pois já foi salvo no banco direto via API de clear
                        marcarComoSalvo(); // Opcional, depende da sua lógica, mas garante consistência
                        Swal.fire({
                            icon: 'success',
                            title: 'Removido',
                            text: 'Produto removido da projeção.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire('Erro', res.data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Erro', 'Falha na conexão.', 'error');
                }
            }
        });
    }
</script>
</body>
</html>