<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório - Transferências</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="block-header">
        <h2> </h2>
        <br>
    </div>

    <div class="card">
        <div class="header">
            <h2>
                <iconify-icon icon="icon-park-solid:transfer-data" width="24" style="color: #0B46AC; vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                RELATÓRIO - TRANSFERÊNCIAS
            </h2>
        </div>

        <div class="body">
            <div class="row clearfix">
                <div class="col-md-3">
                    <label class="muted">Data inicial</label>
                    <input type="date" id="dtInicio" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="muted">Data final</label>
                    <input type="date" id="dtFim" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="muted">Tipo</label>
                    <select id="filtroTipo" class="form-control">
                        <option value="">Todos</option>
                        <option value="ts">Saída (TS)</option>
                        <option value="te">Entrada (TE)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="muted">Documento</label>
                    <input type="text" id="filtroDoc" class="form-control" placeholder="ex: te-0003">
                </div>
                <div class="col-md-2">
                    <label class="muted">Ações</label><br>
                    <button id="btnConsultar" class="btn btn-primary waves-effect" style="margin-right: 5px;">
                        <iconify-icon icon="icon-park-outline:search" width="16" style="vertical-align: middle; margin-right: 4px;"></iconify-icon>
                        Consultar
                    </button>
                    <button id="btnLimpar" class="btn btn-default waves-effect">
                        <iconify-icon icon="icon-park-outline:clear" width="16" style="vertical-align: middle;"></iconify-icon>
                    </button>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 15px;">
                <div class="col-md-3">
                    <div class="kpi blue">
                        <small>Transferências</small>
                        <h4 id="kpiDocs">0</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi green">
                        <small>Total Custo</small>
                        <h4 id="kpiTotalCusto">R$ 0,00</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi gray">
                        <small>Total Itens</small>
                        <h4 id="kpiItens">0</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi orange">
                        <small>Custo Médio</small>
                        <h4 id="kpiMedio">R$ 0,00</h4>
                    </div>
                </div>
            </div>

            <div class="table-responsive" style="margin-top: 10px;">
                <table class="table table-hover" id="tabela-resultado">
                    <thead>
                    <tr>
                        <th class="nowrap text-center" style="width:34px;"></th>
                        <th class="nowrap" style="width:50px;">#</th>
                        <th class="nowrap" style="width:130px;">Doc</th>
                        <th class="nowrap" style="width:110px;">Data</th>
                        <th class="nowrap" style="width:90px;">Status</th>
                        <th class="nowrap" style="width:110px;">Tipo Mov</th>
                        <th>Remetente</th>
                        <th>Destino</th>
                        <th class="nowrap text-right" style="width:150px;">Total Custo</th>
                        <th class="nowrap text-right" style="width:70px;">Itens</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td colspan="10" class="text-center muted text-small" style="padding: 20px;">
                            Informe o período e clique em Consultar.
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-small muted" style="margin-top:8px;">
                <iconify-icon icon="icon-park-outline:info" width="14" style="vertical-align: text-bottom;"></iconify-icon>
                Clique na seta ou na linha para expandir e ver os itens.
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // ====== CONFIG ======
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = Number(urlParams.get('system_unit_id') || urlParams.get('unit_id') || urlParams.get('unit') || 0);

    // ====== STATE ======
    let docs = [];
    const openDocs = {};

    // ====== UTILS ======
    function brMoney(v) {
        const n = Number(v || 0);
        return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    function brNumber(v, casas = 4) {
        const n = Number(v || 0);
        return n.toLocaleString('pt-BR', { minimumFractionDigits: casas, maximumFractionDigits: casas });
    }
    function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    function swalLoading(title) {
        Swal.fire({ title: title || 'Carregando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    }
    function fmtDateBR(iso) {
        if (!iso) return '';
        const m = /^(\d{4})-(\d{2})-(\d{2})/.exec(String(iso));
        if (!m) return String(iso);
        return `${m[3]}/${m[2]}/${m[1]}`;
    }
    function badgeStatus(st) {
        const s = Number(st || 0);
        const txt = (s === 1) ? 'Concluído' : 'Pendente';
        return `<span class="badge-status ${s===1?'st-1':'st-0'}">${txt}</span>`;
    }

    // Gera ícone de entrada/saída usando Iconify
    function tipoMovLabel(tm) {
        const t = String(tm || '').toLowerCase();
        if (t === 'entrada') {
            return `<span class="mov-entrada"><iconify-icon icon="icon-park-solid:arrow-down" width="12" style="margin-right:2px;"></iconify-icon> Entrada</span>`;
        }
        if (t === 'saida') {
            return `<span class="mov-saida"><iconify-icon icon="icon-park-solid:arrow-up" width="12" style="margin-right:2px;"></iconify-icon> Saída</span>`;
        }
        return escapeHtml(tm || '');
    }

    function getTipoMovDoc(docObj) {
        if (docObj && docObj.tipo_mov) return docObj.tipo_mov;
        const it = (docObj && Array.isArray(docObj.itens) && docObj.itens.length) ? docObj.itens[0] : null;
        return it ? (it.tipo_mov || '') : '';
    }

    // ====== RENDER ======
    function renderKPIs() {
        const totalDocs = docs.length;
        const totalCusto = docs.reduce((s, d) => s + Number(d.total_custo || 0), 0);
        const totalItens = docs.reduce((s, d) => s + ((d.itens || []).length), 0);
        const medio = totalDocs > 0 ? (totalCusto / totalDocs) : 0;

        $('#kpiDocs').text(String(totalDocs));
        $('#kpiTotalCusto').text(brMoney(totalCusto));
        $('#kpiItens').text(String(totalItens));
        $('#kpiMedio').text(brMoney(medio));
    }

    function renderTabela() {
        const $tbody = $('#tabela-resultado tbody');
        $tbody.empty();

        if (!docs || docs.length === 0) {
            $tbody.append(`<tr><td colspan="10" class="text-center muted text-small" style="padding:20px;">Nenhum registro encontrado.</td></tr>`);
            renderKPIs();
            return;
        }

        docs.forEach((d, idx) => {
            const doc = d.doc || '';
            const isOpen = !!openDocs[doc];
            const itensCount = (d.itens || []).length;
            const remetenteNome = d.system_unit_remetente_name || d.system_unit_id_remetente || (d.system_unit_name || d.system_unit_id || '');
            const destinoNome   = d.system_unit_destino_name || d.system_unit_id_destino || '';
            const tipoMov = getTipoMovDoc(d);

            // Ícone da seta (Iconify)
            const iconArrow = isOpen
                ? '<iconify-icon icon="icon-park-outline:down" width="16"></iconify-icon>'
                : '<iconify-icon icon="icon-park-outline:right" width="16"></iconify-icon>';

            $tbody.append(`
                <tr class="row-head clickable ${isOpen ? 'open' : ''}" data-doc="${escapeHtml(doc)}">
                    <td class="text-center nowrap">
                        <a href="#" class="btnToggle" data-doc="${escapeHtml(doc)}" title="Detalhes">
                            ${iconArrow}
                        </a>
                    </td>
                    <td class="nowrap">${idx + 1}</td>
                    <td class="nowrap"><b>${escapeHtml(doc)}</b></td>
                    <td class="nowrap">${fmtDateBR(d.data)}</td>
                    <td class="nowrap">${badgeStatus(d.status)}</td>
                    <td class="nowrap">${tipoMovLabel(tipoMov)}</td>
                    <td>${escapeHtml(remetenteNome || '')}</td>
                    <td>${escapeHtml(destinoNome || '')}</td>
                    <td class="text-right nowrap"><b>${brMoney(d.total_custo)}</b></td>
                    <td class="text-right nowrap">${itensCount}</td>
                </tr>
            `);

            if (isOpen) {
                $tbody.append(`
                    <tr class="row-items" data-doc="${escapeHtml(doc)}">
                        <td colspan="10">
                            <div class="table-responsive">
                                <table class="table table-striped table-condensed subtable">
                                    <thead>
                                        <tr>
                                            <th class="nowrap" style="width:60px;">Seq</th>
                                            <th class="nowrap" style="width:110px;">Produto</th>
                                            <th>Descrição</th>
                                            <th class="nowrap" style="width:80px;">Und</th>
                                            <th class="nowrap text-right" style="width:140px;">Qtd</th>
                                            <th class="nowrap text-right" style="width:140px;">Custo Unit.</th>
                                            <th class="nowrap text-right" style="width:160px;">Subtotal</th>
                                            <th class="nowrap" style="width:90px;">Mov</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${renderItensRows(d.itens || [])}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                `);
            }
        });

        renderKPIs();
        bindRowEvents();
    }

    function renderItensRows(itens) {
        if (!itens || itens.length === 0) {
            return `<tr><td colspan="8" class="text-center muted text-small">Sem itens.</td></tr>`;
        }
        let html = '';
        itens.forEach(it => {
            html += `
                <tr>
                    <td class="nowrap">${Number(it.seq || 0)}</td>
                    <td class="nowrap"><b>${escapeHtml(it.produto)}</b></td>
                    <td>${escapeHtml(it.product_nome || '')}</td>
                    <td class="nowrap">${escapeHtml(it.product_und || '')}</td>
                    <td class="text-right nowrap">${brNumber(it.quantidade, 4)}</td>
                    <td class="text-right nowrap">${brMoney(it.preco_custo)}</td>
                    <td class="text-right nowrap"><b>${brMoney(it.subtotal_custo)}</b></td>
                    <td class="nowrap">${tipoMovLabel(it.tipo_mov)}</td>
                </tr>
            `;
        });
        const total = itens.reduce((s, it) => s + Number(it.subtotal_custo || 0), 0);
        html += `
            <tr>
                <td colspan="6" class="text-right"><b>Total do Documento</b></td>
                <td class="text-right nowrap" style="color:var(--mrk-blue);"><b>${brMoney(total)}</b></td>
                <td></td>
            </tr>
        `;
        return html;
    }

    function bindRowEvents() {
        $('#tabela-resultado tbody tr.row-head').off('click').on('click', function(e) {
            if ($(e.target).closest('.btnToggle').length) return;
            const doc = $(this).data('doc');
            toggleDoc(doc);
        });
        $('.btnToggle').off('click').on('click', function(e) {
            e.preventDefault(); e.stopPropagation();
            const doc = $(this).data('doc');
            toggleDoc(doc);
        });
    }

    function toggleDoc(doc) {
        if (!doc) return;
        openDocs[doc] = !openDocs[doc];
        renderTabela();
    }

    // ====== ACTIONS ======
    async function onConsultar() {
        const dt_inicio = $('#dtInicio').val();
        const dt_fim = $('#dtFim').val();
        const tipo = ($('#filtroTipo').val() || '').trim();
        const docLike = ($('#filtroDoc').val() || '').trim();

        if (!token || !system_unit_id) return Swal.fire('Atenção', 'URL inválida (token/unit).', 'warning');
        if (!dt_inicio || !dt_fim) return Swal.fire('Atenção', 'Informe o período.', 'warning');
        if (dt_inicio > dt_fim) return Swal.fire('Atenção', 'Data inicial maior que final.', 'warning');

        swalLoading('Consultando...');

        try {
            const res = await axios.post(baseUrl, {
                method: "getTransferenciasComCustos",
                token,
                data: { system_unit_id: Number(system_unit_id), dt_inicio, dt_fim, ...(tipo ? { tipo } : {}), ...(docLike ? { doc: docLike } : {}) }
            });
            Swal.close();
            const api = res.data;
            if (!api || api.success === false) {
                docs = [];
                for (const k in openDocs) delete openDocs[k];
                renderTabela();
                return Swal.fire('Atenção', api?.message || 'Nada encontrado.', 'warning');
            }
            docs = Array.isArray(api.data) ? api.data : [];
            for (const k in openDocs) delete openDocs[k];
            renderTabela();
        } catch (e) {
            Swal.close();
            Swal.fire('Erro', 'Falha na comunicação.', 'error');
        }
    }

    function onLimpar() {
        $('#filtroTipo').val('');
        $('#filtroDoc').val('');
        docs = [];
        for (const k in openDocs) delete openDocs[k];
        renderTabela();
    }

    // ====== INIT ======
    $(document).ready(() => {
        const hoje = new Date();
        const y = hoje.getFullYear();
        const m = String(hoje.getMonth() + 1).padStart(2, '0');
        const d = String(hoje.getDate()).padStart(2, '0');
        $('#dtFim').val(`${y}-${m}-${d}`);

        const semana = new Date(hoje.getTime() - 7*24*60*60*1000);
        const y2 = semana.getFullYear();
        const m2 = String(semana.getMonth() + 1).padStart(2, '0');
        const d2 = String(semana.getDate()).padStart(2, '0');
        $('#dtInicio').val(`${y2}-${m2}-${d2}`);

        $('#btnConsultar').on('click', onConsultar);
        $('#btnLimpar').on('click', onLimpar);
    });
</script>
</body>
</html>