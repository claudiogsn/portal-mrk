<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>DRE Gerencial | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== AJUSTES GERAIS MRK ====== */
        html, body { background: transparent !important; }
        body { font-family: 'Poppins', sans-serif; background-color: #F4F7F6; }
        .container-fluid { padding-top: 15px; }

        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            border-top: 2px solid var(--mrk-blue) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        .card .header h2 { font-family: 'Kanit', sans-serif; font-weight: 600; color: var(--mrk-blue); display: flex; align-items: center; gap: 10px; }

        /* Labels e Inputs */
        label { font-family: 'Kanit', sans-serif; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-control { height: 38px; border-radius: 6px; border: 1px solid #ddd; font-family: 'Poppins'; }

        /* ====== TABELA DRE PREMIUM ====== */
        .table-container {
            overflow: auto;
            max-height: 65vh;
            border-radius: 4px;
            border: 1px solid #eee;
            position: relative;
        }

        .table-dre { margin-bottom: 0; border-collapse: separate; border-spacing: 0; }
        .table-dre thead th {
            position: sticky; top: 0;
            background-color: #f8f9fa !important;
            color: var(--mrk-blue);
            font-family: 'Kanit'; font-size: 11px; text-transform: uppercase;
            z-index: 10; border-bottom: 2px solid #ddd !important; padding: 12px 8px;
        }

        .fixed-column {
            position: sticky; left: 0; z-index: 11; min-width: 220px;
            background-color: white !important; border-right: 2px solid #eee !important;
        }
        .total-column {
            position: sticky; right: 0; z-index: 9;
            background-color: #fcfcfc !important; border-left: 2px solid #eee !important;
            font-weight: 700; color: var(--mrk-blue);
        }

        .row-01 { background-color: #f1f8f1 !important; color: #2e7d32 !important; }
        .row-02 { background-color: #fff9f0 !important; color: #e67e22 !important; }
        .row-03 { background-color: #fff5f5 !important; color: #d32f2f !important; }
        .row-04 { background-color: #f0f4fa !important; color: var(--mrk-blue) !important; }

        .row-master { font-weight: 700 !important; font-size: 14px; }
        .table-dre tbody td { cursor: pointer; padding: 10px 15px; white-space: nowrap; font-size: 13px; }

        /* ====== MODAIS MRK ====== */
        .modal-content { border-radius: 12px; border: none; overflow: hidden; }
        .modal-header { position: relative; border-bottom: 2px solid var(--mrk-blue); padding: 18px 25px; background: #fff; }
        .modal-title { font-family: 'Kanit'; color: var(--mrk-blue); font-weight: 600; padding-right: 30px; }
        .btn-close-mrk { position: absolute; top: 15px; right: 15px; color: var(--mrk-red); font-size: 26px; background: none; border: none; outline: none !important; cursor: pointer; }

        #iframe_external {
            width: 100%;
            border: none;
            height: calc(100vh - 70px);
            display: block;
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%; animation: skeleton-loading 1.5s infinite;
            border-radius: 4px; height: 12px; width: 100%;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="card" style="margin-bottom: 20px;">
        <div class="body">
            <div class="row clearfix">
                <div class="col-md-3 mb-0">
                    <label>Exercício (Ano)</label>
                    <select id="ano" class="form-control">
                        <option value="2026" selected>2026</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="col-md-3 mb-0">
                    <label>&nbsp;</label>
                    <button id="btnGerarRelatorio" class="btn btn-success btn-block" style="height:38px; background-color: var(--mrk-green) !important;">
                        <iconify-icon icon="icon-park-outline:refresh" style="vertical-align:middle; margin-right:5px;"></iconify-icon> GERAR DRE
                    </button>
                </div>
                <div class="col-md-3 mb-0">
                    <label>&nbsp;</label>
                    <button id="btnExportarTabela" class="btn btn-primary btn-block" style="height:38px; background-color: var(--mrk-blue) !important;">
                        <iconify-icon icon="icon-park-outline:excel" style="vertical-align:middle; margin-right:5px;"></iconify-icon> EXPORTAR EXCEL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="header">
            <h2><iconify-icon icon="icon-park-outline:chart-line" width="24"></iconify-icon> DRE GERENCIAL</h2>
        </div>
        <div class="body p-0">
            <div class="table-container" id="dreScrollContainer">
                <table class="table table-dre" id="dreTable">
                    <thead>
                    <tr>
                        <th class="fixed-column">Categoria</th>
                        <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
                        <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
                        <th class="total-column text-center">Total</th>
                    </tr>
                    </thead>
                    <tbody id="dreTableBody">
                    <tr><td colspan="14" class="text-center p-5 text-muted">Selecione o ano e clique em "Gerar DRE".</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhesDRE" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="tituloModalDetalhes">Detalhamento de Lançamentos</h4>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="tabelaContasDRE">
                        <thead style="background: #f8f9fa;">
                        <tr>
                            <th style="padding-left: 20px;">Documento</th>
                            <th>Favorecido / Nome</th>
                            <th class="text-center">Vencimento</th>
                            <th class="text-right" style="padding-right: 20px;">Valor (R$)</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal" style="color:#666;">FECHAR</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    'use strict';

    $(document).ready(function () {
        const baseUrl = 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php';
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token'), unitId = params.get('unit_id');

        const toBRL = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        async function handleCellClick(code, month, year, name) {
            Swal.fire({ title: 'Buscando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

            try {
                const res = await axios.post(baseUrl, {
                    method: 'getContaByMonth', token,
                    data: { system_unit_id: unitId, plano_contas: code, month, year }
                });

                Swal.close();
                if (res.data.success) {
                    const contas = res.data.data;
                    $('#tituloModalDetalhes').html(`<small style="font-size:12px; color:#999; display:block;">DETALHAMENTO</small> ${code} - ${name} (${month}/${year})`);

                    const tbody = $('#tabelaContasDRE tbody').empty();
                    contas.forEach(c => {
                        tbody.append(`
                                <tr>
                                    <td style="padding-left: 20px;"><b>${c.doc}</b></td>
                                    <td>${c.nome}</td>
                                    <td class="text-center">${c.vencimento.split('-').reverse().join('/')}</td>
                                    <td class="text-right" style="padding-right: 20px;"><b>${toBRL(parseFloat(c.valor))}</b></td>
                                </tr>
                            `);
                    });
                    $('#modalDetalhesDRE').modal('show');
                }
            } catch (e) { Swal.fire('Erro', 'Falha ao carregar.', 'error'); }
        }

        function renderTable(categories) {
            const tbody = $('#dreTableBody').empty();
            categories.forEach(cat => {
                const row = $('<tr></tr>');
                if (cat.code === '01') row.addClass('row-01 row-master');
                else if (cat.code === '02') row.addClass('row-02 row-master');
                else if (cat.code === '03') row.addClass('row-03 row-master');
                else if (cat.code === '04') row.addClass('row-04 row-master');

                row.append(`<td class="fixed-column"><b>${cat.code}</b> - ${cat.name}</td>`);

                const vals = Array.isArray(cat.monthly_values) ? cat.monthly_values : Object.values(cat.monthly_values);
                vals.forEach((v, i) => {
                    const m = (i + 1).toString().padStart(2, '0');
                    const cell = $(`<td class="text-right">${toBRL(v)}</td>`);
                    cell.click(() => handleCellClick(cat.code, m, $('#ano').val(), cat.name));
                    row.append(cell);
                });

                const total = vals.reduce((a, b) => a + b, 0);
                row.append(`<td class="total-column text-right">${toBRL(total)}</td>`);
                tbody.append(row);
            });
        }

        $('#btnGerarRelatorio').click(async () => {
            const year = $('#ano').val();
            $('#dreTableBody').html('<tr><td colspan="14" class="text-center p-5"><div class="skeleton"></div></td></tr>');
            try {
                const res = await axios.post(baseUrl, {
                    method: 'getDreGerencial', token,
                    data: { system_unit_id: unitId, data_inicial: `${year}-01-01`, data_final: `${year}-12-31` }
                });
                if (res.data.success) renderTable(res.data.data.categories);
            } catch (e) { Swal.fire('Erro', 'Falha na comunicação.', 'error'); }
        });

        $('#btnExportarTabela').click(() => {
            // Verifica se a tabela já foi gerada (evita exportar a mensagem de "Selecione o ano")
            if ($('#dreTableBody td').length <= 1) {
                Swal.fire('Atenção', 'Gere o DRE antes de exportar.', 'warning');
                return;
            }

            // Pega o elemento da tabela direto do HTML
            const table = document.getElementById('dreTable');

            // Converte a tabela inteira (incluindo o cabeçalho) para uma planilha
            const wb = XLSX.utils.table_to_book(table, { sheet: "DRE" });

            // Baixa o arquivo
            XLSX.writeFile(wb, `DRE_${$('#ano').val()}.xlsx`);
        });
    });

    /**
     * Ajusta a altura do iframe baseado no espaço disponível abaixo do breadcrumb
     */
    function resizeIframe() {
        try {
            const iframe = document.getElementById('iframe_external');
            const breadcrumb = document.querySelector('.breadcrumb');

            // Se o breadcrumb existir, pega a altura real dele.
            // Caso contrário, usa 70px como uma margem de segurança padrão.
            const offsetHeight = breadcrumb ? breadcrumb.offsetHeight : 70;

            if (iframe) {
                // Calcula a altura final (Altura da Janela - Altura do Cabeçalho/Breadcrumb)
                // Subtraímos 5px extras para evitar "flicker" de scroll em alguns browsers
                const finalHeight = window.innerHeight - offsetHeight - 5;
                iframe.style.height = finalHeight + 'px';
            }
        } catch (e) {
            console.warn("Falha ao ajustar altura do iframe:", e);
        }
    }

    // Registra os eventos de forma limpa
    window.addEventListener('resize', resizeIframe);
    window.addEventListener('load', resizeIframe);

    // Executa imediatamente caso o DOM já esteja pronto
    if (document.readyState === "complete") {
        resizeIframe();
    }
</script>
</body>
</html>