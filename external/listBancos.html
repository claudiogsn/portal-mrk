<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Contas Bancárias</title>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/jquery-datatable/skin/bootstrap/css/dataTables.bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="bsb/plugins/node-waves/waves.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .form-control { margin-bottom: 10px; }
        th, td { vertical-align: middle !important; }

        @media (max-width: 768px) {
            body, .form-control, .modal-content, table, th, td, button {
                font-size: 12px !important;
            }
            h2, .modal-title { font-size: 16px !important; }
            .btn { padding: 6px 10px !important; font-size: 12px !important; }
            .table-responsive { overflow-x: auto; }
            .modal-dialog { margin: 10px; }
            .row > div[class*="col-"] { margin-bottom: 10px; }
            .form-control { height: 30px; padding: 4px 8px; }

            #tabela-bancos td,
            #tabela-bancos th { white-space: nowrap; }
        }

        i.blue { color: #2196F3; cursor: pointer; }
        i.orange { color: #FF9800; cursor: pointer; }
        i.red { color: #F44336; cursor: pointer; }

        .status-label {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #fff;
        }
        .status-ativo { background-color: #4CAF50; }
        .status-inativo { background-color: #F44336; }

        .info-banco {
            font-size: 11px;
            color: #666;
            display: block;
        }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header">
            <h2>Contas Bancárias</h2>
            <small>Cadastre as contas onde o dinheiro é movimentado (Itaú, Bradesco, Caixa Interno, etc).</small>
        </div>
        <div class="body">

            <div class="row">
                <div class="col-md-3">
                    <input type="text" id="filtroCodigo" class="form-control" placeholder="Filtrar por código">
                </div>
                <div class="col-md-6">
                    <input type="text" id="filtroNome" class="form-control" placeholder="Filtrar por nome do banco">
                </div>
                <div class="col-md-3 text-right">
                    <button class="btn btn-success" id="btnNovoBanco">
                        <i class="fa fa-plus"></i> Nova Conta
                    </button>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabela-bancos">
                    <thead>
                    <tr>
                        <th style="width:80px;">Código</th>
                        <th>Instituição / Nome</th>
                        <th>Agência / Conta</th>
                        <th>Carteira</th>
                        <th style="width:100px;">Status</th>
                        <th style="width:120px;">Ações</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalBanco" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">Cadastrar Conta Bancária</h4>
            </div>

            <div class="modal-body">
                <form id="formBanco">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="codigo">Código*</label>
                                <input type="number" class="form-control" id="codigo" placeholder="Ex: 341" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="nome">Nome do Banco *</label>
                                <input type="text" class="form-control" id="nome" placeholder="Ex: Itaú Movimento" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="agencia">Agência</label>
                                <input type="text" class="form-control" id="agencia" placeholder="Ex: 1234">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="conta">Conta</label>
                                <input type="text" class="form-control" id="conta" placeholder="Ex: 12345-6">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="carteira">Carteira</label>
                                <input type="text" class="form-control" id="carteira" placeholder="Ex: 109">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição / Obs</label>
                        <input type="text" class="form-control" id="descricao" placeholder="Opcional">
                    </div>

                    <div class="form-group">
                        <label for="ativos">Status</label>
                        <select id="ativos" class="form-control">
                            <option value="1">Ativo</option>
                            <option value="0">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="salvarBanco">Salvar</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarBanco" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">Editar Conta Bancária</h4>
            </div>

            <div class="modal-body">
                <form id="formEditarBanco">
                    <input type="hidden" id="editarBancoId">

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editarCodigo">Código *</label>
                                <input type="text" class="form-control" id="editarCodigo" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="editarNome">Nome do Banco *</label>
                                <input type="text" class="form-control" id="editarNome" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="editarAgencia">Agência</label>
                                <input type="text" class="form-control" id="editarAgencia">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="editarConta">Conta</label>
                                <input type="text" class="form-control" id="editarConta">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="editarCarteira">Carteira</label>
                                <input type="text" class="form-control" id="editarCarteira">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editarDescricao">Descrição / Obs</label>
                        <input type="text" class="form-control" id="editarDescricao">
                    </div>

                    <div class="form-group">
                        <label for="editarAtivos">Status</label>
                        <select id="editarAtivos" class="form-control">
                            <option value="1">Ativo</option>
                            <option value="0">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="salvarEdicaoBanco">Salvar Alterações</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id');

    let bancosCache = [];

    $(document).ready(() => {
        if (!token || !system_unit_id) {
            Swal.fire('Erro', 'Token ou system_unit_id não informado na URL.', 'error');
            return;
        }

        listarBancos();

        $('#filtroCodigo, #filtroNome').on('input', filtrarTabela);

        $('#btnNovoBanco').click(() => {
            $('#formBanco')[0].reset();
            $('#ativos').val('1');
            $('#modalBanco').modal('show');
        });

        $('#salvarBanco').click(salvarBanco);
        $('#salvarEdicaoBanco').click(salvarEdicaoBanco);
    });

    async function listarBancos() {
        try {
            const res = await axios.post(baseUrl, {
                method: 'listBancos', // Chama o controller de BANCOS reais
                token,
                data: {
                    system_unit_id,
                    apenas_ativos: false
                }
            });

            const dados = Array.isArray(res.data) ? res.data : (res.data.data || []);
            bancosCache = dados.slice();

            const tbody = $('#tabela-bancos tbody');
            tbody.empty();

            if (!bancosCache.length) {
                tbody.append(`
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhuma conta bancária cadastrada.<br>
                            Clique em "Nova Conta" para começar.
                        </td>
                    </tr>
                `);
                return;
            }

            // Ordena por código
            bancosCache.sort((a, b) => String(a.nome).localeCompare(String(b.nome)));

            bancosCache.forEach(b => {
                const codigo    = b.codigo ?? '';
                const nome      = (b.nome || '').trim();
                const agencia   = (b.agencia || '').trim();
                const conta     = (b.conta || '').trim();
                const carteira  = (b.carteira || '').trim();
                const ativos    = Number(b.ativos ?? 1);

                const statusClass = ativos ? 'status-ativo' : 'status-inativo';
                const statusText  = ativos ? 'Ativo' : 'Inativo';

                // Formata Agência e Conta
                let infoAgenciaConta = '-';
                if(agencia || conta) {
                    infoAgenciaConta = `<span class="info-banco">Ag: ${agencia || 'N/A'} | Cc: ${conta || 'N/A'}</span>`;
                }

                tbody.append(`
                    <tr data-id="${b.id}">
                        <td><strong>${codigo}</strong></td>
                        <td>${nome}</td>
                        <td>${infoAgenciaConta}</td>
                        <td>${carteira || '-'}</td>
                        <td><span class="status-label ${statusClass}">${statusText}</span></td>
                        <td>
                            <a href="#" class="editar-banco" title="Editar">
                                <i class="fa fa-edit blue"></i>
                            </a>
                            &nbsp;
                            <a href="#" class="toggle-ativo-banco" title="${ativos ? 'Inativar' : 'Ativar'}">
                                <i class="fa fa-power-off orange"></i>
                            </a>
                            &nbsp;
                            <a href="#" class="excluir-banco" title="Excluir">
                                <i class="fa fa-trash red"></i>
                            </a>
                        </td>
                    </tr>
                `);
            });

            filtrarTabela();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Falha ao listar contas bancárias.', 'error');
        }
    }

    function filtrarTabela() {
        const codigoFiltro = $('#filtroCodigo').val().toLowerCase();
        const textoFiltro  = $('#filtroNome').val().toLowerCase();

        $('#tabela-bancos tbody tr').each(function () {
            const $tr = $(this);
            // Se for a linha de "nenhum registro", não filtra
            if ($tr.text().includes('Nenhuma conta bancária')) return;

            const textoCodigo = $tr.find('td:nth-child(1)').text().toLowerCase();
            const textoNome   = $tr.find('td:nth-child(2)').text().toLowerCase();

            const matchCodigo = !codigoFiltro || textoCodigo.startsWith(codigoFiltro);
            const matchTexto  = !textoFiltro || textoNome.includes(textoFiltro);

            $tr.toggle(matchCodigo && matchTexto);
        });
    }

    async function salvarBanco() {
        const codigo    = $('#codigo').val().trim();
        const nome      = $('#nome').val().trim();
        const agencia   = $('#agencia').val().trim();
        const conta     = $('#conta').val().trim();
        const carteira  = $('#carteira').val().trim();
        const descricao = $('#descricao').val().trim();
        const ativos    = $('#ativos').val();

        if (!codigo || !nome) {
            return Swal.fire('Atenção', 'Código e Nome são obrigatórios.', 'warning');
        }

        Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await axios.post(baseUrl, {
                method: 'createBanco',
                token,
                data: {
                    system_unit_id,
                    codigo,
                    nome,
                    agencia,
                    conta,
                    carteira,
                    descricao,
                    ativos
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Atenção', res.data.message || 'Erro ao criar conta.', 'warning');
            }

            Swal.fire('Sucesso', 'Conta bancária criada com sucesso.', 'success');
            $('#modalBanco').modal('hide');
            listarBancos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao criar conta.', 'error');
        }
    }

    // Abrir modal editar
    $(document).on('click', '.editar-banco', function (e) {
        e.preventDefault();
        const $tr = $(this).closest('tr');
        const id  = $tr.data('id');
        const banco = bancosCache.find(b => String(b.id) === String(id));

        if (!banco) return Swal.fire('Erro', 'Banco não encontrado.', 'error');

        $('#editarBancoId').val(banco.id);
        $('#editarCodigo').val(banco.codigo);
        $('#editarNome').val(banco.nome || '');
        $('#editarAgencia').val(banco.agencia || '');
        $('#editarConta').val(banco.conta || '');
        $('#editarCarteira').val(banco.carteira || '');
        $('#editarDescricao').val(banco.descricao || '');
        $('#editarAtivos').val(banco.ativos ?? 1);

        $('#modalEditarBanco').modal('show');
    });

    async function salvarEdicaoBanco() {
        const id        = $('#editarBancoId').val();
        const codigo    = $('#editarCodigo').val().trim();
        const nome      = $('#editarNome').val().trim();
        const agencia   = $('#editarAgencia').val().trim();
        const conta     = $('#editarConta').val().trim();
        const carteira  = $('#editarCarteira').val().trim();
        const descricao = $('#editarDescricao').val().trim();
        const ativos    = $('#editarAtivos').val();

        if (!codigo || !nome) {
            return Swal.fire('Atenção', 'Código e Nome são obrigatórios.', 'warning');
        }

        const confirmacao = await Swal.fire({
            title: 'Salvar alterações?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmacao.isConfirmed) return;

        Swal.fire({ title: 'Salvando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await axios.post(baseUrl, {
                method: 'updateBanco',
                token,
                data: {
                    id,
                    codigo,
                    nome,
                    agencia,
                    conta,
                    carteira,
                    descricao,
                    ativos
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Erro', res.data.message || 'Erro ao atualizar.', 'error');
            }

            Swal.fire('Sucesso', 'Atualizado com sucesso.', 'success');
            $('#modalEditarBanco').modal('hide');
            listarBancos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao atualizar conta.', 'error');
        }
    }

    // Toggle Ativo
    $(document).on('click', '.toggle-ativo-banco', async function (e) {
        e.preventDefault();
        const id = $(this).closest('tr').data('id');
        const banco = bancosCache.find(b => String(b.id) === String(id));
        const novoStatus = banco.ativos ? 0 : 1;
        const acao = novoStatus ? 'ativar' : 'inativar';

        const conf = await Swal.fire({
            title: `Confirmar ${acao}?`,
            text: `Deseja ${acao} "${banco.nome}"?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Não'
        });
        if (!conf.isConfirmed) return;

        Swal.showLoading();

        try {
            const res = await axios.post(baseUrl, {
                method: 'updateBanco',
                token,
                data: { id, ativos: novoStatus }
            });
            Swal.close();
            if(!res.data.success) return Swal.fire('Erro', res.data.message, 'error');

            Swal.fire('Sucesso', 'Status atualizado.', 'success');
            listarBancos();
        } catch (e) {
            Swal.fire('Erro', 'Falha na requisição.', 'error');
        }
    });

    // Excluir
    $(document).on('click', '.excluir-banco', async function (e) {
        e.preventDefault();
        const id = $(this).closest('tr').data('id');
        const banco = bancosCache.find(b => String(b.id) === String(id));

        const conf = await Swal.fire({
            title: 'Excluir conta?',
            text: `Excluir "${banco.nome}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, excluir'
        });
        if (!conf.isConfirmed) return;

        Swal.showLoading();

        try {
            const res = await axios.post(baseUrl, {
                method: 'deleteBanco',
                token,
                data: { id }
            });
            Swal.close();
            if(!res.data.success) return Swal.fire('Atenção', res.data.message, 'warning');

            Swal.fire('Sucesso', 'Excluído com sucesso.', 'success');
            listarBancos();
        } catch (e) {
            Swal.fire('Erro', 'Falha ao excluir.', 'error');
        }
    });
</script>

</body>
</html>