<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Contas Bancárias | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== ESTILO SKELETON ====== */
        .skeleton {
            background-color: #e2e5e7;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0));
            background-size: 200px 100%;
            background-repeat: no-repeat;
            display: inline-block;
            width: 100%; height: 15px; border-radius: 4px;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading { 0% { background-position: -200px 0; } 100% { background-position: calc(200px + 100%) 0; } }

        /* ====== AJUSTES GERAIS MRK ====== */
        html, body { background: transparent !important; }
        body { font-family: 'Poppins', sans-serif; background-color: #F4F7F6; }
        .container-fluid { padding-top: 15px; }

        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            border-top: 2px solid var(--mrk-blue) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        .card .header h2 { font-family: 'Kanit', sans-serif; font-weight: 600; color: var(--mrk-blue); display: flex; align-items: center; gap: 10px; }

        /* Tabela e Ações */
        .table thead th {
            background-color: #f8f9fa;
            color: var(--mrk-blue);
            font-family: 'Kanit', sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            text-align: center;
        }
        .col-action { width: 50px; text-align: center !important; }
        .action-icon {
            font-size: 20px;
            transition: transform 0.2s;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            text-decoration: none !important;
        }
        .action-icon:hover { transform: scale(1.2); }
        .icon-blue { color: var(--mrk-blue); }
        .icon-orange { color: var(--mrk-amber); }
        .icon-red { color: var(--mrk-red); }

        .status-label { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; color: #fff; }
        .status-ativo { background-color: var(--mrk-green); }
        .status-inativo { background-color: var(--mrk-red); }

        /* ====== MODAL PREMIUM ====== */
        .modal-content { border-radius: 12px; border: none; overflow: hidden; }
        .modal-header { position: relative; border-bottom: 2px solid var(--mrk-blue); padding: 18px 25px; background: #fff; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-blue); font-weight: 600; }
        .btn-close-mrk { position: absolute; top: 15px; right: 15px; color: var(--mrk-red); font-size: 26px; background: none; border: none; outline: none !important; cursor: pointer; }

        label { font-family: 'Kanit', sans-serif; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-control { height: 38px; border-radius: 6px; border: 1px solid #ddd; }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="card">
        <div class="header">
            <h2>
                <iconify-icon icon="icon-park-outline:bank-card" width="24"></iconify-icon>
                GESTÃO DE CONTAS BANCÁRIAS
            </h2>
        </div>
        <div class="body">
            <div class="row clearfix" style="margin-bottom: 20px;">
                <div class="col-md-3 mb-2">
                    <label style="font-family:'Kanit'; font-size:12px;">Código</label>
                    <input type="text" id="filtroCodigo" class="form-control" placeholder="Ex: 341">
                </div>
                <div class="col-md-6 mb-2">
                    <label style="font-family:'Kanit'; font-size:12px;">Instituição / Nome da Conta</label>
                    <input type="text" id="filtroNome" class="form-control" placeholder="Digite para pesquisar...">
                </div>
                <div class="col-md-3 mb-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-success btn-block" id="btnNovoBanco" style="height:38px; background-color: var(--mrk-green) !important;">
                        <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> NOVA CONTA
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="tabela-bancos">
                    <thead>
                    <tr>
                        <th class="col-action">Edit</th>
                        <th class="col-action">OnOff</th>
                        <th class="col-action">Sair</th>
                        <th style="width:80px;">Código</th>
                        <th style="text-align: left;">Instituição / Nome</th>
                        <th style="text-align: left;">Agência / Conta</th>
                        <th class="text-center">Carteira</th>
                        <th class="text-center">Status</th>
                    </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalBanco" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitulo">Cadastrar Conta</h4>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body">
                <form id="formBanco">
                    <input type="hidden" id="bancoId">
                    <div class="row clearfix">
                        <div class="col-md-4 mb-2">
                            <label>Código do Banco *</label>
                            <input type="number" class="form-control" id="codigo" placeholder="Ex: 341" required>
                        </div>
                        <div class="col-md-8 mb-2">
                            <label>Nome da Conta / Banco *</label>
                            <input type="text" class="form-control" id="nome" placeholder="Ex: Itaú Movimento" required>
                        </div>
                    </div>
                    <div class="row clearfix">
                        <div class="col-md-4 mb-2"><label>Agência</label><input type="text" class="form-control" id="agencia" placeholder="1234"></div>
                        <div class="col-md-5 mb-2"><label>Conta Corrente</label><input type="text" class="form-control" id="conta" placeholder="12345-6"></div>
                        <div class="col-md-3 mb-2"><label>Carteira</label><input type="text" class="form-control" id="carteira" placeholder="109"></div>
                    </div>
                    <div class="form-group mb-2">
                        <label>Descrição / Observações</label>
                        <input type="text" class="form-control" id="descricao" placeholder="Opcional">
                    </div>
                    <div class="form-group mb-0">
                        <label>Status</label>
                        <select id="ativos" class="form-control">
                            <option value="1">Ativo</option>
                            <option value="0">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee;">
                <button type="button" class="btn btn-primary" id="btnSalvar" style="background-color: var(--mrk-blue) !important; padding: 10px 30px;">
                    <iconify-icon icon="icon-park-outline:save" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> SALVAR CONTA
                </button>
                <button type="button" class="btn btn-link" data-dismiss="modal" style="color: #666;">CANCELAR</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    'use strict';

    $(document).ready(function () {
        const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php' : 'http://localhost/portal-mrk/api/v1/financeiro.php';
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token'), system_unit_id = params.get('system_unit_id');

        let bancosCache = [];

        function showSkeletons() {
            const tb = $('#tableBody').empty();
            for(let i=0; i<6; i++) {
                tb.append(`<tr><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>`);
            }
        }

        async function listarBancos() {
            showSkeletons();
            try {
                const res = await axios.post(baseUrl, { method: 'listBancos', token, data: { system_unit_id, apenas_ativos: false } });
                bancosCache = res.data.data || res.data;
                renderTabela(bancosCache);
            } catch (e) { Swal.fire('Erro', 'Falha ao carregar contas.', 'error'); }
        }

        function renderTabela(dados) {
            const tbody = $('#tableBody').empty();
            if(!dados.length) { tbody.append('<tr><td colspan="8" class="text-center p-4">Nenhuma conta cadastrada.</td></tr>'); return; }

            dados.sort((a,b) => String(a.nome).localeCompare(String(b.nome)));

            dados.forEach(b => {
                const ativos = Number(b.ativos ?? 1);
                tbody.append(`
                    <tr data-id="${b.id}">
                        <td class="col-action"><a class="action-icon icon-blue btnEditar" data-toggle="tooltip" title="Editar Conta"><iconify-icon icon="icon-park-outline:edit-two"></iconify-icon></a></td>
                        <td class="col-action"><a class="action-icon icon-orange btnToggle" data-toggle="tooltip" title="${ativos ? 'Desativar' : 'Ativar'}"><iconify-icon icon="icon-park-outline:power"></iconify-icon></a></td>
                        <td class="col-action"><a class="action-icon icon-red btnExcluir" data-toggle="tooltip" title="Excluir Definitivo"><iconify-icon icon="icon-park-outline:delete-five"></iconify-icon></a></td>
                        <td class="text-center"><b>${b.codigo || ''}</b></td>
                        <td>${b.nome}</td>
                        <td><small style="color:#888;">Ag: ${b.agencia || '-'} | Cc: ${b.conta || '-'}</small></td>
                        <td class="text-center">${b.carteira || '-'}</td>
                        <td class="text-center"><span class="status-label ${ativos ? 'status-ativo' : 'status-inativo'}">${ativos ? 'Ativo' : 'Inativo'}</span></td>
                    </tr>
                `);
            });

            $('[data-toggle="tooltip"]').tooltip({ container: 'body' });
        }

        // --- FILTROS ---
        $('#filtroCodigo, #filtroNome').on('input', function() {
            const cod = $('#filtroCodigo').val().toLowerCase();
            const nom = $('#filtroNome').val().toLowerCase();
            const filtrados = bancosCache.filter(b => (!cod || String(b.codigo).startsWith(cod)) && (!nom || b.nome.toLowerCase().includes(nom)));
            renderTabela(filtrados);
        });

        // --- CADASTRO/EDIÇÃO ---
        $('#btnNovoBanco').click(() => {
            $('#formBanco')[0].reset();
            $('#bancoId').val('');
            $('#modalTitulo').text('Nova Conta Bancária');
            $('#modalBanco').modal('show');
        });

        $(document).on('click', '.btnEditar', function() {
            const id = $(this).closest('tr').data('id');
            const b = bancosCache.find(x => String(x.id) === String(id));
            $('#bancoId').val(b.id);
            $('#codigo').val(b.codigo);
            $('#nome').val(b.nome);
            $('#agencia').val(b.agencia);
            $('#conta').val(b.conta);
            $('#carteira').val(b.carteira);
            $('#descricao').val(b.descricao);
            $('#ativos').val(b.ativos ?? 1);
            $('#modalTitulo').text('Editar Conta Bancária');
            $('#modalBanco').modal('show');
        });

        $('#btnSalvar').click(async function() {
            const id = $('#bancoId').val();
            const payload = {
                id, codigo: $('#codigo').val(), nome: $('#nome').val(),
                agencia: $('#agencia').val(), conta: $('#conta').val(),
                carteira: $('#carteira').val(), descricao: $('#descricao').val(),
                ativos: $('#ativos').val(), system_unit_id
            };

            if(!payload.codigo || !payload.nome) return Swal.fire('Atenção', 'Código e Nome são obrigatórios.', 'warning');

            Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
            try {
                const method = id ? 'updateBanco' : 'createBanco';
                await axios.post(baseUrl, { method, token, data: payload });
                Swal.fire({ icon: 'success', title: 'Salvo!', timer: 1500, showConfirmButton: false });
                $('#modalBanco').modal('hide');
                listarBancos();
            } catch (e) { Swal.fire('Erro', 'Erro ao salvar.', 'error'); }
        });

        // --- AÇÕES ---
        $(document).on('click', '.btnToggle', async function() {
            const id = $(this).closest('tr').data('id');
            const b = bancosCache.find(x => String(x.id) === String(id));
            const novoStatus = b.ativos ? 0 : 1;

            const res = await Swal.fire({ title: 'Alterar Status?', text: `Deseja ${novoStatus ? 'ativar' : 'inativar'} a conta ${b.nome}?`, icon: 'question', showCancelButton: true });
            if(res.isConfirmed) {
                try {
                    await axios.post(baseUrl, { method: 'updateBanco', token, data: { id, ativos: novoStatus } });
                    listarBancos();
                } catch (e) { Swal.fire('Erro', 'Falha ao atualizar.', 'error'); }
            }
        });

        $(document).on('click', '.btnExcluir', async function() {
            const id = $(this).closest('tr').data('id');
            const b = bancosCache.find(x => String(x.id) === String(id));

            const res = await Swal.fire({ title: 'Excluir Conta?', text: `Deseja excluir permanentemente a conta ${b.nome}?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' });
            if(res.isConfirmed) {
                try {
                    const r = await axios.post(baseUrl, { method: 'deleteBanco', token, data: { id } });
                    if(!r.data.success) return Swal.fire('Atenção', r.data.message, 'warning');
                    listarBancos();
                } catch (e) { Swal.fire('Erro', 'Falha ao excluir.', 'error'); }
            }
        });

        listarBancos();
    });
</script>

</body>
</html>