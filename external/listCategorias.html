<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Categorias</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Header e Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        .table tbody td { font-size: 13px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        /* Ações */
        .btn-action {
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
            display: inline-block;
            margin: 0 5px;
        }
        .btn-action.edit { color: var(--mrk-blue); }
        .btn-action.delete { color: var(--mrk-red); }
        .btn-action:hover { transform: scale(1.2); }

        /* Skeleton */
        .skeleton-wrapper { display: none; margin-top: 20px; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* Modal */
        .modal-header { background-color: #f8f9fa; border-bottom: 1px solid #ddd; padding: 15px; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-black); font-weight: 600; }
        .modal-footer { border-top: 1px solid #eee; background: #fff; }

        /* Botão Gerar Código */
        .btn-addon-icon {
            background: #fff; border: 1px solid #ddd; color: var(--mrk-blue); transition: all 0.2s;
        }
        .btn-addon-icon:hover { background: var(--mrk-blue); color: #fff; border-color: var(--mrk-blue); }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:all-application" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                GESTÃO DE CATEGORIAS
            </h2>
            <button class="btn btn-success waves-effect" onclick="abrirModal()">
                <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                NOVA CATEGORIA
            </button>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-3">
                        <label class="muted">Filtrar por Código</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:tag"></iconify-icon></span>
                            <input type="text" id="filtroCodigo" class="form-control" placeholder="Ex: 10">
                        </div>
                    </div>
                    <div class="col-md-9">
                        <label class="muted">Filtrar por Nome</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                            <input type="text" id="filtroNome" class="form-control" placeholder="Digite o nome da categoria...">
                        </div>
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div class="table-responsive" id="table-area">
                <table class="table table-hover" id="tabela-categorias">
                    <thead>
                    <tr>
                        <th style="width: 100px;" class="text-center">Ações</th>
                        <th style="width: 120px;">Código</th>
                        <th>Nome da Categoria</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="3" class="text-center muted" style="padding: 30px;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="modalCategoria" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 8px; border:none;">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="modalTitulo">
                    <iconify-icon icon="icon-park-outline:edit" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                    Dados da Categoria
                </h4>
            </div>

            <div class="modal-body" style="padding: 20px;">
                <input type="hidden" id="cat_id">

                <div class="row clearfix">
                    <div class="col-md-4">
                        <label class="muted">Código</label>
                        <div class="input-group">
                            <input type="number" id="cat_codigo" class="form-control" placeholder="Automático">
                            <span class="input-group-btn">
                                <button class="btn btn-default btn-addon-icon" type="button" onclick="gerarCodigo()" title="Gerar Próximo Código">
                                    <iconify-icon icon="icon-park-outline:refresh"></iconify-icon>
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="muted">Nome</label>
                        <input type="text" id="cat_nome" class="form-control" placeholder="Ex: Bebidas, Limpeza...">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="salvarCategoria" class="btn btn-primary waves-effect">
                    <iconify-icon icon="icon-park-outline:check"></iconify-icon> SALVAR
                </button>
                <button class="btn btn-default waves-effect" data-dismiss="modal">CANCELAR</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token     = urlParams.get('token');
    const unit_id   = urlParams.get('system_unit_id') || urlParams.get('unit_id');

    let todasCategorias = [];

    // Helper: Skeleton
    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#table-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#table-area').fadeIn();
        }
    }

    $(document).ready(() => {
        if(!unit_id) {
            Swal.fire('Erro', 'Unidade não identificada na URL.', 'error');
            return;
        }

        carregarCategorias();
        $('#filtroNome, #filtroCodigo').on('input', aplicarFiltros);
        $('#salvarCategoria').click(salvar);

        // Focar no nome ao abrir modal se for novo
        $('#modalCategoria').on('shown.bs.modal', function () {
            if(!$('#cat_id').val()) $('#cat_codigo').focus();
        });
    });

    async function gerarCodigo() {
        const input = $('#cat_codigo');
        const btn = $('.btn-addon-icon');

        // Efeito visual de loading no botão
        const iconOriginal = btn.html();
        btn.html('<iconify-icon icon="icon-park-outline:loading-four" class="fa-spin"></iconify-icon>').prop('disabled', true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'getProximoCodigo',
                token,
                data: { system_unit_id: unit_id }
            });

            if (res.data.success) {
                input.val(res.data.next_code);
                input.addClass('focused'); // Simula foco para destacar
                setTimeout(() => input.removeClass('focused'), 500);
            } else {
                Swal.fire('Atenção', res.data.message, 'warning');
            }
        } catch (e) {
            Swal.fire('Erro', 'Não foi possível gerar o código.', 'error');
        } finally {
            btn.html(iconOriginal).prop('disabled', false);
        }
    }

    async function carregarCategorias() {
        toggleLoading(true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'listarCategorias',
                token,
                data: { system_unit_id: unit_id }
            });

            if(res.data.success) {
                todasCategorias = res.data.data;
                aplicarFiltros();
            } else {
                Swal.fire('Atenção', res.data.message, 'warning');
            }
        } catch (e) {
            Swal.fire('Erro', 'Falha ao carregar categorias.', 'error');
        } finally {
            toggleLoading(false);
        }
    }

    function aplicarFiltros() {
        const codigoFiltro = $('#filtroCodigo').val().trim();
        const nomeFiltro   = $('#filtroNome').val().toLowerCase().trim();
        const tbody = $('#tabela-categorias tbody');
        tbody.empty();

        const filtrados = todasCategorias.filter(c => {
            const codeCond = codigoFiltro === "" || String(c.codigo).includes(codigoFiltro);
            const nomeCond = nomeFiltro === "" || c.nome.toLowerCase().includes(nomeFiltro);
            return codeCond && nomeCond;
        });

        if (filtrados.length === 0) {
            tbody.append('<tr><td colspan="3" class="text-center text-muted" style="padding:20px;">Nenhum registro encontrado.</td></tr>');
            return;
        }

        filtrados.forEach(c => {
            // Escapar aspas para o onclick
            const nomeSafe = (c.nome || '').replace(/'/g, "\\'");
            const codigoSafe = (c.codigo || '').toString().replace(/'/g, "\\'");

            tbody.append(`
            <tr>
                <td class="text-center">
                    <a class="btn-action edit" title="Editar" onclick="abrirModal('${c.id}', '${codigoSafe}', '${nomeSafe}')">
                        <iconify-icon icon="icon-park-outline:edit"></iconify-icon>
                    </a>
                    <a class="btn-action delete" title="Excluir" onclick="excluir('${c.id}')">
                        <iconify-icon icon="icon-park-outline:delete"></iconify-icon>
                    </a>
                </td>
                <td><strong>${c.codigo}</strong></td>
                <td>${c.nome}</td>
            </tr>
            `);
        });
    }

    function abrirModal(id = null, codigo = '', nome = '') {
        $('#cat_id').val(id || '');
        $('#cat_codigo').val(codigo);
        $('#cat_nome').val(nome);

        const title = id ? 'Editar Categoria' : 'Nova Categoria';
        const icon = id ? 'icon-park-outline:edit' : 'icon-park-outline:plus';

        $('#modalTitulo').html(`<iconify-icon icon="${icon}" style="vertical-align: middle; margin-right: 5px; color: var(--mrk-blue);"></iconify-icon> ${title}`);

        $('#modalCategoria').modal('show');
    }

    async function salvar() {
        const id     = $('#cat_id').val();
        const codigo = $('#cat_codigo').val();
        const nome   = $('#cat_nome').val();

        if (!codigo || !nome) {
            Swal.fire('Atenção', 'Preencha Código e Nome.', 'warning');
            return;
        }

        try {
            Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });

            const payload = {
                method: 'salvarCategoria',
                token,
                data: {
                    system_unit_id: unit_id,
                    codigo: codigo,
                    nome: nome
                }
            };
            if(id) payload.data.id = id;

            const res = await axios.post(baseUrl, payload);
            Swal.close();

            if (res.data.success) {
                $('#modalCategoria').modal('hide');
                Swal.fire({
                    title: 'Sucesso',
                    text: 'Salvo com sucesso!',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                carregarCategorias();
            } else {
                Swal.fire('Erro', res.data.message, 'error');
            }
        } catch {
            Swal.fire('Erro', 'Erro ao salvar.', 'error');
        }
    }

    function excluir(id) {
        Swal.fire({
            title: 'Excluir Categoria?',
            text: "Esta ação não pode ser desfeita.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Sim, excluir',
            cancelButtonText: 'Cancelar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    Swal.fire({ title: 'Excluindo...', didOpen: () => Swal.showLoading() });
                    const res = await axios.post(baseUrl, {
                        method: 'excluirCategoria',
                        token,
                        data: { id: id }
                    });
                    Swal.close();
                    if (res.data.success) {
                        Swal.fire('Excluído!', res.data.message, 'success');
                        carregarCategorias();
                    } else {
                        Swal.fire('Erro', res.data.message, 'error');
                    }
                } catch {
                    Swal.fire('Erro', 'Falha ao excluir.', 'error');
                }
            }
        });
    }
</script>
</body>
</html>