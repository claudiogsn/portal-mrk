<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impressão da Produção</title>

    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color:#111; }
        h1, h2 { margin: 0; padding: 0; }
        h1 { font-size: 24px; font-weight: bold; }
        h2 { font-size: 18px; margin-bottom: 6px; }
        .subtitulo { font-size: 13px; color:#444; margin-top: 2px; }

        .header { display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .header img { max-height: 60px; }

        hr { border: 1px solid #000; margin: 14px 0; }

        .linha-info { margin: 4px 0; font-size: 14px; }
        .linha-info strong { display:inline-block; min-width: 150px; }

        table { width: 100%; border-collapse: collapse; margin-top: 14px; }
        table, th, td { border: 1px solid #000; }
        th, td { padding: 8px; text-align: left; font-size: 13px; }
        th { background:#f2f2f2; }

        .right { text-align: right; }
        .center { text-align: center; }

        .bloco-produto {
            margin-top: 16px;
            padding-top: 10px;
            border-top: 2px solid #000;
        }

        .titulo-produto {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 4px 0;
        }

        .sub-produto {
            font-size: 13px;
            color: #333;
            margin-bottom: 8px;
        }

        .no-print { margin-top: 12px; }

        /* quebra de página entre produtos (impressão) */
        .page-break {
            display: none;
        }

        @media print {
            .no-print { display: none !important; }
            body { margin: 0; }
            .page-break { display: block; page-break-after: always; }
        }
    </style>
</head>

<body>
<div class="header">
    <div>
        <h1>Portal MRK</h1>
        <h2>Produção</h2>
        <div class="subtitulo">Comprovante de execução</div>
    </div>
    <div>
        <img src="https://portal.mrksolucoes.com.br/app/templates/theme5/images/logo.png" alt="Logo">
    </div>
</div>

<hr>

<div class="linha-info"><strong>Estabelecimento:</strong> <span id="estabelecimento">-</span></div>
<div class="linha-info"><strong>Doc:</strong> <span id="doc">-</span></div>
<div class="linha-info"><strong>Data:</strong> <span id="dataProducao">-</span></div>
<div class="linha-info"><strong>Hora:</strong> <span id="horaExecucao">-</span></div>
<div class="linha-info"><strong>Usuário:</strong> <span id="usuario">-</span></div>

<hr>

<!-- RESUMO (massa) -->
<div id="resumoMassa" style="display:none;">
    <div class="linha-info"><strong>Tipo:</strong> Produção</div>

    <table class="table table-striped" style="margin:0;">
        <thead>
        <tr>
            <th style="width:90px;">Código</th>
            <th>Produto</th>
            <th style="width:70px;" class="center">Unid</th>
            <th style="width:160px;" class="right">Qtd Produzida</th>
        </tr>
        </thead>
        <tbody id="produtosResumo">
        <tr><td colspan="4" class="center">Carregando...</td></tr>
        </tbody>
    </table>

    <hr>
</div>

<!-- CONTEÚDO (simples OU massa) -->
<div id="conteudo">
    <div class="center" style="padding: 18px 0;">Carregando...</div>
</div>

<div class="no-print">
    <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
    <button class="btn btn-default" onclick="window.close()">Fechar</button>
</div>

<script>
    function escapeHtml(str) {
        return (str ?? '').toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function parseBRNumber(v) {
        if (v === null || v === undefined) return 0;
        let s = v.toString().trim();
        if (!s) return 0;
        s = s.replace(/\s/g, '');
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.');
        else if (s.includes(',')) s = s.replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function formatBR(n, dec = 4) {
        const v = (typeof n === 'number') ? n : parseBRNumber(n);
        let s = v.toFixed(dec);
        s = s.replace(/\.?0+$/, (m) => m.startsWith('.') ? '' : m);
        s = s.replace('.', ',');
        return s;
    }

    function setHeader(data) {
        document.getElementById('estabelecimento').textContent = data?.unidade?.nome || '-';
        document.getElementById('doc').textContent = data?.doc || '-';
        document.getElementById('dataProducao').textContent = data?.data_producao || '-';
        document.getElementById('horaExecucao').textContent = data?.hora_execucao || '-';
        document.getElementById('usuario').textContent = data?.usuario?.nome || '-';
    }

    function renderTabelaInsumos(insumos) {
        const itens = Array.isArray(insumos) ? insumos : [];
        if (!itens.length) {
            return `<tr><td colspan="6" class="center">Sem itens</td></tr>`;
        }

        return itens.map(i => {
            const codigo = escapeHtml(i.codigo ?? '');
            const nome = escapeHtml(i.nome ?? '');
            const und = escapeHtml(i.und ?? '');
            const consumo = formatBR(i.consumo ?? 0, 4);
            const rendimento = formatBR(i.rendimento ?? 1, 4);
            const ficha = formatBR(i.ficha ?? 0, 4);

            return `
                <tr>
                  <td>${codigo}</td>
                  <td>${nome}</td>
                  <td class="center">${und}</td>
                  <td class="right"><b>${escapeHtml(consumo)}</b></td>
                  <td class="right">${escapeHtml(rendimento)}</td>
                  <td class="right">${escapeHtml(ficha)}</td>
                </tr>
            `;
        }).join('');
    }

    function renderProducaoSimples(data) {
        const pf = data?.produto_final || {};
        const pfUnd = pf?.und ? ` ${pf.und}` : '';

        const produtoTxt =
            pf?.nome ? `${escapeHtml(pf.nome)} (${escapeHtml(pf.codigo ?? '-')})`
                : (pf?.codigo ? escapeHtml(String(pf.codigo)) : '-');

        const qtdTxt =
            (pf?.quantidade_produzida !== undefined)
                ? `${escapeHtml(formatBR(pf.quantidade_produzida, 3))}${escapeHtml(pfUnd)}`
                : '-';

        const insumosHtml = renderTabelaInsumos(data?.insumos);

        return `
            <div class="linha-info"><strong>Produto:</strong> ${produtoTxt}</div>
            <div class="linha-info"><strong>Quantidade Produzida:</strong> ${qtdTxt}</div>

            <hr>

            <table class="table table-striped" style="margin:0;">
                <thead>
                <tr>
                    <th style="width:90px;">Código</th>
                    <th>Insumo</th>
                    <th style="width:70px;">Unid</th>
                    <th style="width:140px;" class="right">Consumo</th>
                    <th style="width:140px;" class="right">Rendimento</th>
                    <th style="width:140px;" class="right">Ficha</th>
                </tr>
                </thead>
                <tbody>
                ${insumosHtml}
                </tbody>
            </table>
        `;
    }

    function renderResumoMassa(produtos) {
        const tbody = document.getElementById('produtosResumo');
        tbody.innerHTML = '';

        if (!produtos.length) {
            tbody.innerHTML = `<tr><td colspan="4" class="center">Sem produtos</td></tr>`;
            return;
        }

        produtos.forEach(p => {
            const codigo = escapeHtml(p.codigo ?? '');
            const nome = escapeHtml(p.nome ?? '');
            const und = escapeHtml((p.und || '').trim() || '-');
            const qtd = (p.quantidade_produzida !== undefined)
                ? escapeHtml(formatBR(p.quantidade_produzida, 3))
                : '0';

            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>${codigo}</td>
                    <td>${nome}</td>
                    <td class="center">${und}</td>
                    <td class="right"><b>${qtd}</b> ${und !== '-' ? und : ''}</td>
                </tr>
            `);
        });
    }

    function renderProducaoMassa(data) {
        const produtos = Array.isArray(data?.produtos) ? data.produtos : [];

        document.getElementById('resumoMassa').style.display = 'block';
        renderResumoMassa(produtos);

        if (!produtos.length) {
            return `<div class="center" style="padding:18px 0;">Sem produtos</div>`;
        }

        return produtos.map((p, idx) => {
            const codigo = escapeHtml(p.codigo ?? '');
            const nome = escapeHtml(p.nome ?? '');
            const und = escapeHtml((p.und || '').trim() || '-');

            const qtd = (p.quantidade_produzida !== undefined)
                ? escapeHtml(formatBR(p.quantidade_produzida, 3))
                : '0';

            const insumosHtml = renderTabelaInsumos(p.insumos);

            return `
                <div class="bloco-produto">
                    <div class="titulo-produto">${nome} (${codigo})</div>
                    <div class="sub-produto"><b>Quantidade Produzida:</b> ${qtd} ${und !== '-' ? und : ''}</div>

                    <table class="table table-striped" style="margin:0;">
                        <thead>
                        <tr>
                            <th style="width:90px;">Código</th>
                            <th>Insumo</th>
                            <th style="width:70px;">Unid</th>
                            <th style="width:140px;" class="right">Consumo</th>
                            <th style="width:140px;" class="right">Rendimento</th>
                            <th style="width:140px;" class="right">Ficha</th>
                        </tr>
                        </thead>
                        <tbody>
                        ${insumosHtml}
                        </tbody>
                    </table>
                </div>

                ${idx < produtos.length - 1 ? `<div class="page-break"></div>` : ``}
            `;
        }).join('');
    }

    (function init() {
        const raw = localStorage.getItem('producaoPdfData');
        const conteudo = document.getElementById('conteudo');

        if (!raw) {
            conteudo.innerHTML = `<div class="center">Nenhum dado encontrado no localStorage (producaoPdfData).</div>`;
            return;
        }

        try {
            const data = JSON.parse(raw);

            setHeader(data);

            // se tiver "produtos" => massa, senão => simples
            if (Array.isArray(data?.produtos)) {
                conteudo.innerHTML = renderProducaoMassa(data);
            } else {
                // garante que o bloco de massa fica escondido
                document.getElementById('resumoMassa').style.display = 'none';
                conteudo.innerHTML = renderProducaoSimples(data);
            }

            setTimeout(() => window.print(), 300);

        } catch (e) {
            console.error(e);
            conteudo.innerHTML = `<div class="center">Erro ao ler dados do localStorage.</div>`;
        }
    })();
</script>

</body>
</html>
