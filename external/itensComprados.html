<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Itens Comprados</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #f9f9f9; padding: 20px; font-family: 'Poppins', sans-serif; overflow-x: hidden; }

        /* Card Principal */
        .card {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            border-top: 3px solid var(--mrk-blue) !important;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        /* Header e Filtros */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group-addon { background-color: #f0f4f8; border: 1px solid #ddd; border-right: none; color: var(--mrk-blue); }

        /* Select2 Custom */
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ccc; border-radius: 4px; min-height: 34px; font-family: 'Poppins', sans-serif;
        }
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: var(--mrk-blue);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075), 0 0 8px rgba(11, 70, 172, 0.4);
        }

        /* Tabela */
        .table thead th {
            font-family: 'Kanit', sans-serif;
            color: var(--mrk-blue);
            font-weight: 600;
            font-size: 12px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }
        .table tbody td { font-size: 12px; vertical-align: middle !important; border-top: 1px solid #f1f1f1; }

        /* Skeleton Loader */
        .skeleton-wrapper { display: none; margin-top: 20px; }
        .skeleton { background: #e0e0e0; border-radius: 4px; margin-bottom: 10px; animation: pulse 1.5s infinite; }
        .sk-kpi { height: 80px; width: 100%; border-radius: 6px; margin-bottom: 15px; }
        .sk-row { height: 40px; width: 100%; margin-bottom: 8px; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:shopping-bag" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                RELATÓRIO DE ITENS COMPRADOS
            </h2>
        </div>

        <div class="body">

            <div class="filter-box">
                <div class="row clearfix">
                    <div class="col-md-3">
                        <label class="muted">Data Inicial</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dtInicio" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Data Final</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:calendar"></iconify-icon></span>
                            <input type="date" id="dtFim" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Considerar Data de:</label>
                        <select id="tipoData" class="form-control">
                            <option value="entrada">Entrada</option>
                            <option value="emissao">Emissão NF</option>
                        </select>
                    </div>
                    <div class="col-md-3" style="margin-top: 22px;">
                        <button id="btnConsultar" class="btn btn-primary btn-block waves-effect">
                            <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon>
                            CONSULTAR
                        </button>
                    </div>
                </div>
            </div>

            <div id="skeleton-area" class="skeleton-wrapper">
                <div class="row">
                    <div class="col-md-4"><div class="skeleton sk-kpi"></div></div>
                    <div class="col-md-4"><div class="skeleton sk-kpi"></div></div>
                    <div class="col-md-4"><div class="skeleton sk-kpi"></div></div>
                </div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
                <div class="skeleton sk-row"></div>
            </div>

            <div id="result-area" style="display: none;">

                <div class="row clearfix" style="margin-bottom: 20px;">
                    <div class="col-md-4">
                        <div class="kpi blue">
                            <small>Qtd. Interna Total</small>
                            <h4 id="kpiQtd">0,0000</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi green">
                            <small>Qtd. Total da NF</small>
                            <h4 id="kpiQtdNF">0,0000</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi orange" style="border-left-color: var(--mrk-red) !important;">
                            <small>Valor Total</small>
                            <h4 id="kpiVlrNota" style="color: var(--mrk-red);">R$ 0,00</h4>
                        </div>
                    </div>
                </div>

                <div class="row clearfix" style="margin-bottom: 15px;">
                    <div class="col-md-4">
                        <label class="muted">Filtrar Produtos</label>
                        <select id="filtroProduto" class="form-control" multiple="multiple"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="muted">Nº da Nota</label>
                        <input type="text" id="filtroNota" class="form-control" placeholder="Ex: 1234">
                    </div>
                    <div class="col-md-5">
                        <label class="muted">Busca Geral</label>
                        <div class="input-group">
                            <span class="input-group-addon"><iconify-icon icon="icon-park-outline:search"></iconify-icon></span>
                            <input type="text" id="filtroTexto" class="form-control" placeholder="Nome, código, descrição...">
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="tabela-resultado">
                        <thead>
                        <tr>
                            <th class="nowrap">Nº NF</th>
                            <th class="nowrap">Entrada</th>
                            <th class="nowrap">Emissão</th>
                            <th>Produto Interno</th>
                            <th class="text-right nowrap">Qtd Interna</th>
                            <th class="text-right nowrap">Vlr Unit. (Int)</th>
                            <th>Item Nota (Fornecedor)</th>
                            <th class="text-right nowrap">Qtd Nota</th>
                            <th class="text-right nowrap">Vlr Unit. (NF)</th>
                            <th class="text-right nowrap">Vlr Total</th>
                            <th class="text-right nowrap">Fator</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div style="margin-top: 10px; text-align: right;">
                    <small class="muted">Registros exibidos: <b id="kpiRegistros">0</b></small>
                </div>

            </div>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // ====== CONFIG ======
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('unit_id');

    // ====== STATE ======
    let dadosBrutos = [];
    let itensFiltrados = [];

    // ====== UTILS ======
    function brNumber(v, casas = 2) {
        if (v === null || v === undefined || isNaN(v)) return '0,00';
        return Number(v).toLocaleString('pt-BR', { minimumFractionDigits: casas, maximumFractionDigits: casas });
    }

    function brMoney(v) {
        if (v === null || v === undefined || isNaN(v)) return 'R$ 0,00';
        return Number(v).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function escapeHtml(s) {
        if (s == null) return '';
        return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function normalizeDateIso(dt) {
        if (!dt) return null;
        const s = String(dt);
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0, 10);
        const d = new Date(s);
        if (isNaN(d.getTime())) return null;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${da}`;
    }

    function formatDateBR(iso) {
        if (!iso) return '';
        const s = normalizeDateIso(iso);
        if (!s) return '';
        const [y, m, d] = s.split('-');
        return `${d}/${m}/${y}`;
    }

    function toggleLoading(isLoading) {
        if (isLoading) {
            $('#result-area').hide();
            $('#skeleton-area').show();
        } else {
            $('#skeleton-area').hide();
            $('#result-area').fadeIn();
        }
    }

    function debounce(fn, ms){
        let t; return function(){ clearTimeout(t); const args = arguments; t = setTimeout(() => fn.apply(null, args), ms); }
    }

    // ====== INIT ======
    $(document).ready(() => {
        $('#filtroProduto').select2({
            placeholder: 'Selecione produtos...',
            width: '100%',
            allowClear: true,
            closeOnSelect: false
        });

        // Eventos
        $('#btnConsultar').on('click', onConsultar);
        $('#filtroProduto').on('change', applyFiltros);
        $('#filtroNota').on('input', debounce(applyFiltros, 300));
        $('#filtroTexto').on('input', debounce(applyFiltros, 300));
        $('#tipoData').on('change', applyFiltros);

        // Datas Padrão
        const hoje = new Date();
        const y = hoje.getFullYear();
        const m = String(hoje.getMonth() + 1).padStart(2, '0');
        const d = String(hoje.getDate()).padStart(2, '0');
        $('#dtFim').val(`${y}-${m}-${d}`);

        const semanaPassada = new Date(hoje.getTime() - 7*24*60*60*1000);
        const y2 = semanaPassada.getFullYear();
        const m2 = String(semanaPassada.getMonth() + 1).padStart(2, '0');
        const d2 = String(semanaPassada.getDate()).padStart(2, '0');
        $('#dtInicio').val(`${y2}-${m2}-${d2}`);

        if (!token || !system_unit_id) {
            Swal.fire('Atenção', 'Parâmetros de sistema ausentes.', 'warning');
        } else {
            // Estado inicial vazio
            renderTabela([]);
        }
    });

    // ====== CONSULTA BACKEND ======
    async function onConsultar() {
        const data_inicio = $('#dtInicio').val();
        const data_fim    = $('#dtFim').val();

        if (!data_inicio || !data_fim) {
            return Swal.fire('Atenção', 'Informe o período.', 'warning');
        }

        toggleLoading(true);

        try {
            const res = await axios.post(baseUrl, {
                method: 'getItensCompradosPorPeriodo',
                token,
                data: {
                    system_unit_id: Number(system_unit_id),
                    data_inicio,
                    data_fim
                }
            });

            const api = res.data;
            if (!api || api.success === false) {
                toggleLoading(false);
                dadosBrutos = [];
                renderTabela([]);
                renderTotais([]);
                return Swal.fire('Atenção', api && api.error ? api.error : 'Nenhum registro encontrado.', 'info');
            }

            const payload = api.data || {};
            dadosBrutos = Array.isArray(payload.itens) ? payload.itens : [];

            buildFiltroProduto();
            applyFiltros();

            toggleLoading(false);

        } catch (e) {
            console.error(e);
            toggleLoading(false);
            Swal.fire('Erro', 'Falha na comunicação.', 'error');
        }
    }

    // ====== FILTROS ======
    function buildFiltroProduto() {
        const mapa = {};
        dadosBrutos.forEach(it => {
            const cod = it.pi_codigo || it.mv_produto;
            const nome = it.pi_nome || it.in_descricao_nota || '';
            if (cod && !mapa[cod]) mapa[cod] = nome;
        });

        const $sel = $('#filtroProduto');
        $sel.empty();
        Object.keys(mapa).sort((a,b) => Number(a) - Number(b)).forEach(cod => {
            $sel.append(`<option value="${escapeHtml(cod)}">[${escapeHtml(cod)}] ${escapeHtml(mapa[cod])}</option>`);
        });
        $sel.val(null).trigger('change');
    }

    function applyFiltros() {
        if (!dadosBrutos.length) {
            renderTabela([]);
            renderTotais([]);
            return;
        }

        let arr = dadosBrutos.slice();
        const tipoData   = $('#tipoData').val();
        const dtIni      = $('#dtInicio').val();
        const dtFim      = $('#dtFim').val();
        const selProds   = $('#filtroProduto').val() || [];
        const filtroNota = ($('#filtroNota').val() || '').trim().toLowerCase();
        const filtroTxt  = ($('#filtroTexto').val() || '').trim().toLowerCase();

        // 1. Data Range (Local) - Opcional se a API já filtrou, mas bom pra garantir se mudar o tipoData
        if (dtIni && dtFim) {
            arr = arr.filter(it => {
                let campo = (tipoData === 'emissao') ? (it.nt_data_emissao || it.mv_data_emissao) : (it.mv_data || it.nt_data_entrada);
                const iso = normalizeDateIso(campo);
                return iso && iso >= dtIni && iso <= dtFim;
            });
        }

        // 2. Produto
        if (selProds.length > 0) {
            const setSel = new Set(selProds.map(String));
            arr = arr.filter(it => {
                const cod = it.pi_codigo || it.mv_produto;
                return cod && setSel.has(String(cod));
            });
        }

        // 3. Nota
        if (filtroNota) {
            arr = arr.filter(it => (it.nt_numero_nf || it.mv_doc || '').toString().toLowerCase().includes(filtroNota));
        }

        // 4. Texto Geral
        if (filtroTxt) {
            arr = arr.filter(it => {
                const searchStr = [it.pi_nome, it.pi_codigo, it.in_descricao_nota, it.mv_doc].join(' ').toLowerCase();
                return searchStr.includes(filtroTxt);
            });
        }

        itensFiltrados = arr;
        renderTabela(arr);
        renderTotais(arr);
    }

    // ====== RENDER ======
    function renderTotais(itens) {
        let qtdInt = 0, qtdNF = 0, vlrTotal = 0;

        itens.forEach(it => {
            const qInt = parseNumberAny(it.mv_quantidade_interna);
            const qNF = parseNumberAny(it.in_quantidade_nota);
            const vUnit = parseNumberAny(it.in_valor_unitario_nota);

            // Total nota calculado ou vindo da API
            const vTot = (it.in_valor_total_nota != null) ? Number(it.in_valor_total_nota) : (qNF * vUnit);

            qtdInt += qInt;
            qtdNF += qNF;
            vlrTotal += vTot;
        });

        $('#kpiQtd').text(brNumber(qtdInt, 4));
        $('#kpiQtdNF').text(brNumber(qtdNF, 4));
        $('#kpiVlrNota').text(brMoney(vlrTotal));
        $('#kpiRegistros').text(itens.length);
    }

    function renderTabela(itens) {
        const $tbody = $('#tabela-resultado tbody');
        $tbody.empty();

        if (itens.length === 0) {
            $tbody.html('<tr><td colspan="11" class="text-center muted" style="padding: 30px;">Nenhum registro encontrado.</td></tr>');
            return;
        }

        // Limit Render
        const limit = 500;
        const list = itens.slice(0, limit);

        list.forEach(it => {
            const nf        = it.nt_numero_nf || it.mv_doc || '';
            const dtEntrada = normalizeDateIso(it.mv_data || it.nt_data_entrada);
            const dtEmissao = normalizeDateIso(it.nt_data_emissao || it.mv_data_emissao);

            const qtdInt = parseNumberAny(it.mv_quantidade_interna);
            const vlrUnitInt = parseNumberAny(it.mv_valor_unitario_interno);

            const qtdNota = parseNumberAny(it.in_quantidade_nota);
            const vlrUnitNt = parseNumberAny(it.in_valor_unitario_nota);
            const vlrTotNt = (it.in_valor_total_nota != null) ? Number(it.in_valor_total_nota) : (qtdNota * vlrUnitNt);
            const fator = it.rf_fator_conversao != null ? Number(it.rf_fator_conversao) : null;

            $tbody.append(`
                <tr>
                    <td class="nowrap"><strong>${escapeHtml(nf)}</strong></td>
                    <td class="nowrap">${formatDateBR(dtEntrada)}</td>
                    <td class="nowrap">${formatDateBR(dtEmissao)}</td>

                    <td>
                        <div style="font-weight:500; color:var(--mrk-black);">[${it.pi_codigo || '-'}] ${escapeHtml(it.pi_nome)}</div>
                        <div class="text-small muted">Unid: ${escapeHtml(it.pi_unidade || '-')}</div>
                    </td>
                    <td class="text-right nowrap">${brNumber(qtdInt, 3)}</td>
                    <td class="text-right nowrap text-small muted">${brMoney(vlrUnitInt)}</td>

                    <td>
                        <div style="color:#555;">${escapeHtml(it.in_descricao_nota)}</div>
                        <div class="text-small muted">Unid: ${escapeHtml(it.in_unidade_nota || '-')}</div>
                    </td>
                    <td class="text-right nowrap">${brNumber(qtdNota, 3)}</td>
                    <td class="text-right nowrap text-small muted">${brMoney(vlrUnitNt)}</td>

                    <td class="text-right nowrap"><strong>${brMoney(vlrTotNt)}</strong></td>
                    <td class="text-right nowrap text-small">${fator ? brNumber(fator, 4) : '-'}</td>
                </tr>
            `);
        });

        if(itens.length > limit) {
            $tbody.append(`<tr><td colspan="11" class="text-center text-warning">Exibindo os primeiros ${limit} de ${itens.length} registros.</td></tr>`);
        }
    }

    function parseNumberAny(v) {
        if (v === null || v === undefined) return 0;
        if (typeof v === 'number') return v;
        const s = String(v).trim().replace(/[R$\s]/g, '');
        if (!s) return 0;
        // Se tem vírgula, assume padrão BR
        if (s.includes(',')) return Number(s.replace(/\./g, '').replace(',', '.'));
        return Number(s);
    }
</script>
</body>
</html>