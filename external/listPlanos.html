<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano de Contas | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* ====== ESTILO SKELETON ====== */
        .skeleton {
            background-color: #e2e5e7;
            background-image: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0));
            background-size: 200px 100%;
            background-repeat: no-repeat;
            display: inline-block;
            width: 100%; height: 15px; border-radius: 4px;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading { 0% { background-position: -200px 0; } 100% { background-position: calc(200px + 100%) 0; } }

        /* ====== AJUSTES GERAIS MRK ====== */
        html, body { background: transparent !important; }
        body { font-family: 'Poppins', sans-serif; background-color: #F4F7F6; }
        .container-fluid { padding-top: 15px; }

        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            border-top: 2px solid var(--mrk-blue) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05) !important;
        }
        .card .header h2 { font-family: 'Kanit', sans-serif; font-weight: 600; color: var(--mrk-blue); display: flex; align-items: center; gap: 10px; }

        /* Tabela e Hierarquia */
        .table thead th {
            background-color: #f8f9fa;
            color: var(--mrk-blue);
            font-family: 'Kanit', sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            text-align: center;
        }
        .col-action { width: 50px; text-align: center !important; }
        .action-icon {
            font-size: 20px;
            transition: transform 0.2s;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; text-decoration: none !important;
        }
        .action-icon:hover { transform: scale(1.2); }
        .icon-blue { color: var(--mrk-blue); }
        .icon-orange { color: var(--mrk-amber); }
        .icon-red { color: var(--mrk-red); }

        /* Estilo da Árvore */
        .toggle-child { cursor: pointer; color: var(--mrk-blue); margin-right: 8px; font-size: 14px; vertical-align: middle; }
        tr.has-children { background-color: #fcfcfc; }
        tr.has-children td.descricao-cell { font-weight: 600; color: #333; }

        /* Indentação de 2 em 2 dígitos */
        .hierarchy-level-0 { padding-left: 15px !important; }
        .hierarchy-level-1 { padding-left: 40px !important; }
        .hierarchy-level-2 { padding-left: 65px !important; }
        .hierarchy-level-3 { padding-left: 90px !important; }
        .hierarchy-level-4 { padding-left: 115px !important; }

        /* ====== MODAL PREMIUM ====== */
        .modal-content { border-radius: 12px; border: none; overflow: hidden; }
        .modal-header { position: relative; border-bottom: 2px solid var(--mrk-blue); padding: 18px 25px; background: #fff; }
        .modal-title { font-family: 'Kanit', sans-serif; color: var(--mrk-blue); font-weight: 600; }
        .btn-close-mrk { position: absolute; top: 15px; right: 15px; color: var(--mrk-red); font-size: 26px; background: none; border: none; outline: none !important; cursor: pointer; }

        label { font-family: 'Kanit', sans-serif; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-control { height: 38px; border-radius: 6px; border: 1px solid #ddd; }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <div class="card">
        <div class="header">
            <h2>
                <iconify-icon icon="icon-park-outline:nodes-group" width="24"></iconify-icon>
                GESTÃO DE PLANOS DE CONTAS
            </h2>
        </div>
        <div class="body">
            <div class="row clearfix" style="margin-bottom: 20px;">
                <div class="col-md-3 mb-2">
                    <label>Código</label>
                    <input type="text" id="filtroCodigo" class="form-control" placeholder="Ex: 0101">
                </div>
                <div class="col-md-6 mb-2">
                    <label>Descrição da Conta</label>
                    <input type="text" id="filtroDescricao" class="form-control" placeholder="Digite para filtrar...">
                </div>
                <div class="col-md-3 mb-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-success btn-block" id="btnNovoPlano" style="height:38px; background-color: var(--mrk-green) !important;">
                        <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> NOVO PLANO
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover" id="tabela-planos">
                    <thead>
                    <tr>
                        <th class="col-action">Edit</th>
                        <th class="col-action">OnOff</th>
                        <th class="col-action">Excluir</th>
                        <th style="width:180px; text-align: left;">Código</th>
                        <th style="text-align: left;">Descrição</th>
                    </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPlano" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="modalTitulo">Cadastrar Plano</h4>
                <button class="btn-close-mrk" data-dismiss="modal"><iconify-icon icon="icon-park-outline:close-small"></iconify-icon></button>
            </div>
            <div class="modal-body">
                <form id="formPlano">
                    <input type="hidden" id="planoId">
                    <div class="form-group mb-3">
                        <label>Código Estrutural *</label>
                        <input type="text" class="form-control" id="codigo" placeholder="Ex: 010101" required>
                    </div>
                    <div class="form-group mb-0">
                        <label>Descrição da Conta *</label>
                        <input type="text" class="form-control" id="descricao" placeholder="Ex: RECEITAS OPERACIONAIS" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #eee;">
                <button type="button" class="btn btn-primary" id="btnSalvar" style="background-color: var(--mrk-blue) !important; padding: 10px 30px;">
                    <iconify-icon icon="icon-park-outline:save" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> SALVAR PLANO
                </button>
                <button type="button" class="btn btn-link" data-dismiss="modal" style="color: #666;">CANCELAR</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    'use strict';

    $(document).ready(function () {
        const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php' : 'http://localhost/portal-mrk/api/v1/financeiro.php';
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token'), system_unit_id = params.get('system_unit_id');

        let planosCache = [];

        function getNivel(codigo) {
            const cleanCode = String(codigo || '').trim();
            const len = cleanCode.length;
            return Math.max(0, Math.floor(len / 2) - 1);
        }

        function showSkeletons() {
            const tb = $('#tableBody').empty();
            for(let i=0; i<8; i++) {
                tb.append(`<tr><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td class="col-action"><div class="skeleton" style="width:25px;height:25px;border-radius:50%"></div></td><td><div class="skeleton"></div></td><td><div class="skeleton"></div></td></tr>`);
            }
        }

        async function listarPlanos() {
            showSkeletons();
            try {
                const res = await axios.post(baseUrl, { method: 'listPlanos', token, data: { system_unit_id } });
                planosCache = res.data.data || (Array.isArray(res.data) ? res.data : []);
                renderTabela();
            } catch (e) { Swal.fire('Erro', 'Falha ao carregar planos.', 'error'); }
        }

        function renderTabela() {
            const tbody = $('#tableBody').empty();
            if(!planosCache.length) { tbody.append('<tr><td colspan="5" class="text-center p-4">Nenhum plano cadastrado.</td></tr>'); return; }

            // CORREÇÃO: Ordenação puramente textual (string) para preservar a hierarquia física
            planosCache.sort((a,b) => String(a.codigo).localeCompare(String(b.codigo)));

            const codigos = planosCache.map(p => String(p.codigo).trim());

            planosCache.forEach(p => {
                const codigo = String(p.codigo).trim();
                const nivel = getNivel(codigo);
                const hasChildren = codigos.some(c => c !== codigo && c.startsWith(codigo));
                const indentClass = 'hierarchy-level-' + nivel;

                // Mostra apenas o Nível 0 inicialmente
                const displayStyle = nivel === 0 ? '' : 'display:none;';

                tbody.append(`
                    <tr data-id="${p.id}" data-codigo="${codigo}" class="${hasChildren ? 'has-children' : ''}" style="${displayStyle}">
                        <td class="col-action"><a class="action-icon icon-blue btnEditar" data-toggle="tooltip" title="Editar"><iconify-icon icon="icon-park-outline:edit-two"></iconify-icon></a></td>
                        <td class="col-action"><a class="action-icon icon-orange btnInativar" data-toggle="tooltip" title="Inativar"><iconify-icon icon="icon-park-outline:power"></iconify-icon></a></td>
                        <td class="col-action"><a class="action-icon icon-red btnExcluir" data-toggle="tooltip" title="Excluir"><iconify-icon icon="icon-park-outline:delete-five"></iconify-icon></a></td>
                        <td class="codigo-cell ${indentClass}">
                            ${hasChildren ? `<iconify-icon icon="icon-park-outline:right" class="toggle-child" data-expanded="0"></iconify-icon>` : '<span style="margin-right:22px;"></span>'}
                            <b>${codigo}</b>
                        </td>
                        <td class="descricao-cell">${p.descricao}</td>
                    </tr>
                `);
            });

            $('[data-toggle="tooltip"]').tooltip({ container: 'body' });
        }

        $(document).on('click', '.toggle-child', function(e) {
            const icon = $(this);
            const tr = icon.closest('tr');
            const codigo = tr.data('codigo');
            const expanded = icon.attr('data-expanded') === '1';

            if(expanded) {
                icon.attr('icon', 'icon-park-outline:right').attr('data-expanded', '0');
                $(`#tableBody tr`).each(function() {
                    const rowCod = String($(this).data('codigo'));
                    if(rowCod.startsWith(codigo) && rowCod !== codigo) {
                        $(this).hide().find('.toggle-child').attr('icon', 'icon-park-outline:right').attr('data-expanded', '0');
                    }
                });
            } else {
                icon.attr('icon', 'icon-park-outline:down').attr('data-expanded', '1');
                const meuNivel = getNivel(codigo);
                $(`#tableBody tr`).each(function() {
                    const rowCod = String($(this).data('codigo'));
                    if(rowCod.startsWith(codigo) && rowCod !== codigo && getNivel(rowCod) === meuNivel + 1) {
                        $(this).show();
                    }
                });
            }
        });

        // --- FILTROS ---
        $('#filtroCodigo, #filtroDescricao').on('input', function() {
            const fCod = $('#filtroCodigo').val().toLowerCase();
            const fDes = $('#filtroDescricao').val().toLowerCase();

            if(!fCod && !fDes) { renderTabela(); return; }

            $('#tableBody tr').each(function() {
                const c = String($(this).find('.codigo-cell').text()).toLowerCase();
                const d = $(this).find('.descricao-cell').text().toLowerCase();
                const match = c.includes(fCod) && d.includes(fDes);
                $(this).toggle(match);
                $(this).find('.toggle-child').hide();
            });
        });

        $('#btnNovoPlano').click(() => {
            $('#formPlano')[0].reset();
            $('#planoId').val('');
            $('#codigo').prop('disabled', false);
            $('#modalTitulo').text('Cadastrar Plano de Contas');
            $('#modalPlano').modal('show');
        });

        $(document).on('click', '.btnEditar', function() {
            const id = $(this).closest('tr').data('id');
            const p = planosCache.find(x => String(x.id) === String(id));
            $('#planoId').val(p.id);
            $('#codigo').val(p.codigo).prop('disabled', true);
            $('#descricao').val(p.descricao);
            $('#modalTitulo').text('Editar Plano');
            $('#modalPlano').modal('show');
        });

        $('#btnSalvar').click(async function() {
            const id = $('#planoId').val();
            const payload = { id, codigo: $('#codigo').val(), descricao: $('#descricao').val(), system_unit_id };
            if(!payload.codigo || !payload.descricao) return Swal.fire('Atenção', 'Preencha os campos obrigatórios.', 'warning');

            Swal.fire({ title: 'Gravando...', didOpen: () => Swal.showLoading() });
            try {
                const method = id ? 'updatePlano' : 'createPlano';
                await axios.post(baseUrl, { method, token, data: payload });
                Swal.fire({ icon: 'success', title: 'Sucesso!', timer: 1500, showConfirmButton: false });
                $('#modalPlano').modal('hide');
                listarPlanos();
            } catch (e) { Swal.fire('Erro', 'Falha ao salvar.', 'error'); }
        });

        listarPlanos();
    });
</script>
</body>
</html>