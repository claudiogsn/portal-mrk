<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Planos de Contas</title>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/plugins/jquery-datatable/skin/bootstrap/css/dataTables.bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">

    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="bsb/plugins/node-waves/waves.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .form-control { margin-bottom: 10px; }
        th, td { vertical-align: middle !important; }

        @media (max-width: 768px) {
            body, .form-control, .modal-content, table, th, td, button {
                font-size: 12px !important;
            }
            h2, .modal-title { font-size: 16px !important; }
            .btn { padding: 6px 10px !important; font-size: 12px !important; }
            .table-responsive { overflow-x: auto; }
            .modal-dialog { margin: 10px; }
            .row > div[class*="col-"] { margin-bottom: 10px; }
            .form-control { height: 30px; padding: 4px 8px; }

            #tabela-planos td,
            #tabela-planos th { white-space: nowrap; }
        }

        i.blue { color: #2196F3; cursor: pointer; }
        i.orange { color: #FF9800; cursor: pointer; }
        i.red { color: #F44336; cursor: pointer; }

        /* Hierarquia do plano de contas */
        .hierarchy-cell {
            white-space: nowrap;
        }
        .toggle-child {
            cursor: pointer;
            font-weight: bold; /* caret em negrito */
            margin-right: 6px;
        }
        .plano-checkbox {
            margin: 0 6px 0 0;
        }

        .codigo-cell {
            white-space: nowrap;
        }

        /* indentação por nível */
        .hierarchy-level-0  { padding-left: 4px !important; }
        .hierarchy-level-1 { padding-left: 20px !important; }
        .hierarchy-level-2 { padding-left: 36px !important; }
        .hierarchy-level-3 { padding-left: 52px !important; }
        .hierarchy-level-4 { padding-left: 74px !important; }
        .hierarchy-level-5 { padding-left: 80px !important; }
        .hierarchy-level-6 { padding-left: 84px !important; }

        /* Pais (quem tem filhos) em negrito */
        tr.has-children td.codigo-cell,
        tr.has-children td.descricao-cell {
            font-weight: bold;
        }
    </style>
</head>

<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header">
            <h2>Planos de Contas</h2>
        </div>
        <div class="body">

            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="filtroCodigo" class="form-control" placeholder="Filtrar por código">
                </div>
                <div class="col-md-4">
                    <input type="text" id="filtroDescricao" class="form-control" placeholder="Filtrar por descrição">
                </div>
                <div class="col-md-4 text-right">
                    <button class="btn btn-success" id="btnNovoPlano">
                        <i class="fa fa-plus"></i> Novo Plano
                    </button>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabela-planos">
                    <thead>
                    <tr>
                        <th style="width:60px;"></th> <!-- caret + checkbox -->
                        <th style="width:150px;">Código</th>
                        <th>Descrição</th>
                        <th style="width:110px;">Ações</th> <!-- ações no final -->
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<!-- Modal Novo Plano -->
<div class="modal fade" id="modalPlano" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">Cadastrar Plano de Contas</h4>
            </div>

            <div class="modal-body">
                <form id="formPlano">
                    <div class="form-group">
                        <label for="codigo">Código *</label>
                        <input type="text" class="form-control" id="codigo" placeholder="Ex: 0101" required>
                    </div>

                    <div class="form-group">
                        <label for="descricao">Descrição *</label>
                        <input type="text" class="form-control" id="descricao" placeholder="Ex: Vendas de Produtos" required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="salvarPlano">Salvar</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<!-- Modal Editar Plano -->
<div class="modal fade" id="modalEditarPlano" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title">Editar Plano de Contas</h4>
            </div>

            <div class="modal-body">
                <form id="formEditarPlano">
                    <input type="hidden" id="editarPlanoId">

                    <div class="form-group">
                        <label for="editarCodigo">Código</label>
                        <input type="text" class="form-control" id="editarCodigo" disabled>
                    </div>

                    <div class="form-group">
                        <label for="editarDescricao">Descrição *</label>
                        <input type="text" class="form-control" id="editarDescricao" required>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="salvarEdicaoPlano">Salvar Alterações</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
            </div>

        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id');

    let planosCache = [];

    // ===== Helpers de hierarquia =====
    function getNivel(codigo) {
        const len = (codigo || '').length;

        if (len <= 1)  return 0;  // Ex: "1"
        if (len <= 3)  return 1;  // Ex: "101"
        if (len <= 5)  return 2;  // Ex: "10101"
        if (len <= 7)  return 3;  // Ex: "1010101"
        if (len <= 9)  return 4;  // Ex: "101010101"
        if (len <= 11) return 5;  // Ex: "10101010101"
        return 6;                 // níveis ainda mais profundos
    }


    function buildHierarchyMaps(codigos) {
        const parentByCodigo = {};
        const childrenByCodigo = {};

        codigos.forEach(c => {
            const cod = (c || '').trim();
            if (!cod) return;
            childrenByCodigo[cod] = [];
        });

        codigos.forEach(codigo => {
            codigo = (codigo || '').trim();
            if (!codigo) return;

            let parent = null;
            codigos.forEach(cand => {
                cand = (cand || '').trim();
                if (!cand || cand === codigo) return;

                if (codigo.startsWith(cand)) {
                    if (!parent || cand.length > parent.length) {
                        parent = cand;
                    }
                }
            });

            if (parent) {
                parentByCodigo[codigo] = parent;
                childrenByCodigo[parent].push(codigo);
            }
        });

        return { parentByCodigo, childrenByCodigo };
    }

    $(document).ready(() => {
        if (!token || !system_unit_id) {
            Swal.fire('Erro', 'Token ou system_unit_id não informado na URL.', 'error');
            return;
        }

        listarPlanos();

        $('#filtroCodigo, #filtroDescricao').on('input', filtrarTabela);
        $('#btnNovoPlano').click(() => {
            $('#formPlano')[0].reset();
            $('#modalPlano').modal('show');
        });

        $('#salvarPlano').click(salvarPlano);
        $('#salvarEdicaoPlano').click(salvarEdicaoPlano);
    });

    async function listarPlanos() {
        try {
            const res = await axios.post(baseUrl, {
                method: 'listPlanos',
                token,
                data: { system_unit_id }
            });

            const dados = Array.isArray(res.data) ? res.data : (res.data.data || []);
            planosCache = dados.slice(); // copia

            // Ordena pelo código para manter a hierarquia visualmente organizada
            planosCache.sort((a, b) => {
                const ca = (a.codigo || '').trim();
                const cb = (b.codigo || '').trim();
                return ca.localeCompare(cb);
            });

            const codigos = planosCache
                .map(p => (p.codigo || '').trim())
                .filter(c => c);

            const hierarchy = buildHierarchyMaps(codigos);

            const tbody = $('#tabela-planos tbody');
            tbody.empty();

            if (!planosCache.length) {
                tbody.append('<tr><td colspan="4" class="text-center">Nenhum plano cadastrado.</td></tr>');
                return;
            }

            planosCache.forEach(p => {
                const codigo = (p.codigo || '').trim();
                const descricao = (p.descricao || '').trim();

                const parentCodigo = hierarchy.parentByCodigo[codigo] || '';
                const children = hierarchy.childrenByCodigo[codigo] || [];
                const hasChildren = children.length > 0;
                const nivel = getNivel(codigo);
                const indentClass = 'hierarchy-level-' + nivel;

                let toggleIconHtml = '';
                if (hasChildren) {
                    // começa recolhido
                    toggleIconHtml = `
                        <i class="fa fa-chevron-right toggle-child"
                           data-codigo="${codigo}"
                           data-expanded="0"></i>
                    `;
                } else {
                    toggleIconHtml = `
                        <i class="fa fa-circle"
                           style="opacity:0; font-size:6px;"></i>
                    `;
                }

                tbody.append(`
                    <tr data-id="${p.id}"
                        data-codigo="${codigo}"
                        data-parent="${parentCodigo}"
                        class="${hasChildren ? 'has-children' : ''}">
                        <td class="hierarchy-cell ${indentClass}">
                            ${toggleIconHtml}
                            <input type="checkbox" class="plano-checkbox">
                        </td>
                        <td class="codigo-cell ${indentClass}">
                            ${codigo}
                        </td>
                        <td class="descricao-cell">
                            ${descricao}
                        </td>
                        <td>
                            <a href="#" class="editar-plano" title="Editar">
                                <i class="fa fa-edit blue"></i>
                            </a>
                            &nbsp;
                            <a href="#" class="inativar-plano" title="Inativar">
                                <i class="fa fa-power-off orange"></i>
                            </a>
                            &nbsp;
                            <a href="#" class="excluir-plano" title="Excluir">
                                <i class="fa fa-trash red"></i>
                            </a>
                        </td>
                    </tr>
                `);
            });

            // Tudo começa recolhido: esconde quem tem parent
            $('#tabela-planos tbody tr').each(function () {
                const $tr = $(this);
                const parent = $tr.data('parent');
                if (parent) {
                    $tr.attr('data-hidden-by-parent', '1');
                }
            });

            filtrarTabela();

        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Falha ao listar planos de contas.', 'error');
        }
    }

    function filtrarTabela() {
        const codigo = $('#filtroCodigo').val().toLowerCase();
        const descricao = $('#filtroDescricao').val().toLowerCase();

        $('#tabela-planos tbody tr').each(function () {
            const $tr = $(this);
            const textoCodigo = $tr.find('td:nth-child(2)').text().toLowerCase(); // Código
            const textoDescricao = $tr.find('td:nth-child(3)').text().toLowerCase(); // Descrição
            const hiddenByParent = $tr.attr('data-hidden-by-parent') === '1';

            const matchCodigo = codigo === '' || textoCodigo.startsWith(codigo);
            const matchDescricao = descricao === '' || textoDescricao.includes(descricao);

            $tr.toggle(matchCodigo && matchDescricao && !hiddenByParent);
        });
    }

    // Toggle hierarquia (expandir/recolher filhos)
    $(document).on('click', '.toggle-child', function (e) {
        e.stopPropagation();
        const icon = $(this);
        const codigo = String(icon.data('codigo') || '');
        const expanded = String(icon.data('expanded')) === '1';

        if (!codigo) return;

        if (expanded) {
            // Recolher: esconde todos os descendentes e reseta ícones deles
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
            icon.data('expanded', '0');

            $('#tabela-planos tbody tr').each(function () {
                const $tr = $(this);
                const rowCodigo = String($tr.data('codigo') || '');
                if (rowCodigo !== codigo && rowCodigo.startsWith(codigo)) {
                    $tr.attr('data-hidden-by-parent', '1');
                    $tr.find('.toggle-child').each(function () {
                        $(this)
                            .removeClass('fa-chevron-down')
                            .addClass('fa-chevron-right')
                            .data('expanded', '0');
                    });
                }
            });
        } else {
            // Expandir: mostra apenas os filhos diretos
            icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            icon.data('expanded', '1');

            $('#tabela-planos tbody tr').each(function () {
                const $tr = $(this);
                const parent = String($tr.data('parent') || '');
                if (parent && parent === codigo) {
                    $tr.removeAttr('data-hidden-by-parent');
                }
            });
        }

        filtrarTabela();
    });

    async function salvarPlano() {
        const codigo = $('#codigo').val().trim();
        const descricao = $('#descricao').val().trim();

        if (!codigo || !descricao) {
            return Swal.fire('Atenção', 'Preencha Código e Descrição.', 'warning');
        }

        Swal.fire({
            title: 'Salvando...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'createPlano',
                token,
                data: {
                    system_unit_id,
                    codigo,
                    descricao
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Atenção', res.data.message || 'Não foi possível criar o plano.', 'warning');
            }

            Swal.fire('Sucesso', (res.data && res.data.message) || 'Plano criado com sucesso.', 'success');
            $('#modalPlano').modal('hide');
            $('#formPlano')[0].reset();
            listarPlanos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao criar plano.', 'error');
        }
    }

    // Abrir modal editar
    $(document).on('click', '.editar-plano', function (e) {
        e.preventDefault();
        const $tr = $(this).closest('tr');
        const id = $tr.data('id');
        const codigo = $tr.data('codigo');
        const plano = planosCache.find(p => String(p.id) === String(id));

        $('#editarPlanoId').val(id);
        $('#editarCodigo').val(codigo);
        $('#editarDescricao').val(plano ? (plano.descricao || '') : '');

        $('#modalEditarPlano').modal('show');
    });

    async function salvarEdicaoPlano() {
        const id = $('#editarPlanoId').val();
        const descricao = $('#editarDescricao').val().trim();

        if (!descricao) {
            return Swal.fire('Atenção', 'Descrição é obrigatória.', 'warning');
        }

        const confirmacao = await Swal.fire({
            title: 'Confirmar alteração?',
            text: 'Deseja salvar as alterações deste plano?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sim, salvar',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmacao.isConfirmed) return;

        Swal.fire({
            title: 'Salvando...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'updatePlano',
                token,
                data: {
                    id,
                    descricao
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Erro', res.data.message || 'Erro ao atualizar plano.', 'error');
            }

            Swal.fire('Sucesso', (res.data && res.data.message) || 'Plano atualizado com sucesso.', 'success');
            $('#modalEditarPlano').modal('hide');
            listarPlanos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao atualizar plano.', 'error');
        }
    }

    // Inativar plano
    $(document).on('click', '.inativar-plano', async function (e) {
        e.preventDefault();
        const $tr = $(this).closest('tr');
        const codigo = $tr.data('codigo');

        const confirmacao = await Swal.fire({
            title: 'Inativar plano?',
            text: `Deseja inativar o plano ${codigo}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, inativar',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmacao.isConfirmed) return;

        Swal.fire({
            title: 'Inativando...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'inativarPlano',
                token,
                data: {
                    system_unit_id,
                    codigo
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Erro', res.data.message || 'Erro ao inativar plano.', 'error');
            }

            Swal.fire('Sucesso', (res.data && res.data.message) || 'Plano inativado com sucesso.', 'success');
            listarPlanos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao inativar plano.', 'error');
        }
    });

    // Excluir plano
    $(document).on('click', '.excluir-plano', async function (e) {
        e.preventDefault();
        const $tr = $(this).closest('tr');
        const codigo = $tr.data('codigo');

        const confirmacao = await Swal.fire({
            title: 'Excluir plano?',
            text: `Deseja excluir definitivamente o plano ${codigo}? Esta ação não poderá ser desfeita.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, excluir',
            cancelButtonText: 'Cancelar'
        });
        if (!confirmacao.isConfirmed) return;

        Swal.fire({
            title: 'Excluindo...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'deletePlano',
                token,
                data: {
                    system_unit_id,
                    codigo
                }
            });

            Swal.close();

            if (res.data && res.data.success === false) {
                return Swal.fire('Atenção', res.data.message || 'Não foi possível excluir o plano.', 'warning');
            }

            Swal.fire('Sucesso', (res.data && res.data.message) || 'Plano excluído com sucesso.', 'success');
            listarPlanos();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao excluir plano.', 'error');
        }
    });
</script>

</body>
</html>
