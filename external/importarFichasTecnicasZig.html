<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Importar Fichas T√©cnicas</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/css/style.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/css/themes/all-themes.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        .loja {
            font-size: 16px;
        }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <h2></h2>
    </div>
    <div class="row clearfix">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="card">
                <div class="header">
                    <h2>Importa√ß√£o de Fichas T√©cnicas Zig</h2>
                </div>
                <div class="body">
                    <p>
                        <strong>Loja:</strong>
                        <span class="label bg-blue loja" id="lojaInfo">carregando...</span>
                    </p>

                    <p><strong>Este √© um processo de importa√ß√£o de fichas t√©cnicas baseado em um arquivo Excel exportado do sistema Menew.</strong></p>
                    <ol>
                        <li>Acesse o <strong>Portal Menew</strong>.</li>
                        <li>V√° at√© <strong>Estoque &gt; Relat√≥rios Web &gt; Fichas de Produ√ß√£o, Manipula√ß√£o e T√©cnicas</strong>.</li>
                        <li>Selecione o <strong>Estabelecimento</strong> que deseja importar e o Tipo de Ficha como <strong>T√©cnica</strong></li>
                        <li>Clique em <strong>Atualizar</strong> e aguarde o carregamento.</li>
                        <li>Clique no <strong>√≠cone do Excel</strong> para exportar os dados.</li>
                        <li>Salve o arquivo, geralmente salvo como <em>Relat√≥rio - Estoque Web - Fichas T√©cnicas (...).xlsx</em>.</li>
                        <li>Volte para esta tela, clique em <strong>Selecionar Arquivo</strong> e escolha o arquivo baixado.</li>
                        <li>Por fim, clique em <strong>Importar Fichas</strong>.</li>
                    </ol>
                    <p style="color: red; font-style: italic;">
                        * Aten√ß√£o: Ao realizar esta importa√ß√£o, todas as fichas j√° cadastradas nesta loja ser√£o <strong>sobrescritas</strong> com os dados do Excel selecionado.
                    </p>

                    <form id="importForm">
                        <div class="form-group">
                            <label for="excelFile">Arquivo Excel (.xlsx)</label>
                            <input type="file" id="excelFile" class="form-control" accept=".xls,.xlsx" required>
                        </div>
                        <button type="submit" class="btn btn-primary waves-effect">Importar Fichas</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://portal.mrksolucoes.com.br/external/bsb/plugins/node-waves/waves.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/index.php' : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const unit_name = urlParams.get('unit_name');

    function atualizarInfoLoja() {
        const lojaSpan = document.getElementById('lojaInfo');
        if (unit_id && unit_name) {
            lojaSpan.innerText = `${unit_id} - ${decodeURIComponent(unit_name)}`;
        } else {
            lojaSpan.innerText = 'n√£o informado';
        }
    }

    document.addEventListener('DOMContentLoaded', atualizarInfoLoja);

    document.getElementById('importForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const input = document.getElementById('excelFile');
        const file = input.files[0];

        if (!file) {
            Swal.fire('Erro', 'Selecione um arquivo Excel.', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = async function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

            console.log('Conte√∫do bruto da planilha:', rows); // üëà Aqui o log da tabela inteira


            const colSku = 0;
            const colInsumo = 1;
            const colQuantidade = 2;

            const itens = [];

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row[colSku] || !row[colInsumo]) continue;

                let rawQtd = parseFloat(row[colQuantidade]?.toString().replace(',', '.')) || 0;
                let qtd = Math.round(rawQtd * 1000) / 1000;
                if (qtd === 0) qtd = 0.001;

                itens.push({
                    sku_zig: row[colSku].toString().trim(),
                    insumo: row[colInsumo].toString().trim(),
                    quantidade: qtd
                });
            }

            if (!itens.length) {
                Swal.fire('Erro', 'Nenhum dado v√°lido encontrado na planilha.', 'error');
                return;
            }

            // Enviar para o backend
            Swal.fire({ title: 'Importando fichas...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const response = await axios.post(baseUrl, {
                    method: 'importCompositionsZig',
                    token: token,
                    data: {
                        system_unit_id: unit_id,
                        itens: itens
                    }
                });

                Swal.close();

                if (response.data.success) {
                    Swal.fire('Sucesso', 'Fichas importadas com sucesso!', 'success');
                } else {
                    let msg = response.data.message || 'Erro na importa√ß√£o.';
                    if (response.data.erros_sku_nao_encontrado?.length || response.data.erros_insumo_nao_encontrado?.length) {
                        msg += '<br><br><b>Erros:</b><ul>';
                        if (response.data.erros_sku_nao_encontrado?.length) {
                            msg += `<li>SKUs n√£o encontrados: ${response.data.erros_sku_nao_encontrado.join(', ')}</li>`;
                        }
                        if (response.data.erros_insumo_nao_encontrado?.length) {
                            msg += `<li>Insumos n√£o encontrados: ${response.data.erros_insumo_nao_encontrado.map(e => `${e.sku_zig} ‚Üí ${e.insumo}`).join(', ')}</li>`;
                        }
                        msg += '</ul>';
                    }
                    Swal.fire({ icon: 'error', title: 'Importa√ß√£o incompleta', html: msg });
                }
            } catch (err) {
                Swal.close();
                Swal.fire('Erro', 'Erro de comunica√ß√£o com o servidor.', 'error');
                console.error(err);
            }
        };

        reader.readAsArrayBuffer(file);
    });
</script>
</body>
</html>
