<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Notas Fiscais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="bsb/favicon.ico" type="image/x-icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>
    <script src="https://kit.fontawesome.com/313adf4cdc.js" crossorigin="anonymous"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/css/themes/all-themes.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        body { background-color: #F4F7F6; }

        /* Ajustes de Layout */
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        .btn-header-group { display: flex; gap: 10px; }

        /* Ajuste Select2 para tema MRK */
        .select2-container .select2-selection--single {
            height: 34px !important;
            border: 1px solid #ccc !important;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 34px !important;
            font-family: 'Poppins', sans-serif;
            color: #555;
        }

        /* --- CORREÇÃO DO MODAL FULLSCREEN --- */
        .modal-fullscreen {
            padding-right: 0 !important; /* Evita shift do scroll */
        }
        .modal-fullscreen .modal-dialog {
            width: 100vw;       /* Força largura total da viewport */
            height: 100vh;      /* Força altura total da viewport */
            max-width: none;    /* Remove limite do bootstrap */
            margin: 0;          /* Remove margens */
            padding: 0;
        }
        .modal-fullscreen .modal-content {
            height: 100%;       /* Ocupa todo o dialog */
            border: 0;
            border-radius: 0;
            display: flex;      /* Flexbox para gerenciar Header vs Body */
            flex-direction: column;
        }
        .modal-fullscreen .modal-header {
            flex: 0 0 auto;     /* Altura fixa baseada no conteúdo */
            background: #fff;
            z-index: 10;
            border-bottom: 1px solid #ddd;
        }
        .modal-fullscreen .modal-body {
            flex: 1 1 auto;     /* Cresce para ocupar o resto da tela */
            padding: 0 !important;
            overflow: hidden;   /* Evita scroll duplo com o iframe */
            position: relative;
        }
        .modal-iframe-full {
            position: absolute; /* Garante que ocupe o container relativo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Botão Fechar Modal Vermelho */
        .close-x-red {
            color: var(--mrk-red);
            opacity: 1;
            font-size: 28px;
            font-weight: bold;
            text-shadow: none;
            transition: transform 0.2s;
            margin-top: -2px;
        }
        .close-x-red:hover { transform: scale(1.2); color: #b71c1c; }

        /* Badges e Ícones de Status */
        .status-icon { font-size: 16px; vertical-align: middle; }
        .status-pendente { color: var(--mrk-amber); animation: swing 2s infinite ease-in-out; }
        .status-ok { color: var(--mrk-green); }

        @keyframes swing {
            0%, 100% { transform: rotate(0deg); }
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-10deg); }
            60% { transform: rotate(5deg); }
            80% { transform: rotate(-5deg); }
        }

        /* Ajuste Chave de Acesso */
        .chave-acesso {
            font-family: 'Poppins', monospace; /* Monospace ajuda na leitura de números */
            font-size: 11px;
            color: #555;
            letter-spacing: 0.5px;
            word-break: break-all;
        }

        /* Link de ação sempre visível */
        a.abrir-estoque, a.abrir-financeiro {
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            padding: 4px;
        }
        a.abrir-estoque:hover, a.abrir-financeiro:hover {
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .header-flex { flex-direction: column; align-items: flex-start; gap: 10px; }
            .btn-header-group { width: 100%; flex-direction: column; }
            .btn-header-group .btn { width: 100%; }
        }
    </style>
</head>
<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <h2> </h2>
        <br>
    </div>

    <div class="card">
        <div class="header header-flex">
            <h2>
                <iconify-icon icon="icon-park-outline:bill" width="24" style="color: var(--mrk-blue); vertical-align: bottom; margin-right: 5px;"></iconify-icon>
                NOTAS FISCAIS DE ENTRADA
            </h2>
            <div class="btn-header-group">
                <button type="button" class="btn btn-primary" id="btnAbrirImportacao" style="background-color: var(--mrk-blue) !important;">
                    <iconify-icon icon="icon-park-outline:file-import" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> IMPORTAR XML
                </button>
                <button type="button" class="btn btn-default" id="btnEntradaAvulsa" style="background-color: #fff !important; border: 1px solid #ddd; color: #555;">
                    <iconify-icon icon="icon-park-outline:plus" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> ENTRADA AVULSA
                </button>
            </div>
        </div>

        <div class="body">
            <div class="row clearfix">
                <div class="col-md-2">
                    <label class="muted">Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="muted">Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-2">
                    <label class="muted">Filtrar Por</label>
                    <select id="filtroTipoData" class="form-control">
                        <option value="emissao" selected>Data Emissão</option>
                        <option value="entrada">Data Entrada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="muted">Fornecedor (CPF/CNPJ)</label>
                    <input type="text" id="filtroCnpj" class="form-control" placeholder="Digite apenas números">
                </div>
                <div class="col-md-3">
                    <label class="muted">Status da Nota</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todos</option>
                        <option value="sem_pendencia">Concluídas (Estoque + Fin.)</option>
                        <option value="pend_est">Pendente Estoque</option>
                        <option value="pend_fin">Pendente Financeiro</option>
                    </select>
                </div>
            </div>

            <div class="row clearfix" style="margin-top: 10px;">
                <div class="col-md-3">
                    <label class="muted">Número da Nota</label>
                    <input type="text" id="filtroNumeroNF" class="form-control" placeholder="Ex: 12345">
                </div>
                <div class="col-md-6">
                    <label class="muted">Chave de Acesso</label>
                    <input type="text" id="filtroChave" class="form-control" placeholder="Digite a chave parcial ou completa">
                </div>
                <div class="col-md-3" style="display: flex; align-items: flex-end;">
                    <button type="button" class="btn btn-success btn-block" id="btnListarNotas" style="background-color: var(--mrk-green) !important;">
                        <iconify-icon icon="icon-park-outline:search" style="vertical-align: middle; margin-right: 5px;"></iconify-icon> FILTRAR
                    </button>
                </div>
            </div>

            <hr>

            <div class="row">
                <div class="col-md-4">
                    <div class="kpi orange clickable" id="btnVerMaisFin">
                        <h4><span id="kpiPendFin">0</span></h4>
                        <small>PENDÊNCIAS FINANCEIRO</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi orange clickable" id="btnVerMaisEst">
                        <h4><span id="kpiPendEst">0</span></h4>
                        <small>PENDÊNCIAS ESTOQUE</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi blue">
                        <h4><span id="kpiSomatorio">R$ 0,00</span></h4>
                        <small>TOTAL DAS NOTAS LISTADAS</small>
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabelaNotas">
                    <thead>
                    <tr>
                        <th style="width: 40px;"></th> <th>Número</th>
                        <th>Emissão</th>
                        <th>Fornecedor</th>
                        <th>Chave de Acesso</th>
                        <th>CNPJ</th>
                        <th class="text-right">Valor Total</th>
                        <th class="text-center">Tipo</th>
                        <th class="text-center">Estoque</th>
                        <th class="text-center">Financ.</th>
                        <th>Entrada</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImportacao" tabindex="-1">
    <div class="modal-dialog modal-lg" style="width: 90%; max-width: 1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" style="font-family: 'Kanit', sans-serif;">Importar XML</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeImportacao" style="width:100%; height:600px; border:none;"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinanceiroIframe" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"></h4>
                <button type="button" class="close close-x-red" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="iframeFinanceiro" class="modal-iframe-full"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEntradaEstoque" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"></h4>
                <button type="button" class="close close-x-red" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="iframeEntradaEstoque" class="modal-iframe-full"></iframe>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';
    const modelo = { tag: 'nfe' };

    let notasOriginais = [];

    $(document).ready(function () {
        listarNotas(); // Carrega inicial

        $('#btnListarNotas').click(function() {
            aplicarFiltros();
        });

        // Inputs de Filtro (Enter ou Change)
        $('#filtroNumeroNF, #filtroChave, #filtroCnpj').on('keyup', function(e) {
            if (e.key === 'Enter') applyingFilters();
        });
        $('#filtroDataInicial, #filtroDataFinal, #filtroStatus').on('change', applyingFilters);

        // Ações de Botões Header
        $('#btnAbrirImportacao').click(() => {
            const url = `${baseUrlRedirect}/external/importXmlNfe.html?username=${username}&token=${token}&unit_id=${unit_id}&tag=${modelo.tag}&user_id=${encodeURIComponent(username)}`;
            $('#iframeImportacao').attr('src', url);
            $('#modalImportacao').modal('show');
        });

        $('#btnEntradaAvulsa').click(() => {
            const qs = `system_unit_id=${unit_id}&token=${token}&usuario_id=${username}`;
            const url = `${baseUrlRedirect}/external/entradaNotaAvulsa.html?${qs}`;
            $('#iframeEntradaEstoque').attr('src', url);
            $('#modalEntradaEstoque').modal('show');
        });

        // KPIs Click
        $('#btnVerMaisFin').on('click', function() { $('#filtroStatus').val('pend_fin').trigger('change'); });
        $('#btnVerMaisEst').on('click', function() { $('#filtroStatus').val('pend_est').trigger('change'); });

        // Refresh ao fechar modais
        $('#modalImportacao, #modalEntradaEstoque, #modalFinanceiroIframe').on('hidden.bs.modal', function () {
            $(this).find('iframe').attr('src', 'about:blank');
            listarNotas(); // Recarrega dados do servidor
        });
    });

    function applyingFilters() {
        aplicarFiltros();
    }

    // --- ABRIR MODAIS ---
    $(document).on('click', 'a.abrir-financeiro', function (e) {
        e.preventDefault();
        const chave = $(this).data('chave') || '';
        const id    = $(this).data('id') || '';
        const fornecedor = $(this).data('fornecedor') || '';
        const urlIframe = `${baseUrlRedirect}/external/financeiroNota.html?token=${token}&unit_id=${unit_id}&chave_acesso=${chave}&id=${id}&fornecedor=${encodeURIComponent(fornecedor)}`;
        $('#iframeFinanceiro').attr('src', urlIframe);
        $('#modalFinanceiroIframe').modal('show');
    });

    $(document).on('click', 'a.abrir-estoque', function (e) {
        e.preventDefault();
        const tipoRaw = ($(this).data('tipo') || 'i').toString().toLowerCase();

        if (tipoRaw === 'a') { // Avulsa
            const notaId = $(this).data('nota-id');
            const url = `${baseUrlRedirect}/external/entradaNotaAvulsa.html?system_unit_id=${unit_id}&token=${token}&usuario_id=${username}&nota_id=${notaId}`;
            $('#iframeEntradaEstoque').attr('src', url);
        } else { // XML
            const chave = $(this).data('chave');
            const fornecedor = $(this).data('fornecedor') || '';
            const url = `${baseUrlRedirect}/external/entradaNotaEstoque.html?system_unit_id=${unit_id}&chave_acesso=${chave}&fornecedor_id=${fornecedor}&token=${token}&usuario_id=${username}`;
            $('#iframeEntradaEstoque').attr('src', url);
        }
        $('#modalEntradaEstoque').modal('show');
    });

    // --- CORE FUNCTIONS ---
    async function listarNotas() {
        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotas',
                token,
                data: { system_unit_id: unit_id }
            });

            if (res.data.success) {
                notasOriginais = res.data.data || [];
                aplicarFiltros();
                Swal.close();
            } else {
                Swal.fire('Erro', 'Não foi possível carregar as notas.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function aplicarFiltros() {
        let dataFiltrada = [...notasOriginais];

        const dataIni   = $('#filtroDataInicial').val();
        const dataFim   = $('#filtroDataFinal').val();
        const tipoData  = $('#filtroTipoData').val();
        const cnpj      = ($('#filtroCnpj').val() || '').replace(/\D/g, '');
        const status    = $('#filtroStatus').val();
        const campoData = (tipoData === 'entrada') ? 'data_entrada' : 'data_emissao';
        const numeroNF  = ($('#filtroNumeroNF').val() || '').trim().toLowerCase();
        const chave     = ($('#filtroChave').val() || '').replace(/\D/g, '');

        // Filtros Lógicos
        if (dataIni) dataFiltrada = dataFiltrada.filter(n => n[campoData] && n[campoData].substr(0, 10) >= dataIni);
        if (dataFim) dataFiltrada = dataFiltrada.filter(n => n[campoData] && n[campoData].substr(0, 10) <= dataFim);
        if (cnpj) dataFiltrada = dataFiltrada.filter(n => (n.fornecedor_cnpj || '').replace(/\D/g, '').includes(cnpj));
        if (numeroNF) dataFiltrada = dataFiltrada.filter(n => String(n.numero_nf || '').toLowerCase().includes(numeroNF));
        if (chave) dataFiltrada = dataFiltrada.filter(n => String(n.chave_acesso || '').replace(/\D/g, '').includes(chave));

        if (status) {
            if (status === 'sem_pendencia') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) === 1 && Number(n.incluida_financeiro) === 1);
            else if (status === 'pend_est') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) !== 1);
            else if (status === 'pend_fin') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) !== 1);
        }

        recalcKpis(dataFiltrada);
        renderTabela(dataFiltrada);
    }

    function recalcKpis(data) {
        const pendFin = data.filter(n => Number(n.incluida_financeiro) !== 1).length;
        const pendEst = data.filter(n => Number(n.incluida_estoque) !== 1).length;
        const soma = data.reduce((acc, n) => acc + (parseFloat(n.valor_total || 0) || 0), 0);

        $('#kpiPendFin').text(pendFin);
        $('#kpiPendEst').text(pendEst);
        $('#kpiSomatorio').text(soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
    }

    function renderTabela(lista) {
        const tbody = $('#tabelaNotas tbody');
        tbody.empty();

        if (!lista.length) {
            tbody.append('<tr><td colspan="11" class="text-center text-muted" style="padding: 20px;">Nenhuma nota encontrada com os filtros atuais.</td></tr>');
            return;
        }

        lista.forEach(n => {
            const tipoLabel = (String(n.tipo || '').toLowerCase() === 'a') ? 'Avulsa' : 'XML';

            // Ícones de Status
            const iconOk = '<iconify-icon icon="icon-park-solid:check-one" class="status-icon status-ok" title="Concluído"></iconify-icon>';
            const iconPend = '<iconify-icon icon="icon-park-outline:attention" class="status-icon status-pendente" title="Pendente"></iconify-icon>';

            const statusEstoque = Number(n.incluida_estoque) === 1 ? iconOk : iconPend;
            const statusFin = Number(n.incluida_financeiro) === 1 ? iconOk : iconPend;

            // Links de Ação (SEMPRE CLIÁVEIS)
            const linkEstoque = `<a href="#" class="abrir-estoque" data-chave="${n.chave_acesso||''}" data-fornecedor="${n.fornecedor_id||''}" data-tipo="${n.tipo||'i'}" data-nota-id="${n.id||''}">${statusEstoque}</a>`;

            const linkFin = `<a href="#" class="abrir-financeiro" data-chave="${n.chave_acesso||''}" data-id="${n.id||''}" data-fornecedor="${escapeHtml(n.fornecedor_razao||'')}">${statusFin}</a>`;

            tbody.append(`
              <tr>
                <td class="text-center"><a href="#" class="btn-download" data-chave="${n.chave_acesso || ''}" title="Baixar XML/PDF"><i class="fa fa-download text-muted hover-blue"></i></a></td>
                <td><b>${n.numero_nf || '-'}</b></td>
                <td>${formatDateBR(n.data_emissao)}</td>
                <td><span title="${escapeHtml(n.fornecedor_razao)}">${truncate(n.fornecedor_razao, 25)}</span></td>
                <td><small class="chave-acesso">${n.chave_acesso || '-'}</small></td>
                <td>${formatCnpjCpf(n.fornecedor_cnpj)}</td>
                <td class="text-right"><b>${(parseFloat(n.valor_total)||0).toLocaleString('pt-BR', {minimumFractionDigits:2})}</b></td>
                <td class="text-center"><span class="badge badge-default">${tipoLabel}</span></td>
                <td class="text-center">${linkEstoque}</td>
                <td class="text-center">${linkFin}</td>
                <td>${formatDateBR(n.data_entrada)}</td>
              </tr>
            `);
        });
    }

    // --- UTILITÁRIOS ---
    function escapeHtml(s) { return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function truncate(str, n){ return (str && str.length > n) ? str.substr(0, n-1) + '…' : str; }
    function formatDateBR(s) { if(!s) return '-'; const d = new Date(s); return isNaN(d) ? s : d.toLocaleDateString('pt-BR'); }
    function formatCnpjCpf(v) {
        v = v.replace(/\D/g, '');
        if (v.length === 14) return v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
        if (v.length === 11) return v.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        return v;
    }

    // Download XML/PDF (Mantido igual)
    $(document).on('click', 'a.btn-download', async function (e) {
        e.preventDefault();
        const chave = $(this).data('chave');
        if (!chave) return;

        const result = await Swal.fire({
            title: 'Download',
            text: 'Selecione o formato:',
            icon: 'question',
            showDenyButton: true, showCancelButton: true,
            confirmButtonText: 'PDF', denyButtonText: 'XML', cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33', denyButtonColor: '#0B46AC'
        });

        if (result.isDismissed) return;
        const tipo = result.isConfirmed ? 'pdf' : 'xml';

        try {
            Swal.showLoading();
            const { data: resp } = await axios.post(baseUrl, {
                method: 'baixarArquivo', token,
                data: { system_unit_id: Number(unit_id), chave: String(chave), tipo }
            });
            Swal.close();
            if(resp.success && resp.content) {
                downloadBase64(resp.content, `${chave}.${tipo}`, tipo === 'pdf' ? 'application/pdf' : 'application/xml');
            } else {
                throw new Error(resp.message);
            }
        } catch (e) {
            Swal.fire('Erro', 'Arquivo não disponível.', 'error');
        }
    });

    function downloadBase64(b64, filename, mime) {
        const link = document.createElement('a');
        link.href = `data:${mime};base64,${b64}`;
        link.download = filename;
        link.click();
    }
</script>
</body>
</html>