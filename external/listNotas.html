<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Notas Fiscais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/313adf4cdc.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* fullscreen já existe, complemento para garantir 100vh do iframe */
        .modal-iframe-full { width:100%; height:calc(100vh - 56px); border:0; }
        /* (fallback para headers maiores/menores) */
        @media (max-width: 768px){
            .modal-iframe-full { height:calc(100vh - 52px); }
        }

        .select2-container { width: 100% !important; }
        .select2-dropdown { z-index: 9999; }

        .label-success { background-color: #4caf50; }
        .orange { color: orange; font-size: 16px; }

        /* Animação de sino */
        @keyframes swing {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(6deg); }
            100% { transform: rotate(0deg); }
        }
        .sino-animado { display: inline-block; animation: swing 1s infinite; }

        /* Cards KPI */
        .kpi-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kpi-value {
            font-size: 22px;
            font-weight: 700;
        }

        .kpi-label {
            color: #666;
            margin-bottom: 6px;
        }

        /* Temas */
        .kpi.orange {
            background: #fff3e0;
            border-color: #ffe0b2;
            color: #ef6c00;
        }

        .kpi.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        /* Botões dentro do card seguem cor do tema */
        .kpi.orange .btn {
            background-color: #ef6c00;
            border-color: #ef6c00;
            color: #fff;
        }

        .kpi.blue .btn {
            background-color: #1565c0;
            border-color: #1565c0;
            color: #fff;
        }

        /* Modal Fullscreen */
        .modal-fullscreen {
            max-width: 100% !important;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
        }

        .modal-fullscreen .modal-content {
            height: 100%;
            border: 0;
            border-radius: 0;
        }

        .modal-fullscreen .modal-body {
            overflow-y: auto;
        }
        .form-control { margin-bottom: 10px; }
        .label-success { background-color: #4caf50; }
        .label-danger { background-color: #f44336; }
        .modal-iframe {
            width: 100%;
            height: 80vh;
            border: none;
        }
        button i {
            margin-right: 5px; /* espaço entre ícone e texto */
            vertical-align: middle; /* centraliza verticalmente */
        }
        button {
            display: inline-flex;
            align-items: center; /* centraliza texto + ícone */
        }
        /* Escopo só para este modal */
        #modalEntradaEstoque .modal-dialog {
            max-width: 100% !important;
            width: 100% !important;
            height: 100%;
            margin: 0;
        }
        #modalEntradaEstoque .modal-content {
            height: 100vh;              /* ocupa a viewport inteira */
            display: flex;              /* para o body crescer corretamente */
            flex-direction: column;
            border: 0;
            border-radius: 0;
        }
        #modalEntradaEstoque .modal-header,
        #modalEntradaEstoque .modal-footer {
            flex: 0 0 auto;             /* tamanhos naturais */
        }
        #modalEntradaEstoque .modal-body {
            flex: 1 1 auto;             /* ocupa o restante */
            padding: 0;                 /* sem padding pra não dar barra extra */
            overflow: hidden;           /* scroll fica dentro do iframe */
        }
        #modalEntradaEstoque .modal-iframe-full {
            width: 100%;
            height: 100%;               /* preenche o body inteiro */
            border: 0;
            display: block;
        }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header d-flex justify-content-between align-items-center">
            <h2>Notas Fiscais</h2>

        </div>
        <div class="body">
            <!-- Filtros -->
            <div class="row">
                <div class="col-md-2">
                    <label>Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>CPF/CNPJ Fornecedor</label>
                    <input type="text" id="filtroCnpj" class="form-control" placeholder="Digite CPF ou CNPJ">
                </div>
                <div class="col-md-2">
                    <label>Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todas</option>
                        <option value="sem_pendencia">Sem pendência (estoque e financeiro incluídos)</option>
                        <option value="incluida_fin">Incluídas Financeiro</option>
                        <option value="incluida_est">Incluída Estoque</option>
                        <option value="pend_est">Não incluídas no estoque</option>
                        <option value="pend_fin">Não incluída no financeiro</option>
                    </select>
                </div>
                <div class="col-md-3 text-right">
                    <label>&nbsp;</label><br>
                    <button class="btn btn-primary me-2" id="btnListarNotas" style="padding: 8px 15px 12px 15px; min-width: 120px;">
                        <i class="fa fa-search me-2"></i> Listar Notas
                    </button>
                    <button class="btn btn-primary" id="btnAbrirImportacao" style="padding: 8px 15px 12px 15px; min-width: 120px;">
                        <i class="fa fa-upload me-2"></i> Importar Notas
                    </button>
                </div>
            </div>
            <div class="row" id="rowFiltros2" style="margin-top:10px;">
                <div class="col-md-4">
                    <label>Número da NF</label>
                    <input type="text" id="filtroNumeroNF" class="form-control" placeholder="Ex.: 12345">
                </div>
                <div class="col-md-5">
                    <label>Chave de Acesso</label>
                    <input type="text" id="filtroChave" class="form-control" placeholder="Digite parte ou a chave completa">
                </div>
            </div>

            <div class="row" id="rowKpis" style="margin-top:10px;">
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Financeiro</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendFin">0</div>
                            <button class="btn btn-sm" id="btnVerMaisFin">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Estoque</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendEst">0</div>
                            <button class="btn btn-sm" id="btnVerMaisEst">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi blue">
                        <p class="kpi-label">Somatório Total de NF-e</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiSomatorio">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Grid -->
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabelaNotas">
                    <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Número</th>
                        <th>Data Emissão</th>
                        <th>Razão Social</th>
                        <th>Chave de Acesso</th>
                        <th>CPF/CNPJ</th>
                        <th>Valor NF-e</th>
                        <th>Estoque</th>
                        <th>Financeiro</th>
                        <th>Data Entrada</th>
                    </tr>
                    </thead>

                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação -->
<div class="modal fade" id="modalImportacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Importar Notas</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeImportacao" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Modal Inclusão no Contas a Pagar -->
<div class="modal fade" id="modalFinanceiro" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: 1px solid #eee;">
                <h4 class="modal-title">Inclusão no Contas a Pagar</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="finFornecedorId">
                <input type="hidden" id="finChaveAcesso">

                <div class="row">
                    <div class="col-md-12">
                        <label>Fornecedor</label>
                        <input type="text" id="finFornecedorNome" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                        <label>Documento</label>
                        <input type="text" id="finDocumento" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Emissão</label>
                        <input type="date" id="finEmissao" class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label>Vencimento</label>
                        <input type="date" id="finVencimento" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Valor</label>
                        <input type="text" id="finValor" class="form-control" readonly>
                    </div>

                    <div class="col-md-6">
                        <label>Adicional</label>
                        <input type="text" id="finAdicional" class="form-control" value="0">
                    </div>
                    <div class="col-md-6">
                        <label>Desconto</label>
                        <input type="text" id="finDesconto" class="form-control" value="0">
                    </div>

                    <div class="col-md-6">
                        <label>Forma de Pagamento</label>
                        <select id="finForma" class="form-control"></select>
                    </div>
                    <div class="col-md-6">
                        <label>Classificação Contábil (Plano de Contas)</label>
                        <select id="finPlano" class="form-control"></select>
                    </div>


                    <div class="col-md-12" id="grupoObservacao" style="margin-top:18px;">
                        <label>Observação</label>
                        <textarea id="finObs" class="form-control" rows="3"></textarea>
                    </div>

                </div>
            </div>

            <div class="modal-footer" style="border-top: 1px solid #eee;">
                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="btnGravarFinanceiro">
                    <i class="fa fa-save"></i> Gravar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Entrada no Estoque (FULLSCREEN) -->
<div class="modal fade" id="modalEntradaEstoque" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:1px solid #eee;">
                <h4 class="modal-title">Compra – Importação de Nota</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeEntradaEstoque" class="modal-iframe-full"></iframe>
            </div>
        </div>
    </div>
</div>


<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlFinanceiro = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';
    const modelo = { tag: 'nfe' }; // pode vir de algum lugar dinâmico

    let notasOriginais = [];

    $(document).ready(function () {
        $('#btnListarNotas').click(listarNotas);

        $('#filtroDataInicial, #filtroDataFinal, #filtroCnpj, #filtroStatus, #filtroNumeroNF, #filtroChave')
            .on('input change', aplicarFiltros);


        $('#btnAbrirImportacao').click(() => {
            const url = `${baseUrlRedirect}/external/importXmlNfe.html?username=${username}&token=${token}&unit_id=${unit_id}&tag=${modelo.tag}`;
            $('#iframeImportacao').attr('src', url);
            $('#modalImportacao').modal('show');
        });

        // KPIs -> "Ver mais"
        $('#btnVerMaisFin').on('click', function() {
            $('#filtroStatus').val('pend_fin');
            aplicarFiltros();
        });
        $('#btnVerMaisEst').on('click', function() {
            $('#filtroStatus').val('pend_est');
            aplicarFiltros();
        });

        $('#modalImportacao').on('hidden.bs.modal', function () {
            listarNotas();
        });
    });

    // abre a tela de entrada/edição no estoque em fullscreen
    $(document).on('click', 'a.abrir-estoque', function (e) {
        e.preventDefault();

        const chave       = $(this).data('chave');
        const fornecedor  = $(this).data('fornecedor') || '';
        const usuario_id  = urlParams.get('usuario_id') || ''; // se tiver
        // Monta a URL do iframe (use seu host automático)
        const baseRedirect = (window.location.hostname !== 'localhost')
            ? 'https://portal.mrksolucoes.com.br'
            : 'http://localhost/portal-mrk';

        const qs = [
            `system_unit_id=${encodeURIComponent(unit_id)}`,
            `chave_acesso=${encodeURIComponent(chave || '')}`,
            `fornecedor_id=${encodeURIComponent(fornecedor)}`,
            `token=${encodeURIComponent(token || '')}`,
            usuario_id ? `usuario_id=${encodeURIComponent(usuario_id)}` : null
        ].filter(Boolean).join('&');

        const urlIframe = `${baseRedirect}/external/entradaNotaEstoque.html?${qs}`;

        $('#iframeEntradaEstoque').attr('src', urlIframe);
        $('#modalEntradaEstoque').modal('show');
    });

    // sempre que fechar o modal, recarrega a lista
    $('#modalEntradaEstoque').on('hidden.bs.modal', function () {
        $('#iframeEntradaEstoque').attr('src', 'about:blank'); // limpa
        listarNotas(); // atualiza o grid
    });

    async function listarNotas() {
        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });
        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotas',
                token,
                data: { system_unit_id: unit_id }
            });

            if (res.data.success) {
                notasOriginais = res.data.data || [];
                aplicarFiltros();
                Swal.close();
            } else {
                Swal.fire('Erro', 'Não foi possível carregar as notas.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function recalcKpis(data) {
        const pendFin = data.filter(n => Number(n.incluida_financeiro) !== 1).length;
        const pendEst = data.filter(n => Number(n.incluida_estoque) !== 1).length;
        const soma = data.reduce((acc, n) => acc + (parseFloat(n.valor_total || 0) || 0), 0);

        $('#kpiPendFin').text(pendFin);
        $('#kpiPendEst').text(pendEst);
        $('#kpiSomatorio').text(
            soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        );
    }

    function aplicarFiltros() {
        let dataFiltrada = [...notasOriginais];

        const dataIni = $('#filtroDataInicial').val();
        const dataFim = $('#filtroDataFinal').val();
        const cnpj = ($('#filtroCnpj').val() || '').replace(/\D/g, '');
        const status = $('#filtroStatus').val();

        // NOVOS
        const numeroNF = ($('#filtroNumeroNF').val() || '').trim().toLowerCase();
        const chave    = ($('#filtroChave').val() || '').replace(/\s/g, ''); // tira espaços
        const chaveNums = chave.replace(/\D/g, ''); // só dígitos para comparar

        if (dataIni) {
            dataFiltrada = dataFiltrada.filter(n =>
                n.data_emissao && n.data_emissao.substr(0, 10) >= dataIni
            );
        }
        if (dataFim) {
            dataFiltrada = dataFiltrada.filter(n =>
                n.data_emissao && n.data_emissao.substr(0, 10) <= dataFim
            );
        }
        if (cnpj) {
            dataFiltrada = dataFiltrada.filter(n =>
                (n.fornecedor_cnpj || '').replace(/\D/g, '').includes(cnpj)
            );
        }

        // 🔎 filtro por número da NF (parcial, case-insensitive)
        if (numeroNF) {
            dataFiltrada = dataFiltrada.filter(n =>
                String(n.numero_nf || '').toLowerCase().includes(numeroNF)
            );
        }

        // 🔎 filtro por chave de acesso (parcial; ignora separadores)
        if (chaveNums) {
            dataFiltrada = dataFiltrada.filter(n =>
                String(n.chave_acesso || '').replace(/\D/g, '').includes(chaveNums)
            );
        }

        // status combinado (como já estava)
        if (status) {
            if (status === 'sem_pendencia') {
                dataFiltrada = dataFiltrada.filter(n =>
                    Number(n.incluida_estoque) === 1 && Number(n.incluida_financeiro) === 1
                );
            } else if (status === 'incluida_fin') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) === 1);
            } else if (status === 'incluida_est') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) === 1);
            } else if (status === 'pend_est') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) !== 1);
            } else if (status === 'pend_fin') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) !== 1);
            }
        }

        recalcKpis(dataFiltrada);
        renderTabela(dataFiltrada);
    }

    function escapeHtml(s) {
        return String(s ?? '')
            .replace(/&/g, '&amp;').replace(/</g, '&lt;')
            .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function truncateWithTooltip(text, max = 30) {
        const full = (text || '').trim();
        const truncated = full.length > max ? (full.slice(0, max - 1).trimEnd() + '…') : full;
        // tooltip do Bootstrap (v3) usa data-toggle="tooltip"
        return `<span title="${escapeHtml(full)}" data-toggle="tooltip" data-placement="top">${escapeHtml(truncated)}</span>`;
    }

    function formatDateBR(s) {
        if (!s) return '';
        const t = String(s).replace(' ', 'T'); // cobre 'YYYY-MM-DD HH:mm:ss'
        const d = new Date(t);
        if (!isNaN(d)) {
            const [y, m, da] = d.toISOString().substr(0, 10).split('-');
            return `${da}/${m}/${y}`;
        }
        // fallback rápido pra 'YYYY-MM-DD...'
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
            const [y, m, da] = s.substr(0, 10).split('-');
            return `${da}/${m}/${y}`;
        }
        return s;
    }

    function formatCnpjCpf(v) {
        const d = String(v || '').replace(/\D/g, '');
        if (d.length === 14) return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        if (d.length === 11) return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        return v || '';
    }



    function renderTabela(lista) {
        const tbody = $('#tabelaNotas tbody');
        tbody.empty();

        if (!lista.length) {
            tbody.append('<tr><td colspan="11" class="text-center">Nenhuma nota encontrada.</td></tr>');
            return;
        }

        lista.forEach(n => {
            const estoqueBadgeConteudo = Number(n.incluida_estoque) === 1
                ? '<span class="label label-success">Sim</span>'
                : '<i class="fas fa-exclamation-triangle orange sino-animado" title="Não incluída no estoque"></i>';

            const estoqueBadge = `
      <a href="#" class="abrir-estoque"
         title="Abrir Entrada no Estoque"
         data-chave="${n.chave_acesso || ''}"
         data-fornecedor="${n.fornecedor_id || ''}">
         ${estoqueBadgeConteudo}
      </a>`;

            const financeiroBadge = Number(n.incluida_financeiro) === 1
                ? '<span class="label label-success">Sim</span>'
                : `<a href="#" class="abrir-financeiro"
          data-chave="${n.chave_acesso || ''}"
          data-id="${n.id || ''}"
          data-fornecedor="${escapeHtml(n.fornecedor_razao || '')}"
          data-doc="${n.numero_nf || ''}"
          data-emissao="${n.data_emissao ? n.data_emissao.substr(0,10) : ''}"
          data-valor="${n.valor_total || 0}"
          title="Incluir no Financeiro">
          <i class="fas fa-exclamation-triangle orange sino-animado"></i>
       </a>`;

            const razaoHtml      = truncateWithTooltip(n.fornecedor_razao || '', 30);
            const chaveHtml      = truncateWithTooltip(n.chave_acesso || '', 44); // NOVO (20 chars)
            const dataEmissaoBR  = formatDateBR(n.data_emissao);
            const dataEntradaBR  = formatDateBR(n.data_entrada);
            const docFmt         = formatCnpjCpf(n.fornecedor_cnpj);
            const valorFmt       = (parseFloat(n.valor_total) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            tbody.append(`
      <tr>
        <td><a href="#" title="Entrada"><i class="fa fa-download green"></i></a></td>
        <td>${escapeHtml(n.numero_nf ?? '')}</td>
        <td>${escapeHtml(dataEmissaoBR)}</td>
        <td>${razaoHtml}</td>
        <td>${chaveHtml}</td> <!-- NOVO -->
        <td>${escapeHtml(docFmt)}</td>
        <td>${escapeHtml(valorFmt)}</td>
        <td>${estoqueBadge}</td>
        <td>${financeiroBadge}</td>
        <td>${escapeHtml(dataEntradaBR)}</td>
      </tr>
    `);
        });

        $('[data-toggle="tooltip"]').tooltip({ container: 'body' }); // mantém o tooltip funcionando
    }


    function toNumberBR(v) {
        if (v === null || v === undefined) return 0;
        if (typeof v === 'number') return v;
        let s = (v + '').trim();
        // remove milhar e troca vírgula por ponto
        s = s.replace(/\./g, '').replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }
    function toBRL(n) {
        return (Number(n) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }
    async function abrirModalFinanceiro({ chave_acesso, id, fornecedor_nome, documento_hint, emissao_hint, valor_hint }) {
        try {
            if (!chave_acesso && !id) {
                Swal.fire('Atenção', 'Não foi possível identificar a chave de acesso da nota.', 'warning');
                return;
            }

            Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });

            const payloadReq = {
                method: 'getNotaFinanceiroPayload',
                token,
                data: {
                    system_unit_id: Number(unit_id),
                    ...(chave_acesso ? { chave_acesso } : {}),
                    ...(id ? { id } : {})
                }
            };

            const res = await axios.post(baseUrl, payloadReq);
            if (!res.data || !res.data.success || !res.data.data) {
                Swal.close();
                Swal.fire('Erro', res.data?.error || 'Não foi possível obter os dados da nota.', 'error');
                return;
            }

            const d = res.data.data;

            // Preenche campos básicos
            $('#finFornecedorId').val(d.fornecedor_id || '');
            $('#finChaveAcesso').val(chave_acesso || '');
            $('#finFornecedorNome').val(fornecedor_nome || '');              // somente visual
            $('#finDocumento').val(d.documento || documento_hint || '');
            $('#finEmissao').val(d.emissao || emissao_hint || '');
            $('#finVencimento').val('');                                     // usuário define
            $('#finValor').val((d.valor_total !== undefined && d.valor_total !== null)
                ? ('' + Number(d.valor_total).toFixed(2)).replace('.', ',')
                : (valor_hint ? ('' + Number(valor_hint).toFixed(2)).replace('.', ',') : '0,00')
            );
            $('#finAdicional').val('0');
            $('#finDesconto').val('0');
            $('#finObs').val(d.chave_acesso ? ('Chave NFe: ' + d.chave_acesso) : (chave_acesso ? ('Chave NFe: ' + chave_acesso) : ''));

            // === Plano de Contas (hierarquia): ordena por tamanho do código e depois por código ===
            const planos = Array.isArray(d.planos_de_conta) ? d.planos_de_conta.slice() : [];
            planos.sort((a, b) => {
                const ca = (a.codigo || ''), cb = (b.codigo || '');
                if (ca.length !== cb.length) return ca.length - cb.length;
                return ca.localeCompare(cb, 'pt-BR', { numeric: true });
            });

            const $plano = $('#finPlano');
            $plano.empty().append(`<option value="">Selecione...</option>`);
            planos.forEach(p => {
                // valor = código (string). Se quiser pelo id, troque p.id aqui.
                $plano.append(`<option value="${p.codigo}" data-id="${p.id || ''}">${p.label || (p.codigo + ' - ' + (p.descricao || ''))}</option>`);
            });

            // === Formas de Pagamento ===
            const formas = Array.isArray(d.formas_pagamento) ? d.formas_pagamento : (Array.isArray(d.formas_de_pagamento) ? d.formas_de_pagamento : []);
            const $forma = $('#finForma');
            $forma.empty().append(`<option value="">Selecione...</option>`);
            formas.forEach(f => {
                $forma.append(`<option value="${f.id}">${f.descricao || f.nome || f.codigo}</option>`);
            });

            // Ativa selects pesquisáveis
            const $modal = $('#modalFinanceiro');
            $plano.select2({ dropdownParent: $modal, placeholder: 'Selecione...', width: 'resolve' });
            $forma.select2({ dropdownParent: $modal, placeholder: 'Selecione...', width: 'resolve' });

            Swal.close();
            $modal.modal('show');

        } catch (err) {
            console.error(err);
            Swal.close();
            Swal.fire('Erro', 'Falha ao carregar dados para o financeiro.', 'error');
        }
    }
    async function gravarFinanceiro() {
        try {
            const fornecedor_id = Number($('#finFornecedorId').val());
            const chave_acesso  = $('#finChaveAcesso').val();
            const documento     = $('#finDocumento').val().trim();
            const emissao       = $('#finEmissao').val();
            const vencimento    = $('#finVencimento').val();
            const valor         = $('#finValor').val().trim();           // já vem como "123,45"
            const adicional     = $('#finAdicional').val().trim();
            const desconto      = $('#finDesconto').val().trim();
            const plano_contas  = $('#finPlano').val();                  // valor = código
            const forma_id      = $('#finForma').val();
            const obs_extra     = ($('#finObs').val() || '').trim();

            if (!fornecedor_id) return Swal.fire('Atenção', 'Fornecedor inválido.', 'warning');
            if (!documento)     return Swal.fire('Atenção', 'Informe o Documento.', 'warning');
            if (!emissao)       return Swal.fire('Atenção', 'Informe a Emissão.', 'warning');
            if (!vencimento)    return Swal.fire('Atenção', 'Informe o Vencimento.', 'warning');
            if (!valor)         return Swal.fire('Atenção', 'Valor inválido.', 'warning');
            if (!plano_contas)  return Swal.fire('Atenção', 'Selecione o Plano de Contas.', 'warning');
            if (!forma_id)      return Swal.fire('Atenção', 'Selecione a Forma de Pagamento.', 'warning');

            Swal.fire({ title: 'Gravando...', didOpen: () => Swal.showLoading() });

            const req = {
                method: 'lancarNotaNoFinanceiroConta',
                token,
                data: {
                    system_unit_id: Number(unit_id),
                    fornecedor_id: fornecedor_id,
                    documento: documento,
                    emissao: emissao,                // aceita YYYY-MM-DD
                    vencimento: vencimento,          // idem
                    valor: valor,                    // "1.290,50" OK
                    adicional: adicional || '0',
                    desconto: desconto || '0',
                    plano_contas: plano_contas,      // código
                    forma_pagamento_id: Number(forma_id),
                    obs_extra: obs_extra,
                    chave_acesso: chave_acesso
                }
            };

            const res = await axios.post(baseUrlFinanceiro, req);
            Swal.close();

            if (!res.data || !res.data.success) {
                return Swal.fire('Erro', res.data?.error || 'Falha ao gravar lançamento.', 'error');
            }

            $('#modalFinanceiro').modal('hide');
            Swal.fire('Sucesso', 'Lançamento criado com sucesso.', 'success');
            // atualiza a lista
            await listarNotas();

        } catch (e) {
            console.error(e);
            Swal.close();
            Swal.fire('Erro', 'Falha ao gravar lançamento.', 'error');
        }
    }

    $(document).on('click', '#btnGravarFinanceiro', gravarFinanceiro);

    // abre o modal ao clicar no ícone de exclamação
    $(document).on('click', 'a.abrir-financeiro', function (e) {
        e.preventDefault();
        const chave = $(this).data('chave');
        const id    = $(this).data('id');
        const fornecedor = $(this).data('fornecedor');
        const doc   = $(this).data('doc');
        const em    = $(this).data('emissao');
        const val   = $(this).data('valor');
        abrirModalFinanceiro({
            chave_acesso: chave,
            id,
            fornecedor_nome: fornecedor,
            documento_hint: doc,
            emissao_hint: em,
            valor_hint: val
        });
    });



</script>
</body>
</html>
