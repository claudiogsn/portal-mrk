<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Notas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/313adf4cdc.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* Seus estilos originais mantidos */
        .btn-header-right .btn-header-icon { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 18px; font-size: 14px; line-height: 1.2; }
        .btn-header-right .btn-header-icon i { font-size: 15px; }
        .chave-wrapper { display: flex; align-items: flex-end; gap: 10px; }
        @media (max-width: 768px) { .chave-wrapper { flex-direction: column; align-items: stretch; } .btn-header-right .btn-header-icon { width: 100%; } }
        #modalImportacao .modal-dialog { width: 95% !important; max-width: 1400px; margin: 30px auto; }
        @media (max-width: 768px) { #modalImportacao .modal-dialog { width: 100% !important; margin: 10px; } }
        .modal-iframe-full { width:100%; height:calc(100vh - 56px); border:0; }
        @media (max-width: 768px){ .modal-iframe-full { height:calc(100vh - 52px); } }
        .select2-container { width: 100% !important; }
        .select2-dropdown { z-index: 9999; }
        .label-success { background-color: #4caf50; }
        .orange { color: orange; font-size: 16px; }
        @keyframes swing { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(6deg); } 100% { transform: rotate(0deg); } }
        .sino-animado { display: inline-block; animation: swing 1s infinite; }
        .kpi-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .kpi-row { display: flex; align-items: center; justify-content: space-between; }
        .kpi-value { font-size: 22px; font-weight: 700; }
        .kpi-label { color: #666; margin-bottom: 6px; }
        .kpi.orange { background: #fff3e0; border-color: #ffe0b2; color: #ef6c00; }
        .kpi.blue { background: #e3f2fd; border-color: #bbdefb; color: #1565c0; }
        .kpi.orange .btn { background-color: #ef6c00; border-color: #ef6c00; color: #fff; }
        .kpi.blue .btn { background-color: #1565c0; border-color: #1565c0; color: #fff; }
        .modal-fullscreen { max-width: 100% !important; width: 100% !important; height: 100% !important; margin: 0 !important; }
        .modal-fullscreen .modal-content { height: 100%; border: 0; border-radius: 0; }
        .modal-fullscreen .modal-body { overflow-y: auto; }
        .form-control { margin-bottom: 10px; }
        .label-danger { background-color: #f44336; }
        .modal-iframe { width: 100%; height: 80vh; border: none; }
        #modalEntradaEstoque .modal-dialog { max-width: 100% !important; width: 100% !important; height: 100%; margin: 0; }
        #modalEntradaEstoque .modal-content { height: 100vh; display: flex; flex-direction: column; border: 0; border-radius: 0; }
        #modalEntradaEstoque .modal-header, #modalEntradaEstoque .modal-footer { flex: 0 0 auto; }
        #modalEntradaEstoque .modal-body { flex: 1 1 auto; padding: 0; overflow: hidden; }
        #modalEntradaEstoque .modal-iframe-full { width: 100%; height: 100%; border: 0; display: block; }
        #modalEntradaEstoque .modal-header .close.close-x-red { opacity: 1; background: transparent; border: none; border-radius: 0; box-shadow: none; color: #e53935; font-size: 28px; line-height: 1; padding: 6px; width: auto; height: auto; text-shadow: 0 0 6px rgba(229, 57, 53, .6), 0 0 12px rgba(229, 57, 53, .4); transition: transform .15s ease, text-shadow .15s ease; cursor: pointer; }
        #modalEntradaEstoque .modal-header .close.close-x-red:hover { transform: scale(1.12); text-shadow: 0 0 8px rgba(229, 57, 53, .8), 0 0 18px rgba(229, 57, 53, .55); outline: none; }
        .header-flex { display: flex; align-items: center; justify-content: space-between; }
        @media (max-width: 768px) { .header-flex { flex-direction: column; align-items: flex-start; } }
        #rowFiltros2 .col-md-4, #rowFiltros2 .col-md-5, #rowFiltros2 .col-md-3 { display: flex; flex-direction: column; }
        #rowFiltros2 .col-md-3 { justify-content: flex-end; }
        .btn-listar-notas { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; font-size: 14px; line-height: 1.2; margin-top: 12px; }
        .btn-listar-notas i { font-size: 15px; }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header header-flex">
            <h2 style="margin: 0;">Notas de Entrada</h2>
            <div class="btn-header-right">
                <button type="button" class="btn btn-primary btn-header-icon" id="btnAbrirImportacao">
                    <i class="fa fa-file-import"></i> Importar Notas
                </button>
                <button type="button" class="btn btn-primary btn-header-icon" id="btnEntradaAvulsa">
                    <i class="fa fa-plus-circle"></i> Entrada Avulsa
                </button>
            </div>
        </div>

        <div class="body">
            <div class="row">
                <div class="col-md-2">
                    <label>Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Tipo de Data</label>
                    <select id="filtroTipoData" class="form-control">
                        <option value="emissao" selected>Emissão</option>
                        <option value="entrada">Entrada</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>CPF/CNPJ Fornecedor</label>
                    <input type="text" id="filtroCnpj" class="form-control" placeholder="Digite CPF ou CNPJ">
                </div>
                <div class="col-md-2">
                    <label>Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todas</option>
                        <option value="sem_pendencia">Sem pendência (estoque e financeiro incluídos)</option>
                        <option value="incluida_fin">Incluídas Financeiro</option>
                        <option value="incluida_est">Incluída Estoque</option>
                        <option value="pend_est">Não incluídas no estoque</option>
                        <option value="pend_fin">Não incluída no financeiro</option>
                    </select>
                </div>
            </div>

            <div class="row" id="rowFiltros2" style="margin-top:10px;">
                <div class="col-md-4">
                    <label>Número da Nota</label>
                    <input type="text" id="filtroNumeroNF" class="form-control" placeholder="Ex.: 12345">
                </div>

                <div class="col-md-5">
                    <label>Chave de Acesso</label>
                    <div class="chave-wrapper">
                        <input type="text" id="filtroChave" class="form-control" placeholder="Digite parte ou a chave completa">
                    </div>
                </div>
                <div class="col-md-3">
                    <label></label>
                    <button type="button" class="btn btn-success btn-listar-notas" id="btnListarNotas">
                        <i class="fa fa-search"></i> Listar Notas
                    </button>
                </div>
            </div>

            <div class="row" id="rowKpis" style="margin-top:10px;">
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Financeiro</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendFin">0</div>
                            <button class="btn btn-sm" id="btnVerMaisFin">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Estoque</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendEst">0</div>
                            <button class="btn btn-sm" id="btnVerMaisEst">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi blue">
                        <p class="kpi-label">Somatório Total de Notas</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiSomatorio">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabelaNotas">
                    <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Número</th>
                        <th>Data Emissão</th>
                        <th>Razão Social</th>
                        <th>Chave de Acesso</th>
                        <th>CPF/CNPJ</th>
                        <th>Valor Nota</th>
                        <th>Tipo</th>
                        <th>Estoque</th>
                        <th>Financeiro</th>
                        <th>Data Entrada</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalImportacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Importar Notas</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeImportacao" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFinanceiroIframe" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Inclusão no Contas a Pagar</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeFinanceiro" style="width:100%; height:85vh; border:none; display:block;"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEntradaEstoque" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom:1px solid #eee;">
                <h4 class="modal-title">Nota Entrada</h4>
                <button type="button" class="close close-x-red" data-dismiss="modal" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeEntradaEstoque" class="modal-iframe-full"></iframe>
            </div>
        </div>
    </div>
</div>


<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';
    const modelo = { tag: 'nfe' };

    let notasOriginais = [];

    $(document).ready(function () {
        $('#btnListarNotas').click(listarNotas);

        $('#filtroDataInicial, #filtroDataFinal, #filtroTipoData, #filtroCnpj, #filtroStatus, #filtroNumeroNF, #filtroChave')
            .on('input change', aplicarFiltros);

        $('#btnAbrirImportacao').click(() => {
            const url = `${baseUrlRedirect}/external/importXmlNfe.html?username=${username}&token=${token}&unit_id=${unit_id}&tag=${modelo.tag}&user_id=${encodeURIComponent(username)}`;
            $('#iframeImportacao').attr('src', url);
            $('#modalImportacao').modal('show');
        });

        $('#btnEntradaAvulsa').click(() => {
            const usuario_id = urlParams.get('username') || '';
            const qs = [
                `system_unit_id=${encodeURIComponent(unit_id)}`,
                `token=${encodeURIComponent(token || '')}`,
                usuario_id ? `usuario_id=${encodeURIComponent(usuario_id)}` : null
            ].filter(Boolean).join('&');

            const url = `${baseUrlRedirect}/external/entradaNotaAvulsa.html?${qs}`;
            $('#iframeEntradaEstoque').attr('src', url);
            $('#modalEntradaEstoque').modal('show');
        });

        // KPIs
        $('#btnVerMaisFin').on('click', function() { $('#filtroStatus').val('pend_fin'); aplicarFiltros(); });
        $('#btnVerMaisEst').on('click', function() { $('#filtroStatus').val('pend_est'); aplicarFiltros(); });

        $('#modalImportacao').on('hidden.bs.modal', function () { listarNotas(); });
    });

    // --- LÓGICA DO FINANCEIRO (NOVA) ---
    $(document).on('click', 'a.abrir-financeiro', function (e) {
        e.preventDefault();
        const chave = $(this).data('chave') || '';
        const id    = $(this).data('id') || '';
        const fornecedor = $(this).data('fornecedor') || '';

        // Abre o arquivo externo no iframe
        const urlIframe = `${baseUrlRedirect}/external/financeiroNota.html?token=${encodeURIComponent(token)}&unit_id=${unit_id}&chave_acesso=${chave}&id=${id}&fornecedor=${encodeURIComponent(fornecedor)}`;

        $('#iframeFinanceiro').attr('src', urlIframe);
        $('#modalFinanceiroIframe').modal('show');
    });

    $('#modalFinanceiroIframe').on('hidden.bs.modal', function () {
        $('#iframeFinanceiro').attr('src', 'about:blank');
        listarNotas(); // Atualiza a lista para remover o ícone de alerta se foi gravado
    });
    // -----------------------------------

    // Lógica do Estoque (Mantida)
    $(document).on('click', 'a.abrir-estoque', function (e) {
        e.preventDefault();
        const tipoRaw     = ($(this).data('tipo') || 'i').toString().toLowerCase();
        const usuario_id  = urlParams.get('username') || '';
        const baseRedirect = baseUrlRedirect;

        if (tipoRaw === 'a') {
            const notaId = $(this).data('notaId') || $(this).data('id');
            if (!notaId) {
                Swal.fire('Atenção', 'Não foi possível identificar a nota avulsa.', 'warning');
                return;
            }
            const qs = [
                `system_unit_id=${encodeURIComponent(unit_id)}`,
                `token=${encodeURIComponent(token || '')}`,
                usuario_id ? `usuario_id=${encodeURIComponent(usuario_id)}` : null,
                `nota_id=${encodeURIComponent(notaId)}`
            ].filter(Boolean).join('&');
            const urlIframe = `${baseRedirect}/external/entradaNotaAvulsa.html?${qs}`;
            $('#iframeEntradaEstoque').attr('src', urlIframe);
            $('#modalEntradaEstoque').modal('show');
            return;
        }

        const chave       = $(this).data('chave');
        const fornecedor  = $(this).data('fornecedor') || '';
        const qs = [
            `system_unit_id=${encodeURIComponent(unit_id)}`,
            `chave_acesso=${encodeURIComponent(chave || '')}`,
            `fornecedor_id=${encodeURIComponent(fornecedor)}`,
            `token=${encodeURIComponent(token || '')}`,
            usuario_id ? `usuario_id=${encodeURIComponent(usuario_id)}` : null
        ].filter(Boolean).join('&');
        const urlIframe = `${baseRedirect}/external/entradaNotaEstoque.html?${qs}`;
        $('#iframeEntradaEstoque').attr('src', urlIframe);
        $('#modalEntradaEstoque').modal('show');
    });

    $('#modalEntradaEstoque').on('hidden.bs.modal', function () {
        $('#iframeEntradaEstoque').attr('src', 'about:blank');
        listarNotas();
    });

    // Funções Gerais
    async function listarNotas() {
        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });
        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotas',
                token,
                data: { system_unit_id: unit_id }
            });

            if (res.data.success) {
                notasOriginais = res.data.data || [];
                aplicarFiltros();
                Swal.close();
            } else {
                Swal.fire('Erro', 'Não foi possível carregar as notas.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function recalcKpis(data) {
        const pendFin = data.filter(n => Number(n.incluida_financeiro) !== 1).length;
        const pendEst = data.filter(n => Number(n.incluida_estoque) !== 1).length;
        const soma = data.reduce((acc, n) => acc + (parseFloat(n.valor_total || 0) || 0), 0);

        $('#kpiPendFin').text(pendFin);
        $('#kpiPendEst').text(pendEst);
        $('#kpiSomatorio').text(
            soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        );
    }

    function aplicarFiltros() {
        let dataFiltrada = [...notasOriginais];
        const dataIni   = $('#filtroDataInicial').val();
        const dataFim   = $('#filtroDataFinal').val();
        const tipoData  = $('#filtroTipoData').val() || 'emissao';
        const cnpj      = ($('#filtroCnpj').val() || '').replace(/\D/g, '');
        const status    = $('#filtroStatus').val();
        const campoData = (tipoData === 'entrada') ? 'data_entrada' : 'data_emissao';
        const numeroNF  = ($('#filtroNumeroNF').val() || '').trim().toLowerCase();
        const chave     = ($('#filtroChave').val() || '').replace(/\s/g, '');
        const chaveNums = chave.replace(/\D/g, '');

        if (dataIni) dataFiltrada = dataFiltrada.filter(n => n[campoData] && n[campoData].substr(0, 10) >= dataIni);
        if (dataFim) dataFiltrada = dataFiltrada.filter(n => n[campoData] && n[campoData].substr(0, 10) <= dataFim);
        if (cnpj) dataFiltrada = dataFiltrada.filter(n => (n.fornecedor_cnpj || '').replace(/\D/g, '').includes(cnpj));
        if (numeroNF) dataFiltrada = dataFiltrada.filter(n => String(n.numero_nf || '').toLowerCase().includes(numeroNF));
        if (chaveNums) dataFiltrada = dataFiltrada.filter(n => String(n.chave_acesso || '').replace(/\D/g, '').includes(chaveNums));

        if (status) {
            if (status === 'sem_pendencia') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) === 1 && Number(n.incluida_financeiro) === 1);
            else if (status === 'incluida_fin') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) === 1);
            else if (status === 'incluida_est') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) === 1);
            else if (status === 'pend_est') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) !== 1);
            else if (status === 'pend_fin') dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) !== 1);
        }

        recalcKpis(dataFiltrada);
        renderTabela(dataFiltrada);
    }

    function escapeHtml(s) {
        return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function truncateWithTooltip(text, max = 30) {
        const full = (text || '').trim();
        const truncated = full.length > max ? (full.slice(0, max - 1).trimEnd() + '…') : full;
        return `<span title="${escapeHtml(full)}" data-toggle="tooltip" data-placement="top">${escapeHtml(truncated)}</span>`;
    }

    function formatDateBR(s) {
        if (!s) return '';
        const t = String(s).replace(' ', 'T');
        const d = new Date(t);
        if (!isNaN(d)) {
            const [y, m, da] = d.toISOString().substr(0, 10).split('-');
            return `${da}/${m}/${y}`;
        }
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
            const [y, m, da] = s.substr(0, 10).split('-');
            return `${da}/${m}/${y}`;
        }
        return s;
    }

    function formatCnpjCpf(v) {
        const d = String(v || '').replace(/\D/g, '');
        if (d.length === 14) return d.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        if (d.length === 11) return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        return v || '';
    }

    function renderTabela(lista) {
        const tbody = $('#tabelaNotas tbody');
        tbody.empty();

        if (!lista.length) {
            tbody.append('<tr><td colspan="11" class="text-center">Nenhuma nota encontrada.</td></tr>');
            return;
        }

        lista.forEach(n => {
            const tipoChar = (String(n.tipo || '').toLowerCase() === 'a') ? 'Avulsa' : 'Importada';

            const estoqueBadgeConteudo = Number(n.incluida_estoque) === 1
                ? '<span class="label label-success">Sim</span>'
                : '<i class="fas fa-exclamation-triangle orange sino-animado" title="Não incluída no estoque"></i>';

            const estoqueBadge = `
              <a href="#" class="abrir-estoque"
                 title="Abrir Entrada no Estoque"
                 data-chave="${n.chave_acesso || ''}"
                 data-fornecedor="${n.fornecedor_id || ''}"
                 data-tipo="${tipoChar.toLowerCase()}"
                 data-nota-id="${n.id || ''}">
                 ${estoqueBadgeConteudo}
              </a>`;

            const financeiroBadge = Number(n.incluida_financeiro) === 1
                ? '<span class="label label-success">Sim</span>'
                : `<a href="#" class="abrir-financeiro"
                      data-chave="${n.chave_acesso || ''}"
                      data-id="${n.id || ''}"
                      data-fornecedor="${escapeHtml(n.fornecedor_razao || '')}">
                      <i class="fas fa-exclamation-triangle orange sino-animado"></i>
                   </a>`;
            tbody.append(`
              <tr>
                <td><a href="#" class="btn-download" title="Baixar NF-e" data-chave="${n.chave_acesso || ''}"><i class="fa fa-download green"></i></a></td>
                <td>${escapeHtml(n.numero_nf ?? '')}</td>
                <td>${formatDateBR(n.data_emissao)}</td>
                <td>${truncateWithTooltip(n.fornecedor_razao)}</td>
                <td>${truncateWithTooltip(n.chave_acesso, 44)}</td>
                <td>${formatCnpjCpf(n.fornecedor_cnpj)}</td>
                <td>${(parseFloat(n.valor_total) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                <td>${escapeHtml(tipoChar)}</td>
                <td>${estoqueBadge}</td>
                <td>${financeiroBadge}</td>
                <td>${formatDateBR(n.data_entrada)}</td>
              </tr>
            `);
        });

        $('[data-toggle="tooltip"]').tooltip({ container: 'body' });
    }

    // Download XML/PDF
    $(document).on('click', 'a.btn-download', async function (e) {
        e.preventDefault();
        const chave = $(this).data('chave');
        if (!chave) {
            await Swal.fire('Atenção', 'Chave de acesso não encontrada.', 'warning');
            return;
        }
        const result = await Swal.fire({
            title: 'Baixar arquivo',
            text: 'Escolha o formato desejado:',
            icon: 'question',
            showConfirmButton: true, confirmButtonText: 'PDF',
            showDenyButton: true, denyButtonText: 'XML',
            showCancelButton: true, cancelButtonText: 'Cancelar',
            reverseButtons: true, allowOutsideClick: false
        });
        if (result.isDismissed) return;
        const tipo = result.isConfirmed ? 'pdf' : (result.isDenied ? 'xml' : null);
        if (!tipo) return;
        try {
            Swal.fire({ title: 'Gerando arquivo...', didOpen: () => Swal.showLoading(), allowOutsideClick: false });
            const { data: resp } = await axios.post(baseUrl, {
                method: 'baixarArquivo',
                token,
                data: { system_unit_id: Number(unit_id), chave: String(chave), tipo }
            });
            if (!resp?.success || !resp?.content) throw new Error(resp?.message || 'Falha ao obter arquivo.');
            const fileName = `${String(chave)}.${tipo}`;
            const mime = (tipo === 'pdf') ? 'application/pdf' : 'application/xml';
            downloadBase64(resp.content, fileName, mime);
            Swal.close();
        } catch (err) {
            console.error(err);
            Swal.close();
            await Swal.fire('Erro', err?.message || 'Não foi possível baixar o arquivo.', 'error');
        }
    });

    function downloadBase64(b64, filename, mimeType) {
        const byteChars = atob(b64.replace(/\s/g, ''));
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType || 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'arquivo';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>