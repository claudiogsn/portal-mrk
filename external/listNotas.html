<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Notas Fiscais</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/313adf4cdc.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .label-success { background-color: #4caf50; }
        .orange { color: orange; font-size: 16px; }

        /* Animação de sino */
        @keyframes swing {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(6deg); }
            100% { transform: rotate(0deg); }
        }
        .sino-animado { display: inline-block; animation: swing 1s infinite; }

        /* Cards KPI */
        .kpi-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .kpi-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .kpi-value {
            font-size: 22px;
            font-weight: 700;
        }

        .kpi-label {
            color: #666;
            margin-bottom: 6px;
        }

        /* Temas */
        .kpi.orange {
            background: #fff3e0;
            border-color: #ffe0b2;
            color: #ef6c00;
        }

        .kpi.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #1565c0;
        }

        /* Botões dentro do card seguem cor do tema */
        .kpi.orange .btn {
            background-color: #ef6c00;
            border-color: #ef6c00;
            color: #fff;
        }

        .kpi.blue .btn {
            background-color: #1565c0;
            border-color: #1565c0;
            color: #fff;
        }

        /* Modal Fullscreen */
        .modal-fullscreen {
            max-width: 100% !important;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
        }

        .modal-fullscreen .modal-content {
            height: 100%;
            border: 0;
            border-radius: 0;
        }

        .modal-fullscreen .modal-body {
            overflow-y: auto;
        }
        .form-control { margin-bottom: 10px; }
        .label-success { background-color: #4caf50; }
        .label-danger { background-color: #f44336; }
        .modal-iframe {
            width: 100%;
            height: 80vh;
            border: none;
        }
        button i {
            margin-right: 5px; /* espaço entre ícone e texto */
            vertical-align: middle; /* centraliza verticalmente */
        }
        button {
            display: inline-flex;
            align-items: center; /* centraliza texto + ícone */
        }
    </style>
</head>
<body class="theme-blue">
<div class="container-fluid">
    <br>
    <div class="card">
        <div class="header d-flex justify-content-between align-items-center">
            <h2>Notas Fiscais</h2>

        </div>
        <div class="body">
            <!-- Filtros -->
            <div class="row">
                <div class="col-md-2">
                    <label>Data Inicial</label>
                    <input type="date" id="filtroDataInicial" class="form-control">
                </div>
                <div class="col-md-2">
                    <label>Data Final</label>
                    <input type="date" id="filtroDataFinal" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>CPF/CNPJ Fornecedor</label>
                    <input type="text" id="filtroCnpj" class="form-control" placeholder="Digite CPF ou CNPJ">
                </div>
                <div class="col-md-2">
                    <label>Status</label>
                    <select id="filtroStatus" class="form-control">
                        <option value="">Todas</option>
                        <option value="sem_pendencia">Sem pendência (estoque e financeiro incluídos)</option>
                        <option value="incluida_fin">Incluídas Financeiro</option>
                        <option value="incluida_est">Incluída Estoque</option>
                        <option value="pend_est">Não incluídas no estoque</option>
                        <option value="pend_fin">Não incluída no financeiro</option>
                    </select>
                </div>
                <div class="col-md-3 text-right">
                    <label>&nbsp;</label><br>
                    <button class="btn btn-primary me-2" id="btnListarNotas" style="padding: 8px 15px 12px 15px; min-width: 120px;">
                        <i class="fa fa-search me-2"></i> Listar Notas
                    </button>
                    <button class="btn btn-primary" id="btnAbrirImportacao" style="padding: 8px 15px 12px 15px; min-width: 120px;">
                        <i class="fa fa-upload me-2"></i> Importar Notas
                    </button>
                </div>
            </div>

            <div class="row" id="rowKpis" style="margin-top:10px;">
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Financeiro</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendFin">0</div>
                            <button class="btn btn-sm" id="btnVerMaisFin">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi orange">
                        <p class="kpi-label">Pendências Estoque</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiPendEst">0</div>
                            <button class="btn btn-sm" id="btnVerMaisEst">Ver mais</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="kpi-card kpi blue">
                        <p class="kpi-label">Somatório Total de NF-e</p>
                        <div class="kpi-row">
                            <div class="kpi-value" id="kpiSomatorio">R$ 0,00</div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- Grid -->
            <div class="table-responsive mt-3">
                <table class="table table-striped table-hover" id="tabelaNotas">
                    <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 40px;"></th>
                        <th>Número</th>
                        <th>Data Emissão</th>
                        <th>Razão Social</th>
                        <th>CPF/CNPJ</th>
                        <th>Valor NF-e</th>
                        <th>Incluída Estoque</th>
                        <th>Incluída Financeiro</th>
                        <th>Data Entrada</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Importação -->
<div class="modal fade" id="modalImportacao" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Importar Notas</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeImportacao" class="modal-iframe"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const baseUrlRedirect = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br'
        : 'http://localhost/portal-mrk';

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const unit_id = urlParams.get('unit_id');
    const username = urlParams.get('username') || '';
    const modelo = { tag: 'nfe' }; // pode vir de algum lugar dinâmico

    let notasOriginais = [];

    $(document).ready(function () {
        $('#btnListarNotas').click(listarNotas);

        $('#filtroDataInicial, #filtroDataFinal, #filtroCnpj, #filtroStatus')
            .on('input change', aplicarFiltros);

        $('#btnAbrirImportacao').click(() => {
            const url = `${baseUrlRedirect}/external/importXmlNfe.html?username=${username}&token=${token}&unit_id=${unit_id}&tag=${modelo.tag}`;
            $('#iframeImportacao').attr('src', url);
            $('#modalImportacao').modal('show');
        });

        // KPIs -> "Ver mais"
        $('#btnVerMaisFin').on('click', function() {
            $('#filtroStatus').val('pend_fin');
            aplicarFiltros();
        });
        $('#btnVerMaisEst').on('click', function() {
            $('#filtroStatus').val('pend_est');
            aplicarFiltros();
        });

        $('#modalImportacao').on('hidden.bs.modal', function () {
            listarNotas();
        });
    });


    async function listarNotas() {
        Swal.fire({ title: 'Carregando...', didOpen: () => Swal.showLoading() });
        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotas',
                token,
                data: { system_unit_id: unit_id }
            });

            if (res.data.success) {
                notasOriginais = res.data.data || [];
                recalcKpis(notasOriginais);
                renderTabela(notasOriginais);
                Swal.close();
            } else {
                Swal.fire('Erro', 'Não foi possível carregar as notas.', 'error');
            }
        } catch (e) {
            console.error(e);
            Swal.fire('Erro', 'Falha na comunicação com o servidor.', 'error');
        }
    }

    function recalcKpis(data) {
        const pendFin = data.filter(n => Number(n.incluida_financeiro) !== 1).length;
        const pendEst = data.filter(n => Number(n.incluida_estoque) !== 1).length;
        const soma = data.reduce((acc, n) => acc + (parseFloat(n.valor_total || 0) || 0), 0);

        $('#kpiPendFin').text(pendFin);
        $('#kpiPendEst').text(pendEst);
        $('#kpiSomatorio').text(
            soma.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
        );
    }



    function aplicarFiltros() {
        let dataFiltrada = [...notasOriginais];

        const dataIni = $('#filtroDataInicial').val();
        const dataFim = $('#filtroDataFinal').val();
        const cnpj = $('#filtroCnpj').val().replace(/\D/g, '');
        const status = $('#filtroStatus').val();

        if (dataIni) {
            dataFiltrada = dataFiltrada.filter(n =>
                n.data_emissao && n.data_emissao.substr(0, 10) >= dataIni
            );
        }
        if (dataFim) {
            dataFiltrada = dataFiltrada.filter(n =>
                n.data_emissao && n.data_emissao.substr(0, 10) <= dataFim
            );
        }
        if (cnpj) {
            dataFiltrada = dataFiltrada.filter(n =>
                (n.fornecedor_cnpj || '').includes(cnpj)
            );
        }

        // status combinado
        if (status) {
            if (status === 'sem_pendencia') {
                dataFiltrada = dataFiltrada.filter(n =>
                    Number(n.incluida_estoque) === 1 && Number(n.incluida_financeiro) === 1
                );
            } else if (status === 'incluida_fin') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) === 1);
            } else if (status === 'incluida_est') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) === 1);
            } else if (status === 'pend_est') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_estoque) !== 1);
            } else if (status === 'pend_fin') {
                dataFiltrada = dataFiltrada.filter(n => Number(n.incluida_financeiro) !== 1);
            }
        }

        recalcKpis(dataFiltrada);
        renderTabela(dataFiltrada);
    }

    function renderTabela(lista) {
        const tbody = $('#tabelaNotas tbody');
        tbody.empty();

        if (!lista.length) {
            tbody.append('<tr><td colspan="10" class="text-center">Nenhuma nota encontrada.</td></tr>');
            return;
        }

        lista.forEach(n => {
            const estoqueBadge = Number(n.incluida_estoque) === 1
                ? '<span class="label label-success">Sim</span>'
                : '<i class="fas fa-exclamation-triangle orange sino-animado" title="Não incluída no estoque"></i>';

            const financeiroBadge = Number(n.incluida_financeiro) === 1
                ? '<span class="label label-success">Sim</span>'
                : '<i class="fas fa-exclamation-triangle orange sino-animado" title="Não incluída no financeiro"></i>';

            tbody.append(`
      <tr>
        <td><a href="#" title="Editar"><i class="fa fa-edit blue"></i></a></td>
        <td><a href="#" title="Entrada"><i class="fa fa-download green"></i></a></td>
        <td>${n.numero_nf ?? ''}</td>
        <td>${n.data_emissao ? n.data_emissao.substr(0, 10) : ''}</td>
        <td>${n.fornecedor_razao ?? ''}</td>
        <td>${n.fornecedor_cnpj ?? ''}</td>
        <td>${(parseFloat(n.valor_total) || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
        <td>${estoqueBadge}</td>
        <td>${financeiroBadge}</td>
        <td>${n.data_entrada ? n.data_entrada.substr(0, 10) : ''}</td>
      </tr>
    `);
        });
    }

</script>
</body>
</html>
