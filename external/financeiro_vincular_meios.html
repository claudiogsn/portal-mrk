<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vincular Meio de Pagamento</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="style/mrk.css" rel="stylesheet">

    <style>
        /* Ajustes específicos para Iframe */
        html, body {
            background-color: transparent !important;
            padding: 10px;
            overflow-x: hidden;
        }

        .card {
            box-shadow: none;
            border: 1px solid #f0f0f0;
            border-top: 3px solid var(--mrk-amber); /* Laranja para indicar "Ação Pendente" */
        }

        .alert-warning {
            background-color: #fff3e0;
            border-color: #ffe0b2;
            color: #e65100;
            font-family: 'Poppins', sans-serif;
            font-size: 13px;
            border-radius: 6px;
        }

        .select2-container { width: 100% !important; }

        /* Botão Adicionar */
        .btn-add-modal {
            border-radius: 0 4px 4px 0 !important;
            margin-left: -1px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

<div class="card" id="telaVinculo">
    <div class="body">

        <div class="alert alert-warning">
            <div style="display:flex; align-items:center; gap:10px;">
                <iconify-icon icon="icon-park-outline:attention" width="24"></iconify-icon>
                <div>
                    O meio <strong><span id="lblMeioPDV">...</span></strong> veio do PDV e precisa ser associado a uma Opção Financeira.
                </div>
            </div>
        </div>

        <form>
            <input type="hidden" id="hd_codigo_meio_pdv">
            <input type="hidden" id="hd_nome_meio_pdv">

            <label class="muted" style="margin-top:10px;">SELECIONE A OPÇÃO FINANCEIRA</label>
            <div class="input-group" style="display: flex;">
                <div style="flex:1;">
                    <select id="selectOpcao" class="form-control">
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <button type="button" class="btn btn-success waves-effect btn-add-modal" onclick="abrirModalNovaOpcao()" title="Criar Nova Opção">
                    <iconify-icon icon="icon-park-outline:plus" width="18"></iconify-icon>
                </button>
            </div>

            <hr>

            <button type="button" class="btn btn-primary btn-lg btn-block waves-effect" onclick="salvarVinculo()" style="background-color: var(--mrk-amber) !important; border:none;">
                <iconify-icon icon="icon-park-outline:link-one" width="20" style="vertical-align: sub; margin-right:5px;"></iconify-icon>
                CONFIRMAR VÍNCULO
            </button>
        </form>
    </div>
</div>

<div class="modal fade" id="modalNovaOpcao" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="border-radius: 8px;">
            <div class="modal-header" style="border-bottom: 2px solid var(--mrk-green); padding: 15px;">
                <h4 class="modal-title" style="font-family: 'Kanit', sans-serif; color: var(--mrk-black);">
                    <iconify-icon icon="icon-park-outline:add-mode" style="vertical-align: middle; color: var(--mrk-green);"></iconify-icon>
                    Nova Opção de Recebimento
                </h4>
            </div>
            <div class="modal-body">
                <form id="formNovaOpcao">
                    <div class="row clearfix">
                        <div class="col-xs-4">
                            <label class="muted">Código *</label>
                            <input type="text" id="new_codigo" class="form-control" placeholder="Ex: CREDIT">
                        </div>
                        <div class="col-xs-8">
                            <label class="muted">Nome *</label>
                            <input type="text" id="new_nome" class="form-control" placeholder="Ex: Cartão Crédito">
                        </div>
                    </div>
                    <div class="row clearfix">
                        <div class="col-xs-6">
                            <label class="muted">Taxa (%)</label>
                            <input type="number" id="new_taxa" class="form-control" value="0">
                        </div>
                        <div class="col-xs-6">
                            <label class="muted">Prazo (Dias)</label>
                            <input type="number" id="new_prazo" class="form-control" value="1">
                        </div>
                    </div>
                    <div class="row clearfix">
                        <div class="col-xs-12">
                            <label class="muted">Plano de Contas</label>
                            <select id="new_plano" class="form-control" style="width: 100%;"></select>
                        </div>
                    </div>
                    <div class="row clearfix" style="margin-top: 10px;">
                        <div class="col-xs-12">
                            <label class="muted">Banco</label>
                            <select id="new_banco" class="form-control" style="width: 100%;"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="background: #f9f9f9; border-top: 1px solid #eee;">
                <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success waves-effect" onclick="salvarNovaOpcao()">
                    <iconify-icon icon="icon-park-outline:check" width="16" style="vertical-align: middle;"></iconify-icon>
                    SALVAR OPÇÃO
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id');
    const nomeMeioPDV = urlParams.get('meio');
    const codigoMeioPDV = urlParams.get('codigo');

    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    $(document).ready(function() {
        $('#lblMeioPDV').text(`${nomeMeioPDV} (Cód: ${codigoMeioPDV || '?'})`);
        $('#hd_codigo_meio_pdv').val(codigoMeioPDV);
        $('#hd_nome_meio_pdv').val(nomeMeioPDV);

        // Select2 com tema MRK
        $('#selectOpcao').select2({ placeholder: "Selecione..." });
        $('#new_plano').select2({ dropdownParent: $('#modalNovaOpcao'), placeholder: "Selecione o plano..." });
        $('#new_banco').select2({ dropdownParent: $('#modalNovaOpcao'), placeholder: "Selecione o banco..." });

        carregarOpcoes();

        $('#modalNovaOpcao').on('show.bs.modal', function () {
            carregarPlanosEBancos();
        });
    });

    async function carregarOpcoes(selecionarCodigo = null) {
        try {
            const res = await axios.post(baseUrl, { method: 'listOpcoesRecebimento', token, data: { system_unit_id } });
            const corpo = res.data;
            const lista = Array.isArray(corpo) ? corpo : (corpo.data || []);

            const select = $('#selectOpcao');
            select.empty().append('<option value="">Selecione...</option>');

            lista.forEach(op => {
                select.append(new Option(`${op.nome} (${op.codigo})`, op.codigo));
            });

            if(selecionarCodigo) select.val(selecionarCodigo).trigger('change');
        } catch(e) { console.error(e); }
    }

    async function salvarVinculo() {
        const codigoOpcao = $('#selectOpcao').val();
        if(!codigoOpcao) return Swal.fire('Atenção', 'Selecione uma opção financeira.', 'warning');

        const nomeOpcaoFull = $('#selectOpcao option:selected').text().split('(')[0].trim();
        const codMeio = $('#hd_codigo_meio_pdv').val();
        const nomMeio = $('#hd_nome_meio_pdv').val();

        Swal.fire({ title: 'Vinculando...', didOpen: () => Swal.showLoading() });

        try {
            const res = await axios.post(baseUrl, {
                method: 'vincularMeioPagamento',
                token,
                data: { system_unit_id, codigo_opcao: codigoOpcao, nome_opcao: nomeOpcaoFull, codigo_meio: codMeio, nome_meio: nomMeio }
            });

            if(res.data.success) {
                window.parent.postMessage({ action: 'vinculo_sucesso' }, '*');
            } else {
                Swal.fire('Erro', res.data.message, 'error');
            }
        } catch(e) { Swal.fire('Erro', 'Falha ao salvar.', 'error'); }
    }

    async function carregarPlanosEBancos() {
        if($('#new_plano option').length > 1) return; // Evita recarregar se já tem dados

        try {
            const resPlan = await axios.post(baseUrl, { method: 'listPlanos', token, data: { system_unit_id } });
            const planos = Array.isArray(resPlan.data) ? resPlan.data : (resPlan.data.data || []);
            $('#new_plano').empty().append('<option value="">Selecione...</option>');
            planos.forEach(p => $('#new_plano').append(new Option(p.codigo + ' - ' + p.descricao, p.codigo)));

            const resBank = await axios.post(baseUrl, { method: 'listBancos', token, data: { system_unit_id } });
            const bancos = Array.isArray(resBank.data) ? resBank.data : (resBank.data.data || []);
            $('#new_banco').empty().append('<option value="">Selecione...</option>');
            bancos.forEach(b => $('#new_banco').append(new Option(b.nome, b.id)));
        } catch(e) { console.error(e); }
    }

    async function salvarNovaOpcao() {
        const data = {
            system_unit_id,
            codigo: $('#new_codigo').val(),
            nome: $('#new_nome').val(),
            taxa: $('#new_taxa').val(),
            prazo: $('#new_prazo').val(),
            plano_contas_id: $('#new_plano').val(),
            banco_id: $('#new_banco').val()
        };

        if(!data.codigo || !data.nome) return Swal.fire('Atenção', 'Preencha Código e Nome.', 'warning');

        try {
            const res = await axios.post(baseUrl, { method: 'createOpcaoRecebimento', token, data });
            if(res.data.success) {
                $('#modalNovaOpcao').modal('hide');
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Opção criada!', showConfirmButton: false, timer: 1500 });
                carregarOpcoes(data.codigo);
            } else {
                Swal.fire('Erro', res.data.message, 'error');
            }
        } catch(e) { Swal.fire('Erro', 'Falha ao criar opção.', 'error'); }
    }

    function abrirModalNovaOpcao() {

        $('#modalNovaOpcao').modal('show');

    }
</script>
</body>
</html>