<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vincular Meio de Pagamento</title>

    <link href="bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="bsb/plugins/node-waves/waves.css" rel="stylesheet">
    <link href="bsb/plugins/animate-css/animate.css" rel="stylesheet">
    <link href="bsb/css/style.css" rel="stylesheet">
    <link href="bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #fdfdfd; padding: 20px; overflow-x: hidden; }
        .card { box-shadow: none; border: 1px solid #eee; }
        .header h2 { font-size: 18px; color: #555; }
        .select2-container { width: 100% !important; }
        .btn-add-new { cursor: pointer; color: #4CAF50; font-weight: bold; margin-top: 5px; display: inline-block; }
        .btn-add-new:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="card" id="telaVinculo">
    <div class="body">
        <div class="alert alert-warning">
            O meio <strong><span id="lblMeioPDV">...</span></strong> veio do PDV e precisa ser associado a uma Opção Financeira.
        </div>

        <form>
            <input type="hidden" id="hd_codigo_meio_pdv">
            <input type="hidden" id="hd_nome_meio_pdv">

            <label>Selecione a Opção Financeira</label>
            <div class="input-group">
                <select id="selectOpcao" class="form-control">
                    <option value="">Carregando...</option>
                </select>
                <span class="input-group-addon" style="padding: 0; border: none; background: transparent; padding-left: 10px;">
                    <button type="button" class="btn btn-success waves-effect" onclick="abrirModalNovaOpcao()" title="Criar Nova Opção">
                        <i class="fa fa-plus"></i>
                    </button>
                </span>
            </div>

            <hr>
            <button type="button" class="btn btn-warning btn-lg btn-block waves-effect" onclick="salvarVinculo()">
                CONFIRMAR VÍNCULO
            </button>
        </form>
    </div>
</div>

<div class="modal fade" id="modalNovaOpcao" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success" style="padding: 10px 15px;">
                <h4 class="modal-title" style="color:white;">Nova Opção de Recebimento</h4>
            </div>
            <div class="modal-body">
                <form id="formNovaOpcao">
                    <div class="row">
                        <div class="col-xs-4">
                            <label>Código *</label>
                            <input type="text" id="new_codigo" class="form-control" placeholder="Ex: CREDIT">
                        </div>
                        <div class="col-xs-8">
                            <label>Nome *</label>
                            <input type="text" id="new_nome" class="form-control" placeholder="Ex: Cartão Crédito">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6">
                            <label>Taxa (%)</label>
                            <input type="number" id="new_taxa" class="form-control" value="0">
                        </div>
                        <div class="col-xs-6">
                            <label>Prazo (Dias)</label>
                            <input type="number" id="new_prazo" class="form-control" value="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Plano de Contas</label>
                        <select id="new_plano" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>Banco</label>
                        <select id="new_banco" class="form-control"></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarNovaOpcao()">SALVAR OPÇÃO</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    const system_unit_id = urlParams.get('system_unit_id');
    const nomeMeioPDV = urlParams.get('meio');
    const codigoMeioPDV = urlParams.get('codigo'); // Novo parâmetro

    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/financeiro.php'
        : 'http://localhost/portal-mrk/api/v1/financeiro.php';

    $(document).ready(function() {
        // Preenche o header e os inputs ocultos
        $('#lblMeioPDV').text(`${nomeMeioPDV} (Cód: ${codigoMeioPDV || '?'})`);

        $('#hd_codigo_meio_pdv').val(codigoMeioPDV);
        $('#hd_nome_meio_pdv').val(nomeMeioPDV);

        // Configura Select2
        $('#selectOpcao').select2();
        $('#new_plano').select2({ dropdownParent: $('#modalNovaOpcao') });

        carregarOpcoes();

        $('#modalNovaOpcao').on('show.bs.modal', function () {
            carregarPlanosEBancos();
        });
    });

    async function carregarOpcoes(selecionarCodigo = null) {
        try {
            const res = await axios.post(baseUrl, { method: 'listOpcoesRecebimento', token, data: { system_unit_id } });
            const corpo = res.data;
            const lista = Array.isArray(corpo) ? corpo : (corpo.data || []);

            const select = $('#selectOpcao');
            select.empty().append('<option value="">Selecione...</option>');

            if (lista.length === 0) {
                console.warn("Nenhuma opção encontrada ou formato de API incorreto.");
            }

            lista.forEach(op => {
                select.append(new Option(`${op.nome} (${op.codigo})`, op.codigo));
            });

            if(selecionarCodigo) {
                select.val(selecionarCodigo).trigger('change');
            }
        } catch(e) {
            console.error(e);
            Swal.fire('Erro', 'Falha ao carregar opções.', 'error');
        }
    }

    async function salvarVinculo() {
        const codigoOpcao = $('#selectOpcao').val();

        if(!codigoOpcao) return Swal.fire('Atenção', 'Selecione uma opção financeira.', 'warning');

        // Dados para envio
        const nomeOpcaoFull = $('#selectOpcao option:selected').text().split('(')[0].trim();
        const codMeio = $('#hd_codigo_meio_pdv').val();
        const nomMeio = $('#hd_nome_meio_pdv').val();

        Swal.fire({ title: 'Vinculando...', didOpen: () => Swal.showLoading() });

        try {
            const res = await axios.post(baseUrl, {
                method: 'vincularMeioPagamento',
                token,
                data: {
                    system_unit_id,
                    codigo_opcao: codigoOpcao,
                    nome_opcao: nomeOpcaoFull,
                    codigo_meio: codMeio, // Usa o código oculto
                    nome_meio: nomMeio    // Usa o nome oculto
                }
            });

            if(res.data.success) {
                window.parent.postMessage({ action: 'vinculo_sucesso' }, '*');
            } else {
                Swal.fire('Erro', res.data.message, 'error');
            }
        } catch(e) { Swal.fire('Erro', 'Falha ao salvar.', 'error'); }
    }

    // --- CADASTRO DE NOVA OPÇÃO ---
    function abrirModalNovaOpcao() {
        $('#modalNovaOpcao').modal('show');
    }

    async function carregarPlanosEBancos() {
        if($('#new_plano option').length > 0) return;

        try {
            const resPlan = await axios.post(baseUrl, { method: 'listPlanos', token, data: { system_unit_id } });
            const planos = Array.isArray(resPlan.data) ? resPlan.data : (resPlan.data.data || []);
            $('#new_plano').empty().append('<option value="">Plano de Contas...</option>');
            planos.forEach(p => {
                $('#new_plano').append(new Option(p.codigo + ' - ' + p.descricao, p.codigo));
            });

            const resBank = await axios.post(baseUrl, { method: 'listBancos', token, data: { system_unit_id } });
            const bancos = Array.isArray(resBank.data) ? resBank.data : (resBank.data.data || []);
            $('#new_banco').empty().append('<option value="">Banco...</option>');
            bancos.forEach(b => {
                $('#new_banco').append(new Option(b.nome, b.id));
            });
        } catch(e) { console.error(e); }
    }

    async function salvarNovaOpcao() {
        const data = {
            system_unit_id,
            codigo: $('#new_codigo').val(),
            nome: $('#new_nome').val(),
            taxa: $('#new_taxa').val(),
            prazo: $('#new_prazo').val(),
            plano_contas_id: $('#new_plano').val(),
            banco_id: $('#new_banco').val()
        };

        if(!data.codigo || !data.nome) return Swal.fire('Atenção', 'Preencha Código e Nome.', 'warning');

        try {
            const res = await axios.post(baseUrl, { method: 'createOpcaoRecebimento', token, data });
            if(res.data.success) {
                $('#modalNovaOpcao').modal('hide');
                Swal.fire({
                    toast: true, position: 'top-end', icon: 'success',
                    title: 'Opção criada!', showConfirmButton: false, timer: 1500
                });
                carregarOpcoes(data.codigo);
            } else {
                Swal.fire('Erro', res.data.message, 'error');
            }
        } catch(e) { Swal.fire('Erro', 'Falha ao criar opção.', 'error'); }
    }
</script>
</body>
</html>