<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Estoque & Financeiro</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root{
            --mrk-blue: #0B46AC;
            --mrk-green: #08A794;
            --mrk-gray: #EBEBEB;
            --mrk-black: #191F2A;
            --mrk-amber: #f59e0b;
        }
        .animate-number { transition: all 1s ease-in-out; }
        .btn-mrk {
            background: color-mix(in srgb, var(--mrk-blue) 12%, white);
            color: var(--mrk-blue);
            border: 1px solid color-mix(in srgb, var(--mrk-blue) 25%, white);
        }
        .btn-mrk:hover { background: color-mix(in srgb, var(--mrk-blue) 20%, white); }
    </style>
</head>

<body class="text-gray-800" style="background: var(--mrk-gray);">

<div class="p-6">
    <div class="mb-6">
        <div class="flex items-center gap-4 flex-wrap">
            <button onclick="setRange('hoje')" class="btn-mrk px-3 py-1 rounded shadow">Hoje</button>
            <button onclick="setRange('ontem')" class="btn-mrk px-3 py-1 rounded shadow">Ontem</button>
            <button onclick="setRange('7dias')" class="btn-mrk px-3 py-1 rounded shadow">Últimos 7 dias</button>
            <button onclick="setRange('mes')" class="btn-mrk px-3 py-1 rounded shadow">Últimos 30 dias</button>

            <input type="date" id="startDate" onchange="fetchData()" class="border p-2 rounded-md shadow bg-white" />
            <input type="date" id="endDate" onchange="fetchData()" class="border p-2 rounded-md shadow bg-white" />

            <select id="filtroGrupo" class="border p-2 rounded-md shadow bg-white">
                <option value="">Todos os Grupos</option>
            </select>

            <select id="filtroLoja" class="border p-2 rounded-md shadow bg-white">
                <option value="">Todas as lojas</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-blue);">
            <div class="text-4xl" style="color: var(--mrk-blue);"><i class="fas fa-dollar-sign"></i></div>
            <div>
                <div class="text-sm font-semibold">Faturamento</div>
                <div class="text-2xl font-extrabold animate-number" id="faturamentoBruto">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-green);">
            <div class="text-4xl" style="color: var(--mrk-green);"><i class="fas fa-shopping-cart"></i></div>
            <div>
                <div class="text-sm font-semibold">Compras</div>
                <div class="text-2xl font-extrabold animate-number" id="totalCompras">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-black);">
            <div class="text-4xl" style="color: var(--mrk-black);"><i class="fas fa-percent"></i></div>
            <div>
                <div class="text-sm font-semibold">% Compras x Fat.</div>
                <div class="text-2xl font-extrabold animate-number" id="percentualCompras">0%</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-amber);">
            <div class="text-4xl" style="color: var(--mrk-amber);"><i class="fas fa-file-invoice"></i></div>
            <div class="flex-1">
                <div class="text-sm font-semibold">Notas Pendentes</div>
                <div class="flex items-center justify-between">
                    <div class="text-2xl font-extrabold" id="qtdNotasPendentes">0</div>
                    <small>Ultimos 30 dias</small>

                    <button onclick="verDetalhesNotasPendentes()" class="text-xs bg-amber-50 hover:bg-amber-100 text-amber-700 font-bold px-2 py-1 rounded border border-amber-200 transition-all">
                        Ver mais
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Evolução do Faturamento</h2>
            <div id="chartFaturamentoDiario" style="width:100%; height:320px;"></div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Evolução das Compras</h2>
            <div id="chartComprasDiario" style="width:100%; height:320px;"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 h-[350px] rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">TOP 5 - COMPRAS POR PRODUTO</h2>
            <div id="chartTopProdutos" class="w-full h-full"></div>
        </div>
        <div class="bg-white p-6 h-[350px] rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">TOP 5 - COMPRAS POR FORNECEDOR</h2>
            <div id="chartTopFornecedores" class="w-full h-full"></div>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id'));
    const user_id = parseInt(urlParams.get('user_id'));
    const token = urlParams.get('token');

    const MRK = {
        blue:  '#0B46AC',
        green: '#08A794',
        gray:  '#EBEBEB',
        black: '#191F2A',
        amber: '#f59e0b',
        series: ['#0B46AC', '#08A794', '#191F2A', '#0B46AC80', '#08A79480']
    };

    let grupoId = null;
    let resumoEstoqueGrupo = [], evolucaoCmvGrupo = [], datasEvolucao = [], cmvProdutosGrupo = [], topFornecedoresGrupo = [], listaNotasPendentes = [];
    let gruposDisponiveis = {}, lojasPorGrupo = {};

    // --- FUNÇÕES DE APOIO ---
    function animateValue(id, start, end, duration, isCurrency = false, isPercentage = false) {
        const element = document.getElementById(id);
        if (!element) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);
            element.textContent = isCurrency ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : isPercentage ? value.toFixed(2) + '%' : Math.floor(value);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    function parseBRL(v) {
        if (v == null) return 0;
        if (typeof v === 'number') return v;
        return Number(String(v).replace(/[^\d,-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
    }

    function setRange(tipo) {
        const now = new Date();
        const start = new Date();
        if (tipo === 'ontem') start.setDate(now.getDate() - 1);
        else if (tipo === '7dias') start.setDate(now.getDate() - 7);
        else if (tipo === 'mes') start.setMonth(now.getMonth() - 1);
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        fetchData();
    }

    // --- CARREGAMENTO DE DADOS ---
    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUnit', token, data: { system_unit_id } });
        if (res.data?.length > 0) grupoId = res.data[0].id;
        await carregarGruposUsuario();
    }

    async function carregarGruposUsuario() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUser', token, data: { user_id } });
        const { grupos, lojas_por_grupo } = res.data;
        gruposDisponiveis = grupos; lojasPorGrupo = lojas_por_grupo;
        const grupoSelect = document.getElementById('filtroGrupo');
        grupoSelect.innerHTML = '';
        grupos.forEach(grupo => {
            grupoSelect.innerHTML += `<option value="${grupo.id}" ${grupo.id == grupoId ? 'selected' : ''}>${grupo.nome}</option>`;
        });
        grupoSelect.addEventListener('change', () => {
            grupoId = parseInt(grupoSelect.value);
            resetarEstadoDashboard(); limparCharts(); atualizarFiltroLoja();
            document.getElementById('filtroLoja').value = "";
            fetchData();
        });
        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        const filtro = document.getElementById('filtroLoja');
        filtro.innerHTML = '<option value="">Todas as lojas</option>';
        lojas.forEach(loja => { filtro.innerHTML += `<option value="${loja.id}">${loja.name}</option>`; });
    }

    async function fetchData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const dt_inicio = startDate + ' 00:00:00';
        const dt_fim = endDate + ' 23:59:59';

        Swal.fire({ title: 'Carregando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            // Paralelizando chamadas para performance
            await Promise.all([
                carregarResumoEstoquePorGrupo(dt_inicio, dt_fim),
                carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim),
                carregarCmvProdutosPorGrupo(dt_inicio, dt_fim),
                carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim),
                carregarNotasPendentes()
            ]);
            aplicarFiltroLoja();
        } catch (err) {
            Swal.fire('Erro ao carregar', err.message, 'error');
        } finally {
            Swal.close();
        }
    }

    async function carregarResumoEstoquePorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateResumoEstoquePorGrupo', token, data: { grupoId, dt_inicio, dt_fim } });
        resumoEstoqueGrupo = res.data.data || [];
    }

    async function carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateCmvEvolucao', token, data: { grupoId, dt_inicio, dt_fim } });
        evolucaoCmvGrupo = res.data.data || []; datasEvolucao = res.data.labels || [];
    }

    async function carregarCmvProdutosPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateCmvPorProduto', token, data: { grupoId, dt_inicio, dt_fim } });
        cmvProdutosGrupo = res.data.data || [];
    }

    async function carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateTopComprasPorFornecedor', token, data: { grupoId, dt_inicio, dt_fim } });
        topFornecedoresGrupo = res.data.data || [];
    }

    async function carregarNotasPendentes() {
        const filtroLojaEl = document.getElementById('filtroLoja');
        // Prioriza a loja selecionada no combo, se não houver, usa a da URL
        const selectedLoja = parseInt(filtroLojaEl.value) || system_unit_id;

        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotasNaoImportadasUltimos30Dias',
                token,
                data: { system_unit_id: selectedLoja }
            });

            // Correção aqui: acessamos res.data.data.notas_pendentes
            if (res.data.success && res.data.data && res.data.data.notas_pendentes) {
                listaNotasPendentes = res.data.data.notas_pendentes;
                // Atualiza o contador com o total_pendentes do seu JSON
                document.getElementById('qtdNotasPendentes').textContent = res.data.data.total_pendentes || listaNotasPendentes.length;
            } else {
                listaNotasPendentes = [];
                document.getElementById('qtdNotasPendentes').textContent = "0";
            }
        } catch (e) {
            console.error("Erro na API de Notas:", e);
            listaNotasPendentes = [];
            document.getElementById('qtdNotasPendentes').textContent = "0";
        }
    }

    function verDetalhesNotasPendentes() {
        if (!Array.isArray(listaNotasPendentes) || listaNotasPendentes.length === 0) {
            return Swal.fire('Tudo em dia!', 'Nenhuma nota pendente nos últimos 30 dias.', 'success');
        }

        // Calcula o valor total das notas pendentes
        const valorTotalGeral = listaNotasPendentes.reduce((acc, n) => acc + Number(n.valor_total), 0);

        let html = `
        <div class="flex items-center justify-between bg-amber-50 border border-amber-200 p-4 rounded-lg mb-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="text-3xl text-amber-600"><i class="fas fa-file-invoice-dollar"></i></div>
                <div>
                    <div class="text-xs font-bold text-amber-800 uppercase tracking-wider">Total Pendente (30 dias)</div>
                    <div class="text-2xl font-black text-amber-900">
                        R$ ${valorTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits:2})}
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold text-amber-800 uppercase tracking-wider">Quantidade</div>
                <div class="text-2xl font-black text-amber-900">${listaNotasPendentes.length}</div>
            </div>
        </div>

        <div class="max-h-[50vh] overflow-y-auto border rounded-lg">
            <table class="w-full text-xs text-left border-collapse">
                <thead>
                    <tr class="bg-gray-100 sticky top-0 shadow-sm z-10">
                        <th class="p-3 border-b">Emissão</th>
                        <th class="p-3 border-b">NF / Série</th>
                        <th class="p-3 border-b">Fornecedor</th>
                        <th class="p-3 border-b text-right">Valor</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    ${listaNotasPendentes.map(n => `
                        <tr class="hover:bg-blue-50 transition-colors">
                            <td class="p-3">${new Date(n.data_emissao + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                            <td class="p-3 font-medium text-gray-600">${n.numero_nf} / ${n.serie}</td>
                            <td class="p-3 uppercase text-gray-700 font-semibold">${n.emitente_razao}</td>
                            <td class="p-3 text-right font-bold text-blue-700">
                                R$ ${Number(n.valor_total).toLocaleString('pt-BR', {minimumFractionDigits:2})}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>`;

        Swal.fire({
            title: 'Detalhamento de Notas Pendentes',
            html,
            width: '850px',
            confirmButtonColor: MRK.blue,
            confirmButtonText: 'Fechar Janela',
            showCloseButton: true
        });
    }

    // --- RENDERIZAÇÃO ---
    function aplicarFiltroLoja() {
        const filtroLojaEl = document.getElementById('filtroLoja');
        let selectedLoja = parseInt(filtroLojaEl.value) || null;

        const filtradoResumo = resumoEstoqueGrupo.filter(l => !selectedLoja || l.lojaId === selectedLoja);
        const filtradoCmvProdutos = cmvProdutosGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);
        const filtradoFornecedores = topFornecedoresGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);

        const nomeSelecionado = selectedLoja ? (lojasPorGrupo[grupoId].find(x => parseInt(x.id) === selectedLoja)?.name) : null;
        const filtradoEvolucao = evolucaoCmvGrupo.filter(l => !nomeSelecionado || l.nome === nomeSelecionado);

        renderResumo(filtradoResumo);
        renderEvolucaoBarras(filtradoEvolucao, datasEvolucao);
        renderChartTopProdutos(agregarProdutos(filtradoCmvProdutos));
        renderChartTopFornecedores(agregarFornecedores(filtradoFornecedores));
    }

    function renderResumo(data) {
        let fat = 0, comp = 0;
        data.forEach(l => { fat += parseBRL(l.faturamento_bruto); comp += parseBRL(l.total_compras); });
        animateValue('faturamentoBruto', 0, fat, 1000, true);
        animateValue('totalCompras', 0, comp, 1000, true);
        animateValue('percentualCompras', 0, fat > 0 ? (comp / fat) * 100 : 0, 1000, false, true);
    }

    function renderEvolucaoBarras(lojas, labels) {
        const config = (id, tipo) => {
            const chart = echarts.init(document.getElementById(id));
            const series = lojas.map((l, i) => ({
                name: l.nome, type: 'bar', stack: 'total',
                data: tipo === 'fat' ? l.faturamento : l.compras,
                itemStyle: { color: MRK.series[i % MRK.series.length] }
            }));
            chart.setOption({
                legend: { top: 0 }, tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: labels },
                yAxis: { type: 'value' },
                series
            });
        };
        config('chartFaturamentoDiario', 'fat');
        config('chartComprasDiario', 'comp');
    }

    function agregarProdutos(data) {
        const res = {};
        data.forEach(l => (l.produtos || []).forEach(p => { res[p.name] = (res[p.name] || 0) + parseFloat(p.value); }));
        return Object.entries(res).map(([nome, valor]) => ({nome, valor})).sort((a,b) => b.valor - a.valor).slice(0,5);
    }

    function agregarFornecedores(data) {
        const res = {};
        data.forEach(l => (l.fornecedores || []).forEach(f => {
            if(!res[f.fornecedor]) res[f.fornecedor] = {nome: f.fornecedor, valor: 0, qtd: 0};
            res[f.fornecedor].valor += parseFloat(f.valor_total);
            res[f.fornecedor].qtd += parseInt(f.qtd_notas);
        }));
        return Object.values(res).sort((a,b) => b.valor - a.valor).slice(0,5);
    }

    function renderChartTopProdutos(data) {
        const chart = echarts.init(document.getElementById('chartTopProdutos'));
        chart.setOption({
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: data.map(d => d.nome.slice(0,15)), inverse: true },
            xAxis: { type: 'value' },
            series: [{ type: 'bar', data: data.map(d => d.valor), itemStyle: { color: MRK.blue } }]
        });
    }

    function renderChartTopFornecedores(data) {
        const chart = echarts.init(document.getElementById('chartTopFornecedores'));
        chart.setOption({
            tooltip: { trigger: 'axis' },
            yAxis: { type: 'category', data: data.map(d => d.nome.slice(0,15)), inverse: true },
            xAxis: { type: 'value' },
            series: [{ type: 'bar', data: data.map(d => d.valor), itemStyle: { color: MRK.green } }]
        });
    }

    function resetarEstadoDashboard() {
        resumoEstoqueGrupo = []; evolucaoCmvGrupo = []; cmvProdutosGrupo = []; topFornecedoresGrupo = [];
    }

    function limparCharts() {
        ['chartFaturamentoDiario','chartComprasDiario','chartTopProdutos','chartTopFornecedores'].forEach(id => {
            const inst = echarts.getInstanceByDom(document.getElementById(id));
            if (inst) inst.dispose();
        });
    }

    window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('filtroLoja').addEventListener('change', async () => {
            await carregarNotasPendentes(); // Recarrega as notas da unidade específica
            aplicarFiltroLoja();
        });
        await carregarGrupoInicial();
        setRange('7dias');
    });
</script>

</body>
</html>