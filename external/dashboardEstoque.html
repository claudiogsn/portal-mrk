<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Estoque | Portal MRK</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.8/dist/iconify-icon.min.js"></script>

    <style>
        :root {
            --mrk-blue: #0B46AC;
            --mrk-green: #2e7d32;
            --mrk-amber: #ffa000;
            --mrk-red: #d32f2f;
            --bg-gray: #F4F7F6;
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-gray); color: #333; }
        h1, h2, h3, .kanit { font-family: 'Kanit', sans-serif; }

        .mrk-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-top: 3px solid var(--mrk-blue);
        }

        .card-green { border-top-color: var(--mrk-green); }
        .card-amber { border-top-color: var(--mrk-amber); }
        .card-black { border-top-color: #191F2A; }

        label { font-family: 'Kanit', sans-serif; font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .form-control {
            height: 38px; border-radius: 6px; border: 1px solid #d1d5db; padding: 0 10px; font-size: 13px; width: 100%;
        }

        .btn-mrk {
            padding: 6px 12px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;
            font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.2s;
        }
        .btn-mrk:hover { border-color: var(--mrk-blue); color: var(--mrk-blue); background: #f0f4fa; }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px; color: transparent !important;
        }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .chart-skel { position: absolute; inset: 0; background: white; z-index: 10; display: flex; flex-direction: column; padding: 20px; }
    </style>
</head>

<body class="text-gray-800">
<div class="p-6 mx-auto">

    <div class="mrk-card p-4 mb-6" style="border-top-width: 2px;">
        <div class="flex items-end gap-4 flex-wrap">
            <div class="flex-1 min-w-[300px]">
                <label>Atalhos de Período</label>
                <div class="flex gap-2">
                    <button onclick="setRange('hoje')" class="btn-mrk">Hoje</button>
                    <button onclick="setRange('ontem')" class="btn-mrk">Ontem</button>
                    <button onclick="setRange('7dias')" class="btn-mrk">7 Dias</button>
                    <button onclick="setRange('mes')" class="btn-mrk">30 Dias</button>
                </div>
            </div>
            <div class="w-40">
                <label>Data Início</label>
                <input type="date" id="startDate" class="form-control filter-input" />
            </div>
            <div class="w-40">
                <label>Data Fim</label>
                <input type="date" id="endDate" class="form-control filter-input" />
            </div>
            <div class="w-56">
                <label>Grupo</label>
                <select id="filtroGrupo" class="form-control filter-input"></select>
            </div>
            <div class="w-56">
                <label>Loja</label>
                <select id="filtroLoja" class="form-control filter-input"></select>
            </div>
            <div class="w-44">
                <button id="btnAplicar" onclick="fetchData()" class="hidden bg-blue-700 hover:bg-blue-800 text-white font-bold h-[38px] px-4 rounded shadow-lg transition-all flex items-center justify-center gap-2 w-full">
                    <iconify-icon icon="icon-park-outline:check-one"></iconify-icon> APLICAR
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="mrk-card p-6 flex items-center gap-5">
            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-700 text-2xl">
                <iconify-icon icon="icon-park-outline:finance"></iconify-icon>
            </div>
            <div class="flex-1">
                <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Faturamento Bruto</div>
                <div class="text-2xl font-bold kanit kpi-value" id="faturamentoBruto">R$ 0,00</div>
            </div>
        </div>

        <div class="mrk-card p-6 card-green flex items-center gap-5">
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-green-700 text-2xl">
                <iconify-icon icon="icon-park-outline:shopping-cart"></iconify-icon>
            </div>
            <div class="flex-1">
                <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">Total Compras</div>
                <div class="text-2xl font-bold kanit kpi-value" id="totalCompras">R$ 0,00</div>
            </div>
        </div>

        <div class="mrk-card p-6 card-black flex items-center gap-5">
            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center text-gray-800 text-2xl">
                <iconify-icon icon="icon-park-outline:percentage"></iconify-icon>
            </div>
            <div class="flex-1">
                <div class="text-[10px] font-bold uppercase text-gray-500 tracking-wider">% Compras / Fat</div>
                <div class="text-2xl font-bold kanit kpi-value" id="percentualCompras">0%</div>
            </div>
        </div>

        <div class="mrk-card p-5 card-amber">
            <div class="flex items-center justify-between mb-1">
                <div class="text-[10px] font-bold uppercase text-gray-500">Notas Pendentes</div>
                <iconify-icon icon="icon-park-outline:file-invoice" class="text-amber-600 text-xl"></iconify-icon>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <div class="text-2xl font-bold kanit kpi-value" id="qtdNotasPendentes">-</div>
                    <div id="nomeLojaPendente" class="text-[9px] font-bold text-gray-400 uppercase truncate max-w-[120px]">Selecione uma loja</div>
                </div>
                <div class="flex gap-1">
                    <button onclick="atualizarNotasPendentesForce(this)" class="p-2 text-amber-600 hover:bg-amber-50 rounded-md transition-colors" title="Sincronizar">
                        <iconify-icon icon="icon-park-outline:refresh"></iconify-icon>
                    </button>
                    <button onclick="verDetalhesNotasPendentes()" class="text-[10px] bg-amber-600 text-white font-bold px-2 py-1 rounded hover:bg-amber-700">VER MAIS</button>
                </div>
            </div>
            <div id="msgCache" class="text-[9px] text-gray-400 mt-1 hidden"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="mrk-card p-6 relative">
            <h2 class="text-md font-bold mb-4 uppercase flex items-center gap-2">Evolução do Faturamento</h2>
            <div id="chartFaturamentoDiario" style="width:100%; height:320px;"></div>
            <div id="skel-chartFaturamentoDiario" class="chart-skel hidden"><div class="flex-1 skeleton"></div></div>
        </div>
        <div class="mrk-card p-6 relative">
            <h2 class="text-md font-bold mb-4 uppercase flex items-center gap-2">Evolução das Compras</h2>
            <div id="chartComprasDiario" style="width:100%; height:320px;"></div>
            <div id="skel-chartComprasDiario" class="chart-skel hidden"><div class="flex-1 skeleton"></div></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="mrk-card p-6 h-[350px] relative">
            <h2 class="text-md font-bold mb-4 uppercase">Top 5 Compras por Produto</h2>
            <div id="chartTopProdutos" class="w-full h-full"></div>
            <div id="skel-chartTopProdutos" class="chart-skel hidden"><div class="flex-1 skeleton"></div></div>
        </div>
        <div class="mrk-card p-6 h-[350px] relative">
            <h2 class="text-md font-bold mb-4 uppercase">Top 5 Compras por Fornecedor</h2>
            <div id="chartTopFornecedores" class="w-full h-full"></div>
            <div id="skel-chartTopFornecedores" class="chart-skel hidden"><div class="flex-1 skeleton"></div></div>
        </div>
    </div>
</div>

<script>
    'use strict';

    const baseUrl = window.location.hostname !== 'localhost' ? 'https://portal.mrksolucoes.com.br/api/v1/index.php' : 'http://localhost/portal-mrk/api/v1/index.php';
    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id')), user_id = parseInt(urlParams.get('user_id')), token = urlParams.get('token');

    const MRK = { blue: '#0B46AC', green: '#2e7d32', gray: '#EBEBEB', black: '#191F2A', amber: '#ffa000', palette: ['#0B46AC', '#2e7d32', '#191F2A', '#ffa000', '#673ab7'] };

    // FORMATADOR DE MOEDA
    const formatCurrency = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // HELPER: LIMPEZA DE STRING PARA FLOAT
    function cleanFloat(v) {
        if (typeof v === 'number') return v;
        if (!v || v === "" || v === "-") return 0;
        let clean = v.toString().replace("R$", "").replace(/\s/g, "").replace(/\./g, "").replace(",", ".");
        return parseFloat(clean) || 0;
    }

    let grupoId = null, resumoEstoqueGrupo = [], evolucaoCmvGrupo = [], datasEvolucao = [], cmvProdutosGrupo = [], topFornecedoresGrupo = [], listaNotasPendentes = [], lojasPorGrupo = {};

    // --- FUNÇÕES DE UI ---
    function showApplyButton() { document.getElementById('btnAplicar').classList.remove('hidden'); }
    function hideApplyButton() { document.getElementById('btnAplicar').classList.add('hidden'); }

    function setRange(tipo) {
        const now = new Date(), start = new Date();
        if (tipo === 'ontem') start.setDate(now.getDate() - 1);
        else if (tipo === '7dias') start.setDate(now.getDate() - 7);
        else if (tipo === 'mes') start.setMonth(now.getMonth() - 1);
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        showApplyButton();
    }

    function toggleSkeletons(isLoading) {
        if(isLoading) {
            document.querySelectorAll('.kpi-value').forEach(el => el.classList.add('skeleton'));
            document.querySelectorAll('.chart-skel').forEach(el => el.classList.remove('hidden'));
        } else {
            document.querySelectorAll('.kpi-value').forEach(el => el.classList.remove('skeleton'));
            document.querySelectorAll('.chart-skel').forEach(el => el.classList.add('hidden'));
        }
    }

    function animateValue(id, start, end, duration, isCurrency = false, isPercentage = false) {
        const el = document.getElementById(id); if (!el) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);
            el.textContent = isCurrency ? formatCurrency(value) : (isPercentage ? value.toFixed(2) + '%' : Math.floor(value));
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // --- CORE DE DADOS ---
    async function fetchData() {
        hideApplyButton();
        const start = document.getElementById('startDate').value, end = document.getElementById('endDate').value;
        const dt_inicio = start + ' 00:00:00', dt_fim = end + ' 23:59:59';
        const lojaSel = document.getElementById('filtroLoja').value;

        toggleSkeletons(true);

        const promises = [
            axios.post(baseUrl, { method: 'generateResumoEstoquePorGrupo', token, data: { grupoId, dt_inicio, dt_fim } }),
            axios.post(baseUrl, { method: 'generateCmvEvolucao', token, data: { grupoId, dt_inicio, dt_fim } }),
            axios.post(baseUrl, { method: 'generateCmvPorProduto', token, data: { grupoId, dt_inicio, dt_fim } }),
            axios.post(baseUrl, { method: 'generateTopComprasPorFornecedor', token, data: { grupoId, dt_inicio, dt_fim } })
        ];

        if (lojaSel) promises.push(carregarNotasPendentes(lojaSel));
        else resetNotasPendentesUI();

        try {
            const results = await Promise.all(promises);
            resumoEstoqueGrupo = results[0].data.data || [];
            evolucaoCmvGrupo = results[1].data.data || [];
            datasEvolucao = results[1].data.labels || [];
            cmvProdutosGrupo = results[2].data.data || [];
            topFornecedoresGrupo = results[3].data.data || [];
            aplicarFiltroLoja();
        } catch (e) { Swal.fire('Erro', 'Falha ao buscar dados.', 'error'); }
        finally { toggleSkeletons(false); }
    }

    // --- LÓGICA DE NOTAS PENDENTES (AS QUE ESTAVAM FALTANDO) ---

    function resetNotasPendentesUI() {
        document.getElementById('qtdNotasPendentes').textContent = '-';
        const nomeEl = document.getElementById('nomeLojaPendente');
        nomeEl.textContent = 'Selecione uma loja';
        nomeEl.classList.remove('text-amber-600');
        nomeEl.classList.add('text-gray-400');
        document.getElementById('msgCache').classList.add('hidden');
        listaNotasPendentes = [];
    }

    async function carregarNotasPendentes(id) {
        try {
            const res = await axios.post(baseUrl, { method: 'listarNotasNaoImportadasUltimos30DiasCached', token, data: { system_unit_id: id } });
            processarRespostaNotas(res.data);
        } catch(e) { console.error(e); }
    }

    // *** FUNÇÃO CORRIGIDA E REINSERIDA ***
    window.atualizarNotasPendentesForce = async function(btn) {
        const id = document.getElementById('filtroLoja').value;
        if(!id) return Swal.fire('Aviso', 'Selecione uma loja para sincronizar.', 'warning');

        const icon = btn.querySelector('iconify-icon');
        // Efeito de loading no ícone
        if(icon) icon.style.animation = "spin 1s linear infinite";

        try {
            const res = await axios.post(baseUrl, { method: 'listarNotasNaoImportadasUltimos30Dias', token, data: { system_unit_id: id } });
            processarRespostaNotas(res.data);
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'Sincronizado!' });
        } catch(e) {
            Swal.fire('Erro', 'Erro ao sincronizar notas.', 'error');
        } finally {
            if(icon) icon.style.animation = "";
        }
    }

    // *** FUNÇÃO CORRIGIDA E REINSERIDA ***
    window.verDetalhesNotasPendentes = function() {
        // 1. Validação
        const filtroLojaEl = document.getElementById('filtroLoja');
        if(!filtroLojaEl.value) {
            return Swal.fire({
                icon: 'warning',
                title: 'Atenção',
                text: 'Selecione uma loja para ver os detalhes.',
                confirmButtonColor: '#0B46AC'
            });
        }

        if (!Array.isArray(listaNotasPendentes) || listaNotasPendentes.length === 0) {
            return Swal.fire({
                icon: 'success',
                title: 'Tudo em dia!',
                text: 'Nenhuma nota pendente para esta loja.',
                confirmButtonColor: '#0B46AC'
            });
        }

        // 2. Cálculos
        const valorTotalGeral = listaNotasPendentes.reduce((acc, n) => acc + Number(n.valor_total), 0);

        // 3. Construção do HTML (Layout MRK)
        let html = `
    <div class="flex items-center justify-between bg-amber-50 border border-amber-200 p-5 rounded-lg mb-5 shadow-sm">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 text-2xl">
                <iconify-icon icon="icon-park-outline:bill"></iconify-icon>
            </div>
            <div class="text-left">
                <div class="text-[10px] font-bold text-amber-800 uppercase tracking-wider mb-1">Total Pendente</div>
                <div class="text-2xl font-bold text-amber-900 kanit">
                    ${valorTotalGeral.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                </div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-[10px] font-bold text-amber-800 uppercase tracking-wider mb-1">Qtd Notas</div>
            <div class="text-2xl font-bold text-amber-900 kanit">${listaNotasPendentes.length}</div>
        </div>
    </div>

    <div class="max-h-[55vh] overflow-y-auto border border-gray-200 rounded-lg custom-scrollbar">
        <table class="w-full text-xs text-left border-collapse">
            <thead class="bg-gray-50 sticky top-0 shadow-sm z-10">
                <tr>
                    <th class="p-3 border-b text-gray-500 font-bold uppercase tracking-wider">Emissão</th>
                    <th class="p-3 border-b text-gray-500 font-bold uppercase tracking-wider">NF / Série</th>
                    <th class="p-3 border-b text-gray-500 font-bold uppercase tracking-wider">Fornecedor</th>
                    <th class="p-3 border-b text-right text-gray-500 font-bold uppercase tracking-wider">Valor</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 bg-white">
                ${listaNotasPendentes.map(n => `
                    <tr class="hover:bg-blue-50 transition-colors duration-150">
                        <td class="p-3 text-gray-600">
                            ${new Date(n.data_emissao + 'T00:00:00').toLocaleDateString('pt-BR')}
                        </td>
                        <td class="p-3 font-medium text-gray-800">
                            ${n.numero_nf} <span class="text-gray-400 text-[10px]">/ ${n.serie}</span>
                        </td>
                        <td class="p-3 uppercase text-gray-600 truncate max-w-[200px]" title="${n.emitente_razao}">
                            ${n.emitente_razao.slice(0, 25)}${n.emitente_razao.length > 25 ? '...' : ''}
                        </td>
                        <td class="p-3 text-right font-bold text-blue-700">
                            ${Number(n.valor_total).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    </div>`;

        // 4. Exibição Modal
        Swal.fire({
            title: '<div class="flex items-center gap-2 text-xl font-bold text-[#0B46AC] font-sans"><iconify-icon icon="icon-park-outline:file-invoice"></iconify-icon> Notas Pendentes de Importação</div>',
            html: html,
            width: '850px',
            showConfirmButton: true,
            confirmButtonText: 'FECHAR',
            confirmButtonColor: '#0B46AC',
            buttonsStyling: true,
            customClass: {
                popup: 'rounded-xl',
                confirmButton: 'font-bold px-6 py-2 rounded-lg'
            }
        });
    }

    function processarRespostaNotas(data) {
        const sel = document.getElementById('filtroLoja');
        const nomeLoja = sel.options[sel.selectedIndex].text;
        const nomeEl = document.getElementById('nomeLojaPendente');

        nomeEl.textContent = nomeLoja;
        nomeEl.classList.remove('text-gray-400');
        nomeEl.classList.add('text-amber-600');

        if (data.success && data.data) {
            listaNotasPendentes = data.data.notas_pendentes || [];
            document.getElementById('qtdNotasPendentes').textContent = data.data.total_pendentes || listaNotasPendentes.length;
            if(data.data.last_update) {
                const d = new Date(data.data.last_update);
                document.getElementById('msgCache').textContent = `Atualizado: ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
                document.getElementById('msgCache').classList.remove('hidden');
            }
        }
    }

    // --- RENDERIZAÇÃO ---
    function aplicarFiltroLoja() {
        const lojaId = parseInt(document.getElementById('filtroLoja').value) || null;
        const f = l => !lojaId || l.lojaId == lojaId;
        const lojaObj = lojaId ? lojasPorGrupo[grupoId].find(x => parseInt(x.id) === lojaId) : null;
        const fName = lojaObj ? lojaObj.name : null;

        renderResumo(resumoEstoqueGrupo.filter(f));
        renderEvolucao(evolucaoCmvGrupo.filter(l => !fName || l.nome === fName));
        renderTopProdutos(cmvProdutosGrupo.filter(f));
        renderTopFornecedores(topFornecedoresGrupo.filter(f));
    }

    function renderResumo(data) {
        let fat = 0, comp = 0;
        data.forEach(l => { fat += cleanFloat(l.faturamento_bruto); comp += cleanFloat(l.total_compras); });
        animateValue('faturamentoBruto', 0, fat, 800, true);
        animateValue('totalCompras', 0, comp, 800, true);
        animateValue('percentualCompras', 0, fat > 0 ? (comp / fat) * 100 : 0, 800, false, true);
    }

    function renderEvolucao(lojas) {
        const config = (id, field) => {
            const chartDom = document.getElementById(id); if(!chartDom) return;
            const chart = echarts.init(chartDom);
            chart.setOption({
                color: MRK.palette,
                tooltip: { trigger: 'axis', formatter: p => `<b>${p[0].name}</b><br>${p.map(x => `${x.marker} ${x.seriesName}: <b>${formatCurrency(x.value)}</b>`).join('<br>')}` },
                legend: { top: 0 },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: datasEvolucao },
                yAxis: { type: 'value', axisLabel: { formatter: v => v.toLocaleString('pt-BR', {compactDisplay:'short', notation:'compact'}) } },
                series: lojas.map(l => ({ name: l.nome, type: 'bar', stack: 'total', data: l[field].map(v => cleanFloat(v)) }))
            }, true);
        };
        config('chartFaturamentoDiario', 'faturamento');
        config('chartComprasDiario', 'compras');
    }

    function renderTopProdutos(data) {
        const chart = echarts.init(document.getElementById('chartTopProdutos'));
        const agg = {};
        data.forEach(l => (l.produtos || []).forEach(p => agg[p.name] = (agg[p.name] || 0) + cleanFloat(p.value)));
        const ds = Object.entries(agg).sort((a,b) => b[1] - a[1]).slice(0,5);
        chart.setOption({
            tooltip: { trigger: 'axis', formatter: p => `${p[0].name}: <b>${formatCurrency(p[0].value)}</b>` },
            grid: { right: '20%', containLabel: true },
            xAxis: { type: 'value', show: false },
            yAxis: { type: 'category', data: ds.map(x => x[0].slice(0,15)), inverse: true },
            series: [{ type: 'bar', data: ds.map(x => x[1]), color: MRK.blue, label: { show: true, position: 'right', formatter: p => formatCurrency(p.value) }, itemStyle: { borderRadius: [0,4,4,0] } }]
        }, true);
    }

    function renderTopFornecedores(data) {
        const chart = echarts.init(document.getElementById('chartTopFornecedores'));
        const agg = {};
        data.forEach(l => (l.fornecedores || []).forEach(f => {
            if(!agg[f.fornecedor]) agg[f.fornecedor] = {v:0, n:0};
            agg[f.fornecedor].v += cleanFloat(f.valor_total); agg[f.fornecedor].n += parseInt(f.qtd_notas);
        }));
        const ds = Object.entries(agg).sort((a,b) => b[1].v - a[1].v).slice(0,5);
        chart.setOption({
            tooltip: { trigger: 'axis', formatter: p => `<b>${ds[p[0].dataIndex][0]}</b><br>Total: ${formatCurrency(ds[p[0].dataIndex][1].v)}` },
            grid: { right: '20%', containLabel: true },
            xAxis: { type: 'value', show: false },
            yAxis: { type: 'category', data: ds.map(x => x[0].slice(0,15)), inverse: true },
            series: [{ type: 'bar', data: ds.map(x => x[1].v), color: MRK.green, label: { show: true, position: 'right', formatter: p => formatCurrency(p.value) }, itemStyle: { borderRadius: [0,4,4,0] } }]
        }, true);
    }

    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUnit', token, data: { system_unit_id } });
        if (res.data?.length > 0) grupoId = res.data[0].id;
        const resGroups = await axios.post(baseUrl, { method: 'getGroupByUser', token, data: { user_id } });
        const { grupos, lojas_por_grupo } = resGroups.data;
        lojasPorGrupo = lojas_por_grupo;

        const gSel = document.getElementById('filtroGrupo');
        gSel.innerHTML = grupos.map(g => `<option value="${g.id}" ${g.id == grupoId ? 'selected' : ''}>${g.nome}</option>`).join('');
        gSel.addEventListener('change', function() { grupoId = parseInt(this.value); atualizarFiltroLoja(); document.getElementById('filtroLoja').value = ""; resetNotasPendentesUI(); showApplyButton(); });

        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        const lSel = document.getElementById('filtroLoja');
        lSel.innerHTML = '<option value="">Todas as lojas</option>' + lojas.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        lSel.addEventListener('change', function() { showApplyButton(); if(!this.value) resetNotasPendentesUI(); });
    }

    // CSS para animação do spin
    const styleSheet = document.createElement("style");
    styleSheet.innerText = "@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }";
    document.head.appendChild(styleSheet);

    window.addEventListener('DOMContentLoaded', async () => {
        document.querySelectorAll('.filter-input').forEach(el => el.addEventListener('change', showApplyButton));
        setRange('7dias');
        await carregarGrupoInicial();
        fetchData();
    });
</script>
</body>
</html>