<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Estoque & Financeiro</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root{
            --mrk-blue: #0B46AC;
            --mrk-green: #08A794;
            --mrk-gray: #EBEBEB;
            --mrk-black: #191F2A;
            --mrk-amber: #f59e0b;
        }
        .btn-mrk {
            background: color-mix(in srgb, var(--mrk-blue) 12%, white);
            color: var(--mrk-blue);
            border: 1px solid color-mix(in srgb, var(--mrk-blue) 25%, white);
            transition: all 0.2s;
        }
        .btn-mrk:hover { background: color-mix(in srgb, var(--mrk-blue) 20%, white); }

        .skeleton {
            background-color: #e2e8f0;
            background-image: linear-gradient(90deg, #e2e8f0 0px, #f1f5f9 40px, #e2e8f0 80px);
            background-size: 600px;
            animation: shine-lines 1.6s infinite linear;
            border-radius: 6px;
            color: transparent !important;
            pointer-events: none;
            min-height: 2rem;
            display: inline-block;
            width: 100%;
        }

        @keyframes shine-lines {
            0% { background-position: -100px; }
            40%, 100% { background-position: 140px; }
        }
    </style>
</head>

<body class="text-gray-800" style="background: var(--mrk-gray);">

<div class="p-6">
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4 flex-wrap">
            <button onclick="setRange('hoje')" class="btn-mrk px-3 py-1 rounded shadow text-sm">Hoje</button>
            <button onclick="setRange('ontem')" class="btn-mrk px-3 py-1 rounded shadow text-sm">Ontem</button>
            <button onclick="setRange('7dias')" class="btn-mrk px-3 py-1 rounded shadow text-sm">Últimos 7 dias</button>
            <button onclick="setRange('mes')" class="btn-mrk px-3 py-1 rounded shadow text-sm">Últimos 30 dias</button>

            <input type="date" id="startDate" class="filter-input border p-2 rounded-md shadow bg-white text-sm" />
            <input type="date" id="endDate" class="filter-input border p-2 rounded-md shadow bg-white text-sm" />

            <select id="filtroGrupo" class="filter-input border p-2 rounded-md shadow bg-white text-sm min-w-[150px]">
                <option value="">Todos os Grupos</option>
            </select>

            <select id="filtroLoja" class="filter-input border p-2 rounded-md shadow bg-white text-sm min-w-[150px]">
                <option value="">Todas as lojas</option>
            </select>
        </div>

        <button id="btnAplicar" onclick="fetchData()" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow-lg transform transition hover:scale-105 flex items-center gap-2">
            <i class="fas fa-check"></i> Aplicar Filtros
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-blue);">
            <div class="text-4xl" style="color: var(--mrk-blue);"><i class="fas fa-dollar-sign"></i></div>
            <div class="w-full">
                <div class="text-sm font-semibold">Faturamento</div>
                <div class="text-2xl font-extrabold kpi-value" id="faturamentoBruto">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-green);">
            <div class="text-4xl" style="color: var(--mrk-green);"><i class="fas fa-shopping-cart"></i></div>
            <div class="w-full">
                <div class="text-sm font-semibold">Compras</div>
                <div class="text-2xl font-extrabold kpi-value" id="totalCompras">R$ 0,00</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-black);">
            <div class="text-4xl" style="color: var(--mrk-black);"><i class="fas fa-percent"></i></div>
            <div class="w-full">
                <div class="text-sm font-semibold">% Compras x Fat.</div>
                <div class="text-2xl font-extrabold kpi-value" id="percentualCompras">0%</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 flex items-center gap-4" style="border-color: var(--mrk-amber);">
            <div class="text-4xl" style="color: var(--mrk-amber);"><i class="fas fa-file-invoice"></i></div>
            <div class="flex-1 w-full">
                <div class="text-sm font-semibold">Notas Pendentes</div>
                <div class="flex items-center justify-between mt-1">
                    <div class="flex flex-col">
                        <div class="text-2xl font-extrabold kpi-value" id="qtdNotasPendentes">-</div>
                        <div id="nomeLojaPendente" class="text-[10px] font-bold text-gray-400 max-w-[100px] uppercase">Selecione uma loja</div>
                        <small class="text-xs text-gray-500">Últimos 30 dias</small>
                    </div>

                    <div class="flex items-center gap-2">
                        <a href="javascript:void(0)" onclick="atualizarNotasPendentesForce(this)" class="text-amber-500 hover:text-amber-700 transition-colors p-2" title="Atualizar (Requer Loja Selecionada)">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                        <button onclick="verDetalhesNotasPendentes()" class="text-xs bg-amber-50 hover:bg-amber-100 text-amber-700 font-bold px-3 py-1.5 rounded border border-amber-200 transition-all">Ver mais</button>
                    </div>
                </div>
                <div id="msgCache" class="text-[10px] text-gray-400 text-right mt-1 hidden"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 rounded-lg shadow relative group">
            <h2 class="text-lg font-semibold mb-4">Evolução do Faturamento</h2>
            <div id="chartFaturamentoDiario" style="width:100%; height:320px;"></div>
            <div id="skel-chartFaturamentoDiario" class="absolute inset-0 bg-white z-10 hidden flex flex-col p-6"><div class="h-6 w-1/3 bg-gray-200 rounded animate-pulse mb-4"></div><div class="flex-1 bg-gray-100 rounded animate-pulse"></div></div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow relative group">
            <h2 class="text-lg font-semibold mb-4">Evolução das Compras</h2>
            <div id="chartComprasDiario" style="width:100%; height:320px;"></div>
            <div id="skel-chartComprasDiario" class="absolute inset-0 bg-white z-10 hidden flex flex-col p-6"><div class="h-6 w-1/3 bg-gray-200 rounded animate-pulse mb-4"></div><div class="flex-1 bg-gray-100 rounded animate-pulse"></div></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white p-6 h-[350px] rounded-lg shadow relative">
            <h2 class="text-lg font-semibold mb-4">TOP 5 - COMPRAS POR PRODUTO</h2>
            <div id="chartTopProdutos" class="w-full h-full"></div>
            <div id="skel-chartTopProdutos" class="absolute inset-0 bg-white z-10 hidden flex flex-col p-6"><div class="h-6 w-1/2 bg-gray-200 rounded animate-pulse mb-4"></div><div class="h-full bg-gray-100 rounded animate-pulse"></div></div>
        </div>
        <div class="bg-white p-6 h-[350px] rounded-lg shadow relative">
            <h2 class="text-lg font-semibold mb-4">TOP 5 - COMPRAS POR FORNECEDOR</h2>
            <div id="chartTopFornecedores" class="w-full h-full"></div>
            <div id="skel-chartTopFornecedores" class="absolute inset-0 bg-white z-10 hidden flex flex-col p-6"><div class="h-6 w-1/2 bg-gray-200 rounded animate-pulse mb-4"></div><div class="h-full bg-gray-100 rounded animate-pulse"></div></div>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id'));
    const user_id = parseInt(urlParams.get('user_id'));
    const token = urlParams.get('token');

    const MRK = {
        blue:  '#0B46AC',
        green: '#08A794',
        gray:  '#EBEBEB',
        black: '#191F2A',
        amber: '#f59e0b',
        series: ['#0B46AC', '#08A794', '#191F2A', '#0B46AC80', '#08A79480']
    };

    const formatCurrency = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    let grupoId = null;
    let resumoEstoqueGrupo = [], evolucaoCmvGrupo = [], datasEvolucao = [], cmvProdutosGrupo = [], topFornecedoresGrupo = [], listaNotasPendentes = [];
    let gruposDisponiveis = {}, lojasPorGrupo = {};

    function showApplyButton() {
        const btn = document.getElementById('btnAplicar');
        btn.classList.remove('hidden');
        btn.classList.add('animate-bounce');
        setTimeout(() => btn.classList.remove('animate-bounce'), 1000);
    }

    function hideApplyButton() { document.getElementById('btnAplicar').classList.add('hidden'); }

    function setupFilterListeners() {
        document.querySelectorAll('.filter-input').forEach(input => {
            input.addEventListener('change', showApplyButton);
            input.addEventListener('keyup', showApplyButton);
        });
    }

    function setRange(tipo) {
        const now = new Date();
        const start = new Date();
        if (tipo === 'ontem') start.setDate(now.getDate() - 1);
        else if (tipo === '7dias') start.setDate(now.getDate() - 7);
        else if (tipo === 'mes') start.setMonth(now.getMonth() - 1);

        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        showApplyButton();
    }

    function toggleSkeleton(type, isLoading) {
        if (type === 'kpi' || type === 'all') {
            const kpis = document.querySelectorAll('.kpi-value');
            kpis.forEach(el => {
                // Não adiciona skeleton ao card de notas pendentes se for 'all', pois ele tem lógica própria
                if(type === 'all' && el.id === 'qtdNotasPendentes') return;

                if (isLoading) el.classList.add('skeleton');
                else el.classList.remove('skeleton');
            });
        }
        if (type === 'charts' || type === 'all') {
            const ids = ['skel-chartFaturamentoDiario', 'skel-chartComprasDiario', 'skel-chartTopProdutos', 'skel-chartTopFornecedores'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    if (isLoading) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });
        }
    }

    function animateValue(id, start, end, duration, isCurrency = false, isPercentage = false) {
        const element = document.getElementById(id);
        if (!element) return;
        element.classList.remove('skeleton');
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);
            let formatted;
            if (isCurrency) {
                formatted = value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else if (isPercentage) {
                formatted = value.toFixed(2) + '%';
            } else {
                formatted = Math.floor(value);
            }
            element.textContent = formatted;
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // --- NOVA FUNÇÃO PARA RESETAR UI DE NOTAS ---
    function resetNotasPendentesUI() {
        const elQtd = document.getElementById('qtdNotasPendentes');
        const elNome = document.getElementById('nomeLojaPendente');

        elQtd.textContent = "-";
        elQtd.classList.remove('skeleton');

        elNome.textContent = "Selecione uma loja";
        elNome.classList.remove('text-amber-600');
        elNome.classList.add('text-gray-400');

        document.getElementById('msgCache').classList.add('hidden');
        listaNotasPendentes = [];
    }

    async function fetchData() {
        hideApplyButton();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const lojaSelecionada = document.getElementById('filtroLoja').value;

        const dt_inicio = startDate + ' 00:00:00';
        const dt_fim = endDate + ' 23:59:59';

        toggleSkeleton('all', true);

        // Lista de promessas básicas (sempre executadas)
        const promises = [
            carregarResumoEstoquePorGrupo(dt_inicio, dt_fim),
            carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim),
            carregarCmvProdutosPorGrupo(dt_inicio, dt_fim),
            carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim)
        ];

        // LÓGICA CONDICIONAL: Só carrega notas se tiver loja selecionada
        if (lojaSelecionada) {
            // Adiciona skeleton visualmente apenas neste momento
            document.getElementById('qtdNotasPendentes').classList.add('skeleton');
            promises.push(carregarNotasPendentes());
        } else {
            resetNotasPendentesUI();
        }

        try {
            await Promise.all(promises);
            aplicarFiltroLoja();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Falha ao carregar dados.', 'error');
        } finally {
            toggleSkeleton('charts', false);
            setTimeout(() => toggleSkeleton('kpi', false), 100);
        }
    }

    function parseBRL(v) {
        if (v == null) return 0;
        if (typeof v === 'number') return v;
        return Number(String(v).replace(/[^\d,-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
    }

    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUnit', token, data: { system_unit_id } });
        if (res.data?.length > 0) grupoId = res.data[0].id;
        await carregarGruposUsuario();
    }

    async function carregarGruposUsuario() {
        const res = await axios.post(baseUrl, { method: 'getGroupByUser', token, data: { user_id } });
        const { grupos, lojas_por_grupo } = res.data;
        gruposDisponiveis = grupos; lojasPorGrupo = lojas_por_grupo;
        const grupoSelect = document.getElementById('filtroGrupo');
        grupoSelect.innerHTML = '';
        grupos.forEach(grupo => {
            grupoSelect.innerHTML += `<option value="${grupo.id}" ${grupo.id == grupoId ? 'selected' : ''}>${grupo.nome}</option>`;
        });

        grupoSelect.addEventListener('change', () => {
            grupoId = parseInt(grupoSelect.value);
            atualizarFiltroLoja();
            document.getElementById('filtroLoja').value = ""; // Reseta loja ao mudar grupo
            resetNotasPendentesUI(); // Reseta notas ao mudar grupo
            showApplyButton();
        });
        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        const filtro = document.getElementById('filtroLoja');
        filtro.innerHTML = '<option value="">Todas as lojas</option>';
        lojas.forEach(loja => { filtro.innerHTML += `<option value="${loja.id}">${loja.name}</option>`; });
        filtro.addEventListener('change', showApplyButton);
    }

    // --- FUNÇÕES DE CARGA DE DADOS ---
    async function carregarResumoEstoquePorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateResumoEstoquePorGrupo', token, data: { grupoId, dt_inicio, dt_fim } });
        resumoEstoqueGrupo = res.data.data || [];
    }
    async function carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateCmvEvolucao', token, data: { grupoId, dt_inicio, dt_fim } });
        evolucaoCmvGrupo = res.data.data || []; datasEvolucao = res.data.labels || [];
    }
    async function carregarCmvProdutosPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateCmvPorProduto', token, data: { grupoId, dt_inicio, dt_fim } });
        cmvProdutosGrupo = res.data.data || [];
    }
    async function carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim) {
        const res = await axios.post(baseUrl, { method: 'generateTopComprasPorFornecedor', token, data: { grupoId, dt_inicio, dt_fim } });
        topFornecedoresGrupo = res.data.data || [];
    }

    async function carregarNotasPendentes() {
        const filtroLojaEl = document.getElementById('filtroLoja');
        // Se chegou aqui, já validamos que tem valor, mas por segurança:
        if(!filtroLojaEl.value) {
            resetNotasPendentesUI();
            return;
        }

        const selectedLoja = parseInt(filtroLojaEl.value);

        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotasNaoImportadasUltimos30DiasCached',
                token,
                data: { system_unit_id: selectedLoja }
            });
            processarRespostaNotas(res.data);
        } catch (e) {
            console.error(e);
            listaNotasPendentes = [];
            document.getElementById('qtdNotasPendentes').textContent = "Erro";
        }
    }

    async function atualizarNotasPendentesForce(element) {
        const filtroLojaEl = document.getElementById('filtroLoja');

        // BLOQUEIO: Se não tem loja selecionada, avisa e para.
        if(!filtroLojaEl.value) {
            return Swal.fire({
                icon: 'warning',
                title: 'Atenção',
                text: 'Selecione uma loja específica para buscar notas pendentes.'
            });
        }

        const elQtd = document.getElementById('qtdNotasPendentes');
        elQtd.classList.add('skeleton');

        const selectedLoja = parseInt(filtroLojaEl.value);
        const icon = element.querySelector('i');
        if(icon) icon.classList.add('fa-spin');

        try {
            const res = await axios.post(baseUrl, {
                method: 'listarNotasNaoImportadasUltimos30Dias',
                token,
                data: { system_unit_id: selectedLoja }
            });
            processarRespostaNotas(res.data);
            Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 }).fire({ icon: 'success', title: 'Notas sincronizadas!' });
        } catch (e) { console.error(e); }
        finally {
            if(icon) icon.classList.remove('fa-spin');
            elQtd.classList.remove('skeleton');
        }
    }

    function processarRespostaNotas(data) {
        const msgCache = document.getElementById('msgCache');
        const nomeLojaEl = document.getElementById('nomeLojaPendente');

        // Estiliza o nome da loja para ativo
        const filtroLojaEl = document.getElementById('filtroLoja');
        const nomeLojaSelecionada = filtroLojaEl.options[filtroLojaEl.selectedIndex].text;
        nomeLojaEl.textContent = nomeLojaSelecionada;
        nomeLojaEl.classList.remove('text-gray-400');
        nomeLojaEl.classList.add('text-amber-600');

        if (data.success && data.data && data.data.notas_pendentes) {
            listaNotasPendentes = data.data.notas_pendentes;
            const el = document.getElementById('qtdNotasPendentes');
            el.textContent = data.data.total_pendentes || listaNotasPendentes.length;
            el.classList.remove('skeleton');

            if (data.data.cached && data.data.last_update) {
                const date = new Date(data.data.last_update);
                msgCache.textContent = `Atualizado às ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
                msgCache.classList.remove('hidden');
            } else { msgCache.classList.add('hidden'); }
        } else {
            listaNotasPendentes = [];
            document.getElementById('qtdNotasPendentes').textContent = "0";
            document.getElementById('qtdNotasPendentes').classList.remove('skeleton');
            msgCache.classList.add('hidden');
        }
    }

    function verDetalhesNotasPendentes() {
        // Se não houver loja selecionada ou lista vazia, mostra mensagem
        const filtroLojaEl = document.getElementById('filtroLoja');
        if(!filtroLojaEl.value) {
            return Swal.fire('Atenção', 'Selecione uma loja para ver os detalhes.', 'warning');
        }

        if (!Array.isArray(listaNotasPendentes) || listaNotasPendentes.length === 0) {
            return Swal.fire('Tudo em dia!', 'Nenhuma nota pendente para esta loja.', 'success');
        }

        const valorTotalGeral = listaNotasPendentes.reduce((acc, n) => acc + Number(n.valor_total), 0);
        let html = `
        <div class="flex items-center justify-between bg-amber-50 border border-amber-200 p-4 rounded-lg mb-4 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="text-3xl text-amber-600"><i class="fas fa-file-invoice-dollar"></i></div>
                <div><div class="text-xs font-bold text-amber-800 uppercase">Total Pendente</div>
                <div class="text-2xl font-black text-amber-900">R$ ${valorTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div></div>
            </div>
            <div class="text-right"><div class="text-xs font-bold text-amber-800 uppercase">Qtd</div>
            <div class="text-2xl font-black text-amber-900">${listaNotasPendentes.length}</div></div>
        </div>
        <div class="max-h-[50vh] overflow-y-auto border rounded-lg">
            <table class="w-full text-xs text-left border-collapse">
                <thead><tr class="bg-gray-100 sticky top-0 shadow-sm z-10"><th class="p-3 border-b">Emissão</th><th class="p-3 border-b">NF / Série</th><th class="p-3 border-b">Fornecedor</th><th class="p-3 border-b text-right">Valor</th></tr></thead>
                <tbody class="divide-y divide-gray-200">
                    ${listaNotasPendentes.map(n => `<tr class="hover:bg-blue-50"><td class="p-3">${new Date(n.data_emissao+'T00:00:00').toLocaleDateString('pt-BR')}</td><td class="p-3">${n.numero_nf}/${n.serie}</td><td class="p-3 uppercase">${n.emitente_razao.slice(0,25)}</td><td class="p-3 text-right font-bold text-blue-700">R$ ${Number(n.valor_total).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>`;
        Swal.fire({ title: 'Notas Pendentes', html, width: '850px', confirmButtonColor: MRK.blue, confirmButtonText: 'Fechar' });
    }

    function aplicarFiltroLoja() {
        const filtroLojaEl = document.getElementById('filtroLoja');
        let selectedLoja = parseInt(filtroLojaEl.value) || null;

        const filtradoResumo = resumoEstoqueGrupo.filter(l => !selectedLoja || l.lojaId === selectedLoja);
        const filtradoCmvProdutos = cmvProdutosGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);
        const filtradoFornecedores = topFornecedoresGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);

        const lojaObj = selectedLoja ? (lojasPorGrupo[grupoId].find(x => parseInt(x.id) === selectedLoja)) : null;
        const nomeSelecionado = lojaObj ? lojaObj.name : null;

        // Se não tem loja selecionada (selectedLoja é null ou 0), chama o reset
        if (!selectedLoja) {
            resetNotasPendentesUI();
        }

        const filtradoEvolucao = evolucaoCmvGrupo.filter(l => !nomeSelecionado || l.nome === nomeSelecionado);

        renderResumo(filtradoResumo);
        renderEvolucaoBarras(filtradoEvolucao, datasEvolucao);
        renderChartTopProdutos(agregarProdutos(filtradoCmvProdutos));
        renderChartTopFornecedores(agregarFornecedores(filtradoFornecedores));
    }

    function renderResumo(data) {
        let fat = 0, comp = 0;
        data.forEach(l => { fat += parseBRL(l.faturamento_bruto); comp += parseBRL(l.total_compras); });
        animateValue('faturamentoBruto', 0, fat, 1000, true);
        animateValue('totalCompras', 0, comp, 1000, true);
        animateValue('percentualCompras', 0, fat > 0 ? (comp / fat) * 100 : 0, 1000, false, true);
    }

    function renderEvolucaoBarras(lojas, labels) {
        const config = (id, tipo) => {
            const chartDom = document.getElementById(id);
            if(!chartDom) return;
            const chart = echarts.init(chartDom);
            const series = lojas.map((l, i) => ({
                name: l.nome, type: 'bar', stack: 'total',
                data: tipo === 'fat' ? l.faturamento : l.compras,
                itemStyle: { color: MRK.series[i % MRK.series.length] }
            }));
            chart.setOption({
                legend: { top: 0 },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let res = `${params[0].name}<br/>`;
                        params.forEach(p => {
                            res += `${p.marker} ${p.seriesName}: <b>${formatCurrency(p.value)}</b><br/>`;
                        });
                        return res;
                    }
                },
                xAxis: { type: 'category', data: labels },
                yAxis: { type: 'value', axisLabel: { formatter: (v) => 'R$ ' + v.toLocaleString('pt-BR') } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                series
            }, true);
        };
        config('chartFaturamentoDiario', 'fat');
        config('chartComprasDiario', 'comp');
    }

    function agregarProdutos(data) {
        const res = {};
        data.forEach(l => (l.produtos || []).forEach(p => { res[p.name] = (res[p.name] || 0) + parseFloat(p.value); }));
        return Object.entries(res).map(([nome, valor]) => ({nome, valor})).sort((a,b) => b.valor - a.valor).slice(0,5);
    }

    function agregarFornecedores(data) {
        const res = {};
        data.forEach(l => (l.fornecedores || []).forEach(f => {
            if(!res[f.fornecedor]) res[f.fornecedor] = {nome: f.fornecedor, valor: 0, qtd: 0};
            res[f.fornecedor].valor += parseFloat(f.valor_total);
            res[f.fornecedor].qtd += parseInt(f.qtd_notas);
        }));
        return Object.values(res).sort((a,b) => b.valor - a.valor).slice(0,5);
    }

    function renderChartTopProdutos(data) {
        const chart = echarts.init(document.getElementById('chartTopProdutos'));
        chart.setOption({
            tooltip: { trigger: 'axis', formatter: (params) => `${params[0].name}: <b>${formatCurrency(params[0].value)}</b>` },
            yAxis: { type: 'category', data: data.map(d => d.nome.slice(0,15)), inverse: true },
            xAxis: { type: 'value', axisLabel: { show: false } },
            grid: { left: '3%', right: '12%', bottom: '10%', containLabel: true },
            series: [{ type: 'bar', data: data.map(d => d.valor), itemStyle: { color: MRK.blue }, label: { show: true, position: 'right', formatter: (p) => formatCurrency(p.value), fontSize: 10, fontWeight: 'bold' } }]
        }, true);
    }

    function renderChartTopFornecedores(data) {
        const chart = echarts.init(document.getElementById('chartTopFornecedores'));
        chart.setOption({
            tooltip: {
                trigger: 'axis',
                formatter: (params) => {
                    const item = data[params[0].dataIndex];
                    return `<b>${item.nome}</b><br/>` +
                        `<i class="fas fa-money-bill-wave"></i> Valor: <b>${formatCurrency(item.valor)}</b><br/>` +
                        `<i class="fas fa-file-invoice"></i> Qtd Notas: <b>${item.qtd}</b>`;
                }
            },
            yAxis: { type: 'category', data: data.map(d => d.nome.slice(0,15)), inverse: true },
            xAxis: { type: 'value', axisLabel: { show: false } },
            grid: { left: '3%', right: '15%', bottom: '10%', containLabel: true },
            series: [{ type: 'bar', data: data.map(d => d.valor), itemStyle: { color: MRK.green }, label: { show: true, position: 'right', formatter: (p) => formatCurrency(p.value), fontSize: 10, fontWeight: 'bold' } }]
        }, true);
    }

    window.addEventListener('DOMContentLoaded', async () => {
        setupFilterListeners();
        const now = new Date();
        const start = new Date();
        start.setDate(now.getDate() - 7);
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        await carregarGrupoInicial();
        fetchData();
    });
</script>

</body>
</html>