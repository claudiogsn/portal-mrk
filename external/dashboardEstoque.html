<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard CMV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-4">

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-sm text-gray-500">CMV (R$)</h2>
        <p id="cmv" class="text-2xl font-bold text-red-600">-</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-sm text-gray-500">% CMV</h2>
        <p id="percentual_cmv" class="text-2xl font-bold">-</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-sm text-gray-500">Faturamento</h2>
        <p id="faturamento" class="text-2xl font-bold text-green-600">-</p>
    </div>
    <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-sm text-gray-500">Total de Compras</h2>
        <p id="total_compras" class="text-2xl font-bold text-blue-600">-</p>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-semibold mb-2">Evolução do CMV</h3>
        <div id="graficoLinha" style="height: 300px;"></div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
        <h3 class="text-lg font-semibold mb-2">CMV por Categoria</h3>
        <div id="graficoBarra" style="height: 300px;"></div>
    </div>

    <div class="bg-white rounded-xl shadow p-4 col-span-1 md:col-span-2">
        <h3 class="text-lg font-semibold mb-2">Composição do CMV</h3>
        <div id="graficoPizza" style="height: 300px;"></div>
    </div>
</div>

<script>
    const baseUrl = 'https://portal.mrksolucoes.com.br/api/v1/index.php';
    const params = new URLSearchParams(window.location.search);
    const grupoId = params.get('grupo_id');
    const token = params.get('token');
    const dt_inicio = params.get('dt_inicio');
    const dt_fim = params.get('dt_fim');

    function formatReal(valor) {
        return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    async function carregarDashboard() {
        try {
            const resumo = await axios.post(baseUrl, {
                method: 'generateResumoEstoqueGrupo',
                token,
                data: { grupoId, dt_inicio, dt_fim }
            });

            if (resumo.data.success && resumo.data.data.length > 0) {
                const total = resumo.data.data.reduce((acc, cur) => {
                    acc.cmv += cur.cmv;
                    acc.fat += cur.faturamento_bruto;
                    acc.compras += cur.total_compras;
                    return acc;
                }, { cmv: 0, fat: 0, compras: 0 });

                document.getElementById('cmv').innerText = formatReal(total.cmv);
                document.getElementById('faturamento').innerText = formatReal(total.fat);
                document.getElementById('total_compras').innerText = formatReal(total.compras);
                const percentual = total.fat > 0 ? (total.cmv / total.fat * 100) : 0;
                document.getElementById('percentual_cmv').innerText = percentual.toFixed(2) + '%';
            }

            const evolucao = await axios.post(baseUrl, {
                method: 'generateCmvEvolucao',
                token,
                data: { grupoId, dt_inicio, dt_fim }
            });
            const labels = evolucao.data.labels;
            const series = evolucao.data.data.map(loja => ({
                name: loja.nome,
                type: 'line',
                data: loja.valores
            }));
            echarts.init(document.getElementById('graficoLinha')).setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: evolucao.data.data.map(l => l.nome) },
                xAxis: { type: 'category', data: labels },
                yAxis: { type: 'value' },
                series
            });

            const pizza = await axios.post(baseUrl, {
                method: 'generateCmvPorProduto',
                token,
                data: { grupoId, dt_inicio, dt_fim }
            });
            echarts.init(document.getElementById('graficoPizza')).setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '60%',
                    data: pizza.data.data.filter(p => p.value > 0)
                }]
            });

            const barra = await axios.post(baseUrl, {
                method: 'generateCmvPorCategoria',
                token,
                data: { grupoId, dt_inicio, dt_fim }
            });
            echarts.init(document.getElementById('graficoBarra')).setOption({
                tooltip: {},
                xAxis: { type: 'category', data: barra.data.data.map(d => d.name) },
                yAxis: { type: 'value' },
                series: [{
                    name: 'CMV',
                    type: 'bar',
                    data: barra.data.data.map(d => d.value)
                }]
            });

        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
        }
    }

    carregarDashboard();
</script>
</body>
</html>
