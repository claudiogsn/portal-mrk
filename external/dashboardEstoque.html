<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estoque - CMV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="mb-6">
    <div class="flex flex-wrap gap-4">
        <button onclick="setRange('hoje')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded shadow">Hoje</button>
        <button onclick="setRange('ontem')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded shadow">Ontem</button>
        <button onclick="setRange('7dias')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded shadow">7 dias</button>
        <button onclick="setRange('mes')" class="bg-blue-100 text-blue-700 px-3 py-1 rounded shadow">Último mês</button>
        <input type="date" id="startDate" onchange="fetchData()" class="border p-2 rounded-md shadow" />
        <input type="date" id="endDate" onchange="fetchData()" class="border p-2 rounded-md shadow" />
        <select id="filtroLoja" class="border p-2 rounded-md shadow">
            <option value="">Todas as lojas</option>
        </select>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
        <div class="text-sm text-gray-500">CMV Total</div>
        <div class="text-2xl font-bold" id="cmvTotal">R$ 0,00</div>
    </div>
    <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
        <div class="text-sm text-gray-500">Desperdício</div>
        <div class="text-2xl font-bold" id="desperdicio">R$ 0,00</div>
    </div>
    <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
        <div class="text-sm text-gray-500">Total de Entradas</div>
        <div class="text-2xl font-bold" id="totalEntradas">R$ 0,00</div>
    </div>
    <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500">
        <div class="text-sm text-gray-500">Total de Saídas</div>
        <div class="text-2xl font-bold" id="totalSaidas">R$ 0,00</div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">Evolução do CMV</h2>
        <div id="chartCmvEvolucao" class="w-full h-[300px]"></div>
    </div>
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-semibold mb-4">CMV por Produto</h2>
        <div id="chartCmvPorProduto" class="w-full h-[300px]"></div>
    </div>
</div>

<div class="bg-white p-6 mt-6 rounded shadow">
    <h2 class="text-lg font-semibold mb-4">Top 5 Produtos mais Comprados</h2>
    <div id="chartTopProdutos" class="w-full h-[400px]"></div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const grupoId = new URLSearchParams(window.location.search).get('grupo_id');
    const token = new URLSearchParams(window.location.search).get('token');

    function setRange(tipo) {
        const now = new Date();
        const start = new Date();
        if (tipo === 'ontem') start.setDate(now.getDate() - 1);
        else if (tipo === '7dias') start.setDate(now.getDate() - 7);
        else if (tipo === 'mes') start.setMonth(now.getMonth() - 1);
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        fetchData();
    }

    async function fetchData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const dt_inicio = startDate + ' 00:00:00';
        const dt_fim = endDate + ' 23:59:59';
        const lojaId = document.getElementById('filtroLoja').value;

        Swal.fire({
            title: 'Carregando...',
            html: 'Buscando dados atualizados.',
            didOpen: () => Swal.showLoading(),
            allowOutsideClick: false
        });

        try {
            const res = await axios.post(baseUrl, {
                method: 'generateDashboardEstoqueGrupo',
                token,
                data: { grupoId, dt_inicio, dt_fim, lojaId }
            });

            const { resumo, evolucao, produtos, top_compras } = res.data;

            document.getElementById('cmvTotal').textContent = resumo.total_cmv;
            document.getElementById('desperdicio').textContent = resumo.desperdicio;
            document.getElementById('totalEntradas').textContent = resumo.total_entradas;
            document.getElementById('totalSaidas').textContent = resumo.total_saidas;

            renderCmvEvolucao(evolucao);
            renderCmvPorProduto(produtos);
            renderTopCompras(top_compras);

            Swal.close();
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', 'Erro ao buscar dados do dashboard', 'error');
        }
    }

    function renderCmvEvolucao(data) {
        const chart = echarts.init(document.getElementById('chartCmvEvolucao'));
        chart.setOption({
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: data.map(d => d.data) },
            yAxis: { type: 'value' },
            series: [{ name: 'CMV', type: 'line', data: data.map(d => d.valor) }]
        });
    }

    function renderCmvPorProduto(data) {
        const chart = echarts.init(document.getElementById('chartCmvPorProduto'));
        chart.setOption({
            tooltip: { trigger: 'item' },
            series: [{
                name: 'CMV', type: 'pie', radius: '70%',
                data: data.filter(p => p.valor > 0).map(p => ({ name: p.nome, value: p.valor }))
            }]
        });
    }

    function renderTopCompras(data) {
        const chart = echarts.init(document.getElementById('chartTopProdutos'));
        chart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            xAxis: { type: 'category', data: data.map(p => p.nome), axisLabel: { fontSize: 10 } },
            yAxis: { type: 'value' },
            series: [{
                name: 'Valor Comprado',
                type: 'bar',
                data: data.map(p => p.valor),
                itemStyle: { borderRadius: [4, 4, 4, 4] }
            }]
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
        document.getElementById('filtroLoja').addEventListener('change', fetchData);
        setRange('7dias');
    });
</script>
</body>

</html>
