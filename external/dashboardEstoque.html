<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Estoque</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <style>
        .animate-number {
            transition: all 1s ease-in-out;
        }

        .loader {
            border-top-color: #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
<div class="p-6">
    <div class="mb-6">
        <div class="flex items-center gap-4 flex-wrap">
            <button onclick="setRange('hoje')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded shadow">Hoje</button>
            <button onclick="setRange('ontem')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded shadow">Ontem</button>
            <button onclick="setRange('7dias')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded shadow">Últimos 7 dias</button>
            <button onclick="setRange('mes')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded shadow">Último mês</button>

            <input type="date" id="startDate" onchange="fetchData()" class="border p-2 rounded-md shadow" />
            <input type="date" id="endDate" onchange="fetchData()" class="border p-2 rounded-md shadow" />

            <select id="filtroGrupo" class="border p-2 rounded-md shadow">
                <option value="">Todos os Grupos</option>
            </select>

            <select id="filtroLoja" class="border p-2 rounded-md shadow">
                <option value="">Todas as lojas</option>
            </select>
        </div>
    </div>

    <!-- ✅ Cards ajustados conforme novo totalizado -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
            <div class="text-gray-500 text-sm">Faturamento</div>
            <div class="text-2xl font-bold animate-number" id="faturamentoBruto">R$ 0,00</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
            <div class="text-gray-500 text-sm">Compras</div>
            <div class="text-2xl font-bold animate-number" id="totalCompras">R$ 0,00</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-amber-500">
            <div class="text-gray-500 text-sm">% Compras x Faturamento</div>
            <div class="text-2xl font-bold animate-number" id="percentualCompras">0%</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
            <div class="text-gray-500 text-sm">% Margem de Lucro</div>
            <div class="text-2xl font-bold animate-number" id="percentualMargem">0%</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-emerald-600">
            <div class="text-gray-500 text-sm">Produto Maior Margem</div>
            <div class="text-sm font-semibold truncate" id="produtoMaiorMargemDesc">-</div>
            <div class="text-2xl font-bold animate-number" id="produtoMaiorMargemValor">R$ 0,00</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow border-l-4 border-rose-600">
            <div class="text-gray-500 text-sm">Produto Menor Margem</div>
            <div class="text-sm font-semibold truncate" id="produtoMenorMargemDesc">-</div>
            <div class="text-2xl font-bold animate-number" id="produtoMenorMargemValor">R$ 0,00</div>
        </div>
    </div>

    <!-- ✅ Evolução -->
    <div class="flex flex-col lg:flex-row gap-6 mb-6">
        <div class="w-full bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Evolução do CMV Diário</h2>
            <div id="chartCmvDiario" style="width: 100%; height: 300px;"></div>
        </div>
    </div>

    <!-- ✅ Top 5 Produtos + Top 5 Fornecedores lado a lado -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top 5 Produtos -->
        <div class="bg-white p-6 h-[350px] rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Top 5 Produtos</h2>
            <div id="chartTopProdutos" class="w-full h-full"></div>
        </div>

        <!-- Top 5 Fornecedores -->
        <div class="bg-white p-6 h-[350px] rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">Top 5 Fornecedores</h2>
            <div id="chartTopFornecedores" class="w-full h-full"></div>
        </div>
    </div>
</div>

<script>
    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/api/v1/index.php'
        : 'http://localhost/portal-mrk/api/v1/index.php';

    const urlParams = new URLSearchParams(window.location.search);
    const system_unit_id = parseInt(urlParams.get('system_unit_id'));
    const user_id = parseInt(urlParams.get('user_id'));
    const token = urlParams.get('token');

    let grupoId = null;

    // ✅ flag pra desenhar CMV no gráfico de evolução (default desativado)
    let showCmvLine = false;

    let lojasGrupo = [];
    let resumoEstoqueGrupo = [];
    let evolucaoCmvGrupo = [];
    let cmvProdutosGrupo = [];
    let topFornecedoresGrupo = [];
    let datasEvolucao = [];

    function animateValue(id, start, end, duration, isCurrency = false, isPercentage = false) {
        const element = document.getElementById(id);
        if (!element) return;

        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = start + progress * (end - start);

            element.textContent = isCurrency
                ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
                : isPercentage
                    ? value.toFixed(2) + '%'
                    : Math.floor(value);

            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // ✅ helpers para strings "R$ 1.234,56" e "4,79%"
    function parseBRL(v) {
        if (v == null) return 0;
        if (typeof v === 'number') return v;
        return Number(
            String(v)
                .replace(/[^\d,-]/g, '')
                .replace(/\./g, '')
                .replace(',', '.')
        ) || 0;
    }

    function setRange(tipo) {
        const now = new Date();
        const start = new Date();
        if (tipo === 'ontem') start.setDate(now.getDate() - 1);
        else if (tipo === '7dias') start.setDate(now.getDate() - 7);
        else if (tipo === 'mes') start.setMonth(now.getMonth() - 1);

        document.getElementById('endDate').value = now.toISOString().split('T')[0];
        document.getElementById('startDate').value = start.toISOString().split('T')[0];
        fetchData();
    }

    let gruposDisponiveis = {};
    let lojasPorGrupo = {};

    async function carregarGrupoInicial() {
        const res = await axios.post(baseUrl, {
            method: 'getGroupByUnit',
            token,
            data: { system_unit_id }
        });

        if (res.data?.length > 0) {
            grupoId = res.data[0].id;
        }

        await carregarGruposUsuario();
    }

    async function carregarGruposUsuario() {
        const res = await axios.post(baseUrl, {
            method: 'getGroupByUser',
            token,
            data: { user_id }
        });

        const { grupos, lojas_por_grupo } = res.data;
        gruposDisponiveis = grupos;
        lojasPorGrupo = lojas_por_grupo;

        const grupoSelect = document.getElementById('filtroGrupo');
        grupoSelect.innerHTML = '';

        grupos.forEach(grupo => {
            grupoSelect.innerHTML += `<option value="${grupo.id}" ${grupo.id == grupoId ? 'selected' : ''}>${grupo.nome}</option>`;
        });

        grupoSelect.addEventListener('change', () => {
            grupoId = parseInt(grupoSelect.value);

            resetarEstadoDashboard();
            limparCharts();

            atualizarFiltroLoja();

            const filtroLoja = document.getElementById('filtroLoja');
            filtroLoja.value = "";

            fetchData();
        });

        atualizarFiltroLoja();
    }

    function atualizarFiltroLoja() {
        const lojas = lojasPorGrupo[grupoId] || [];
        const filtro = document.getElementById('filtroLoja');

        filtro.innerHTML = '<option value="">Todas as lojas</option>';
        lojas.forEach(loja => {
            filtro.innerHTML += `<option value="${loja.id}">${loja.name}</option>`;
        });
    }

    async function fetchData() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const dt_inicio = startDate + ' 00:00:00';
        const dt_fim = endDate + ' 23:59:59';

        Swal.fire({
            title: 'Carregando...',
            html: 'Buscando dados atualizados.',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            await carregarLojasGrupo();
            await carregarResumoEstoquePorGrupo(dt_inicio, dt_fim);
            await carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim);
            await carregarCmvProdutosPorGrupo(dt_inicio, dt_fim);
            await carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim);

            aplicarFiltroLoja();
        } catch (err) {
            Swal.fire('Erro ao carregar', err.message, 'error');
        } finally {
            Swal.close();
        }
    }

    function resetarEstadoDashboard() {
        resumoEstoqueGrupo = [];
        evolucaoCmvGrupo = [];
        cmvProdutosGrupo = [];
        topFornecedoresGrupo = [];
        datasEvolucao = [];
    }

    function limparCharts() {
        const domEvol = document.getElementById('chartCmvDiario');
        const domTop = document.getElementById('chartTopProdutos');
        const domForn = document.getElementById('chartTopFornecedores');

        const instEvol = domEvol ? echarts.getInstanceByDom(domEvol) : null;
        const instTop  = domTop  ? echarts.getInstanceByDom(domTop)  : null;
        const instForn = domForn ? echarts.getInstanceByDom(domForn) : null;

        if (instEvol) instEvol.dispose();
        if (instTop) instTop.dispose();
        if (instForn) instForn.dispose();
    }

    async function carregarLojasGrupo() {
        const res = await axios.post(baseUrl, {
            method: 'getUnitsByGroup',
            token,
            data: { group_id: grupoId }
        });
        lojasGrupo = res.data || [];
    }

    async function carregarResumoEstoquePorGrupo(dt_inicio, dt_fim) {
        const resumo = await axios.post(baseUrl, {
            method: 'generateResumoEstoquePorGrupo',
            token,
            data: { grupoId, dt_inicio, dt_fim }
        });
        resumoEstoqueGrupo = resumo.data.data || [];
    }

    async function carregarEvolucaoCmvPorGrupo(dt_inicio, dt_fim) {
        const response = await axios.post(baseUrl, {
            method: 'generateCmvEvolucao',
            token,
            data: { grupoId, dt_inicio, dt_fim }
        });

        evolucaoCmvGrupo = response.data.data || [];
        datasEvolucao = response.data.labels || [];
    }

    async function carregarCmvProdutosPorGrupo(dt_inicio, dt_fim) {
        const response = await axios.post(baseUrl, {
            method: 'generateCmvPorProduto',
            token,
            data: { grupoId, dt_inicio, dt_fim }
        });
        cmvProdutosGrupo = response.data.data || [];
    }

    async function carregarTopFornecedoresPorGrupo(dt_inicio, dt_fim) {
        const response = await axios.post(baseUrl, {
            method: 'generateTopComprasPorFornecedor',
            token,
            data: { grupoId, dt_inicio, dt_fim }
        });
        topFornecedoresGrupo = response.data.data || [];
    }

    function getNomeLojaById(lojaId) {
        const lojas = lojasPorGrupo[grupoId] || [];
        const l = lojas.find(x => parseInt(x.id) === parseInt(lojaId));
        return l ? l.name : null;
    }

    function aplicarFiltroLoja() {
        const filtroLojaEl = document.getElementById('filtroLoja');
        let selectedLoja = parseInt(filtroLojaEl.value) || null;

        const lojasValidas = (lojasPorGrupo[grupoId] || []).map(l => parseInt(l.id));
        if (selectedLoja && !lojasValidas.includes(selectedLoja)) {
            selectedLoja = null;
            filtroLojaEl.value = "";
        }

        const filtradoResumo = resumoEstoqueGrupo.filter(l => !selectedLoja || l.lojaId === selectedLoja);
        const filtradoCmvProdutos = cmvProdutosGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);
        const filtradoFornecedores = topFornecedoresGrupo.filter(l => !selectedLoja || l.lojaId == selectedLoja);

        const nomeSelecionado = selectedLoja ? getNomeLojaById(selectedLoja) : null;
        const filtradoEvolucao = evolucaoCmvGrupo.filter(l => !nomeSelecionado || l.nome === nomeSelecionado);

        renderResumo(filtradoResumo);
        renderEvolucaoCmv(filtradoEvolucao, datasEvolucao);
        renderChartTopProdutos(agregarProdutos(filtradoCmvProdutos));
        renderChartTopFornecedores(agregarFornecedores(filtradoFornecedores));
    }

    function agregarProdutos(data) {
        const agregados = {};
        data.forEach(loja => {
            (loja.produtos || []).forEach(prod => {
                const nome = prod.name.trim();
                if (!agregados[nome]) agregados[nome] = { nome, valor: 0 };
                agregados[nome].valor += parseFloat(prod.value);
            });
        });
        return Object.values(agregados)
            .sort((a, b) => b.valor - a.valor)
            .slice(0, 5);
    }

    function agregarFornecedores(data) {
        const agregados = {};

        data.forEach(loja => {
            (loja.fornecedores || []).forEach(f => {
                const nome = (f.fornecedor || '').trim();
                if (!agregados[nome]) {
                    agregados[nome] = { nome, valor: 0, qtd_notas: 0 };
                }
                agregados[nome].valor += parseFloat(f.valor_total || 0);
                agregados[nome].qtd_notas += parseInt(f.qtd_notas || 0);
            });
        });

        return Object.values(agregados)
            .sort((a, b) => b.valor - a.valor)
            .slice(0, 5);
    }

    function renderChartTopProdutos(data) {
        const chartDom = document.getElementById('chartTopProdutos');
        if (!chartDom) return;

        const old = echarts.getInstanceByDom(chartDom);
        if (old) old.dispose();

        const myChart = echarts.init(chartDom);

        const nomes = data.map(item =>
            item.nome.length > 18 ? item.nome.slice(0, 18) + '...' : item.nome
        );
        const valores = data.map(item => item.valor);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: (params) => {
                    const item = data[params[0].dataIndex];
                    return `<b>${item.nome}</b><br>CMV: R$ ${item.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                }
            },
            grid: { top: 10, bottom: 10, left: '3%', right: '4%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: {
                type: 'category',
                data: nomes,
                axisLabel: { fontSize: 10 },
                inverse: true   // ✅ maior fica no topo
            },
            series: [
                {
                    name: 'CMV',
                    type: 'bar',
                    data: valores,
                    itemStyle: {
                        borderRadius: [4, 4, 4, 4],
                        color: function(params) {
                            const colorList = ['#c23531', '#2f4554', '#61a0a8', '#d48265', '#91c7ae'];
                            return colorList[params.dataIndex];
                        }
                    }
                }
            ]
        };

        myChart.setOption(option);
    }

    function renderChartTopFornecedores(data) {
        const chartDom = document.getElementById('chartTopFornecedores');
        if (!chartDom) return;

        const old = echarts.getInstanceByDom(chartDom);
        if (old) old.dispose();

        const myChart = echarts.init(chartDom);

        const nomes = data.map(item =>
            item.nome.length > 18 ? item.nome.slice(0, 18) + '...' : item.nome
        );
        const valores = data.map(item => item.valor);

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: (params) => {
                    const item = data[params[0].dataIndex];
                    return `<b>${item.nome}</b><br>
                            Total Comprado: R$ ${item.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}<br>
                            Qtd Notas: ${item.qtd_notas}`;
                }
            },
            grid: { top: 10, bottom: 10, left: '3%', right: '4%', containLabel: true },
            xAxis: { type: 'value' },
            yAxis: {
                type: 'category',
                data: nomes,
                axisLabel: { fontSize: 10 },
                inverse: true   // ✅ maior fica no topo
            },
            series: [
                {
                    name: 'Compras',
                    type: 'bar',
                    data: valores,
                    itemStyle: {
                        borderRadius: [4, 4, 4, 4],
                        color: function(params) {
                            const colorList = ['#c23531', '#2f4554', '#61a0a8', '#d48265', '#91c7ae'];
                            return colorList[params.dataIndex];
                        }
                    }
                }
            ]
        };

        myChart.setOption(option);
    }

    function renderResumo(data) {
        let totalFaturamento = 0;
        let totalCompras = 0;
        let totalMargemLucro = 0;

        let melhorProduto = null;
        let piorProduto = null;

        data.forEach(loja => {
            totalFaturamento += parseBRL(loja.faturamento_bruto);
            totalCompras += parseBRL(loja.total_compras);
            totalMargemLucro += parseBRL(loja.margem_lucro);

            const pm = loja.produto_maior_margem;
            if (pm) {
                const margemPm = parseBRL(pm.margem);
                if (!melhorProduto || margemPm > melhorProduto._margemNum) {
                    melhorProduto = { ...pm, _margemNum: margemPm };
                }
            }

            const pn = loja.produto_menor_margem;
            if (pn) {
                const margemPn = parseBRL(pn.margem);
                if (!piorProduto || margemPn < piorProduto._margemNum) {
                    piorProduto = { ...pn, _margemNum: margemPn };
                }
            }
        });

        const percCompras = totalFaturamento > 0 ? (totalCompras / totalFaturamento) * 100 : 0;
        const percMargem  = totalFaturamento > 0 ? (totalMargemLucro / totalFaturamento) * 100 : 0;

        animateValue('faturamentoBruto', 0, totalFaturamento, 1000, true);
        animateValue('totalCompras', 0, totalCompras, 1000, true);
        animateValue('percentualCompras', 0, percCompras, 1000, false, true);
        animateValue('percentualMargem', 0, percMargem, 1000, false, true);

        const maiorDescEl = document.getElementById('produtoMaiorMargemDesc');
        if (maiorDescEl) maiorDescEl.textContent = melhorProduto ? melhorProduto.descricao : '-';
        animateValue('produtoMaiorMargemValor', 0, melhorProduto ? melhorProduto._margemNum : 0, 1000, true);

        const menorDescEl = document.getElementById('produtoMenorMargemDesc');
        if (menorDescEl) menorDescEl.textContent = piorProduto ? piorProduto.descricao : '-';
        animateValue('produtoMenorMargemValor', 0, piorProduto ? piorProduto._margemNum : 0, 1000, true);
    }

    function renderEvolucaoCmv(lojas, labels) {
        const chartDom = document.getElementById('chartCmvDiario');
        if (!chartDom) return;

        const old = echarts.getInstanceByDom(chartDom);
        if (old) old.dispose();

        const myChart = echarts.init(chartDom);

        const lojaMap = {};
        lojas.forEach(l => lojaMap[l.nome] = l);

        const seriesPercent = lojas.map(loja => {
            const faturamentoArr = loja.faturamento || [];
            const comprasArr = loja.compras || [];

            const percentuais = faturamentoArr.map((fat, i) => {
                const comp = comprasArr[i] ?? 0;
                return fat > 0 ? (comp / fat) * 100 : 0;
            });

            return {
                name: loja.nome,
                type: 'line',
                smooth: true,
                symbol: 'circle',
                symbolSize: 7,
                data: percentuais,
                yAxisIndex: 0
            };
        });

        const seriesCmv = showCmvLine
            ? lojas.map(loja => ({
                name: `${loja.nome} (CMV)`,
                type: 'line',
                smooth: true,
                symbol: 'none',
                lineStyle: { type: 'dashed' },
                data: loja.cmv || [],
                yAxisIndex: 1
            }))
            : [];

        const option = {
            title: { text: ' ', left: 'center' },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function (params) {
                    const idx = params[0].dataIndex;
                    let html = `<b>${params[0].axisValue}</b><br/>`;

                    const percentParams = params.filter(p => !p.seriesName.includes('(CMV)'));
                    const cmvParams = params.filter(p => p.seriesName.includes('(CMV)'));

                    percentParams.forEach(p => {
                        const loja = lojaMap[p.seriesName];
                        const fat = loja?.faturamento?.[idx] ?? 0;
                        const comp = loja?.compras?.[idx] ?? 0;
                        const perc = fat > 0 ? (comp / fat) * 100 : 0;

                        html += `
                        <span style="display:inline-block;width:10px;height:10px;background:${p.color};margin-right:4px;border-radius:50%"></span>
                        ${p.seriesName}: <b>${perc.toFixed(2)}%</b><br/>
                        &nbsp;&nbsp;Faturamento: R$ ${fat.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}<br/>
                        &nbsp;&nbsp;Compras: R$ ${comp.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}<br/>
                    `;
                    });

                    if (cmvParams.length) {
                        html += `<hr style="margin:6px 0;">`;
                        cmvParams.forEach(p => {
                            const pureName = p.seriesName.replace(' (CMV)', '');
                            const loja = lojaMap[pureName];
                            const cmv = loja?.cmv?.[idx] ?? 0;

                            html += `
                            <span style="display:inline-block;width:10px;height:10px;background:${p.color};margin-right:4px;border-radius:50%"></span>
                            ${pureName} CMV: <b>R$ ${cmv.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</b><br/>
                        `;
                        });
                    }

                    return html;
                }
            },
            legend: { top: 30 },
            grid: { left: '3%', right: '4%', bottom: '5%', containLabel: true },
            xAxis: {
                type: 'category',
                data: labels,
                axisLabel: { fontSize: 12 }
            },
            yAxis: [
                {
                    type: 'value',
                    name: '% Compras/Faturamento',
                    axisLabel: { formatter: v => `${v.toFixed(0)}%` }
                },
                ...(showCmvLine ? [{
                    type: 'value',
                    name: 'CMV (R$)',
                    axisLabel: { formatter: v => `R$ ${v.toLocaleString('pt-BR')}` }
                }] : [])
            ],
            series: [...seriesPercent, ...seriesCmv]
        };

        myChart.setOption(option);
    }

    window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('filtroLoja').addEventListener('change', aplicarFiltroLoja);
        await carregarGrupoInicial();
        setRange('7dias');
    });

</script>
</body>
</html>
