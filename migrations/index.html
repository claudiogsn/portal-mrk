<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Clonador de Dados - MRK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="icon" href="https://portal.mrksolucoes.com.br/external/bsb/favicon.ico" type="image/x-icon">

    <link href="https://fonts.googleapis.com/css?family=Kanit:400,700&subset=latin,cyrillic-ext" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css">

    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/node-waves/waves.css" rel="stylesheet" />
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/animate-css/animate.css" rel="stylesheet" />
    <link href="https://portal.mrksolucoes.com.br/external/bsb/plugins/sweetalert/sweetalert.css" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <link href="https://portal.mrksolucoes.com.br/external/bsb/css/style.css" rel="stylesheet">
    <link href="https://portal.mrksolucoes.com.br/external/bsb/css/themes/all-themes.css" rel="stylesheet" />

    <style>
        /* --- Identidade Visual MRK --- */
        :root {
            --mrk-blue:  #0B46AC;
            --mrk-green: #08A794;
            --mrk-gray:  #EBEBEB;
            --mrk-black: #191F2A;
            --mrk-red:   #F44336;
        }

        html, body { background-color: transparent !important; font-family: 'Kanit', sans-serif; }

        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 3px solid var(--mrk-blue);
            background-color: #fff;
        }

        .card .header h2 { color: var(--mrk-black); font-weight: bold; font-size: 18px; }
        .card .header h2 small { color: #777; font-size: 12px; margin-top: 5px; }

        /* Bot√µes */
        .btn-primary { background-color: var(--mrk-blue) !important; color: #fff; }
        .btn-primary:hover { background-color: #093a8f !important; }

        /* Select2 Customization */
        .select2-container .select2-selection--single {
            height: 40px !important;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
        }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
            background-color: var(--mrk-blue);
            color: white;
        }

        /* Alerta Customizado */
        .alert-custom {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            font-size: 13px;
        }
        .alert-custom ul { margin-bottom: 0; padding-left: 20px; }

        .step-icon {
            font-size: 24px; color: var(--mrk-blue); vertical-align: middle; margin-right: 10px;
        }
    </style>
</head>

<body class="theme-blue">

<div class="container-fluid">
    <div class="block-header">
        <h2> </h2> <br>
    </div>

    <div class="row clearfix">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 col-sm-12 col-xs-12">
            <div class="card">
                <div class="header">
                    <h2>
                        <i class="material-icons" style="color: var(--mrk-blue); vertical-align: bottom;">content_copy</i>
                        CLONAR CADASTROS ENTRE UNIDADES
                    </h2>
                    <small>Replica cadastros de produtos, fichas t√©cnicas entre unidades</small>
                </div>

                <div class="body">
                    <form id="cloneForm">

                        <div class="row">
                            <div class="col-md-6">
                                <p><b><i class="material-icons step-icon">output</i> Unidade de ORIGEM</b></p>
                                <p class="text-muted" style="font-size: 12px; margin-top:-10px;">De onde os dados ser√£o copiados</p>
                                <select id="sourceUnit" class="form-control" style="width: 100%;" required>
                                    <option value="">Selecione a origem...</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <p><b><i class="material-icons step-icon">input</i> Unidade de DESTINO</b></p>
                                <p class="text-muted" style="font-size: 12px; margin-top:-10px;">Para onde os dados v√£o (ser√£o apagados)</p>
                                <select id="targetUnit" class="form-control" style="width: 100%;" required>
                                    <option value="">Selecione o destino...</option>
                                </select>
                            </div>
                        </div>

                        <hr>

                        <div class="alert-custom">
                            <strong><i class="fa fa-exclamation-triangle"></i> Aten√ß√£o: Perigo de Perda de Dados</strong>
                            <br><br>
                            Ao confirmar, o sistema realizar√° as seguintes a√ß√µes na <b>Unidade de Destino</b>:
                            <ol>
                                <li>Apagar√° todos os dados atuais das tabelas listadas abaixo.</li>
                                <li>Inserir√° os dados copiados da Unidade de Origem.</li>
                            </ol>
                            <strong>Tabelas Afetadas:</strong>
                            <ul style="margin-top: 5px; column-count: 2;">
                                <li>categorias (Categorias)</li>
                                <li>products (Produtos)</li>
                                <li>compositions (Fichas de T√©cnicas)</li>
                                <li>productions (Fichas de Produ√ß√£o)</li>
                                <li>modelos_balanco (Modelos de Balanco)</li>
                                <li>modelos_balanco_itens (Itens dos modelos de balanco)</li>
                            </ul>
                        </div>

                        <div style="text-align: right; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary waves-effect btn-lg" style="padding: 10px 30px;">
                                <i class="material-icons">content_copy</i> CLONAR DADOS
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="https://portal.mrksolucoes.com.br/external/bsb/plugins/bootstrap/js/bootstrap.js"></script>
<script src="https://portal.mrksolucoes.com.br/external/bsb/plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- Configura√ß√£o da URL da API ---
    const API_BASE_URL = window.location.hostname !== 'localhost'
        ? 'https://portal.mrksolucoes.com.br/migrations/api'
        : 'http://localhost/portal-mrk/migrations/api';

    $(document).ready(function() {
        // Inicializa Select2
        $('#sourceUnit').select2({ placeholder: "Selecione a origem", allowClear: true });
        $('#targetUnit').select2({ placeholder: "Selecione o destino", allowClear: true });

        // Valida√ß√£o Inicial: Verifica se tem par√¢metros na URL ao carregar
        checkAuthParams();

        loadUnits();

        // Valida√ß√£o visual de sele√ß√£o igual
        $('#sourceUnit, #targetUnit').on('change', validateUnits);
    });

    function checkAuthParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('user_id') || urlParams.get('username');

        if (!token || !userId) {
            Swal.fire({
                icon: 'error',
                title: 'Acesso Negado',
                text: 'Par√¢metros de autentica√ß√£o ausentes. Acesse atrav√©s do sistema principal.',
                allowOutsideClick: false,
                showConfirmButton: false,
                footer: '<a href="#" onclick="window.close()">Fechar Janela</a>'
            });
            // Desabilita o formul√°rio
            $('button[type="submit"]').prop('disabled', true);
            $('select').prop('disabled', true);
            return false;
        }
        return true;
    }

    function validateUnits() {
        const source = $('#sourceUnit').val();
        const target = $('#targetUnit').val();

        if (source && target && source === target) {
            Swal.fire({
                icon: 'warning',
                title: 'Sele√ß√£o Inv√°lida',
                text: 'A unidade de origem e destino n√£o podem ser a mesma!',
                timer: 2000,
                showConfirmButton: false
            });
            $(this).val(null).trigger('change');
        }
    }

    async function loadUnits() {
        try {
            const res = await axios.get(`${API_BASE_URL}/list-system-units.php`);
            if (res.data.success) {
                const units = res.data.units;
                units.forEach(u => {
                    const option = new Option(`${u.id} - ${u.name}`, u.id, false, false);
                    $('#sourceUnit').append(option.cloneNode(true));
                    $('#targetUnit').append(option);
                });
            } else {
                Swal.fire('Erro', 'N√£o foi poss√≠vel carregar as unidades.', 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Erro de Conex√£o', 'Falha ao buscar unidades.', 'error');
        }
    }

    document.getElementById('cloneForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // 1. Valida√ß√£o de Seguran√ßa (Params URL) ANTES DE TUDO
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const userId = urlParams.get('user_id') || urlParams.get('username');

        if (!token || !userId) {
            Swal.fire({
                icon: 'error',
                title: 'Erro de Autentica√ß√£o',
                text: 'N√£o √© poss√≠vel enviar a requisi√ß√£o sem token e usu√°rio.'
            });
            return; // üõë PARA AQUI
        }

        // 2. Valida√ß√£o do Formul√°rio
        const sourceVal = $('#sourceUnit').val();
        const targetVal = $('#targetUnit').val();
        const sourceText = $('#sourceUnit option:selected').text();
        const targetText = $('#targetUnit option:selected').text();

        if (!sourceVal || !targetVal) {
            Swal.fire('Aten√ß√£o', 'Selecione a origem e o destino.', 'warning');
            return;
        }

        if (sourceVal === targetVal) {
            Swal.fire('Erro', 'Origem e destino s√£o iguais.', 'error');
            return;
        }

        // 3. Confirma√ß√£o
        Swal.fire({
            title: 'Confirmar Clonagem?',
            html: `
                <div style="text-align: left; font-size: 14px; color: #555;">
                    <p><b>De:</b> ${sourceText}</p>
                    <p><b>Para:</b> ${targetText}</p>
                    <hr>
                    <p style="color: #D32F2F; font-weight: bold;">
                        <i class="fa fa-times-circle"></i> OS DADOS DA UNIDADE DE DESTINO SER√ÉO APAGADOS PERMANENTEMENTE!
                    </p>
                    <p>Tem certeza absoluta?</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#0B46AC',
            cancelButtonColor: '#d33',
            confirmButtonText: 'SIM, CLONAR AGORA',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                executeClone(sourceVal, targetVal, token, userId);
            }
        });
    });

    async function executeClone(sourceId, targetId, token, userId) {
        Swal.fire({
            title: 'Clonando...',
            html: 'Isso pode levar alguns segundos.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const res = await axios.post(`${API_BASE_URL}/clone-unit-data.php`, {
                source_system_unit_id: sourceId,
                target_system_unit_id: targetId,
                token: token,   // Envia Token
                user_id: userId // Envia UserID
            });

            Swal.close();

            if (res.data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: res.data.message || 'Dados clonados com sucesso.',
                    confirmButtonColor: '#08A794'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: res.data.message || 'Erro ao clonar dados.'
                });
            }
        } catch (err) {
            Swal.close();
            Swal.fire('Erro Cr√≠tico', err.message || 'Falha na comunica√ß√£o com o servidor.', 'error');
        }
    }
</script>
</body>
</html>