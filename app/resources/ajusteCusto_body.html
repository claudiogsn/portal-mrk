<div class="container-fluid">

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="header">
                    <h2>Ajuste de Preço de Custo</h2>
                </div>
                <div class="body">
                    <form id="adjustForm">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="adjust-date">Data</label>
                                <input type="date" id="adjust-date" class="form-control" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-5">
                                <label for="item-description">Produto</label>
                                <input type="hidden" id="item-code" class="form-control" readonly>
                                <input type="text" id="item-description" class="form-control" readonly placeholder="Clique para selecionar um produto">
                            </div>

                            <div class="col-md-3">
                                <label for="current-price">Preço Atual</label>
                                <input type="text" id="current-price" class="form-control" readonly>
                            </div>

                            <div class="col-md-3">
                                <label for="new-price">Novo Preço</label>
                                <input type="number" id="new-price" class="form-control" placeholder="Digite o Novo Preço">
                            </div>

                            <div class="col-md-1">
                                <label>&nbsp;</label>
                                <button type="button" id="add-item" class="btn btn-primary btn-block">Adicionar</button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- tabela -->
    <div class="card">
        <div class="row">
            <div class="col-md-12">
                <table id="result-table" class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th>Cod.</th>
                        <th>Descrição</th>
                        <th>Preço Atual</th>
                        <th>Novo Preço</th>
                        <th>Ações</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <center>
        <button type="button" id="submit-adjust" class="btn btn-success">Confirmar Ajuste</button>
    </center>

</div>

<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Selecionar Produto</h4>
            </div>
            <div class="modal-body">
                <input type="text" id="item-search" class="form-control" placeholder="Buscar por código ou descrição">

                <table id="item-table" class="table table-striped">
                    <thead>
                    <tr>
                        <th>Cod.</th>
                        <th>Descrição</th>
                        <th>Preço Atual</th>
                        <th>Ações</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>

            </div>
        </div>
    </div>
</div>

<script>
    // ===================================================================
    // Você PODE incluir seu JS inline aqui
    // ===================================================================

    document.addEventListener('DOMContentLoaded', function() {

        const baseUrl = window.location.hostname !== 'localhost' ?
            'https://portal.mrksolucoes.com.br/api/v1/index.php' :
            'http://localhost/portal-mrk/api/v1/index.php';

        // Como agora está dentro do Adianti: pegue params via TSession
        const token = '{$token}';
        const unit_id = '{$unit_id}';
        const username = '{$username}';

        async function loadItems() {
            Swal.fire({
                title: 'Carregando itens...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await axios.post(baseUrl, {
                    method: 'listInsumos',
                    token: token,
                    data: { unit_id: unit_id }
                });

                Swal.close();

                if (response.data.success) {
                    const items = response.data.insumos;
                    const tbody = document.querySelector('#item-table tbody');
                    tbody.innerHTML = '';

                    items.forEach(item => {
                        let tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${item.codigo}</td>
                        <td>${item.nome}</td>
                        <td>${item.preco_custo}</td>
                        <td>
                            <button class="btn btn-primary select-item"
                                data-codigo="${item.codigo}"
                                data-nome="${item.nome}"
                                data-preco="${item.preco_custo}">
                                Inserir
                            </button>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('item-search').addEventListener('input', function() {
                        const value = this.value.toLowerCase();
                        document.querySelectorAll('#item-table tbody tr').forEach(row => {
                            const c = row.children[0].innerText.toLowerCase();
                            const n = row.children[1].innerText.toLowerCase();
                            row.style.display = (c.includes(value) || n.includes(value)) ? '' : 'none';
                        });
                    });

                    document.querySelectorAll('.select-item').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.getElementById('item-code').value = btn.dataset.codigo;
                            document.getElementById('item-description').value = btn.dataset.nome;
                            document.getElementById('current-price').value = btn.dataset.preco;
                            $('#itemModal').modal('hide');
                        });
                    });

                } else {
                    Swal.fire('Erro', 'Não foi possível carregar os itens.', 'error');
                }

            } catch (err) {
                Swal.fire('Erro', 'Erro ao carregar itens.', 'error');
            }
        }

        document.getElementById('item-description').addEventListener('click', () => {
            loadItems().then(() => $('#itemModal').modal('show'));
        });

        document.getElementById('add-item').addEventListener('click', () => {
            const codigo     = document.getElementById('item-code').value;
            const descricao  = document.getElementById('item-description').value;
            const precoAtual = document.getElementById('current-price').value;
            const novoPreco  = document.getElementById('new-price').value;

            if (!codigo || !precoAtual || !novoPreco) {
                Swal.fire('Erro', 'Preencha todos os campos!', 'error');
                return;
            }

            const tbody = document.querySelector('#result-table tbody');
            if ([...tbody.children].some(tr => tr.children[0].innerText === codigo)) {
                Swal.fire('Erro', 'Produto já adicionado!', 'error');
                return;
            }

            let tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${codigo}</td>
            <td>${descricao}</td>
            <td>${precoAtual}</td>
            <td>${parseFloat(novoPreco).toFixed(2)}</td>
            <td><button class="btn btn-danger remove-item">Remover</button></td>
        `;
            tbody.appendChild(tr);

            tr.querySelector('.remove-item').addEventListener('click', () => tr.remove());

            document.getElementById('item-code').value = '';
            document.getElementById('item-description').value = '';
            document.getElementById('current-price').value = '';
            document.getElementById('new-price').value = '';
        });

        document.getElementById('submit-adjust').addEventListener('click', async () => {

            const rows = [...document.querySelectorAll('#result-table tbody tr')];
            if (!rows.length) {
                Swal.fire('Erro', 'Nenhum item adicionado!', 'error');
                return;
            }

            const adjustDate = document.getElementById('adjust-date').value;
            if (!adjustDate) {
                Swal.fire('Erro', 'Selecione uma data válida.', 'error');
                return;
            }

            Swal.fire({
                title: 'Confirmar Ajuste?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim',
                cancelButtonText: 'Não'
            }).then(async (result) => {
                if (result.isConfirmed) {

                    const itens = rows.map(row => ({
                        codigo: row.children[0].innerText,
                        descricao: row.children[1].innerText,
                        precoAtual: row.children[2].innerText,
                        novoPreco: row.children[3].innerText
                    }));

                    try {
                        const response = await axios.post(baseUrl, {
                            method: 'createAjusteCusto',
                            token: token,
                            data: {
                                system_unit_id: unit_id,
                                ajuste_date: adjustDate,
                                itens: itens,
                                usuario_id: username
                            }
                        });

                        if (response.data.status === 'success') {
                            Swal.fire('Sucesso', 'Ajuste de preço realizado!', 'success');
                            document.querySelector('#result-table tbody').innerHTML = '';
                        } else {
                            Swal.fire('Erro', response.data.message || 'Erro no servidor!', 'error');
                        }

                    } catch (err) {
                        Swal.fire('Erro', 'Erro de comunicação com o servidor', 'error');
                    }
                }
            });
        });

    });
</script>
